name: CI

on:
  push:
    branches: [ "**" ]  # All branches
  pull_request:
    branches: [ main, develop ]

env:
  JAVA_VERSION: '21'
  JAVA_DISTRIBUTION: 'temurin'
  # CI_NOTE: GitHub Actions sets CI=true by default so coverage/lint flags run in non-interactive mode.

jobs:
  backend:
    name: Backend (Gradle + Testcontainers + Coverage)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      BILLING_CRYPTO_SECRET: ${{ secrets.TEST_BILLING_CRYPTO_SECRET || 'MDEyMzQ1Njc4OUFCQ0RFRjAxMjM0NTY3ODlBQkNERUY=' }}
      BILLING_WEBHOOK_SECRET: ${{ secrets.TEST_BILLING_WEBHOOK_SECRET || 'test-webhook-secret-for-ci' }}
      BILLING_DOCUMENTS_BASE_URL: 'http://localhost:8080/api/v1'
      STORAGE_S3_BUCKET: 'test-bucket'
      STORAGE_S3_ACCESS_KEY: 'TESTACCESSKEY'
      STORAGE_S3_SECRET_KEY: 'TESTSECRETKEY'
      STORAGE_S3_REGION: 'us-east-1'
      WEBHOOKS_HMAC_SECRET: 'TEST_HMAC_SECRET_FOR_CI_PIPELINE'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('backend/gradle/wrapper/gradle-wrapper.properties', 'backend/build.gradle', 'backend/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.JAVA_DISTRIBUTION }}

      - name: Validate Gradle wrapper
        uses: gradle/wrapper-validation-action@v2

      - name: Make gradlew executable
        run: chmod +x ./backend/gradlew

      - name: Clean build and run tests
        working-directory: ./backend
        run: ./gradlew clean build jacocoTestReport jacocoTestCoverageVerification --no-daemon --stacktrace

      - name: Check code style (Checkstyle)
        working-directory: ./backend
        run: ./gradlew checkstyleMain checkstyleTest --no-daemon --stacktrace

      - name: Check code formatting (Spotless)
        working-directory: ./backend
        run: ./gradlew spotlessCheck --no-daemon --stacktrace

      - name: Publish test results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            backend/build/test-results/**/*.xml

      - name: Upload build artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: |
            backend/build/libs/*.jar
          retention-days: 7

      - name: Upload Jacoco coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-jacoco-coverage
          path: |
            backend/build/reports/jacoco/test
          retention-days: 7

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            backend/build/reports/tests/**
          retention-days: 7

  ui:
    name: UI (npm lint + coverage)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm dependencies
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install UI dependencies
        working-directory: ./ui
        run: npm ci

      - name: Lint UI sources
        working-directory: ./ui
        run: npm run lint

      - name: Run UI tests with coverage
        working-directory: ./ui
        run: npm test -- --coverage
        # CI_NOTE: Vitest needs --coverage to emit `coverage/lcov.info` for artifact upload.

      - name: Upload UI coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ui-lcov
          path: |
            ui/coverage
          retention-days: 7

  flutter:
    name: Flutter (tests + coverage)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable

      - name: Cache Flutter artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            app_flutter/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('app_flutter/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Install Flutter packages
        working-directory: ./app_flutter
        run: flutter pub get

      - name: Run Flutter tests with coverage
        working-directory: ./app_flutter
        run: flutter test --coverage

      - name: Verify Flutter coverage threshold
        run: python3 scripts/check_flutter_coverage.py app_flutter/coverage/lcov.info 50

      - name: Upload Flutter coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: flutter-coverage
          path: |
            app_flutter/coverage
          retention-days: 7

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache npm dependencies for audit
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-npm-${{ hashFiles('ui/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-npm-

      - name: Install UI deps for audit
        working-directory: ./ui
        run: npm ci

      - name: Run npm audit
        working-directory: ./ui
        run: npm audit --audit-level=high

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: stable

      - name: Cache Flutter deps for security scans
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            app_flutter/.dart_tool
          key: ${{ runner.os }}-flutter-${{ hashFiles('app_flutter/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      - name: Flutter dependency audit
        working-directory: ./app_flutter
        run: |
          flutter pub get
          flutter pub outdated

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: './backend'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  smoke:
    name: Smoke tests (Docker Compose)
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Start Docker Compose stack
        run: docker compose -f docker-compose.yml -f docker-compose.local-prod.yml up -d --build

      - name: Probe backend endpoints
        run: |
          set -euo pipefail
          urls=(
            "http://localhost:8081/actuator/health"
            "http://localhost:8081/actuator/info"
            "http://localhost:8081/api/v1/ping"
          )
          for url in "${urls[@]}"; do
            echo "Waiting for $url"
            for attempt in $(seq 1 30); do
              if curl -sf "$url" >/dev/null; then
                echo "$url is ready"
                break
              fi
              if [ "$attempt" -eq 30 ]; then
                echo "Timeout waiting for $url"
                exit 1
              fi
              sleep 5
            done
          done

          if ! curl -sf http://localhost:8081/swagger-ui.html && ! curl -sf http://localhost:8081/swagger-ui/index.html; then
            echo "Swagger UI no respondi√≥"
            exit 1
          fi

      - name: Stop Docker Compose stack
        if: always()
        run: docker compose -f docker-compose.yml -f docker-compose.local-prod.yml down -v
