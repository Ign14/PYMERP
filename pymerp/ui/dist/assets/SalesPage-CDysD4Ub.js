import{j as e,e as J,d as ee,g as te,u as ae,h as se,i as ne,k as le,m as oe,a as ce,n as re}from"./index-BpLAP759.js";import{r as l}from"./react-BYfE7jJl.js";import{u as F,a as V}from"./useMutation-CPedeap3.js";import{P as ie}from"./PageHeader-ECmiVUlh.js";import{M as H}from"./Modal-Bq1-hS2x.js";import{u as de,f as z,g as ue}from"./table-Bis8ST_Y.js";import{u as me}from"./useDebouncedValue-e1gzF8eY.js";import{R as he,A as pe,C as xe,X as je,Y as ge,T as ye,a as be}from"./charts-CrTcgEid.js";const _=[{value:"Factura",label:"Factura"},{value:"Boleta",label:"Boleta"},{value:"Comprobante",label:"Comprobante"}],Q=[{value:"Efectivo",label:"Efectivo"},{value:"Tarjetas",label:"Tarjetas"},{value:"Transferencia",label:"Transferencia"},{value:"Otros",label:"Otros"}],Y=_[0].value,G=Q[2].value;function ve({open:o,onClose:u,onCreated:N}){const[P,M]=l.useState(""),[h,I]=l.useState(Y),[p,D]=l.useState(G),[c,E]=l.useState([]),[x,f]=l.useState(""),[j,S]=l.useState(1),[C,g]=l.useState(0),k=F({queryKey:["products",{dialog:"sales"}],queryFn:()=>ee({size:200}),enabled:o,staleTime:3e4}),r=F({queryKey:["customers",{dialog:"sales"}],queryFn:()=>te({size:200}),enabled:o,staleTime:3e4}),m=V({mutationFn:a=>J(a),onSuccess:a=>{N(a),A(),u()}}),T=k.data?.content??[],$=r.data?.content??[],K=l.useMemo(()=>c.reduce((a,n)=>a+n.qty*n.unitPrice-(n.discount??0),0),[c]),O=()=>{if(!x)return;const a=T.find(n=>n.id===x);a&&(j<=0||C<=0||(E(n=>[...n,{productId:x,qty:j,unitPrice:C}]),f(""),S(1),g(Number(a.currentPrice??0))))},L=a=>{E(n=>n.filter((i,b)=>b!==a))},A=()=>{M(""),I(Y),D(G),E([]),f(""),S(1),g(0)},R=a=>{if(a.preventDefault(),!P||c.length===0)return;const n={customerId:P,docType:h,paymentMethod:p,items:c};m.mutate(n)};return e.jsx(H,{open:o,onClose:u,title:"Registrar venta",children:e.jsxs("form",{className:"form-grid",onSubmit:R,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Cliente *"}),e.jsxs("select",{className:"input",value:P,onChange:a=>M(a.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecciona cliente"}),$.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Documento"}),e.jsx("select",{className:"input",value:h,onChange:a=>I(a.target.value),children:_.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Metodo de pago"}),e.jsx("select",{className:"input",value:p,onChange:a=>D(a.target.value),children:Q.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsx("div",{className:"line"}),e.jsxs("div",{className:"item-builder",children:[e.jsxs("select",{className:"input",value:x,onChange:a=>{const n=a.target.value;f(n);const i=T.find(b=>b.id===n);i?.currentPrice&&g(Number(i.currentPrice))},children:[e.jsx("option",{value:"",children:"Selecciona producto"}),T.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx("input",{className:"input",type:"number",min:1,value:j,onChange:a=>S(Number(a.target.value))}),e.jsx("input",{className:"input",type:"number",step:"0.01",min:0,value:C,onChange:a=>g(Number(a.target.value))}),e.jsx("button",{type:"button",className:"btn",onClick:O,children:"Agregar"})]}),c.length>0&&e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Precio"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:c.map((a,n)=>{const i=T.find(b=>b.id===a.productId);return e.jsxs("tr",{children:[e.jsx("td",{children:i?.name??a.productId}),e.jsx("td",{className:"mono",children:a.qty}),e.jsxs("td",{className:"mono",children:["$",a.unitPrice.toFixed(2)]}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>L(n),children:"Quitar"})})]},`${a.productId}-${n}`)})})]})}),e.jsxs("div",{className:"total-section",children:[e.jsx("span",{className:"muted",children:"Total estimado"}),e.jsxs("strong",{children:["$",K.toFixed(2)]})]}),m.isError&&e.jsx("p",{className:"error",children:m.error.message}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:m.isPending,children:m.isPending?"Guardando...":"Registrar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:A,children:"Limpiar"})]})]})})}const q=10,Ne=[{value:"",label:"Todos"},{value:"emitida",label:"Emitida"},{value:"cancelled",label:"Cancelada"}],Ce=[{value:"",label:"Todos los documentos"},..._.map(o=>({value:o.value,label:o.label}))],fe=[{value:"",label:"Todos los pagos"},...Q.map(o=>({value:o.value,label:o.label}))];function w(o,u){return o?o.toLowerCase().includes(u):!1}function De(){const o=ae(),[u,N]=l.useState(0),[P,M]=l.useState(!1),[h,I]=l.useState("emitida"),[p,D]=l.useState(""),[c,E]=l.useState(""),[x,f]=l.useState(""),[j,S]=l.useState(null),C=me(x,300);l.useEffect(()=>{N(0)},[h,p,c,C]);const g=F({queryKey:["sales",u,h,p,c,C],queryFn:()=>oe({page:u,size:q,status:h||void 0,docType:p||void 0,paymentMethod:c||void 0,search:C||void 0}),placeholderData:le}),k=F({queryKey:["sales","metrics",14],queryFn:()=>ce(14)}),r=F({queryKey:["sale-detail",j],queryFn:()=>{if(!j)throw new Error("Venta no seleccionada");return re(j)},enabled:!!j}),m=V({mutationFn:t=>se(t),onSuccess:()=>o.invalidateQueries({queryKey:["sales"]})}),T=V({mutationFn:({id:t,payload:s})=>ne(t,s),onSuccess:()=>o.invalidateQueries({queryKey:["sales"]})}),$=t=>{if(t.status?.toLowerCase()==="cancelled"){window.alert("La venta ya fue cancelada.");return}window.confirm(`Cancelar venta ${t.docType??"Factura"}?`)&&m.mutate(t.id)},K=t=>{const s=window.prompt("Documento",t.docType??"");if(s===null)return;const d=window.prompt("Metodo de pago",t.paymentMethod??"");if(d===null)return;const y={docType:s.trim()||t.docType,paymentMethod:d.trim()||t.paymentMethod};T.mutate({id:t.id,payload:y})},O=t=>{S(t.id)},L=()=>{S(null)},A=()=>{const t=r.data;if(!t)return;const s=window.open("","_blank","width=420,height=640");if(!s)return;const d=s.document;d.write("<title>Comprobante de venta</title>");const y=d.createElement("pre");y.style.fontFamily="'Courier New', monospace",y.style.fontSize="12px",y.style.whiteSpace="pre-wrap",y.textContent=t.thermalTicket,d.body.appendChild(y),d.close(),s.focus(),s.print()},R=t=>{N(0);const s=x.trim().toLowerCase(),d=!h||t.status.toLowerCase()===h.toLowerCase(),y=!p||t.docType===p,U=!c||t.paymentMethod===c,B=!s||w(t.docType,s)||w(t.paymentMethod,s)||w(t.customerName,s)||w(t.customerId,s)||w(t.id,s);d&&y&&U&&B&&o.setQueriesData({queryKey:["sales"]},v=>{if(!v||v.number!==0)return v;const X={id:t.id,customerId:t.customerId??void 0,customerName:t.customerName??void 0,docType:t.docType,paymentMethod:t.paymentMethod,status:t.status,net:t.net,vat:t.vat,total:t.total,issuedAt:t.issuedAt},W=v.content??[],Z=[X,...W].slice(0,v.size??q);return{...v,content:Z,totalElements:(v.totalElements??0)+1}}),o.invalidateQueries({queryKey:["sales"]})},a=l.useMemo(()=>[{header:"Documento",accessorKey:"docType",cell:t=>t.getValue()??"Factura"},{header:"Cliente",accessorFn:t=>t.customerName??t.customerId??"-",cell:t=>t.getValue()??"-"},{header:"Pago",accessorKey:"paymentMethod",cell:t=>t.getValue()??"-"},{header:"Estado",accessorKey:"status",cell:t=>{const s=t.getValue()??"";return e.jsx("span",{className:`status ${s.toLowerCase()}`,children:s})}},{header:"Neto",accessorKey:"net",cell:t=>`$${(t.getValue()??0).toLocaleString()}`},{header:"IVA",accessorKey:"vat",cell:t=>`$${(t.getValue()??0).toLocaleString()}`},{header:"Total",accessorKey:"total",cell:t=>`$${(t.getValue()??0).toLocaleString()}`},{header:"Emitida",accessorKey:"issuedAt",cell:t=>new Date(t.getValue()).toLocaleString()},{id:"actions",header:"Acciones",cell:({row:t})=>e.jsxs("div",{className:"table-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>O(t.original),children:"Comprobante"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>K(t.original),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>$(t.original),disabled:m.isPending,children:m.isPending?"Cancelando...":"Cancelar"})]})}],[m.isPending]),n=de({data:g.data?.content??[],columns:a,getCoreRowModel:ue(),manualPagination:!0,pageCount:g.data?.totalPages??-1,state:{pagination:{pageIndex:u,pageSize:q}},onPaginationChange:t=>{const s=typeof t=="function"?t({pageIndex:u,pageSize:q}).pageIndex:t.pageIndex;N(s)}}),i=l.useMemo(()=>(k.data??[]).map(t=>({date:t.date,total:t.total??0,count:t.count})),[k.data]),b=l.useMemo(()=>i.length?i.reduce((s,d)=>s+(d.count>0?d.total/d.count:0),0)/i.length:0,[i]);return e.jsxs("div",{className:"page-section",children:[e.jsx(ie,{title:"Ventas",description:"Gestiona documentos, monitorea cobranzas y analiza el desempeno.",actions:e.jsx("button",{className:"btn",onClick:()=>M(!0),children:"+ Registrar venta"})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"filter-bar",children:[e.jsx("input",{className:"input",placeholder:"Buscar (cliente, doc, pago)",value:x,onChange:t=>f(t.target.value)}),x&&e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>f(""),children:"Limpiar"}),e.jsx("select",{className:"input",value:h,onChange:t=>I(t.target.value),children:Ne.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("select",{className:"input",value:p,onChange:t=>D(t.target.value),children:Ce.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))}),e.jsx("select",{className:"input",value:c,onChange:t=>E(t.target.value),children:fe.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]})}),e.jsxs("section",{className:"kpi-grid",children:[e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ticket promedio"}),e.jsxs("p",{className:"stat-value",children:["$",b?b.toFixed(0):"-"]}),e.jsx("span",{className:"stat-trend",children:"Promedio diario en 14 dias"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ventas 14 dias"}),e.jsxs("p",{className:"stat-value",children:["$",i.reduce((t,s)=>t+s.total,0).toLocaleString()]}),e.jsx("span",{className:"stat-trend",children:"Incluye impuestos"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Documentos"}),e.jsx("p",{className:"stat-value",children:i.reduce((t,s)=>t+s.count,0)}),e.jsx("span",{className:"stat-trend",children:"Emitidos ultimas 2 semanas"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Tendencia de ventas"}),e.jsx("div",{style:{height:260},children:e.jsx(he,{width:"100%",height:"100%",children:e.jsxs(pe,{data:i,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"salesGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#60a5fa",stopOpacity:.8}),e.jsx("stop",{offset:"95%",stopColor:"#60a5fa",stopOpacity:0})]})}),e.jsx(xe,{strokeDasharray:"3 3",stroke:"#1f2937"}),e.jsx(je,{dataKey:"date",stroke:"#9aa0a6",tick:{fontSize:12}}),e.jsx(ge,{stroke:"#9aa0a6",tickFormatter:t=>`$${(t/1e3).toFixed(0)}k`}),e.jsx(ye,{formatter:t=>`$${t.toLocaleString()}`}),e.jsx(be,{type:"monotone",dataKey:"total",stroke:"#60a5fa",fill:"url(#salesGradient)"})]})})})]}),e.jsxs("div",{className:"card table-card",children:[e.jsx("h3",{children:"Facturas recientes"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:n.getHeaderGroups().map(t=>e.jsx("tr",{children:t.headers.map(s=>e.jsx("th",{children:s.isPlaceholder?null:z(s.column.columnDef.header,s.getContext())},s.id))},t.id))}),e.jsx("tbody",{children:n.getRowModel().rows.map(t=>e.jsx("tr",{children:t.getVisibleCells().map(s=>e.jsx("td",{children:z(s.column.columnDef.cell,s.getContext())},s.id))},t.id))})]})}),e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:u===0,onClick:()=>N(t=>Math.max(0,t-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Pagina ",u+1," de ",g.data?.totalPages??1]}),e.jsx("button",{className:"btn",disabled:u+1>=(g.data?.totalPages??1),onClick:()=>N(t=>t+1),children:"Siguiente"})]})]}),e.jsx(ve,{open:P,onClose:()=>M(!1),onCreated:R}),e.jsxs(H,{open:!!j,onClose:L,title:"Comprobante termico",children:[r.isLoading&&e.jsx("p",{children:"Cargando comprobante..."}),r.isError&&e.jsx("p",{className:"error",children:r.error?.message??"No se pudo cargar el comprobante"}),r.data&&e.jsxs("div",{className:"receipt-modal",children:[e.jsxs("div",{className:"receipt-summary",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Documento:"})," ",r.data.docType]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Pago:"})," ",r.data.paymentMethod]}),r.data.customer&&e.jsxs("p",{children:[e.jsx("strong",{children:"Cliente:"})," ",r.data.customer.name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Total:"})," $",r.data.total.toLocaleString()]})]}),e.jsx("pre",{className:"mono small",style:{whiteSpace:"pre-wrap"},children:r.data.thermalTicket}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"button",onClick:A,children:"Imprimir"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:L,children:"Cerrar"})]})]})]})]})}export{De as default};
