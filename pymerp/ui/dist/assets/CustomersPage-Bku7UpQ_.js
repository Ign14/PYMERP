import{j as e,u as te,e as se,c as Y,aj as ve,ak as ee,al as ae,d as Ne,am as ye,an as oe,ao as Ce}from"./index-BtVHljoa.js";import{r as u}from"./react-D8kvZI4c.js";import{u as R}from"./useQuery-Dnian6zg.js";import{P as Se}from"./PageHeader-BlxDVWRK.js";import{u as we,m as De,c as Te}from"./customersUtils-cyr8bVhJ.js";import{u as Ee,a as Fe,g as $e,f as ie}from"./table-DbsuG4jc.js";import{M as ke}from"./Modal-B2h9NkJO.js";import{c as Le}from"./currency-HwQAg_Xa.js";import{R as ce,A as Pe,C as de,X as ue,Y as me,T as xe,a as he,c as Re,B as Me,g as ge}from"./charts-BH7DIlZU.js";function Ae({customers:N,customerStats:g,onCustomerSelect:a,onCustomerEdit:f,onCustomerDelete:o,selectedCustomerId:m,getHealthStatus:c,calculateRFM:x}){const[r,i]=u.useState([]),s=u.useMemo(()=>[{accessorKey:"name",header:"Nombre",cell:n=>e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("strong",{className:"text-neutral-100",children:n.getValue()}),g[n.row.original.id]&&e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium border ${c(g[n.row.original.id]?.lastSaleDate||void 0).color}`,children:[e.jsx("span",{children:c(g[n.row.original.id]?.lastSaleDate||void 0).icon}),e.jsx("span",{children:c(g[n.row.original.id]?.lastSaleDate||void 0).label})]})]})},{accessorKey:"rut",header:"RUT",cell:n=>e.jsx("span",{className:"mono text-sm text-neutral-300",children:n.getValue()||"-"})},{accessorKey:"email",header:"Email",cell:n=>e.jsx("span",{className:"mono text-sm text-neutral-400",children:n.getValue()||"-"})},{accessorKey:"phone",header:"TelÃ©fono",cell:n=>e.jsx("span",{className:"mono text-sm text-neutral-400",children:n.getValue()||"-"})},{accessorKey:"segment",header:"Segmento",cell:n=>e.jsx("span",{className:"text-sm text-neutral-300",children:n.getValue()||"-"})},{id:"totalSales",header:"Ventas",accessorFn:n=>g[n.id]?.totalSales||0,cell:n=>e.jsx("span",{className:"text-neutral-100 font-semibold",children:n.getValue()})},{id:"totalRevenue",header:"Ingresos",accessorFn:n=>g[n.id]?.totalRevenue||0,cell:n=>e.jsxs("span",{className:"text-neutral-100 font-semibold",children:["$",n.getValue().toLocaleString("es-CL")]})},{id:"rfm",header:"RFM Score",accessorFn:n=>x?x(g[n.id])?.score||"000":"",cell:({row:n})=>{if(!x)return e.jsx("span",{className:"text-neutral-500",children:"-"});const l=x(g[n.original.id]);return e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx("span",{className:"mono text-sm font-bold text-neutral-100",children:l.score}),e.jsx("span",{className:"text-xs text-neutral-400",children:l.segment})]})}},{accessorKey:"createdAt",header:"Registrado",cell:n=>e.jsx("span",{className:"text-sm text-neutral-400",children:n.getValue()?new Date(n.getValue()).toLocaleDateString("es-CL"):"-"})},{id:"actions",header:"Acciones",cell:({row:n})=>e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{className:"btn ghost text-sm",onClick:l=>{l.stopPropagation(),f(n.original)},children:"Editar"}),e.jsx("button",{className:"btn ghost text-sm",onClick:l=>{l.stopPropagation(),o(n.original.id)},children:n.original.active!==!1?"Desactivar":"Activar"})]})}],[g,c,f,o]),d=Ee({data:N,columns:s,state:{sorting:r},onSortingChange:i,getCoreRowModel:$e(),getSortedRowModel:Fe()});return e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"table w-full",children:[e.jsx("thead",{children:d.getHeaderGroups().map(n=>e.jsx("tr",{children:n.headers.map(l=>e.jsx("th",{className:"cursor-pointer select-none hover:bg-neutral-800",onClick:l.column.getToggleSortingHandler(),children:e.jsxs("div",{className:"flex items-center gap-2",children:[ie(l.column.columnDef.header,l.getContext()),{asc:" ðŸ”¼",desc:" ðŸ”½"}[l.column.getIsSorted()]??null]})},l.id))},n.id))}),e.jsx("tbody",{children:d.getRowModel().rows.map(n=>e.jsx("tr",{className:`cursor-pointer hover:bg-neutral-700 ${m===n.original.id?"bg-neutral-700 ring-2 ring-blue-500":""}`,onClick:()=>a(n.original),children:n.getVisibleCells().map(l=>e.jsx("td",{children:ie(l.column.columnDef.cell,l.getContext())},l.id))},n.id))})]})})}const Ie=20,qe="createdAt,desc",be=u.forwardRef((N,g)=>{const{segmentFilter:a,segmentLabel:f,onClearSegment:o,onOpenCreateDialog:m,onOpenEditDialog:c}=N,x=te(),[r,i]=u.useState(""),[s,d]=u.useState(null),[n,l]=u.useState(null),[y,D]=u.useState(!1),[b,S]=u.useState("list"),[k,B]=u.useState(!1),[C,M]=u.useState({minRevenue:"",maxRevenue:"",lastPurchaseDays:"",hasAddress:!1,hasGPS:!1}),z=u.useRef(null),q=u.useRef(0);u.useImperativeHandle(g,()=>({focusCreate:()=>{m?.()},clearForm:()=>{},getFilters:()=>({query:r,segment:a??null,active:s})}),[m,r,a,s]),u.useEffect(()=>{q.current=0},[r,a,s]);const X=u.useCallback(async t=>{const p=r.trim(),v=performance.now(),T=await se({q:p.length?p:void 0,segment:a??void 0,page:t,size:Ie,sort:qe}),E=Math.round(performance.now()-v),P=T.content?.length??0;return console.info(`[Customers] page ${t} fetched (${P} items) in ${E}ms`),T},[r,a,s]),F=we({queryKey:["customers",r,a??null,s??null],queryFn:({pageParam:t=0})=>X(t),getNextPageParam:t=>Te(t),initialPageParam:0}),{fetchNextPage:Q,isFetchingNextPage:V,refetch:W}=F,L=u.useMemo(()=>De(F.data?.pages??[]),[F.data]),h=u.useMemo(()=>L.slice(0,20).map(t=>t.id),[L]),w=R({queryKey:["customers","batch-stats",h],queryFn:async()=>{const t=h.map(v=>ee(v).catch(()=>null)),p=await Promise.all(t);return h.reduce((v,T,E)=>{const P=p[E];return P&&(v[T]=P),v},{})},enabled:h.length>0,staleTime:6e4});u.useEffect(()=>{if(L.length===0){l(null);return}l(t=>t&&L.some(p=>p.id===t)?t:L[0]?.id??null)},[L]);const $=u.useMemo(()=>!C.minRevenue&&!C.maxRevenue&&!C.lastPurchaseDays&&!C.hasAddress&&!C.hasGPS?L:L.filter(t=>{const p=w.data?.[t.id];if(C.minRevenue){const v=parseFloat(C.minRevenue);if(!p||(p.totalRevenue||0)<v)return!1}if(C.maxRevenue){const v=parseFloat(C.maxRevenue);if(!p||(p.totalRevenue||0)>v)return!1}if(C.lastPurchaseDays){const v=parseInt(C.lastPurchaseDays);if(!p?.lastSaleDate||Math.floor((new Date().getTime()-new Date(p.lastSaleDate).getTime())/(1e3*60*60*24))>v)return!1}return!(C.hasAddress&&!t.address||C.hasGPS&&(!t.lat||!t.lng))}),[L,w.data,C]),j=u.useMemo(()=>n?$.find(t=>t.id===n)??null:null,[$,n]),A=u.useMemo(()=>j?j.lat!==void 0&&j.lat!==null&&`${j.lat}`.trim()!==""&&j.lng!==void 0&&j.lng!==null&&`${j.lng}`.trim()!==""?`${j.lat},${j.lng}`:j.address&&j.address.trim()?j.address.trim():null:null,[j]),_=u.useMemo(()=>A?`https://www.google.com/maps?q=${encodeURIComponent(A)}&output=embed`:null,[A]),G=u.useMemo(()=>A?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(A)}`:null,[A]),J=F.hasNextPage??!1,Z=F.isLoading&&!V;u.useEffect(()=>{const t=F.data?.pages.length??0;t>q.current&&(q.current=t,console.info(`[Customers] pages fetched so far: ${t}`))},[F.data]),u.useEffect(()=>{const t=z.current;if(!t)return;const p=new IntersectionObserver(v=>{v[0].isIntersecting&&J&&!V&&Q()});return p.observe(t),()=>p.disconnect()},[J,V,Q]);const H=Y({mutationFn:t=>ve(t),onSuccess:()=>{x.invalidateQueries({queryKey:["customers"],exact:!1})}}),I=R({queryKey:["customers",n,"stats"],queryFn:()=>ee(n),enabled:!!n&&y,staleTime:3e4}),O=R({queryKey:["customers",n,"sales"],queryFn:()=>ae(n,0,5),enabled:!!n&&y,staleTime:3e4}),re=t=>{if(!t)return{status:"inactive",label:"Sin ventas",color:"bg-neutral-700 text-neutral-400 border-neutral-600",icon:"âšª"};const p=Math.floor((new Date().getTime()-new Date(t).getTime())/(1e3*60*60*24));return p<=30?{status:"healthy",label:"Saludable",color:"bg-green-950 text-green-400 border-green-800",icon:"ðŸŸ¢"}:p<=90?{status:"at-risk",label:"En riesgo",color:"bg-yellow-950 text-yellow-400 border-yellow-800",icon:"ðŸŸ¡"}:{status:"inactive",label:"Inactivo",color:"bg-red-950 text-red-400 border-red-800",icon:"ðŸ”´"}},le=t=>{if(!t)return{recency:0,frequency:0,monetary:0,recencyScore:0,frequencyScore:0,monetaryScore:0,score:"000",segment:"Sin datos"};const p=t.lastSaleDate?Math.floor((new Date().getTime()-new Date(t.lastSaleDate).getTime())/(1e3*60*60*24)):999,v=p<=30?5:p<=60?4:p<=90?3:p<=180?2:1,T=t.totalSales||0,E=T>=20?5:T>=10?4:T>=5?3:T>=2?2:1,P=t.totalRevenue||0,U=P>=5e6?5:P>=2e6?4:P>=1e6?3:P>=5e5?2:1,fe=`${v}${E}${U}`;let K="Sin clasificar";return v>=4&&E>=4&&U>=4?K="ðŸ† CampeÃ³n":v>=4&&U>=4?K="ðŸ’Ž Leal":v>=4?K="â­ Potencial":E>=4||U>=4?K="ðŸ”„ Necesita atenciÃ³n":v<=2?K="âš ï¸ En riesgo":v===1&&(K="ðŸ’¤ Dormido"),{recency:p,frequency:T,monetary:P,recencyScore:v,frequencyScore:E,monetaryScore:U,score:fe,segment:K}},ne=F.isError?F.error?.message??"No se pudieron cargar los clientes":void 0,je=!Z&&!F.isError&&$.length===0;return e.jsxs("div",{children:[e.jsxs("div",{className:"card-header border-b border-neutral-800 pb-4 mb-4",children:[e.jsx("h2",{className:"text-neutral-100",children:"Clientes"}),e.jsxs("div",{className:"flex gap-2 items-center flex-1",children:[e.jsx("input",{className:"input bg-neutral-800 border-neutral-700 text-neutral-100 flex-1",placeholder:"Buscar por nombre, email, telÃ©fono o RUT",value:r,onChange:t=>i(t.target.value)}),e.jsxs("div",{className:"flex gap-1 bg-neutral-800 border border-neutral-700 rounded-lg p-1",children:[e.jsx("button",{className:`px-3 py-1 rounded text-sm ${b==="list"?"bg-neutral-700 text-neutral-100":"text-neutral-400 hover:text-neutral-100"}`,onClick:()=>S("list"),title:"Vista de lista",children:"ðŸ“‹ Lista"}),e.jsx("button",{className:`px-3 py-1 rounded text-sm ${b==="table"?"bg-neutral-700 text-neutral-100":"text-neutral-400 hover:text-neutral-100"}`,onClick:()=>S("table"),title:"Vista de tabla",children:"ðŸ“Š Tabla"})]})]}),e.jsxs("button",{className:"btn ghost text-sm text-neutral-400 hover:text-neutral-100",onClick:()=>B(!k),children:[k?"ðŸ”¼":"ðŸ”½"," Filtros avanzados"]})]}),k&&e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-300 mb-2",children:"Ingresos mÃ­nimos ($)"}),e.jsx("input",{type:"number",className:"input bg-neutral-900 border-neutral-700 text-neutral-100 w-full",placeholder:"Ej: 100000",value:C.minRevenue,onChange:t=>M(p=>({...p,minRevenue:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-300 mb-2",children:"Ingresos mÃ¡ximos ($)"}),e.jsx("input",{type:"number",className:"input bg-neutral-900 border-neutral-700 text-neutral-100 w-full",placeholder:"Ej: 5000000",value:C.maxRevenue,onChange:t=>M(p=>({...p,maxRevenue:t.target.value}))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-neutral-300 mb-2",children:"Ãšltima compra (mÃ¡x dÃ­as)"}),e.jsx("input",{type:"number",className:"input bg-neutral-900 border-neutral-700 text-neutral-100 w-full",placeholder:"Ej: 90",value:C.lastPurchaseDays,onChange:t=>M(p=>({...p,lastPurchaseDays:t.target.value}))})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"hasAddress",checked:C.hasAddress,onChange:t=>M(p=>({...p,hasAddress:t.target.checked})),className:"w-4 h-4 text-blue-600 bg-neutral-900 border-neutral-700 rounded focus:ring-blue-500"}),e.jsx("label",{htmlFor:"hasAddress",className:"text-sm text-neutral-300",children:"Solo con direcciÃ³n"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("input",{type:"checkbox",id:"hasGPS",checked:C.hasGPS,onChange:t=>M(p=>({...p,hasGPS:t.target.checked})),className:"w-4 h-4 text-blue-600 bg-neutral-900 border-neutral-700 rounded focus:ring-blue-500"}),e.jsx("label",{htmlFor:"hasGPS",className:"text-sm text-neutral-300",children:"Solo con coordenadas GPS"})]}),e.jsx("div",{className:"flex items-center gap-2",children:e.jsx("button",{className:"btn ghost text-sm",onClick:()=>M({minRevenue:"",maxRevenue:"",lastPurchaseDays:"",hasAddress:!1,hasGPS:!1}),children:"Limpiar filtros"})})]})}),f&&e.jsxs("div",{className:"active-filter bg-neutral-800 border border-neutral-700 rounded-lg",children:[e.jsxs("span",{className:"text-neutral-100",children:["Filtrado por segmento: ",f]}),o&&e.jsx("button",{className:"btn ghost",type:"button",onClick:o,children:"Limpiar"})]}),Z&&e.jsx("p",{className:"text-neutral-400",children:"Loading..."}),!Z&&F.isError&&L.length===0&&e.jsxs("div",{className:"error bg-red-950 border border-red-800 rounded-lg p-4",children:[e.jsx("p",{className:"text-red-400",children:ne}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>W(),children:"Reintentar"})]}),b==="table"?e.jsx(Ae,{customers:$,customerStats:w.data||{},onCustomerSelect:t=>l(t.id),onCustomerEdit:t=>c?.(t),onCustomerDelete:t=>H.mutate(t),selectedCustomerId:n,getHealthStatus:re,calculateRFM:le}):!F.isError&&$.length>0&&e.jsx("ul",{className:"list","aria-live":"polite",children:$.map(t=>{const p=n===t.id,v=w.data?.[t.id],T=re(v?.lastSaleDate||void 0);return e.jsxs("li",{className:`list-row bg-neutral-800 hover:bg-neutral-700 border border-neutral-700 rounded-lg${p?" selected ring-2 ring-blue-500":""}`,onClick:()=>l(t.id),role:"button",tabIndex:0,onKeyDown:E=>{(E.key==="Enter"||E.key===" ")&&(E.preventDefault(),l(t.id))},children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("strong",{className:"text-neutral-100",children:t.name}),v&&e.jsxs("span",{className:`inline-flex items-center gap-1 px-2 py-0.5 rounded text-xs font-medium border ${T.color}`,children:[e.jsx("span",{children:T.icon}),e.jsx("span",{children:T.label})]})]}),t.rut?e.jsxs("div",{className:"mono small text-neutral-400",children:["RUT: ",t.rut]}):null,t.segment?e.jsx("div",{className:"mono small text-neutral-300",children:t.segment}):null,t.email?e.jsx("div",{className:"mono small text-neutral-400",children:t.email}):null,t.phone?e.jsx("div",{className:"mono small text-neutral-400",children:t.phone}):null,t.address?e.jsx("div",{className:"mono small text-neutral-400",children:t.address}):null,t.active===!1?e.jsx("div",{className:"badge bg-neutral-700 text-neutral-300 border border-neutral-600",children:"Inactivo"}):null]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn ghost",onClick:E=>{E.stopPropagation(),c?.(t)},children:"Editar"}),e.jsx("button",{className:"btn ghost",onClick:E=>{E.stopPropagation(),H.mutate(t.id)},disabled:H.isPending,children:t.active!==!1?"Desactivar":"Activar"})]})]},t.id)})}),je&&e.jsxs("div",{className:"muted text-neutral-400 text-center py-8",children:[e.jsx("p",{children:"Sin clientes"}),e.jsx("p",{className:"small",children:"Crea tu primer cliente usando el formulario debajo."})]}),F.isError&&$.length>0&&e.jsxs("div",{className:"error inline bg-red-950 border border-red-800 rounded-lg p-3",children:[e.jsx("span",{className:"text-red-400",children:ne}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>W(),children:"Reintentar"})]}),e.jsx("div",{ref:z,"aria-hidden":"true"}),V&&e.jsx("p",{className:"muted text-neutral-400",children:"Cargando mas..."}),!J&&$.length>0&&e.jsx("p",{className:"muted text-neutral-400",children:"No hay mas resultados"}),j&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"map-panel bg-neutral-800 border border-neutral-700 rounded-lg mt-4",children:[e.jsxs("div",{className:"map-header border-b border-neutral-700",children:[e.jsxs("div",{children:[e.jsx("strong",{className:"text-neutral-100",children:j.name}),j.address?e.jsx("p",{className:"muted small text-neutral-400",children:j.address}):e.jsx("p",{className:"muted small text-neutral-400",children:"Sin direcciÃ³n registrada"})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>D(!y),children:y?"Ocultar detalles":"Ver detalles"}),G&&e.jsx("a",{className:"btn ghost",href:G,target:"_blank",rel:"noreferrer",children:"Ver en Google Maps"})]})]}),_?e.jsx("div",{className:"map-preview",children:e.jsx("iframe",{title:`UbicaciÃ³n de ${j.name}`,src:_,loading:"lazy",allowFullScreen:!0})}):e.jsx("p",{className:"muted small text-neutral-400",children:"Registra una direcciÃ³n o coordenadas para visualizar el mapa."})]}),y&&e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",style:{marginTop:"1rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem",fontSize:"0.95rem"},className:"text-neutral-100",children:"Historial y EstadÃ­sticas"}),I.isLoading&&e.jsx("p",{className:"muted text-neutral-400",children:"Cargando estadÃ­sticas..."}),I.isError&&e.jsx("p",{className:"error text-red-400",children:"Error al cargar estadÃ­sticas"}),I.data&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:"1rem",marginBottom:"1rem"},children:[e.jsxs("div",{children:[e.jsx("p",{className:"muted small text-neutral-400",children:"Total Ventas"}),e.jsx("p",{style:{fontSize:"1.5rem",fontWeight:"600",margin:"0.25rem 0"},className:"text-neutral-100",children:I.data.totalSales||0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"muted small text-neutral-400",children:"Ingresos Totales"}),e.jsxs("p",{style:{fontSize:"1.5rem",fontWeight:"600",margin:"0.25rem 0"},className:"text-neutral-100",children:["$",(I.data.totalRevenue||0).toLocaleString("es-CL")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"muted small text-neutral-400",children:"Ãšltima Venta"}),e.jsx("p",{style:{fontSize:"1.5rem",fontWeight:"600",margin:"0.25rem 0"},className:"text-neutral-100",children:I.data.lastSaleDate?new Date(I.data.lastSaleDate).toLocaleDateString("es-CL"):"-"})]})]}),(()=>{const t=le(I.data);return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-700 rounded-lg p-4 mb-4",children:[e.jsx("h4",{className:"text-neutral-100 font-semibold mb-3",children:"ðŸ“Š AnÃ¡lisis RFM"}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Recency"}),e.jsxs("p",{className:"text-lg font-bold text-neutral-100",children:[t.recencyScore,"/5"]}),e.jsxs("p",{className:"text-xs text-neutral-400",children:[t.recency," dÃ­as"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Frequency"}),e.jsxs("p",{className:"text-lg font-bold text-neutral-100",children:[t.frequencyScore,"/5"]}),e.jsxs("p",{className:"text-xs text-neutral-400",children:[t.frequency," ventas"]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Monetary"}),e.jsxs("p",{className:"text-lg font-bold text-neutral-100",children:[t.monetaryScore,"/5"]}),e.jsxs("p",{className:"text-xs text-neutral-400",children:["$",t.monetary.toLocaleString("es-CL")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Score Total"}),e.jsx("p",{className:"text-xl font-bold text-blue-400 mono",children:t.score})]})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-sm text-neutral-400 mb-1",children:"Segmento AutomÃ¡tico"}),e.jsx("p",{className:"text-lg font-semibold text-neutral-100",children:t.segment})]})]})})()]}),e.jsx("h4",{style:{marginBottom:"0.5rem",fontSize:"0.9rem"},className:"text-neutral-100",children:"Ãšltimas Ventas"}),O.isLoading&&e.jsx("p",{className:"muted text-neutral-400",children:"Cargando historial..."}),O.isError&&e.jsx("p",{className:"error text-red-400",children:"Error al cargar historial"}),O.data&&O.data.content.length>0?e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{className:"text-neutral-100",children:"Fecha"}),e.jsx("th",{className:"text-neutral-100",children:"Tipo"}),e.jsx("th",{style:{textAlign:"right"},className:"text-neutral-100",children:"Total"})]})}),e.jsx("tbody",{children:O.data.content.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small text-neutral-300",children:new Date(t.saleDate).toLocaleDateString("es-CL")}),e.jsx("td",{className:"text-neutral-300",children:t.docType||"-"}),e.jsxs("td",{className:"mono text-neutral-100",style:{textAlign:"right",fontWeight:"600"},children:["$",t.total.toLocaleString("es-CL")]})]},t.saleId))})]}):O.data&&e.jsx("p",{className:"muted small text-neutral-400",children:"No hay ventas registradas"})]})]}),e.jsxs("div",{className:"active-filter bg-neutral-800 border border-neutral-700 rounded-lg",style:{display:"flex",gap:"1rem",alignItems:"center",marginTop:"1rem"},children:[e.jsx("span",{className:"muted small text-neutral-400",children:"Mostrar:"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:`btn ghost ${s===null?"selected":""}`,type:"button",onClick:()=>d(null),children:"Todos"}),e.jsx("button",{className:`btn ghost ${s===!0?"selected":""}`,type:"button",onClick:()=>d(!0),children:"Activos"}),e.jsx("button",{className:`btn ghost ${s===!1?"selected":""}`,type:"button",onClick:()=>d(!1),children:"Inactivos"})]})]}),H.isError&&e.jsx("p",{className:"error text-red-400",children:H.error?.message})]})});be.displayName="CustomersCard";const pe=()=>({name:"",rut:"",phone:"",email:"",address:"",segment:"",contactPerson:"",notes:"",active:!0,latText:"",lngText:""});function Ke({open:N,onClose:g,editingCustomer:a}){const f=te(),[o,m]=u.useState(()=>a?{name:a.name,rut:a.rut||"",phone:a.phone||"",email:a.email||"",address:a.address||"",segment:a.segment||"",contactPerson:a.contactPerson||"",notes:a.notes||"",active:a.active!==!1,latText:a.lat?.toString()||"",lngText:a.lng?.toString()||""}:pe()),c=Y({mutationFn:s=>Ne(s),onSuccess:()=>{f.invalidateQueries({queryKey:["customers"],exact:!1}),r()}}),x=Y({mutationFn:({id:s,payload:d})=>ye(s,d),onSuccess:()=>{f.invalidateQueries({queryKey:["customers"],exact:!1}),r()}}),r=()=>{m(pe()),g()},i=s=>{if(s.preventDefault(),!o.name||!o.name.trim()){alert("El nombre es obligatorio");return}const d=l=>{if(!l||!l.trim())return null;const y=Number(l.trim());return Number.isFinite(y)?y:null},n={name:o.name.trim(),rut:o.rut?.trim()||void 0,phone:o.phone?.trim()||void 0,email:o.email?.trim()||void 0,address:o.address?.trim()||void 0,segment:o.segment?.trim()||void 0,contactPerson:o.contactPerson?.trim()||void 0,notes:o.notes?.trim()||void 0,active:o.active,lat:d(o.latText),lng:d(o.lngText)};a?x.mutate({id:a.id,payload:n}):c.mutate(n)};return e.jsx(ke,{open:N,onClose:r,title:a?"Editar Cliente":"Nuevo Cliente",children:e.jsxs("form",{className:"form-grid",onSubmit:i,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",autoFocus:!0,value:o.name,onChange:s=>m(d=>({...d,name:s.target.value})),placeholder:"Cliente demo"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"RUT"}),e.jsx("input",{className:"input",value:o.rut??"",onChange:s=>m(d=>({...d,rut:s.target.value})),placeholder:"12.345.678-9"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Email"}),e.jsx("input",{className:"input",type:"email",value:o.email??"",onChange:s=>m(d=>({...d,email:s.target.value})),placeholder:"cliente@correo.com"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"TelÃ©fono"}),e.jsx("input",{className:"input",value:o.phone??"",onChange:s=>m(d=>({...d,phone:s.target.value})),placeholder:"+56 9 0000 0000"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Persona de Contacto"}),e.jsx("input",{className:"input",value:o.contactPerson??"",onChange:s=>m(d=>({...d,contactPerson:s.target.value})),placeholder:"Juan PÃ©rez"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Segmento"}),e.jsx("input",{className:"input",value:o.segment??"",onChange:s=>m(d=>({...d,segment:s.target.value})),placeholder:"Retail"})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"DirecciÃ³n"}),e.jsx("input",{className:"input",value:o.address??"",onChange:s=>m(d=>({...d,address:s.target.value})),placeholder:"Av. Demo 123"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Latitud"}),e.jsx("input",{className:"input",type:"number",step:"any",value:o.latText,onChange:s=>m(d=>({...d,latText:s.target.value})),placeholder:"-33.4489"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Longitud"}),e.jsx("input",{className:"input",type:"number",step:"any",value:o.lngText,onChange:s=>m(d=>({...d,lngText:s.target.value})),placeholder:"-70.6693"})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"Notas"}),e.jsx("textarea",{className:"input",rows:3,value:o.notes??"",onChange:s=>m(d=>({...d,notes:s.target.value})),placeholder:"Observaciones adicionales..."})]}),e.jsxs("label",{className:"checkbox-label",style:{gridColumn:"1 / -1"},children:[e.jsx("input",{type:"checkbox",checked:o.active!==!1,onChange:s=>m(d=>({...d,active:s.target.checked}))}),e.jsx("span",{children:"Cliente activo"})]}),e.jsxs("div",{className:"buttons",style:{gridColumn:"1 / -1"},children:[e.jsx("button",{className:"btn",type:"submit",disabled:c.isPending||x.isPending,children:a?x.isPending?"Actualizando...":"Actualizar":c.isPending?"Guardando...":"Crear"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:r,children:"Cancelar"})]}),c.isError&&e.jsx("p",{className:"error",style:{gridColumn:"1 / -1"},children:c.error?.message}),x.isError&&e.jsx("p",{className:"error",style:{gridColumn:"1 / -1"},children:x.error?.message})]})})}function Ve({open:N,onClose:g}){const a=te(),[f,o]=u.useState(null),[m,c]=u.useState(null),[x,r]=u.useState(!1),i=Y({mutationFn:async b=>{const S=new FormData;S.append("file",b);const k=await fetch("/api/v1/customers/import",{method:"POST",body:S});if(!k.ok)throw new Error("Error importando archivo");return k.json()},onSuccess:b=>{c(b),a.invalidateQueries({queryKey:["customers"]}),a.invalidateQueries({queryKey:["customers","segments"]})}}),s=b=>{b.preventDefault(),r(!1);const S=b.dataTransfer.files[0];S&&S.name.endsWith(".csv")&&(o(S),c(null))},d=b=>{b.preventDefault(),r(!0)},n=()=>{r(!1)},l=b=>{const S=b.target.files?.[0];S&&(o(S),c(null))},y=()=>{f&&i.mutate(f)},D=()=>{o(null),c(null),g()};return N?e.jsx("div",{className:"dialog-overlay",onClick:D,children:e.jsxs("div",{className:"dialog",onClick:b=>b.stopPropagation(),children:[e.jsxs("div",{className:"dialog-header",children:[e.jsx("h2",{children:"Importar Clientes desde CSV"}),e.jsx("button",{className:"close-button",onClick:D,children:"âœ•"})]}),e.jsx("div",{className:"dialog-body",children:m?e.jsxs("div",{className:"import-result",children:[e.jsxs("div",{className:`result-summary ${m.totalErrors>0?"warning":"success"}`,children:[e.jsx("h3",{children:"ImportaciÃ³n completada"}),e.jsxs("div",{className:"result-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"Creados:"}),e.jsx("span",{className:"stat-value text-success",children:m.created})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"Errores:"}),e.jsx("span",{className:"stat-value text-critical",children:m.totalErrors})]})]})]}),m.errors.length>0&&e.jsxs("div",{className:"error-list",children:[e.jsx("h4",{children:"Errores detectados:"}),e.jsxs("div",{className:"errors-container",children:[m.errors.slice(0,10).map((b,S)=>e.jsxs("div",{className:"error-item",children:[e.jsxs("span",{className:"error-line",children:["LÃ­nea ",b.line,":"]}),e.jsx("span",{className:"error-message",children:b.error})]},S)),m.errors.length>10&&e.jsxs("p",{className:"text-muted",children:["... y ",m.errors.length-10," errores mÃ¡s"]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`file-drop-zone ${x?"dragging":""}`,onDrop:s,onDragOver:d,onDragLeave:n,children:f?e.jsxs("div",{className:"file-selected",children:[e.jsx("div",{className:"file-icon",children:"ðŸ“„"}),e.jsx("div",{className:"file-name",children:f.name}),e.jsxs("div",{className:"file-size",children:[(f.size/1024).toFixed(1)," KB"]})]}):e.jsxs("div",{className:"file-drop-message",children:[e.jsx("div",{className:"upload-icon",children:"ðŸ“¥"}),e.jsx("p",{children:"Arrastra un archivo CSV aquÃ­"}),e.jsx("p",{className:"text-muted",children:"o"}),e.jsxs("label",{className:"btn btn-secondary",children:["Seleccionar archivo",e.jsx("input",{type:"file",accept:".csv",onChange:l,style:{display:"none"}})]})]})}),e.jsxs("div",{className:"import-instructions",children:[e.jsx("h4",{children:"Formato esperado del CSV:"}),e.jsx("p",{children:"El archivo debe tener las siguientes columnas en orden:"}),e.jsxs("ol",{children:[e.jsx("li",{children:"Nombre (requerido)"}),e.jsx("li",{children:"RUT"}),e.jsx("li",{children:"Email"}),e.jsx("li",{children:"TelÃ©fono"}),e.jsx("li",{children:"DirecciÃ³n"}),e.jsx("li",{children:"Segmento (cÃ³digo)"}),e.jsx("li",{children:"Persona de Contacto"}),e.jsx("li",{children:"Notas"}),e.jsx("li",{children:"Activo (SÃ­/No)"})]})]})]})}),e.jsx("div",{className:"dialog-footer",children:m?e.jsx("button",{className:"btn",onClick:D,children:"Cerrar"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:D,children:"Cancelar"}),e.jsx("button",{className:"btn",onClick:y,disabled:!f||i.isPending,children:i.isPending?"Importando...":"Importar"})]})})]})}):null}function Oe(){const N=u.useMemo(()=>Le(),[]),g=c=>N.format(c??0),a=R({queryKey:["customers","dashboard"],queryFn:()=>se({page:0,size:1e4})}),f=u.useMemo(()=>{const c=new Date;return c.setDate(c.getDate()-30),c.toISOString()},[]),o=u.useMemo(()=>{if(!a.data)return null;const c=a.data.content||[],x=c.length,r=c.filter(i=>i.createdAt&&new Date(i.createdAt)>=new Date(f)).length;return{totalActive:x,newCustomers:r,totalCustomers:a.data.totalElements||x}},[a.data,f]),m=R({queryKey:["customers","top-revenue"],queryFn:async()=>({totalRevenue:0,topCustomer:null}),enabled:!!a.data});return a.isLoading?e.jsx("section",{className:"mb-6",children:e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h2",{className:"text-neutral-100 mb-4",children:"Resumen de Clientes"}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[1,2,3,4].map(c=>e.jsx("div",{className:"animate-pulse bg-neutral-800 rounded-lg h-32"},c))})]})}):a.isError?e.jsx("section",{className:"mb-6",children:e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:e.jsx("div",{className:"bg-red-950 border border-red-800 rounded-lg p-4",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar mÃ©tricas de clientes"})})})}):o?e.jsx("section",{className:"mb-6",children:e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h2",{className:"text-neutral-100 mb-4 text-xl font-semibold",children:"Resumen de Clientes"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("article",{className:"bg-neutral-800 border border-neutral-700 rounded-xl shadow p-5",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"text-neutral-400 text-sm font-medium",children:"Clientes Activos"}),e.jsx("span",{className:"text-2xl",children:"ðŸ‘¥"})]}),e.jsx("p",{className:"text-3xl font-bold text-neutral-100 mb-1",children:o.totalActive}),e.jsxs("span",{className:"text-neutral-400 text-sm",children:["De ",o.totalCustomers," totales"]})]}),e.jsxs("article",{className:"bg-neutral-800 border border-neutral-700 rounded-xl shadow p-5",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"text-neutral-400 text-sm font-medium",children:"Nuevos (30 dÃ­as)"}),e.jsx("span",{className:"text-2xl",children:"ðŸ“ˆ"})]}),e.jsx("p",{className:"text-3xl font-bold text-neutral-100 mb-1",children:o.newCustomers}),e.jsx("span",{className:"text-neutral-400 text-sm",children:o.totalActive>0?`${(o.newCustomers/o.totalActive*100).toFixed(1)}% del total`:"0% del total"})]}),e.jsxs("article",{className:"bg-neutral-800 border border-neutral-700 rounded-xl shadow p-5",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"text-neutral-400 text-sm font-medium",children:"Ingresos Totales"}),e.jsx("span",{className:"text-2xl",children:"ðŸ’°"})]}),e.jsx("p",{className:"text-3xl font-bold text-neutral-100 mb-1",children:g(m.data?.totalRevenue||0)}),e.jsx("span",{className:"text-neutral-400 text-sm",children:"HistÃ³rico completo"})]}),e.jsxs("article",{className:"bg-neutral-800 border border-neutral-700 rounded-xl shadow p-5",children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsx("h3",{className:"text-neutral-400 text-sm font-medium",children:"Top Cliente"}),e.jsx("span",{className:"text-2xl",children:"â­"})]}),m.data?.topCustomer?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-lg font-bold text-neutral-100 mb-1 truncate",children:m.data.topCustomer.name}),e.jsx("span",{className:"text-neutral-400 text-sm",children:g(m.data.topCustomer.revenue)})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-lg font-bold text-neutral-100 mb-1",children:"-"}),e.jsx("span",{className:"text-neutral-400 text-sm",children:"Sin datos suficientes"})]})]})]})]})}):null}function ze({customers:N,customerStats:g,onCustomerSelect:a,selectedCustomerId:f,getHealthStatus:o}){const[m,c]=u.useState(null),[x,r]=u.useState(null),i=u.useMemo(()=>N.filter(l=>{if(!(l.lat!==null&&l.lat!==void 0&&l.lng!==null&&l.lng!==void 0&&`${l.lat}`.trim()!==""&&`${l.lng}`.trim()!=="")||m&&l.segment!==m)return!1;if(x){const D=g[l.id];if(o(D?.lastSaleDate||void 0).status!==x)return!1}return!0}),[N,m,x,g,o]),s=u.useMemo(()=>{if(i.length===0)return{lat:-33.4489,lng:-70.6693};const l=i.reduce((D,b)=>D+parseFloat(`${b.lat}`),0)/i.length,y=i.reduce((D,b)=>D+parseFloat(`${b.lng}`),0)/i.length;return{lat:l,lng:y}},[i]),d=u.useMemo(()=>{const l=new Set(N.map(y=>y.segment).filter(Boolean));return Array.from(l)},[N]),n=u.useMemo(()=>i.length===0?`https://www.google.com/maps?q=${s.lat},${s.lng}&output=embed&z=12`:(i.slice(0,20).map(l=>`${l.lat},${l.lng}`).join("|"),`https://www.google.com/maps/embed/v1/view?key=YOUR_API_KEY&center=${s.lat},${s.lng}&zoom=12`),[i,s]);return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl p-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-semibold text-neutral-100",children:["ðŸ—ºï¸ Mapa de Clientes (",i.length,")"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("select",{className:"input bg-neutral-800 border-neutral-700 text-neutral-100 text-sm",value:m||"",onChange:l=>c(l.target.value||null),children:[e.jsx("option",{value:"",children:"Todos los segmentos"}),d.map(l=>e.jsx("option",{value:l,children:l},l))]}),e.jsxs("select",{className:"input bg-neutral-800 border-neutral-700 text-neutral-100 text-sm",value:x||"",onChange:l=>r(l.target.value||null),children:[e.jsx("option",{value:"",children:"Todos los estados"}),e.jsx("option",{value:"healthy",children:"ðŸŸ¢ Saludables"}),e.jsx("option",{value:"at-risk",children:"ðŸŸ¡ En riesgo"}),e.jsx("option",{value:"inactive",children:"ðŸ”´ Inactivos"})]})]})]}),i.length===0?e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-8 text-center",children:e.jsx("p",{className:"text-neutral-400",children:"No hay clientes con coordenadas GPS disponibles"})}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg overflow-hidden mb-4",style:{height:"500px"},children:e.jsx("iframe",{title:"Mapa de clientes",src:n,width:"100%",height:"100%",loading:"lazy",allowFullScreen:!0,style:{border:0}})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto",children:i.map(l=>{const y=g[l.id],D=o(y?.lastSaleDate||void 0),b=f===l.id;return e.jsxs("button",{className:`bg-neutral-800 hover:bg-neutral-700 border rounded-lg p-3 text-left transition-all ${b?"border-blue-500 ring-2 ring-blue-500":"border-neutral-700"}`,onClick:()=>a(l),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-lg",children:D.icon}),e.jsx("strong",{className:"text-neutral-100 text-sm",children:l.name})]}),l.segment&&e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:l.segment}),e.jsxs("p",{className:"text-xs font-mono text-neutral-500",children:["ðŸ“ ",parseFloat(`${l.lat}`).toFixed(4),","," ",parseFloat(`${l.lng}`).toFixed(4)]}),y&&e.jsxs("p",{className:"text-xs text-neutral-400 mt-1",children:[y.totalSales||0," ventas â€¢ $",(y.totalRevenue||0).toLocaleString("es-CL")]})]},l.id)})})]})]})}function Qe({customerId:N,customerName:g}){const[a,f]=u.useState(365),o=R({queryKey:["customers",N,"sales-history"],queryFn:()=>ae(N,0,100),staleTime:3e4}),m=u.useMemo(()=>{const r=[];return o.data?.content&&o.data.content.forEach(i=>{const s=new Date(i.saleDate);Math.floor((new Date().getTime()-s.getTime())/(1e3*60*60*24))<=a&&r.push({id:`sale-${i.saleId}`,type:"sale",date:s,title:`Venta ${i.docType||""} ${i.docNumber||""}`,description:`${i.itemCount||0} productos â€¢ Total: $${(i.total||0).toLocaleString("es-CL")}`,amount:i.total,icon:"ðŸ’°",color:"bg-green-950 border-green-800 text-green-400"})}),r.sort((i,s)=>s.date.getTime()-i.date.getTime())},[o.data,a]),c=u.useMemo(()=>{const r={};return m.forEach(i=>{const s=i.date.toLocaleDateString("es-CL",{year:"numeric",month:"long"});r[s]||(r[s]=[]),r[s].push(i)}),r},[m]),x=r=>{const s=new Date().getTime()-r.getTime(),d=Math.floor(s/(1e3*60*60*24));return d===0?"Hoy":d===1?"Ayer":d<7?`Hace ${d} dÃ­as`:d<30?`Hace ${Math.floor(d/7)} semanas`:d<365?`Hace ${Math.floor(d/30)} meses`:`Hace ${Math.floor(d/365)} aÃ±os`};return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl p-5",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs("h3",{className:"text-xl font-semibold text-neutral-100",children:["ðŸ“… Timeline de Actividad - ",g]}),e.jsxs("select",{className:"input bg-neutral-800 border-neutral-700 text-neutral-100 text-sm",value:a,onChange:r=>f(parseInt(r.target.value)),children:[e.jsx("option",{value:30,children:"Ãšltimos 30 dÃ­as"}),e.jsx("option",{value:90,children:"Ãšltimos 3 meses"}),e.jsx("option",{value:180,children:"Ãšltimos 6 meses"}),e.jsx("option",{value:365,children:"Ãšltimo aÃ±o"}),e.jsx("option",{value:730,children:"Ãšltimos 2 aÃ±os"}),e.jsx("option",{value:9999,children:"Todo el historial"})]})]}),o.isLoading&&e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-8 text-center",children:e.jsx("p",{className:"text-neutral-400",children:"Cargando actividad..."})}),o.isError&&e.jsx("div",{className:"bg-red-950 border border-red-800 rounded-lg p-4",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar el historial de actividad"})}),o.data&&m.length===0&&e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-8 text-center",children:e.jsx("p",{className:"text-neutral-400",children:"No hay actividad en el perÃ­odo seleccionado"})}),o.data&&m.length>0&&e.jsx("div",{className:"space-y-6 max-h-[600px] overflow-y-auto pr-2",children:Object.entries(c).map(([r,i])=>e.jsxs("div",{children:[e.jsx("div",{className:"sticky top-0 bg-neutral-900 border-b border-neutral-700 pb-2 mb-4 z-10",children:e.jsx("h4",{className:"text-sm font-semibold text-neutral-300 uppercase tracking-wide",children:r})}),e.jsx("div",{className:"space-y-3 relative before:absolute before:left-[19px] before:top-2 before:bottom-2 before:w-[2px] before:bg-neutral-700",children:i.map(s=>e.jsxs("div",{className:"relative pl-12",children:[e.jsx("div",{className:`absolute left-0 top-1 w-10 h-10 rounded-full border-2 flex items-center justify-center text-lg ${s.color}`,children:s.icon}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4 hover:bg-neutral-750 transition-colors",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-semibold text-neutral-100",children:s.title}),e.jsx("p",{className:"text-sm text-neutral-400",children:s.description})]}),s.amount&&e.jsxs("span",{className:"text-lg font-bold text-green-400",children:["$",s.amount.toLocaleString("es-CL")]})]}),e.jsxs("div",{className:"flex gap-3 text-xs text-neutral-500",children:[e.jsxs("span",{children:["ðŸ“† ",s.date.toLocaleDateString("es-CL")]}),e.jsxs("span",{children:["â°"," ",s.date.toLocaleTimeString("es-CL",{hour:"2-digit",minute:"2-digit"})]}),e.jsx("span",{className:"text-neutral-400",children:x(s.date)})]})]})]},s.id))})]},r))}),o.data&&m.length>0&&e.jsx("div",{className:"mt-4 pt-4 border-t border-neutral-700",children:e.jsxs("div",{className:"grid grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-2xl font-bold text-neutral-100",children:m.length}),e.jsx("p",{className:"text-xs text-neutral-400",children:"Eventos totales"})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-2xl font-bold text-green-400",children:m.filter(r=>r.type==="sale").length}),e.jsx("p",{className:"text-xs text-neutral-400",children:"Ventas registradas"})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:[e.jsxs("p",{className:"text-2xl font-bold text-blue-400",children:["$",m.filter(r=>r.amount).reduce((r,i)=>r+(i.amount||0),0).toLocaleString("es-CL")]}),e.jsx("p",{className:"text-xs text-neutral-400",children:"Total del perÃ­odo"})]})]})})]})}function Ge({customerId:N,customerName:g}){const a=R({queryKey:["customers",N,"sales-history-analysis"],queryFn:()=>ae(N,0,500),staleTime:6e4}),f=u.useMemo(()=>{if(!a.data?.content)return[];const c={};return a.data.content.forEach(x=>{const r=new Date(x.saleDate),i=`${r.getFullYear()}-${String(r.getMonth()+1).padStart(2,"0")}`,s=r.toLocaleDateString("es-CL",{year:"numeric",month:"short"});c[i]||(c[i]={month:s,sales:0,revenue:0,items:0}),c[i].sales+=1,c[i].revenue+=x.total||0,c[i].items+=x.itemCount||0}),Object.values(c).sort((x,r)=>x.month.localeCompare(r.month)).slice(-12)},[a.data]),o=u.useMemo(()=>{if(!a.data?.content)return[];const c={};return a.data.content.forEach(x=>{const r=x.docType||"Sin tipo";c[r]||(c[r]={type:r,count:0,total:0}),c[r].count+=1,c[r].total+=x.total||0}),Object.values(c).sort((x,r)=>r.total-x.total)},[a.data]),m=u.useMemo(()=>{if(!a.data?.content||a.data.content.length===0)return{avgSale:0,avgItems:0,totalRevenue:0,totalSales:0};const c=a.data.content.reduce((i,s)=>i+(s.total||0),0),x=a.data.content.length,r=a.data.content.reduce((i,s)=>i+(s.itemCount||0),0);return{avgSale:c/x,avgItems:r/x,totalRevenue:c,totalSales:x}},[a.data]);return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl p-5",children:[e.jsxs("h3",{className:"text-xl font-semibold text-neutral-100 mb-4",children:["ðŸ“ˆ AnÃ¡lisis Temporal - ",g]}),a.isLoading&&e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-8 text-center",children:e.jsx("p",{className:"text-neutral-400",children:"Cargando anÃ¡lisis..."})}),a.isError&&e.jsx("div",{className:"bg-red-950 border border-red-800 rounded-lg p-4",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar el anÃ¡lisis"})}),a.data&&a.data.content.length===0&&e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-8 text-center",children:e.jsx("p",{className:"text-neutral-400",children:"No hay datos suficientes para generar anÃ¡lisis"})}),a.data&&a.data.content.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Total Ventas"}),e.jsx("p",{className:"text-2xl font-bold text-neutral-100",children:m.totalSales})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Ingresos Totales"}),e.jsxs("p",{className:"text-2xl font-bold text-green-400",children:["$",m.totalRevenue.toLocaleString("es-CL")]})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Ticket Promedio"}),e.jsxs("p",{className:"text-2xl font-bold text-blue-400",children:["$",Math.round(m.avgSale).toLocaleString("es-CL")]})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("p",{className:"text-xs text-neutral-400 mb-1",children:"Productos/Venta"}),e.jsx("p",{className:"text-2xl font-bold text-purple-400",children:m.avgItems.toFixed(1)})]})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4 mb-6",children:[e.jsx("h4",{className:"text-neutral-100 font-semibold mb-4",children:"Tendencia de Ventas (Ãºltimos 12 meses)"}),e.jsx(ce,{width:"100%",height:300,children:e.jsxs(Pe,{data:f,children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"colorRevenue",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#3b82f6",stopOpacity:.3}),e.jsx("stop",{offset:"95%",stopColor:"#3b82f6",stopOpacity:0})]})}),e.jsx(de,{strokeDasharray:"3 3",stroke:"#404040"}),e.jsx(ue,{dataKey:"month",stroke:"#a3a3a3",style:{fontSize:"12px"}}),e.jsx(me,{stroke:"#a3a3a3",style:{fontSize:"12px"}}),e.jsx(xe,{contentStyle:{backgroundColor:"#262626",border:"1px solid #404040",borderRadius:"8px",color:"#e5e5e5"},formatter:c=>`$${c.toLocaleString("es-CL")}`}),e.jsx(he,{wrapperStyle:{color:"#e5e5e5"}}),e.jsx(Re,{type:"monotone",dataKey:"revenue",name:"Ingresos",stroke:"#3b82f6",strokeWidth:2,fill:"url(#colorRevenue)"})]})})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("h4",{className:"text-neutral-100 font-semibold mb-4",children:"Ventas por Tipo de Documento"}),e.jsx(ce,{width:"100%",height:300,children:e.jsxs(Me,{data:o,children:[e.jsx(de,{strokeDasharray:"3 3",stroke:"#404040"}),e.jsx(ue,{dataKey:"type",stroke:"#a3a3a3",style:{fontSize:"12px"}}),e.jsx(me,{stroke:"#a3a3a3",style:{fontSize:"12px"}}),e.jsx(xe,{contentStyle:{backgroundColor:"#262626",border:"1px solid #404040",borderRadius:"8px",color:"#e5e5e5"},formatter:(c,x)=>x==="total"?`$${c.toLocaleString("es-CL")}`:c}),e.jsx(he,{wrapperStyle:{color:"#e5e5e5"}}),e.jsx(ge,{dataKey:"count",name:"Cantidad",fill:"#10b981"}),e.jsx(ge,{dataKey:"total",name:"Total ($)",fill:"#3b82f6"})]})})]})]})]})}function et(){const N=u.useRef(null),[g,a]=u.useState(null),[f,o]=u.useState(!1),[m,c]=u.useState(!1),[x,r]=u.useState(null),[i,s]=u.useState(null),[d,n]=u.useState(!1),[l,y]=u.useState(!1),[D,b]=u.useState(!1),S=R({queryKey:["customers","segments"],queryFn:Ce,staleTime:6e4}),k=S.data??[],B=k.reduce((h,w)=>h+w.total,0),C=u.useMemo(()=>g?k.find(h=>h.code===g)??{name:g===oe?"Sin segmentar":g,segment:g===oe?"Sin segmentar":g,code:g,total:0,color:null}:null,[g,k]),M=h=>{a(w=>w===h.code?null:h.code)},z=()=>a(null),q=R({queryKey:["customers","all"],queryFn:async()=>(await se({page:0,size:1e3})).content||[],enabled:d,staleTime:6e4}),X=R({queryKey:["customers","all-stats"],queryFn:async()=>{const h=q.data||[],w=h.map(j=>ee(j.id).catch(()=>null)),$=await Promise.all(w);return h.reduce((j,A,_)=>{const G=$[_];return G&&(j[A.id]=G),j},{})},enabled:d&&!!q.data,staleTime:6e4}),F=h=>{if(!h)return{status:"inactive",label:"Sin ventas",color:"bg-neutral-700 text-neutral-400 border-neutral-600",icon:"âšª"};const w=Math.floor((new Date().getTime()-new Date(h).getTime())/(1e3*60*60*24));return w<=30?{status:"healthy",label:"Saludable",color:"bg-green-950 text-green-400 border-green-800",icon:"ðŸŸ¢"}:w<=90?{status:"at-risk",label:"En riesgo",color:"bg-yellow-950 text-yellow-400 border-yellow-800",icon:"ðŸŸ¡"}:{status:"inactive",label:"Inactivo",color:"bg-red-950 text-red-400 border-red-800",icon:"ðŸ”´"}},Q=()=>{r(null),o(!0)},V=h=>{r(h),o(!0)},W=()=>{o(!1),r(null)},L=()=>{const h=N.current?.getFilters(),w=new URLSearchParams;h?.query&&w.append("query",h.query),h?.segment&&w.append("segment",h.segment),h?.active!==void 0&&h.active!==null&&w.append("active",String(h.active));const $=`/api/v1/customers/export${w.toString()?`?${w.toString()}`:""}`,j=document.createElement("a");j.href=$,j.download="customers.csv",document.body.appendChild(j),j.click(),document.body.removeChild(j)};return e.jsxs("div",{className:"page-section bg-neutral-950",children:[e.jsx(Se,{title:"Clientes",description:"Administra fichas, contactos y geolocalizaciÃ³n de clientes.",actions:e.jsxs(e.Fragment,{children:[e.jsxs("button",{className:`btn ${d?"btn-secondary":"btn-ghost"}`,onClick:()=>n(!d),children:["ðŸ—ºï¸ ",d?"Ocultar":"Mostrar"," Mapa"]}),e.jsx("button",{className:"btn btn-secondary",onClick:()=>c(!0),children:"ðŸ“¤ Importar CSV"}),e.jsx("button",{className:"btn btn-secondary",onClick:L,children:"ðŸ“¥ Exportar CSV"}),e.jsx("button",{className:"btn",onClick:Q,children:"+ Nuevo cliente"})]})}),e.jsx(Ke,{open:f,onClose:W,editingCustomer:x}),e.jsx(Ve,{open:m,onClose:()=>c(!1)}),e.jsx(Oe,{}),d&&e.jsx(ze,{customers:q.data||[],customerStats:X.data||{},onCustomerSelect:h=>{s(h.id),r(h),y(!0),b(!0)},selectedCustomerId:i,getHealthStatus:F}),l&&i&&x&&e.jsx(Qe,{customerId:i,customerName:x.name}),D&&i&&x&&e.jsx(Ge,{customerId:i,customerName:x.name}),e.jsxs("section",{className:"responsive-grid",children:[e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:e.jsx(be,{ref:N,segmentFilter:g,segmentLabel:C?.name||C?.segment,onClearSegment:g?z:void 0,onOpenCreateDialog:Q,onOpenEditDialog:h=>{V(h),s(h.id),y(!0),b(!0)}})}),e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100",children:"SegmentaciÃ³n"}),S.isLoading&&e.jsx("p",{className:"text-neutral-400",children:"Loading..."}),S.isError&&e.jsx("p",{className:"error text-red-400",children:S.error?.message??"No se pudieron cargar los segmentos"}),!S.isLoading&&!S.isError&&e.jsxs(e.Fragment,{children:[e.jsxs("ul",{className:"segment-list",children:[k.map(h=>{const w=h.code===g,$=h.name||h.segment;return e.jsx("li",{children:e.jsxs("button",{type:"button",className:`segment-chip${w?" active":""} bg-neutral-800 hover:bg-neutral-700 border border-neutral-700`,onClick:()=>M(h),style:{borderLeft:h.color?`4px solid ${h.color}`:void 0},children:[e.jsxs("div",{children:[e.jsx("strong",{className:"text-neutral-100",children:$}),e.jsxs("p",{className:"muted small text-neutral-400",children:[h.total," clientes"]})]}),e.jsx("span",{className:"stat-trend text-neutral-300",children:B?`${Math.round(h.total/B*100)}%`:"-"})]})},`${h.code}-${$}`)}),k.length===0&&e.jsx("li",{className:"muted text-neutral-400",children:"Sin segmentos registrados"})]}),C&&e.jsx("button",{className:"btn ghost",type:"button",onClick:z,children:"Limpiar filtro"})]})]})]})]})}export{et as default};
