import{c as U,j as e,I as Ke,J as Oe,K as je,L as he,u as Z,M as $e,N as Te,O as Ve,P as ze,p as Ge,h as ne,Q as _e,R as Be,S as He,T as We,k as Ye,U as Ze,V as Je,W as Xe,X as es,B as pe,Y as ss,Z as ts,_ as as,$ as ns,a0 as is}from"./index-OfXnknKF.js";import{r as d}from"./react-DFcFNn96.js";import{u as I}from"./useQuery-7A7SEbdC.js";import{P as rs}from"./PageHeader-DR0dkBli.js";import{M as H}from"./Modal-BCEKQ7aJ.js";const te={sku:"",name:"",description:"",category:"",barcode:"",imageUrl:null,imageFile:null};function cs({open:i,product:n,onClose:v,onSaved:o}){const[l,p]=d.useState(te),[a,m]=d.useState(null),[g,c]=d.useState(null),h=d.useRef(null),x=d.useRef(null);d.useEffect(()=>()=>{x.current&&x.current.startsWith("blob:")&&URL.revokeObjectURL(x.current)},[]),d.useEffect(()=>{if(!i){p(te),c(null),y(null);return}n?(p({sku:n.sku??"",name:n.name??"",description:n.description??"",category:n.category??"",barcode:n.barcode??"",imageUrl:n.imageUrl??null,imageFile:null}),c(null),y(n.imageUrl??null)):(p(te),c(null),y(null))},[i,n]);const j=U({mutationFn:r=>n?Ke(n.id,r):Oe(r),onSuccess:r=>{o?.(r),v()}});d.useEffect(()=>{i||j.reset()},[i,j]);const b=r=>{const s=r.target.files?.[0];if(!s)return;if(s.size>512*1024){c("La imagen debe pesar 500 KB o menos"),r.target.value="";return}c(null),p(C=>({...C,imageFile:s}));const N=URL.createObjectURL(s);S(N)},P=()=>{if(c(null),l.imageFile){const r=l.imageUrl??null;p(s=>({...s,imageFile:null})),S(r)}else p(r=>({...r,imageUrl:null})),S(null);h.current&&(h.current.value="")},y=r=>{S(r)},S=r=>{x.current&&x.current.startsWith("blob:")&&URL.revokeObjectURL(x.current),x.current=r,m(r)},k=r=>{r.preventDefault();const s=l.sku.trim(),N=l.name.trim();if(!s){window.alert("El SKU es obligatorio");return}if(!N){window.alert("El nombre es obligatorio");return}const C={sku:s,name:N,description:l.description.trim()?l.description.trim():void 0,category:l.category.trim()?l.category.trim():void 0,barcode:l.barcode.trim()?l.barcode.trim():void 0};l.imageFile?(C.imageFile=l.imageFile,C.imageUrl=null):l.imageUrl===null?C.imageUrl=null:typeof l.imageUrl=="string"&&l.imageUrl.trim().length>0&&(C.imageUrl=l.imageUrl.trim()),j.mutate(C)},Q=n?"Editar producto":"Nuevo producto",E=!!a;return e.jsx(H,{open:i,title:Q,onClose:()=>!j.isPending&&v(),children:e.jsxs("form",{className:"form-grid",onSubmit:k,children:[e.jsxs("label",{children:[e.jsx("span",{children:"SKU *"}),e.jsx("input",{className:"input",value:l.sku,onChange:r=>p(s=>({...s,sku:r.target.value})),placeholder:"SKU-001",disabled:j.isPending,"data-autofocus":!0})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",value:l.name,onChange:r=>p(s=>({...s,name:r.target.value})),placeholder:"Producto demo",disabled:j.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Categoria"}),e.jsx("input",{className:"input",value:l.category,onChange:r=>p(s=>({...s,category:r.target.value})),placeholder:"Bebidas",disabled:j.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Codigo de barras"}),e.jsx("input",{className:"input",value:l.barcode,onChange:r=>p(s=>({...s,barcode:r.target.value})),placeholder:"7890000000",disabled:j.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Descripcion"}),e.jsx("textarea",{className:"input",value:l.description,onChange:r=>p(s=>({...s,description:r.target.value})),placeholder:"Notas internas",rows:3,disabled:j.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Imagen"}),E?e.jsx("div",{className:"image-preview",children:e.jsx("img",{src:a??void 0,alt:"Vista previa del producto"})}):e.jsx("p",{className:"muted small",children:"No has seleccionado una imagen"}),e.jsx("input",{ref:h,className:"input",type:"file",accept:"image/png,image/jpeg,image/webp,image/*",onChange:b,disabled:j.isPending}),e.jsx("p",{className:"muted small",children:"Formatos aceptados: PNG, JPG o WebP. Tamao mximo 500 KB."}),(l.imageFile||l.imageUrl)&&e.jsx("div",{className:"inline-actions",children:e.jsx("button",{className:"btn ghost",type:"button",onClick:P,disabled:j.isPending,children:"Quitar imagen"})}),g&&e.jsx("p",{className:"error",children:g})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:j.isPending,children:j.isPending?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:v,disabled:j.isPending,children:"Cancelar"})]}),j.isError&&e.jsx("p",{className:"error",children:ls(j.error)})]})})}function ls(i){if(je.isAxiosError(i)){const n=i.response?.data;if(typeof n=="string"&&n.trim().length>0)return n;if(n&&typeof n=="object"){if(typeof n.detail=="string"&&n.detail.trim().length>0)return n.detail;if(typeof n.message=="string"&&n.message.trim().length>0)return n.message;if(typeof n.error=="string"&&n.error.trim().length>0)return n.error}}return i instanceof Error&&i.message?i.message:"No se pudo guardar"}function os({open:i,product:n,pendingValue:v,submitting:o=!1,error:l,onClose:p,onSubmit:a}){const[m,g]=d.useState("0"),[c,h]=d.useState(null),x=d.useMemo(()=>{if(typeof v=="number")return v;const S=Number(n?.criticalStock??0);return Number.isFinite(S)&&S>=0?S:0},[v,n?.criticalStock]);d.useEffect(()=>{if(!i||!n){g("0"),h(null);return}g(String(x)),h(null)},[i,n?.id,x]);const j=S=>{S.preventDefault();const k=Number(m);if(!Number.isFinite(k)||k<0){h("Ingresa un stock válido (mayor o igual a 0)");return}h(null),a(k)},b=()=>{o||p()},P=n?`Stock crítico - ${n.name}`:"Stock crítico",y=!!c||!!l;return e.jsx(H,{open:i,title:P,onClose:b,children:e.jsxs("form",{className:"form-grid",onSubmit:j,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Stock crítico"}),e.jsx("input",{className:`input${y?" input-error":""}`,type:"number",min:"0",step:"1",value:m,onChange:S=>g(S.target.value),disabled:o,"data-autofocus":!0,inputMode:"numeric"})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:o,children:o?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:b,disabled:o,children:"Cancelar"})]}),c&&e.jsx("p",{className:"error",children:c}),!c&&l&&e.jsx("p",{className:"error",children:l})]})})}function ds({open:i,product:n,onClose:v}){const[o,l]=d.useState(null),[p,a]=d.useState(!1),[m,g]=d.useState(null),c=()=>{a(!1),g(null),o&&o.startsWith("blob:")&&URL.revokeObjectURL(o),l(null)};d.useEffect(()=>{if(!i||!n){c();return}return a(!0),g(null),he(n.id).then(b=>{const P=URL.createObjectURL(b);l(P)}).catch(()=>{g("No se pudo cargar el código QR")}).finally(()=>{a(!1)}),c},[i,n?.id]);const h=()=>{if(!o||!n)return;const b=window.open("","_blank","noopener,noreferrer");if(!b)return;const P=n.sku?`QR ${n.sku}`:"QR";b.document.write(`<!doctype html><html><head><title>${P}</title></head>`),b.document.write('<body style="margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#fff;">'),b.document.write(`<img src="${o}" alt="${P}" style="max-width:90%;max-height:90%;" />`),b.document.write("</body></html>"),b.document.close(),b.focus(),b.print(),b.close()},x=async()=>{if(n)try{const b=await he(n.id,{download:!0}),P=URL.createObjectURL(b),y=document.createElement("a"),S=b.type==="image/svg+xml"?"svg":"png",k=(n.sku||n.id).replace(/[^a-zA-Z0-9-_]+/g,"-");y.href=P,y.download=`${k}-qr.${S}`,document.body.appendChild(y),y.click(),y.remove(),setTimeout(()=>URL.revokeObjectURL(P),500)}catch{g("No se pudo descargar el código QR")}},j=n&&`Código QR ${n.sku??""}`.trim()||"Código QR";return e.jsxs(H,{open:i,title:j,onClose:v,children:[p&&e.jsx("p",{className:"muted",children:"Cargando código QR..."}),m&&e.jsx("p",{className:"error",children:m}),!p&&!m&&o&&e.jsx("div",{className:"qr-preview",children:e.jsx("img",{src:o,alt:j})}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"button",onClick:h,disabled:!o||p,"data-autofocus":!0,children:"Imprimir"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:x,disabled:!n||p,children:"Descargar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:v,children:"Cerrar"})]})]})}function us({open:i,product:n,imageUrl:v,onClose:o}){const l=d.useRef(null),p=d.useMemo(()=>n?`Imagen - ${n.name}`:"Imagen del producto",[n]),a=v??"";return e.jsxs(H,{open:i,title:p,onClose:o,initialFocusRef:l,children:[e.jsx("div",{className:"image-modal__content",children:a?e.jsx("img",{src:a,alt:p,className:"image-modal__preview"}):e.jsx("p",{className:"muted",children:"Sin imagen disponible"})}),e.jsx("div",{className:"buttons",children:e.jsx("button",{ref:l,className:"btn",type:"button",onClick:o,children:"Cerrar"})})]})}const ge="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20160%20160'%20role='img'%20aria-label='Producto%20sin%20imagen'%3e%3cdefs%3e%3clinearGradient%20id='bg'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%231f2937'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3crect%20width='160'%20height='160'%20fill='url(%23bg)'%20rx='24'%20ry='24'%20/%3e%3cpath%20d='M48%2052c0-8.837%207.163-16%2016-16h32c8.837%200%2016%207.163%2016%2016v56c0%208.837-7.163%2016-16%2016H64c-8.837%200-16-7.163-16-16V52zm16-4a12%2012%200%200%200-12%2012v4.382l11.172-11.172a4%204%200%200%201%205.656%200L92%2094.343l10.828-10.828a4%204%200%200%201%205.656%200L112%2086V60a12%2012%200%200%200-12-12H64zm0%2096c-13.255%200-24-10.745-24-24V60c0-13.255%2010.745-24%2024-24h32c13.255%200%2024%2010.745%2024%2024v60c0%2013.255-10.745%2024-24%2024H64z'%20fill='%2360a5fa'%20fill-opacity='0.35'%20/%3e%3ccircle%20cx='64'%20cy='64'%20r='12'%20fill='%23ffffff'%20fill-opacity='0.08'%20/%3e%3c/svg%3e",ms=10;function hs(){const[i,n]=d.useState(""),[v,o]=d.useState(0),[l,p]=d.useState("active"),[a,m]=d.useState(null),[g,c]=d.useState({price:0}),[h,x]=d.useState(!1),[j,b]=d.useState(null),[P,y]=d.useState(!1),[S,k]=d.useState(null),[Q,E]=d.useState(!1),[r,s]=d.useState(null),[N,C]=d.useState({}),[J,R]=d.useState({}),[$,G]=d.useState(!1),[X,W]=d.useState(null),[be,ie]=d.useState(!1),[ve,re]=d.useState(null),[Ne,ce]=d.useState(null),M=Z(),K=t=>{if(typeof t=="number")return Number.isFinite(t)?t:null;if(typeof t=="string"&&t.trim().length>0){const u=Number(t);return Number.isFinite(u)?u:null}return null},le=t=>{const u=K(t);return u===null||u<=0?"Sin precio":`$${u.toFixed(2)}`},_=d.useMemo(()=>Object.keys(N).length>0,[N]);d.useEffect(()=>{const t=u=>{_&&(u.preventDefault(),u.returnValue="")};return window.addEventListener("beforeunload",t),()=>{window.removeEventListener("beforeunload",t)}},[_]);const ee=t=>{const u=K(t);return u===null||Number.isNaN(u)?0:u},se=t=>{if(!t)return 0;const u=N[t.id];return typeof u=="number"?u:ee(t.criticalStock??0)},oe=t=>t?ee(t.stock??0):0,fe=t=>{const u=oe(t),L=se(t);return L>0&&u<=L},ye=t=>Object.prototype.hasOwnProperty.call(N,t);d.useEffect(()=>{o(0)},[l]);const w=I({queryKey:["products",{q:i,page:v,status:l}],queryFn:()=>ne({q:i||void 0,page:v,size:ms,status:l}),placeholderData:Ge}),Se=I({queryKey:["product-prices",a?.id],queryFn:()=>{if(!a)throw new Error("Producto no seleccionado");return _e(a.id,{size:5})},enabled:!!a}),F=I({queryKey:["product",a?.id,"stock"],queryFn:()=>{if(!a)throw new Error("Producto no seleccionado");return Be(a.id)},enabled:!!a}),B=U({mutationFn:async()=>{if(!a)throw new Error("Select a product first");return $e(a.id,g)},onSuccess:()=>{M.invalidateQueries({queryKey:["products"],exact:!1}),M.invalidateQueries({queryKey:["product-prices",a?.id]}),c({price:0})}}),T=U({mutationFn:t=>Te(t),onSuccess:(t,u)=>{M.invalidateQueries({queryKey:["products"],exact:!1}),M.removeQueries({queryKey:["product-prices",u],exact:!0}),a?.id===u&&(m(null),c({price:0}))}}),V=U({mutationFn:t=>{if(!a)throw new Error("Producto no seleccionado");return Ve(a.id,t)},onSuccess:t=>{M.invalidateQueries({queryKey:["products"],exact:!1}),m(t),c({price:K(t.currentPrice)??0})}}),Ce=()=>{b(null),x(!0)},Pe=()=>{a&&(b(a),x(!0))},ke=()=>{x(!1),b(null)},de=t=>{const u=t??a;u&&(k(u),y(!0))},Ee=()=>{y(!1),k(null)},ue=t=>{const u=t??a;u&&(s(u),E(!0))},we=()=>{E(!1),s(null)},Fe=t=>{if(!r)return;const u=r.id,L=ee(r.criticalStock??0);C(f=>{const A={...f};return t===L?delete A[u]:A[u]=t,A}),R(f=>{if(!f[u])return f;const{[u]:A,...O}=f;return O}),W(null),a?.id===u&&m({...a,criticalStock:t}),E(!1),s(null)},Le=async()=>{const t=Object.entries(N);if(t.length===0||$)return;G(!0),W(null);const u={...N},L=[];for(const[f,A]of t)try{const O=await ze(f,A);L.push(O),delete u[f],R(q=>{if(!q[f])return q;const{[f]:z,...D}=q;return D})}catch(O){const q=ps(O),z=w.data?.content?.find(D=>D.id===f)?.name??f;R(D=>({...D,[f]:q.fieldMessage??q.message})),C(u),W({type:"error",text:`${z}: ${q.message}`}),G(!1);return}if(C({}),W({type:"success",text:"Cambios guardados correctamente."}),G(!1),M.invalidateQueries({queryKey:["products"],exact:!1}),L.forEach(f=>{M.invalidateQueries({queryKey:["product",f.id,"stock"]})}),a){const f=L.find(A=>A.id===a.id);f&&(m(f),c({price:K(f.currentPrice)??0}))}},qe=t=>{M.invalidateQueries({queryKey:["products"],exact:!1}),m(t),c({price:K(t.currentPrice)??0}),S?.id===t.id&&k(t),C(u=>{if(!u[t.id])return u;const{[t.id]:L,...f}=u;return f}),R(u=>{if(!u[t.id])return u;const{[t.id]:L,...f}=u;return f}),M.invalidateQueries({queryKey:["product",t.id,"stock"]})},De=t=>{const u=typeof t.imageUrl=="string"&&t.imageUrl.trim().length>0?t.imageUrl:ge;re(t),ce(u),ie(!0)},Ie=()=>{ie(!1),re(null),ce(null)},Ue=()=>{!a||T.isPending||window.confirm(`Eliminar producto ${a.name}?`)&&T.mutate(a.id)},Qe=()=>{!a||V.isPending||V.mutate(!a.active)},me=w.data?.content??[],Y=w.data?.totalPages??1;d.useEffect(()=>{if(!a)return;const t=w.data?.content?.find(u=>u.id===a.id);if(!t){m(null),c({price:0});return}t!==a&&(m(t),c({price:K(t.currentPrice)??0}))},[w.data,a]);const Me=d.useMemo(()=>a?le(a.currentPrice):"",[a]),Ae=d.useMemo(()=>a?se(a):0,[a,N]),Re=t=>{if(t.preventDefault(),!!a){if(!g.price||g.price<=0){alert("Ingresa un precio valido");return}B.mutate()}};return e.jsxs("div",{className:"card products-card",children:[e.jsxs("div",{className:"products-banner",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Productos"}),e.jsx("p",{className:"muted small",children:_?"Tienes cambios sin guardar en los stocks críticos.":"Administra tu catálogo, imágenes y alertas de stock."})]}),e.jsx("button",{className:"btn primary",type:"button",onClick:Le,disabled:!_||$,children:$?"Guardando...":"Guardar cambios"})]}),X&&e.jsx("div",{className:`status-message ${X.type}`,role:"status",children:X.text}),e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"inline-actions",children:[e.jsx("input",{className:"input",placeholder:"Buscar por nombre, SKU o codigo",value:i,onChange:t=>{n(t.target.value),o(0)}}),e.jsxs("select",{className:"input",value:l,onChange:t=>p(t.target.value),children:[e.jsx("option",{value:"active",children:"Activos"}),e.jsx("option",{value:"inactive",children:"Inactivos"}),e.jsx("option",{value:"all",children:"Todos"})]}),e.jsx("button",{className:"btn",onClick:()=>M.invalidateQueries({queryKey:["products"]}),disabled:w.isFetching,children:w.isFetching?"Cargando":"Refrescar"})]})}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn",type:"button",onClick:Ce,children:"+ Producto"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Pe,disabled:!a,children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>de(a),disabled:!a,children:"Ver QR"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Qe,disabled:!a||V.isPending,children:V.isPending?"Actualizando...":a?.active?"Desactivar":"Activar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Ue,disabled:!a||T.isPending,children:T.isPending?"Eliminando...":"Eliminar"})]}),_&&e.jsx("p",{className:"muted small notice-dirty",children:"Recuerda guardar para aplicar los cambios pendientes."}),T.isError&&e.jsx("p",{className:"error",children:T.error?.message??"No se pudo eliminar el producto"}),V.isError&&e.jsx("p",{className:"error",children:V.error?.message??"No se pudo actualizar el estado"}),w.isLoading&&e.jsx("p",{children:"Loading..."}),w.isError&&e.jsx("p",{className:"error",children:w.error.message}),!w.isLoading&&!w.isError&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"products-grid",children:me.map(t=>{N[t.id];const u=oe(t),L=se(t),f=J[t.id],A=typeof t.imageUrl=="string"&&t.imageUrl.trim().length>0?t.imageUrl:ge,O=a?.id===t.id,q=fe(t),z=ye(t.id);return e.jsxs("div",{className:`product-card${O?" product-card--selected":""}${q?" product-card--critical":""}${z?" product-card--pending":""}`,onClick:()=>{m(t),c({price:K(t.currentPrice)??0})},children:[e.jsxs("div",{className:"product-card-image",onClick:D=>{D.stopPropagation(),De(t)},children:[e.jsx("img",{src:A,alt:t.name}),!t.active&&e.jsx("div",{className:"product-badge product-badge--inactive",children:"Inactivo"}),q&&t.active&&e.jsx("div",{className:"product-badge product-badge--critical",children:"⚠️ Stock Bajo"})]}),e.jsxs("div",{className:"product-card-body",children:[e.jsxs("div",{className:"product-card-header",children:[e.jsx("h4",{className:"product-card-title",children:t.name}),e.jsx("span",{className:"product-card-sku mono small muted",children:t.sku})]}),e.jsxs("div",{className:"product-card-stats",children:[e.jsxs("div",{className:"product-stat",children:[e.jsx("span",{className:"product-stat-label muted small",children:"Precio"}),e.jsx("span",{className:"product-stat-value mono",children:le(t.currentPrice)})]}),e.jsxs("div",{className:"product-stat",children:[e.jsx("span",{className:"product-stat-label muted small",children:"Stock"}),e.jsxs("span",{className:`product-stat-value ${q?"text-critical":""}`,children:[u,q&&e.jsx("span",{className:"stock-indicator",children:"⚠️"})]})]}),e.jsxs("div",{className:"product-stat",children:[e.jsx("span",{className:"product-stat-label muted small",children:"Crítico"}),e.jsxs("span",{className:`product-stat-value${z?" text-pending":""}`,children:[L,z&&e.jsx("span",{className:"pending-indicator",children:"●"})]})]})]}),f&&e.jsx("p",{className:"error small",style:{marginTop:"0.5rem"},children:f}),e.jsxs("div",{className:"product-card-actions",children:[e.jsx("button",{className:"btn ghost small",type:"button",onClick:D=>{D.stopPropagation(),ue(t)},children:"Stock crítico"}),e.jsx("button",{className:"btn ghost small",type:"button",onClick:D=>{D.stopPropagation(),de(t)},children:"QR"})]})]})]},t.id)})}),me.length===0&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"No se encontraron productos"})}),Y>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:v===0,onClick:()=>o(t=>Math.max(0,t-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Pagina ",v+1," de ",Y]}),e.jsx("button",{className:"btn",disabled:v>=Y-1,onClick:()=>o(t=>Math.min(Y-1,t+1)),children:"Siguiente"})]}),a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Precio"}),e.jsxs("p",{className:"muted",children:["Actual: ",Me]}),e.jsxs("p",{className:"muted",children:["Estado: ",a.active?"Activo":"Inactivo"]}),e.jsxs("form",{className:"form-inline",onSubmit:Re,children:[e.jsx("input",{className:"input",type:"number",step:"0.01",min:"0",placeholder:"Nuevo precio",value:g.price,onChange:t=>c(u=>({...u,price:Number(t.target.value)}))}),e.jsx("button",{className:"btn",type:"submit",disabled:B.isPending,children:B.isPending?"Guardando...":"Actualizar"})]}),B.isError&&e.jsx("p",{className:"error",children:B.error?.message}),e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Precio"}),e.jsx("th",{children:"Desde"})]})}),e.jsx("tbody",{children:(Se.data?.content??[]).map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono",children:`$${t.price.toFixed(2)}`}),e.jsx("td",{className:"mono small",children:new Date(t.validFrom).toLocaleString()})]},t.id))})]})})]}),e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Inventario"}),e.jsxs("p",{className:"muted",children:["Stock total: ",F.isLoading?"Cargando...":F.data?F.data.total:"Sin datos"]}),e.jsxs("p",{className:"muted",children:["Stock crítico configurado: ",Ae]}),e.jsx("button",{className:"btn ghost",type:"button",onClick:ue,children:"Definir stock crítico"}),F.isError&&e.jsx("p",{className:"error",children:F.error?.message??"No se pudo obtener el stock"}),F.isLoading&&e.jsx("p",{className:"muted",children:"Cargando lotes..."}),F.data&&F.data.lots.length>0&&e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Lote"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Ubicación"}),e.jsx("th",{children:"Vence"})]})}),e.jsx("tbody",{children:F.data.lots.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:t.lotId}),e.jsx("td",{className:"mono",children:t.quantity}),e.jsx("td",{children:t.location??"—"}),e.jsx("td",{className:"mono small",children:t.expiresAt?new Date(t.expiresAt).toLocaleDateString():"—"})]},t.lotId))})]})}),F.data&&F.data.lots.length===0&&!F.isLoading&&e.jsx("p",{className:"muted small",children:"No hay lotes registrados para este producto."})]})]})]}),e.jsx(cs,{open:h,product:j,onClose:ke,onSaved:qe}),e.jsx(ds,{open:P,product:S,onClose:Ee}),e.jsx(os,{open:Q,product:r,pendingValue:r?N[r.id]:void 0,error:r?J[r.id]:void 0,submitting:$,onClose:we,onSubmit:Fe}),e.jsx(us,{open:be,product:ve,imageUrl:Ne,onClose:Ie})]})}function ps(i){if(je.isAxiosError(i)){const n=i.response?.data;if(typeof n=="string"&&n.trim().length>0)return{message:n};if(n&&typeof n=="object"){const o=n.errors??{};let l;const p=o.criticalStock;return Array.isArray(p)&&p.length>0?l=p[0]:typeof p=="string"&&p.trim().length>0&&(l=p),{message:[n.detail,n.message,n.error,n.title].find(m=>typeof m=="string"&&m.trim().length>0)?.trim()??i.response?.statusText??"No se pudo guardar",fieldMessage:l}}const v=i.response?.statusText;if(v)return{message:v}}return i instanceof Error&&i.message?{message:i.message}:{message:"No se pudo guardar"}}function gs(){const[i,n]=d.useState(null),[v,o]=d.useState(!1),[l,p]=d.useState(null),[a,m]=d.useState({code:"",name:"",description:"",type:"WAREHOUSE",parentLocationId:void 0}),g=Z(),c=I({queryKey:["locations"],queryFn:()=>Ye()}),h=I({queryKey:["location-stock-summary"],queryFn:Ze}),x=U({mutationFn:s=>He(s),onSuccess:()=>{g.invalidateQueries({queryKey:["locations"]}),g.invalidateQueries({queryKey:["location-stock-summary"]}),o(!1),b()}}),j=U({mutationFn:s=>We(s),onSuccess:()=>{g.invalidateQueries({queryKey:["locations"]}),g.invalidateQueries({queryKey:["location-stock-summary"]}),n(null)}}),b=()=>{m({code:"",name:"",description:"",type:"WAREHOUSE",parentLocationId:void 0}),p(null)},P=s=>{s?(p(s),m({code:s.code,name:s.name,description:s.description,type:s.type,parentLocationId:s.parentLocationId})):b(),o(!0)},y=s=>{if(s.preventDefault(),!a.code||!a.name){alert("Código y nombre son requeridos");return}x.mutate(a)},S=()=>{i&&window.confirm(`¿Eliminar ubicación ${i.name}?`)&&j.mutate(i.id)},k=c.data??[],Q=h.data??[],E=k.reduce((s,N)=>(s[N.type]||(s[N.type]=[]),s[N.type].push(N),s),{}),r=i?Q.find(s=>s.locationId===i.id):null;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Ubicaciones"}),e.jsx("p",{className:"muted small",children:"Gestiona las ubicaciones físicas del inventario"})]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn primary",type:"button",onClick:()=>P(),children:"+ Nueva Ubicación"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>g.invalidateQueries({queryKey:["locations"]}),disabled:c.isFetching,children:c.isFetching?"Cargando...":"Refrescar"})]}),c.isLoading&&e.jsx("p",{children:"Cargando ubicaciones..."}),c.isError&&e.jsx("p",{className:"error",children:c.error.message}),!c.isLoading&&!c.isError&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"locations-grid",children:[e.jsx("div",{className:"locations-list",children:Object.entries(E).map(([s,N])=>e.jsxs("div",{className:"location-type-section",children:[e.jsx("h3",{className:"location-type-title",children:s}),e.jsx("div",{className:"location-items",children:N.map(C=>{const R=Q.find(G=>G.locationId===C.id)?.products.length??0,$=i?.id===C.id;return e.jsxs("div",{className:`location-item${$?" selected":""}`,onClick:()=>n(C),children:[e.jsxs("div",{className:"location-item-header",children:[e.jsx("span",{className:"location-code mono",children:C.code}),R>0&&e.jsxs("span",{className:"location-badge",children:[R," productos"]})]}),e.jsx("div",{className:"location-name",children:C.name}),C.description&&e.jsx("div",{className:"location-description muted small",children:C.description})]},C.id)})})]},s))}),e.jsx("div",{className:"location-details",children:i?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Detalles de Ubicación"}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Código:"}),e.jsx("span",{className:"mono",children:i.code})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Nombre:"}),e.jsx("span",{children:i.name})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Tipo:"}),e.jsx("span",{children:i.type})]}),i.description&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Descripción:"}),e.jsx("span",{children:i.description})]}),e.jsxs("div",{className:"inline-actions",style:{marginTop:"1rem"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>P(i),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:S,disabled:j.isPending,children:j.isPending?"Eliminando...":"Eliminar"})]})]}),e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Productos en esta Ubicación"}),h.isLoading&&e.jsx("p",{className:"muted",children:"Cargando stock..."}),r&&r.products.length>0?e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Lotes"})]})}),e.jsx("tbody",{children:r.products.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:s.productSku}),e.jsx("td",{children:s.productName}),e.jsx("td",{className:"mono",children:s.totalQuantity.toFixed(2)}),e.jsx("td",{className:"mono",children:s.lotCount})]},s.productId))})]})}):e.jsx("p",{className:"muted small",children:"No hay productos en esta ubicación"})]})]}):e.jsx("div",{className:"empty-state",children:e.jsx("p",{className:"muted",children:"Selecciona una ubicación para ver detalles"})})})]})}),v&&e.jsx("div",{className:"modal-overlay",onClick:()=>o(!1),children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:l?"Editar Ubicación":"Nueva Ubicación"}),e.jsx("button",{className:"btn-close",onClick:()=>o(!1),children:"×"})]}),e.jsxs("form",{onSubmit:y,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Código *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:a.code,onChange:s=>m({...a,code:s.target.value}),placeholder:"Ej: ALM-01"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:a.name,onChange:s=>m({...a,name:s.target.value}),placeholder:"Ej: Almacén Principal"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Tipo"}),e.jsxs("select",{className:"input",value:a.type,onChange:s=>m({...a,type:s.target.value}),children:[e.jsx("option",{value:"WAREHOUSE",children:"WAREHOUSE"}),e.jsx("option",{value:"SHELF",children:"SHELF"}),e.jsx("option",{value:"BIN",children:"BIN"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Ubicación Padre (opcional)"}),e.jsxs("select",{className:"input",value:a.parentLocationId??"",onChange:s=>m({...a,parentLocationId:s.target.value||void 0}),children:[e.jsx("option",{value:"",children:"-- Sin ubicación padre --"}),k.map(s=>e.jsxs("option",{value:s.id,children:[s.code," - ",s.name," (",s.type,")"]},s.id))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Descripción (opcional)"}),e.jsx("textarea",{className:"input",rows:3,value:a.description??"",onChange:s=>m({...a,description:s.target.value}),placeholder:"Descripción de la ubicación"})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>o(!1),disabled:x.isPending,children:"Cancelar"}),e.jsx("button",{className:"btn primary",type:"submit",disabled:x.isPending,children:x.isPending?"Guardando...":l?"Actualizar":"Crear"})]}),x.isError&&e.jsx("p",{className:"error",children:x.error?.message??"Error al guardar"})]})]})})]})}function xs(){const[i,n]=d.useState(null),[v,o]=d.useState(!1),[l,p]=d.useState(null),[a,m]=d.useState("active"),[g,c]=d.useState({code:"",name:"",description:"",active:!0}),h=Z(),x=I({queryKey:["services",{status:a}],queryFn:()=>a==="all"?pe():pe(a==="active")}),j=U({mutationFn:s=>Je(s),onSuccess:s=>{h.invalidateQueries({queryKey:["services"]}),o(!1),n(s),y()}}),b=U({mutationFn:({id:s,payload:N})=>Xe(s,N),onSuccess:()=>{h.invalidateQueries({queryKey:["services"]}),o(!1),y()}}),P=U({mutationFn:s=>es(s),onSuccess:()=>{h.invalidateQueries({queryKey:["services"]}),n(null)}}),y=()=>{c({code:"",name:"",description:"",active:!0}),p(null)},S=s=>{s?(p(s),c({code:s.code,name:s.name,description:s.description,active:s.active})):y(),o(!0)},k=s=>{if(s.preventDefault(),!g.code||!g.name){alert("Código y nombre son requeridos");return}l?b.mutate({id:l.id,payload:g}):j.mutate(g)},Q=()=>{i&&window.confirm(`¿Eliminar servicio ${i.name}?`)&&P.mutate(i.id)},E=x.data??[],r=s=>s?new Date(s).toLocaleDateString("es-CL",{year:"numeric",month:"short",day:"numeric"}):"Nunca";return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{children:[e.jsx("h2",{children:"Servicios"}),e.jsx("p",{className:"muted small",children:"Gestiona servicios que no requieren inventario"})]})}),e.jsxs("div",{className:"inline-actions",children:[e.jsxs("select",{className:"input",value:a,onChange:s=>m(s.target.value),children:[e.jsx("option",{value:"active",children:"Activos"}),e.jsx("option",{value:"inactive",children:"Inactivos"}),e.jsx("option",{value:"all",children:"Todos"})]}),e.jsx("button",{className:"btn primary",type:"button",onClick:()=>S(),children:"+ Nuevo Servicio"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>h.invalidateQueries({queryKey:["services"]}),disabled:x.isFetching,children:x.isFetching?"Cargando...":"Refrescar"})]}),x.isLoading&&e.jsx("p",{children:"Cargando servicios..."}),x.isError&&e.jsx("p",{className:"error",children:x.error.message}),!x.isLoading&&!x.isError&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Última Compra"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:E.map(s=>{const N=i?.id===s.id;return e.jsxs("tr",{className:N?"selected":"",onClick:()=>n(s),children:[e.jsx("td",{className:"mono",children:s.code}),e.jsx("td",{children:s.name}),e.jsx("td",{className:"mono small",children:r(s.lastPurchaseDate)}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.active?"badge-success":"badge-muted"}`,children:s.active?"Activo":"Inactivo"})}),e.jsx("td",{children:e.jsx("button",{className:"btn ghost small",type:"button",onClick:C=>{C.stopPropagation(),S(s)},children:"Editar"})})]},s.id)})})]})}),E.length===0&&e.jsx("div",{className:"empty-state",children:e.jsx("p",{className:"muted",children:"No hay servicios registrados"})}),i&&e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Detalles del Servicio"}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Código:"}),e.jsx("span",{className:"mono",children:i.code})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Nombre:"}),e.jsx("span",{children:i.name})]}),i.description&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Descripción:"}),e.jsx("span",{children:i.description})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Última compra:"}),e.jsx("span",{children:r(i.lastPurchaseDate)})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Estado:"}),e.jsx("span",{children:i.active?"Activo":"Inactivo"})]}),e.jsxs("div",{className:"inline-actions",style:{marginTop:"1rem"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>S(i),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Q,disabled:P.isPending,children:P.isPending?"Eliminando...":"Eliminar"})]})]})]}),v&&e.jsx("div",{className:"modal-overlay",onClick:()=>o(!1),children:e.jsxs("div",{className:"modal",onClick:s=>s.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:l?"Editar Servicio":"Nuevo Servicio"}),e.jsx("button",{className:"btn-close",onClick:()=>o(!1),children:"×"})]}),e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Código *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:g.code,onChange:s=>c({...g,code:s.target.value}),placeholder:"Ej: SRV-001"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:g.name,onChange:s=>c({...g,name:s.target.value}),placeholder:"Ej: Consultoría de TI"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Descripción (opcional)"}),e.jsx("textarea",{className:"input",rows:3,value:g.description??"",onChange:s=>c({...g,description:s.target.value}),placeholder:"Descripción del servicio"})]}),e.jsx("div",{className:"form-group",children:e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:g.active??!0,onChange:s=>c({...g,active:s.target.checked})}),"Activo"]})}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>o(!1),disabled:j.isPending||b.isPending,children:"Cancelar"}),e.jsx("button",{className:"btn primary",type:"submit",disabled:j.isPending||b.isPending,children:j.isPending||b.isPending?"Guardando...":l?"Actualizar":"Crear"})]}),(j.isError||b.isError)&&e.jsx("p",{className:"error",children:(j.error||b.error)?.message??"Error al guardar"})]})]})})]})}const ae={productId:"",direction:"increase",quantity:"0",unitCost:"0",reason:"",expDate:""};function js({open:i,onClose:n,onApplied:v}){const[o,l]=d.useState(ae);d.useEffect(()=>{i||l(ae)},[i]);const p=I({queryKey:["products",{dialog:"inventory-adjustment"}],queryFn:()=>ne({size:200,status:"all"}),enabled:i}),a=d.useMemo(()=>p.data?.content??[],[p.data]),m=U({mutationFn:()=>{if(!o.productId)throw new Error("Selecciona un producto");const c=Number(o.quantity);if(!Number.isFinite(c)||c<=0)throw new Error("La cantidad debe ser mayor a cero");const h=o.direction,x=Number(o.unitCost||0);if(h==="increase"&&(Number.isNaN(x)||x<0))throw new Error("El costo unitario debe ser positivo");const j={productId:o.productId,quantity:c,direction:h,reason:o.reason.trim()||"Ajuste manual",unitCost:h==="increase"?x:void 0,expDate:o.expDate||void 0};return ss(j)},onSuccess:()=>{v?.(),l(ae),n()}}),g=c=>{c.preventDefault(),!m.isPending&&m.mutate()};return e.jsx(H,{open:i,title:"Ajuste de stock",onClose:()=>{m.isPending||n()},children:e.jsxs("form",{className:"form-grid",onSubmit:g,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Producto *"}),e.jsxs("select",{className:"input",value:o.productId,onChange:c=>l(h=>({...h,productId:c.target.value})),disabled:m.isPending,required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un producto"}),a.map(c=>e.jsx("option",{value:c.id,children:c.name},c.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Tipo de ajuste"}),e.jsxs("select",{className:"input",value:o.direction,onChange:c=>l(h=>({...h,direction:c.target.value})),disabled:m.isPending,children:[e.jsx("option",{value:"increase",children:"Incremento"}),e.jsx("option",{value:"decrease",children:"Disminucion"})]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Cantidad *"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:o.quantity,onChange:c=>l(h=>({...h,quantity:c.target.value})),disabled:m.isPending,required:!0})]}),o.direction==="increase"&&e.jsxs("label",{children:[e.jsx("span",{children:"Costo unitario"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:o.unitCost,onChange:c=>l(h=>({...h,unitCost:c.target.value})),disabled:m.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de vencimiento"}),e.jsx("input",{className:"input",type:"date",value:o.expDate,onChange:c=>l(h=>({...h,expDate:c.target.value})),disabled:m.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Motivo"}),e.jsx("textarea",{className:"input",rows:3,value:o.reason,onChange:c=>l(h=>({...h,reason:c.target.value})),placeholder:"Regularizacion, inventario, merma, etc.",disabled:m.isPending})]}),m.isError&&e.jsx("p",{className:"error",children:m.error?.message??"No se pudo registrar el ajuste"}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:m.isPending,children:m.isPending?"Guardando...":"Registrar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:n,disabled:m.isPending,children:"Cancelar"})]})]})})}const xe=10;function bs(i){const n=Number(i);return Number.isFinite(n)?`$${n.toLocaleString("es-CL",{maximumFractionDigits:0})}`:"$0"}function Cs(){const i=Z(),[n,v]=d.useState(!1),[o,l]=d.useState(null),[p,a]=d.useState(""),m=I({queryKey:["products",{view:"inventory"}],queryFn:()=>ne({size:200,status:"all"})}),g=I({queryKey:["inventory","settings"],queryFn:as});d.useEffect(()=>{if(g.data){const r=Number(g.data.lowStockThreshold??0);if(Number.isFinite(r)&&r>0){o===null&&l(r),a(s=>s||String(r));return}}!g.isLoading&&o===null&&(l(xe),a(String(xe)))},[g.data,g.isLoading,o]);const c=I({queryKey:["inventory","summary"],queryFn:ns}),h=I({queryKey:["inventory","alerts",o],enabled:o!==null,queryFn:()=>is(o??void 0)}),x=U({mutationFn:r=>ts({lowStockThreshold:r}),onSuccess:r=>{const s=Number(r.lowStockThreshold??0);Number.isFinite(s)&&s>0&&(l(s),a(String(s))),i.invalidateQueries({queryKey:["inventory","summary"]}),i.invalidateQueries({queryKey:["inventory","alerts"]}),i.setQueryData(["inventory","settings"],r)}}),j=()=>{const r=Number(p);if(!Number.isFinite(r)||r<=0){window.alert("Ingresa un umbral mayor a cero");return}x.mutate(r)},b=()=>{i.invalidateQueries({queryKey:["inventory","summary"]}),i.invalidateQueries({queryKey:["inventory","alerts"]}),i.invalidateQueries({queryKey:["products"],exact:!1}),v(!1)},P=d.useMemo(()=>new Map((m.data?.content??[]).map(r=>[r.id,r])),[m.data]),y=c.data,S=bs(y?.totalValue??0),k=y?.activeProducts??0,Q=y?.lowStockAlerts??h.data?.length??0,E=y?.lowStockThreshold??o??Number(p||0);return e.jsxs("div",{className:"page-section",children:[e.jsx(rs,{title:"Inventario",description:"Visibiliza catalogo, lotes y alertas de stock para garantizar disponibilidad.",actions:e.jsx("button",{className:"btn",onClick:()=>v(!0),children:"+ Ajuste de stock"})}),e.jsxs("section",{className:"kpi-grid",children:[e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Valor inventario"}),e.jsx("p",{className:"stat-value",children:c.isLoading?"-":S}),e.jsx("span",{className:"stat-trend",children:"Costo total disponible"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Productos activos"}),e.jsx("p",{className:"stat-value",children:c.isLoading?"-":k}),e.jsx("span",{className:"stat-trend",children:"Inventario sincronizado"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Alertas stock"}),e.jsx("p",{className:"stat-value",children:h.isLoading?"-":Q}),e.jsxs("span",{className:"stat-trend",children:["Umbral ",E??"-"]})]})]}),e.jsxs("section",{className:"responsive-grid",children:[e.jsx("div",{className:"card",children:e.jsx(hs,{})}),e.jsx("div",{className:"card",children:e.jsx(gs,{})}),e.jsx("div",{className:"card",children:e.jsx(xs,{})}),e.jsxs("div",{className:"card table-card",children:[e.jsx("h3",{children:"Lotes con stock critico"}),e.jsxs("div",{className:"inline-actions",style:{marginBottom:"0.75rem"},children:[e.jsx("label",{className:"muted small",htmlFor:"low-stock-threshold",children:"Umbral"}),e.jsx("input",{id:"low-stock-threshold",className:"input",type:"number",step:"0.1",min:"0.1",value:p,onChange:r=>a(r.target.value),disabled:x.isPending}),e.jsx("button",{className:"btn",type:"button",onClick:j,disabled:x.isPending,children:x.isPending?"Guardando...":"Guardar"})]}),x.isError&&e.jsx("p",{className:"error",children:x.error?.message??"No se pudo actualizar el umbral"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Lote"}),e.jsx("th",{children:"Disponible"}),e.jsx("th",{children:"Expira"}),e.jsx("th",{children:"Creado"})]})}),e.jsxs("tbody",{children:[h.isLoading&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"muted",children:"Cargando alertas..."})}),h.isError&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"error",children:h.error?.message??"No se pudieron obtener alertas"})}),!h.isLoading&&!h.isError&&(h.data??[]).map(r=>{const s=P.get(r.productId),N=r.expDate?new Date(r.expDate).toLocaleDateString():"-";return e.jsxs("tr",{children:[e.jsx("td",{children:s?.name??r.productId}),e.jsx("td",{className:"mono",children:r.lotId}),e.jsx("td",{className:"mono",children:Number(r.qtyAvailable).toFixed(2)}),e.jsx("td",{className:"mono",children:N}),e.jsx("td",{className:"mono small",children:new Date(r.createdAt).toLocaleDateString()})]},r.lotId)}),!h.isLoading&&!h.isError&&(h.data??[]).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"muted",children:"Sin alertas"})})]})]})})]})]}),e.jsx(js,{open:n,onClose:()=>v(!1),onApplied:b})]})}export{Cs as default};
