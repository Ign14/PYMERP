import{j as e,g as F,a as P}from"./index-OfXnknKF.js";import{i as M,r as p}from"./react-DFcFNn96.js";import{u as b}from"./useQuery-7A7SEbdC.js";import{P as E}from"./PageHeader-DR0dkBli.js";import{R as w,L,C as R,X as S,Y as $,T as A,a as K,b as k}from"./charts-BeDQCoM6.js";const f=/^\d{4}-\d{2}-\d{2}$/;function T(s,n){const i=new Date(s);return i.setDate(i.getDate()+n),i}function C(s){const n=s.getFullYear(),i=`${s.getMonth()+1}`.padStart(2,"0"),r=`${s.getDate()}`.padStart(2,"0");return`${n}-${i}-${r}`}function q(){const s=new Date,n=T(s,-13);return{from:C(n),to:C(s)}}function z(s,n,i){const r=f.test(s??"")?s:i.from,l=f.test(n??"")?n:i.to;return r>l?{from:r,to:r}:{from:r,to:l}}function H(){const[s,n]=M(),i=p.useMemo(q,[]),r=p.useMemo(()=>({from:s.get("from"),to:s.get("to")}),[s]),l=p.useMemo(()=>z(r.from,r.to,i),[r.from,r.to,i]);p.useEffect(()=>{(r.from!==l.from||r.to!==l.to)&&n({from:l.from,to:l.to},{replace:!0})},[r.from,r.to,l.from,l.to,n]);const g=a=>t=>{const o=t.target.value;if(!f.test(o))return;let x=a==="from"?o:l.from,j=a==="to"?o:l.to;x>j&&(a==="from"?j=o:x=o),n({from:x,to:j})},{from:m,to:d}=l,c=b({queryKey:["salesMetrics",m,d],queryFn:()=>F({from:m,to:d}),enabled:!!(m&&d)}),h=b({queryKey:["trend",m,d,"purchase-sale"],queryFn:()=>P({from:m,to:d,series:"purchase,sale"}),enabled:!!(m&&d)}),D=p.useMemo(()=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",maximumFractionDigits:0}),[]),u=a=>D.format(a??0),y=p.useMemo(()=>{if(!h.data)return[];const a=new Map;return h.data.purchase.forEach(t=>{const o=a.get(t.date)??{date:t.date,purchase:0,sale:0};o.purchase=t.value??0,a.set(t.date,o)}),h.data.sale.forEach(t=>{const o=a.get(t.date)??{date:t.date,purchase:0,sale:0};o.sale=t.value??0,a.set(t.date,o)}),Array.from(a.values()).sort((t,o)=>t.date.localeCompare(o.date))},[h.data]),N=(c.data?.topPaymentMethods??[]).slice(0,4),v=c.isFetching||h.isFetching;return e.jsxs("div",{className:"dashboard-panel",children:[e.jsx(E,{title:"Panel de control",description:"Visualiza tus KPIs diarios y compara la tendencia de compras versus ventas."}),e.jsxs("section",{className:"card panel-filter","aria-labelledby":"panel-filter-title",children:[e.jsxs("div",{className:"panel-filter-header",children:[e.jsx("h3",{id:"panel-filter-title",children:"Filtro por fechas"}),e.jsx("span",{className:`panel-filter-status ${v?"busy":""}`,role:"status",children:v?"Actualizando datos...":"Datos al día"})]}),e.jsxs("div",{className:"date-filter",role:"group","aria-label":"Rango de fechas",children:[e.jsxs("label",{children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{type:"date",value:m,max:d,onChange:g("from")})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{type:"date",value:d,min:m,onChange:g("to")})]})]}),e.jsxs("p",{className:"muted small",children:["Período seleccionado: ",m," a ",d]})]}),e.jsxs("section",{className:"panel-kpis","aria-label":"Indicadores clave",children:[e.jsxs("article",{className:"card kpi-card",children:[e.jsx("h3",{children:"Ventas del día"}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando..."}):c.isError?e.jsx("p",{className:"panel-error",children:"No se pudieron cargar los indicadores."}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"kpi-value",children:u(c.data?.totalDay??0)}),e.jsxs("p",{className:"kpi-meta",children:["Total emitido el ",d]})]})]}),e.jsxs("article",{className:"card kpi-card",children:[e.jsx("h3",{children:"Producto más vendido"}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando..."}):c.isError?e.jsx("p",{className:"panel-error",children:"No se pudieron cargar los indicadores."}):c.data?.topProduct?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"kpi-value",children:c.data.topProduct.name}),e.jsxs("p",{className:"kpi-meta",children:[c.data.topProduct.qty," unidades"]})]}):e.jsx("p",{className:"muted",children:"Sin datos para el período seleccionado."})]}),e.jsxs("article",{className:"card kpi-card",children:[e.jsx("h3",{children:"Formas de pago más utilizadas"}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando..."}):c.isError?e.jsx("p",{className:"panel-error",children:"No se pudieron cargar los indicadores."}):N.length>0?e.jsx("ul",{className:"kpi-list",children:N.map(a=>e.jsxs("li",{children:[e.jsx("span",{className:"kpi-list-label",children:a.method}),e.jsxs("span",{className:"kpi-list-value",children:[a.count," usos"]})]},a.method))}):e.jsx("p",{className:"muted",children:"No hay ventas registradas en este rango."})]})]}),e.jsxs("section",{className:"card panel-chart","aria-labelledby":"overview-title",children:[e.jsx("div",{className:"panel-chart-header",children:e.jsxs("div",{children:[e.jsx("h3",{id:"overview-title",children:"Vista general"}),e.jsx("p",{className:"muted small",children:"Comparativo de compras vs. ventas"})]})}),h.isLoading?e.jsx("p",{className:"muted",children:"Cargando tendencia..."}):h.isError?e.jsx("p",{className:"panel-error",children:"No se pudo cargar la tendencia."}):y.length===0?e.jsx("p",{className:"muted",children:"Sin datos para el rango seleccionado."}):e.jsx("div",{className:"chart-wrapper",children:e.jsx(w,{width:"100%",height:"100%",children:e.jsxs(L,{data:y,margin:{top:20,right:24,bottom:8,left:0},children:[e.jsx(R,{strokeDasharray:"3 3",stroke:"#1f2937"}),e.jsx(S,{dataKey:"date",stroke:"#9aa0a6",tick:{fontSize:12}}),e.jsx($,{stroke:"#9aa0a6",tickFormatter:a=>u(Number(a)),width:96}),e.jsx(A,{formatter:a=>u(a),labelFormatter:a=>`Fecha: ${a}`}),e.jsx(K,{}),e.jsx(k,{type:"monotone",dataKey:"sale",name:"Ventas",stroke:"#60a5fa",strokeWidth:2,dot:!1}),e.jsx(k,{type:"monotone",dataKey:"purchase",name:"Compras",stroke:"#f97316",strokeWidth:2,dot:!1})]})})})]})]})}export{H as default};
