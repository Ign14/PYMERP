import{c as O,j as e,S as at,T as rt,U as ce,V as Fe,W as nt,m as qe,u as re,X as lt,Y as it,Z as ot,_ as ct,q as dt,k as Y,$ as ut,a0 as mt,a1 as xt,a2 as ht,a3 as gt,a4 as bt,a5 as pt,a6 as jt,a7 as Nt,a8 as vt,G as Ae,a9 as ft,aa as de,ab as yt,ac as Ct,ad as ue,ae as me,af as St,ag as wt,ah as kt}from"./index-BtVHljoa.js";import{r as x,d as Pt}from"./react-D8kvZI4c.js";import{u as P}from"./useQuery-Dnian6zg.js";import{P as Et}from"./PageHeader-BlxDVWRK.js";import{M as X}from"./Modal-B2h9NkJO.js";import{c as xe}from"./currency-HwQAg_Xa.js";import{R as he,B as ge,C as be,X as pe,Y as je,T as Ne,a as ve,g as ae,f as Me}from"./charts-BH7DIlZU.js";const ie={sku:"",name:"",description:"",category:"",barcode:"",imageUrl:null,imageFile:null};function Ft({open:s,product:a,onClose:h,onSaved:i}){const[r,d]=x.useState(ie),[t,n]=x.useState(null),[m,u]=x.useState(null),j=x.useRef(null),c=x.useRef(null);x.useEffect(()=>()=>{c.current&&c.current.startsWith("blob:")&&URL.revokeObjectURL(c.current)},[]),x.useEffect(()=>{if(!s){d(ie),u(null),w(null);return}a?(d({sku:a.sku??"",name:a.name??"",description:a.description??"",category:a.category??"",barcode:a.barcode??"",imageUrl:a.imageUrl??null,imageFile:null}),u(null),w(a.imageUrl??null)):(d(ie),u(null),w(null))},[s,a]);const b=O({mutationFn:y=>a?at(a.id,y):rt(y),onSuccess:y=>{i?.(y),h()}});x.useEffect(()=>{s||b.reset()},[s,b]);const l=y=>{const g=y.target.files?.[0];if(!g)return;if(g.size>512*1024){u("La imagen debe pesar 500 KB o menos"),y.target.value="";return}u(null),d(v=>({...v,imageFile:g}));const F=URL.createObjectURL(g);f(F)},N=()=>{if(u(null),r.imageFile){const y=r.imageUrl??null;d(g=>({...g,imageFile:null})),f(y)}else d(y=>({...y,imageUrl:null})),f(null);j.current&&(j.current.value="")},w=y=>{f(y)},f=y=>{c.current&&c.current.startsWith("blob:")&&URL.revokeObjectURL(c.current),c.current=y,n(y)},k=y=>{y.preventDefault();const g=r.sku.trim(),F=r.name.trim();if(!g){window.alert("El SKU es obligatorio");return}if(!F){window.alert("El nombre es obligatorio");return}const v={sku:g,name:F,description:r.description.trim()?r.description.trim():void 0,category:r.category.trim()?r.category.trim():void 0,barcode:r.barcode.trim()?r.barcode.trim():void 0};r.imageFile?(v.imageFile=r.imageFile,v.imageUrl=null):r.imageUrl===null?v.imageUrl=null:typeof r.imageUrl=="string"&&r.imageUrl.trim().length>0&&(v.imageUrl=r.imageUrl.trim()),b.mutate(v)},p=a?"Editar producto":"Nuevo producto",S=!!t;return e.jsx(X,{open:s,title:p,onClose:()=>!b.isPending&&h(),children:e.jsxs("form",{className:"form-grid",onSubmit:k,children:[e.jsxs("label",{children:[e.jsx("span",{children:"SKU *"}),e.jsx("input",{className:"input",value:r.sku,onChange:y=>d(g=>({...g,sku:y.target.value})),placeholder:"SKU-001",disabled:b.isPending,"data-autofocus":!0})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",value:r.name,onChange:y=>d(g=>({...g,name:y.target.value})),placeholder:"Producto demo",disabled:b.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Categoria"}),e.jsx("input",{className:"input",value:r.category,onChange:y=>d(g=>({...g,category:y.target.value})),placeholder:"Bebidas",disabled:b.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Codigo de barras"}),e.jsx("input",{className:"input",value:r.barcode,onChange:y=>d(g=>({...g,barcode:y.target.value})),placeholder:"7890000000",disabled:b.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Descripcion"}),e.jsx("textarea",{className:"input",value:r.description,onChange:y=>d(g=>({...g,description:y.target.value})),placeholder:"Notas internas",rows:3,disabled:b.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Imagen"}),S?e.jsx("div",{className:"image-preview",children:e.jsx("img",{src:t??void 0,alt:"Vista previa del producto"})}):e.jsx("p",{className:"muted small",children:"No has seleccionado una imagen"}),e.jsx("input",{ref:j,className:"input",type:"file",accept:"image/png,image/jpeg,image/webp,image/*",onChange:l,disabled:b.isPending}),e.jsx("p",{className:"muted small",children:"Formatos aceptados: PNG, JPG o WebP. Tamao mximo 500 KB."}),(r.imageFile||r.imageUrl)&&e.jsx("div",{className:"inline-actions",children:e.jsx("button",{className:"btn ghost",type:"button",onClick:N,disabled:b.isPending,children:"Quitar imagen"})}),m&&e.jsx("p",{className:"error",children:m})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:b.isPending,children:b.isPending?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:h,disabled:b.isPending,children:"Cancelar"})]}),b.isError&&e.jsx("p",{className:"error",children:At(b.error)})]})})}function At(s){if(ce.isAxiosError(s)){const a=s.response?.data;if(typeof a=="string"&&a.trim().length>0)return a;if(a&&typeof a=="object"){if(typeof a.detail=="string"&&a.detail.trim().length>0)return a.detail;if(typeof a.message=="string"&&a.message.trim().length>0)return a.message;if(typeof a.error=="string"&&a.error.trim().length>0)return a.error}}return s instanceof Error&&s.message?s.message:"No se pudo guardar"}function Lt({open:s,product:a,pendingValue:h,submitting:i=!1,error:r,onClose:d,onSubmit:t}){const[n,m]=x.useState("0"),[u,j]=x.useState(null),c=x.useMemo(()=>{if(typeof h=="number")return h;const f=Number(a?.criticalStock??0);return Number.isFinite(f)&&f>=0?f:0},[h,a?.criticalStock]);x.useEffect(()=>{if(!s||!a){m("0"),j(null);return}m(String(c)),j(null)},[s,a?.id,c]);const b=f=>{f.preventDefault();const k=Number(n);if(!Number.isFinite(k)||k<0){j("Ingresa un stock válido (mayor o igual a 0)");return}j(null),t(k)},l=()=>{i||d()},N=a?`Stock crítico - ${a.name}`:"Stock crítico",w=!!u||!!r;return e.jsx(X,{open:s,title:N,onClose:l,children:e.jsxs("form",{className:"form-grid",onSubmit:b,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Stock crítico"}),e.jsx("input",{className:`input${w?" input-error":""}`,type:"number",min:"0",step:"1",value:n,onChange:f=>m(f.target.value),disabled:i,"data-autofocus":!0,inputMode:"numeric"})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:i,children:i?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:l,disabled:i,children:"Cancelar"})]}),u&&e.jsx("p",{className:"error",children:u}),!u&&r&&e.jsx("p",{className:"error",children:r})]})})}function It({open:s,product:a,onClose:h}){const[i,r]=x.useState(null),[d,t]=x.useState(!1),[n,m]=x.useState(null),u=()=>{t(!1),m(null),i&&i.startsWith("blob:")&&URL.revokeObjectURL(i),r(null)};x.useEffect(()=>{if(!s||!a){u();return}return t(!0),m(null),Fe(a.id).then(l=>{const N=URL.createObjectURL(l);r(N)}).catch(()=>{m("No se pudo cargar el código QR")}).finally(()=>{t(!1)}),u},[s,a?.id]);const j=()=>{if(!i||!a)return;const l=window.open("","_blank","noopener,noreferrer");if(!l)return;const N=a.sku?`QR ${a.sku}`:"QR";l.document.write(`<!doctype html><html><head><title>${N}</title></head>`),l.document.write('<body style="margin:0;display:flex;align-items:center;justify-content:center;height:100vh;background:#fff;">'),l.document.write(`<img src="${i}" alt="${N}" style="max-width:90%;max-height:90%;" />`),l.document.write("</body></html>"),l.document.close(),l.focus(),l.print(),l.close()},c=async()=>{if(a)try{const l=await Fe(a.id,{download:!0}),N=URL.createObjectURL(l),w=document.createElement("a"),f=l.type==="image/svg+xml"?"svg":"png",k=(a.sku||a.id).replace(/[^a-zA-Z0-9-_]+/g,"-");w.href=N,w.download=`${k}-qr.${f}`,document.body.appendChild(w),w.click(),w.remove(),setTimeout(()=>URL.revokeObjectURL(N),500)}catch{m("No se pudo descargar el código QR")}},b=a&&`Código QR ${a.sku??""}`.trim()||"Código QR";return e.jsxs(X,{open:s,title:b,onClose:h,children:[d&&e.jsx("p",{className:"muted",children:"Cargando código QR..."}),n&&e.jsx("p",{className:"error",children:n}),!d&&!n&&i&&e.jsx("div",{className:"qr-preview",children:e.jsx("img",{src:i,alt:b})}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"button",onClick:j,disabled:!i||d,"data-autofocus":!0,children:"Imprimir"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:c,disabled:!a||d,children:"Descargar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:h,children:"Cerrar"})]})]})}function Dt({open:s,product:a,imageUrl:h,onClose:i}){const r=x.useRef(null),d=x.useMemo(()=>a?`Imagen - ${a.name}`:"Imagen del producto",[a]),t=h??"";return e.jsxs(X,{open:s,title:d,onClose:i,initialFocusRef:r,children:[e.jsx("div",{className:"image-modal__content",children:t?e.jsx("img",{src:t,alt:d,className:"image-modal__preview"}):e.jsx("p",{className:"muted",children:"Sin imagen disponible"})}),e.jsx("div",{className:"buttons",children:e.jsx("button",{ref:r,className:"btn",type:"button",onClick:i,children:"Cerrar"})})]})}const se={targetLocationId:"",qty:"",note:""};function qt({open:s,lot:a,productName:h,onClose:i,onTransferred:r}){const[d,t]=x.useState(se),[n,m]=x.useState(null),u=a?.quantity??0,j=x.useMemo(()=>a?a.locationCode&&a.locationName?`${a.locationCode} · ${a.locationName}`:a.locationCode?a.locationCode:a.locationName?a.locationName:"Sin ubicación asignada":"—",[a]);x.useEffect(()=>{if(!s){t(se),m(null);return}t(f=>({...se,qty:u>0?String(Math.min(u,1)):""})),m(null)},[s,u]);const c=P({queryKey:["locations"],queryFn:()=>qe(),enabled:s,staleTime:300*1e3}),b=x.useMemo(()=>!c.data||!a?.locationId?c.data??[]:c.data.filter(f=>f.id!==a.locationId),[c.data,a?.locationId]),l=O({mutationFn:async()=>{if(!a)throw new Error("No hay lote seleccionado");const f=Number(d.qty);if(!Number.isFinite(f)||f<=0)throw new Error("La cantidad debe ser mayor a 0");if(f>u)throw new Error(`La cantidad no puede superar ${u}`);if(!d.targetLocationId)throw new Error("Selecciona una ubicación destino");const k={targetLocationId:d.targetLocationId,qty:f,note:d.note.trim()||void 0};await nt(a.lotId,k)},onSuccess:()=>{t(se),r?.(),i()},onError:f=>{const k=Mt(f);m(k)}}),N=f=>{f.preventDefault(),!l.isPending&&(m(null),l.mutate())},w=!a||!d.targetLocationId||!d.qty||Number(d.qty)<=0||Number(d.qty)>u||b.length===0||l.isPending;return e.jsx(X,{open:s,onClose:i,title:"Transferir stock",className:"modal-card",children:e.jsxs("form",{onSubmit:N,style:{width:"100%",maxWidth:"480px"},children:[e.jsxs("section",{className:"transfer-summary",children:[e.jsx("p",{className:"muted small",children:"Producto"}),e.jsx("p",{style:{marginBottom:"0.75rem",fontWeight:600},children:h}),e.jsxs("div",{className:"summary-row",children:[e.jsxs("div",{children:[e.jsx("p",{className:"muted small",children:"Ubicación actual"}),e.jsx("p",{children:j})]}),e.jsxs("div",{children:[e.jsx("p",{className:"muted small",children:"Stock disponible"}),e.jsx("p",{className:"mono",children:u})]})]})]}),b.length===0&&!c.isLoading&&e.jsx("p",{className:"panel-error",style:{marginBottom:"1rem"},children:"No hay ubicaciones destino disponibles para transferir."}),e.jsxs("div",{className:"form-grid",style:{display:"grid",gap:"1rem",marginTop:"1rem"},children:[e.jsxs("label",{className:"form-field",children:[e.jsx("span",{className:"label",children:"Ubicación destino"}),e.jsxs("select",{className:"input",value:d.targetLocationId,onChange:f=>t(k=>({...k,targetLocationId:f.target.value})),disabled:c.isLoading||l.isPending||b.length===0,"data-autofocus":!0,children:[e.jsx("option",{value:"",children:"Selecciona una ubicación…"}),b.map(f=>e.jsxs("option",{value:f.id,children:[f.code," · ",f.name]},f.id))]}),c.isLoading&&e.jsx("span",{className:"muted small",children:"Cargando ubicaciones…"})]}),e.jsxs("label",{className:"form-field",children:[e.jsx("span",{className:"label",children:"Cantidad a transferir"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:d.qty,onChange:f=>t(k=>({...k,qty:f.target.value})),disabled:l.isPending}),e.jsxs("span",{className:"muted very-small",children:["Máximo permitido: ",u]})]}),e.jsxs("label",{className:"form-field",children:[e.jsx("span",{className:"label",children:"Comentario (opcional)"}),e.jsx("textarea",{className:"input",rows:3,value:d.note,onChange:f=>t(k=>({...k,note:f.target.value})),placeholder:"Ej. mover a bodega principal",disabled:l.isPending})]})]}),n&&e.jsx("p",{className:"panel-error",style:{marginTop:"1rem"},children:n}),e.jsxs("footer",{style:{marginTop:"1.5rem",display:"flex",justifyContent:"flex-end",gap:"0.75rem"},children:[e.jsx("button",{type:"button",className:"btn ghost",onClick:i,disabled:l.isPending,children:"Cancelar"}),e.jsx("button",{type:"submit",className:"btn primary",disabled:w,children:l.isPending?"Transfiriendo…":"Transferir"})]})]})})}function Mt(s){if(ce.isAxiosError(s)){const a=s.response?.data;if(a){if(typeof a=="string")return a;if(typeof a=="object"){const h=a.message??a.detail??a.error;if(h&&typeof h=="string")return h}}return s.response?.statusText??"No se pudo completar la transferencia"}return s instanceof Error&&s.message?s.message:"No se pudo completar la transferencia"}const Le="data:image/svg+xml,%3csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%20160%20160'%20role='img'%20aria-label='Producto%20sin%20imagen'%3e%3cdefs%3e%3clinearGradient%20id='bg'%20x1='0%25'%20y1='0%25'%20x2='100%25'%20y2='100%25'%3e%3cstop%20offset='0%25'%20stop-color='%231f2937'%20/%3e%3cstop%20offset='100%25'%20stop-color='%23111827'%20/%3e%3c/linearGradient%3e%3c/defs%3e%3crect%20width='160'%20height='160'%20fill='url(%23bg)'%20rx='24'%20ry='24'%20/%3e%3cpath%20d='M48%2052c0-8.837%207.163-16%2016-16h32c8.837%200%2016%207.163%2016%2016v56c0%208.837-7.163%2016-16%2016H64c-8.837%200-16-7.163-16-16V52zm16-4a12%2012%200%200%200-12%2012v4.382l11.172-11.172a4%204%200%200%201%205.656%200L92%2094.343l10.828-10.828a4%204%200%200%201%205.656%200L112%2086V60a12%2012%200%200%200-12-12H64zm0%2096c-13.255%200-24-10.745-24-24V60c0-13.255%2010.745-24%2024-24h32c13.255%200%2024%2010.745%2024%2024v60c0%2013.255-10.745%2024-24%2024H64z'%20fill='%2360a5fa'%20fill-opacity='0.35'%20/%3e%3ccircle%20cx='64'%20cy='64'%20r='12'%20fill='%23ffffff'%20fill-opacity='0.08'%20/%3e%3c/svg%3e",Tt=10;function Rt(){const[s,a]=x.useState(""),[h,i]=x.useState(0),[r,d]=x.useState("active"),[t,n]=x.useState(null),[m,u]=x.useState({price:0}),[j,c]=x.useState(!1),[b,l]=x.useState(null),[N,w]=x.useState(!1),[f,k]=x.useState(null),[p,S]=x.useState(!1),[y,g]=x.useState(null),[F,v]=x.useState({}),[I,A]=x.useState({}),[K,L]=x.useState(!1),[B,Q]=x.useState(null),[V,ee]=x.useState(null),[Te,fe]=x.useState(!1),[Re,ye]=x.useState(null),[Oe,Ce]=x.useState(null),D=re(),z=o=>{if(typeof o=="number")return Number.isFinite(o)?o:null;if(typeof o=="string"&&o.trim().length>0){const C=Number(o);return Number.isFinite(C)?C:null}return null},Se=o=>{const C=z(o);return C===null||C<=0?"Sin precio":`$${C.toFixed(2)}`},Z=x.useMemo(()=>Object.keys(F).length>0,[F]);x.useEffect(()=>{const o=C=>{Z&&(C.preventDefault(),C.returnValue="")};return window.addEventListener("beforeunload",o),()=>{window.removeEventListener("beforeunload",o)}},[Z]);const ne=o=>{const C=z(o);return C===null||Number.isNaN(C)?0:C},le=o=>{if(!o)return 0;const C=F[o.id];return typeof C=="number"?C:ne(o.criticalStock??0)},we=o=>o?ne(o.stock??0):0,Be=o=>{const C=we(o),T=le(o);return T>0&&C<=T},Ue=o=>Object.prototype.hasOwnProperty.call(F,o);x.useEffect(()=>{i(0)},[r]);const q=P({queryKey:["products",{q:s,page:h,status:r}],queryFn:()=>Y({q:s||void 0,page:h,size:Tt,status:r}),placeholderData:dt}),$e=P({queryKey:["product-prices",t?.id],queryFn:()=>{if(!t)throw new Error("Producto no seleccionado");return ut(t.id,{size:5})},enabled:!!t}),M=P({queryKey:["product",t?.id,"stock"],queryFn:()=>{if(!t)throw new Error("Producto no seleccionado");return mt(t.id)},enabled:!!t}),J=O({mutationFn:async()=>{if(!t)throw new Error("Select a product first");return lt(t.id,m)},onSuccess:()=>{D.invalidateQueries({queryKey:["products"],exact:!1}),D.invalidateQueries({queryKey:["product-prices",t?.id]}),u({price:0})}}),G=O({mutationFn:o=>it(o),onSuccess:(o,C)=>{D.invalidateQueries({queryKey:["products"],exact:!1}),D.removeQueries({queryKey:["product-prices",C],exact:!0}),t?.id===C&&(n(null),u({price:0}))}}),H=O({mutationFn:o=>{if(!t)throw new Error("Producto no seleccionado");return ot(t.id,o)},onSuccess:o=>{D.invalidateQueries({queryKey:["products"],exact:!1}),n(o),u({price:z(o.currentPrice)??0})}}),Qe=()=>{l(null),c(!0)},Ke=()=>{t&&(l(t),c(!0))},Ve=()=>{c(!1),l(null)},ke=o=>{const C=o??t;C&&(k(C),w(!0))},ze=()=>{w(!1),k(null)},Pe=o=>{const C=o??t;C&&(g(C),S(!0))},_e=()=>{S(!1),g(null)},Ge=o=>{if(!y)return;const C=y.id,T=ne(y.criticalStock??0);v(E=>{const $={...E};return o===T?delete $[C]:$[C]=o,$}),A(E=>{if(!E[C])return E;const{[C]:$,..._}=E;return _}),ee(null),t?.id===C&&n({...t,criticalStock:o}),S(!1),g(null)},He=async()=>{const o=Object.entries(F);if(o.length===0||K)return;L(!0),ee(null);const C={...F},T=[];for(const[E,$]of o)try{const _=await ct(E,$);T.push(_),delete C[E],A(R=>{if(!R[E])return R;const{[E]:W,...U}=R;return U})}catch(_){const R=Ot(_),W=q.data?.content?.find(U=>U.id===E)?.name??E;A(U=>({...U,[E]:R.fieldMessage??R.message})),v(C),ee({type:"error",text:`${W}: ${R.message}`}),L(!1);return}if(v({}),ee({type:"success",text:"Cambios guardados correctamente."}),L(!1),D.invalidateQueries({queryKey:["products"],exact:!1}),T.forEach(E=>{D.invalidateQueries({queryKey:["product",E.id,"stock"]})}),t){const E=T.find($=>$.id===t.id);E&&(n(E),u({price:z(E.currentPrice)??0}))}},We=o=>{D.invalidateQueries({queryKey:["products"],exact:!1}),n(o),u({price:z(o.currentPrice)??0}),f?.id===o.id&&k(o),v(C=>{if(!C[o.id])return C;const{[o.id]:T,...E}=C;return E}),A(C=>{if(!C[o.id])return C;const{[o.id]:T,...E}=C;return E}),D.invalidateQueries({queryKey:["product",o.id,"stock"]})},Ye=o=>{const C=typeof o.imageUrl=="string"&&o.imageUrl.trim().length>0?o.imageUrl:Le;ye(o),Ce(C),fe(!0)},Xe=()=>{fe(!1),ye(null),Ce(null)},Ze=()=>{!t||G.isPending||window.confirm(`Eliminar producto ${t.name}?`)&&G.mutate(t.id)},Je=()=>{!t||H.isPending||H.mutate(!t.active)},Ee=q.data?.content??[],te=q.data?.totalPages??1;x.useEffect(()=>{if(!t)return;const o=q.data?.content?.find(C=>C.id===t.id);if(!o){n(null),u({price:0});return}o!==t&&(n(o),u({price:z(o.currentPrice)??0}))},[q.data,t]);const et=x.useMemo(()=>t?Se(t.currentPrice):"",[t]),tt=x.useMemo(()=>t?le(t):0,[t,F]),st=o=>{if(o.preventDefault(),!!t){if(!m.price||m.price<=0){alert("Ingresa un precio valido");return}J.mutate()}};return e.jsxs("div",{className:"card products-card",children:[e.jsxs("div",{className:"products-banner",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Productos"}),e.jsx("p",{className:"muted small",children:Z?"Tienes cambios sin guardar en los stocks críticos.":"Administra tu catálogo, imágenes y alertas de stock."})]}),e.jsx("button",{className:"btn primary",type:"button",onClick:He,disabled:!Z||K,children:K?"Guardando...":"Guardar cambios"})]}),V&&e.jsx("div",{className:`status-message ${V.type}`,role:"status",children:V.text}),e.jsx("div",{className:"card-header",children:e.jsxs("div",{className:"inline-actions",children:[e.jsx("input",{className:"input",placeholder:"Buscar por nombre, SKU o codigo",value:s,onChange:o=>{a(o.target.value),i(0)}}),e.jsxs("select",{className:"input",value:r,onChange:o=>d(o.target.value),children:[e.jsx("option",{value:"active",children:"Activos"}),e.jsx("option",{value:"inactive",children:"Inactivos"}),e.jsx("option",{value:"all",children:"Todos"})]}),e.jsx("button",{className:"btn",onClick:()=>D.invalidateQueries({queryKey:["products"]}),disabled:q.isFetching,children:q.isFetching?"Cargando":"Refrescar"})]})}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn",type:"button",onClick:Qe,children:"+ Producto"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Ke,disabled:!t,children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>ke(t),disabled:!t,children:"Ver QR"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Je,disabled:!t||H.isPending,children:H.isPending?"Actualizando...":t?.active?"Desactivar":"Activar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:Ze,disabled:!t||G.isPending,children:G.isPending?"Eliminando...":"Eliminar"})]}),Z&&e.jsx("p",{className:"muted small notice-dirty",children:"Recuerda guardar para aplicar los cambios pendientes."}),G.isError&&e.jsx("p",{className:"error",children:G.error?.message??"No se pudo eliminar el producto"}),H.isError&&e.jsx("p",{className:"error",children:H.error?.message??"No se pudo actualizar el estado"}),q.isLoading&&e.jsx("p",{children:"Loading..."}),q.isError&&e.jsx("p",{className:"error",children:q.error.message}),!q.isLoading&&!q.isError&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"products-grid",children:Ee.map(o=>{F[o.id];const C=we(o),T=le(o),E=I[o.id],$=typeof o.imageUrl=="string"&&o.imageUrl.trim().length>0?o.imageUrl:Le,_=t?.id===o.id,R=Be(o),W=Ue(o.id);return e.jsxs("div",{className:`product-card${_?" product-card--selected":""}${R?" product-card--critical":""}${W?" product-card--pending":""}`,onClick:()=>{n(o),u({price:z(o.currentPrice)??0})},children:[e.jsxs("div",{className:"product-card-image",onClick:U=>{U.stopPropagation(),Ye(o)},children:[e.jsx("img",{src:$,alt:o.name}),!o.active&&e.jsx("div",{className:"product-badge product-badge--inactive",children:"Inactivo"}),R&&o.active&&e.jsx("div",{className:"product-badge product-badge--critical",children:"⚠️ Stock Bajo"})]}),e.jsxs("div",{className:"product-card-body",children:[e.jsxs("div",{className:"product-card-header",children:[e.jsx("h4",{className:"product-card-title",children:o.name}),e.jsx("span",{className:"product-card-sku mono small muted",children:o.sku})]}),e.jsxs("div",{className:"product-card-stats",children:[e.jsxs("div",{className:"product-stat",children:[e.jsx("span",{className:"product-stat-label muted small",children:"Precio"}),e.jsx("span",{className:"product-stat-value mono",children:Se(o.currentPrice)})]}),e.jsxs("div",{className:"product-stat",children:[e.jsx("span",{className:"product-stat-label muted small",children:"Stock"}),e.jsxs("span",{className:`product-stat-value ${R?"text-critical":""}`,children:[C,R&&e.jsx("span",{className:"stock-indicator",children:"⚠️"})]})]}),e.jsxs("div",{className:"product-stat",children:[e.jsx("span",{className:"product-stat-label muted small",children:"Crítico"}),e.jsxs("span",{className:`product-stat-value${W?" text-pending":""}`,children:[T,W&&e.jsx("span",{className:"pending-indicator",children:"●"})]})]})]}),E&&e.jsx("p",{className:"error small",style:{marginTop:"0.5rem"},children:E}),e.jsxs("div",{className:"product-card-actions",children:[e.jsx("button",{className:"btn ghost small",type:"button",onClick:U=>{U.stopPropagation(),Pe(o)},children:"Stock crítico"}),e.jsx("button",{className:"btn ghost small",type:"button",onClick:U=>{U.stopPropagation(),ke(o)},children:"QR"})]})]})]},o.id)})}),Ee.length===0&&e.jsx("div",{className:"muted",style:{textAlign:"center",padding:"2rem"},children:e.jsx("p",{children:"No se encontraron productos"})}),te>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:h===0,onClick:()=>i(o=>Math.max(0,o-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Pagina ",h+1," de ",te]}),e.jsx("button",{className:"btn",disabled:h>=te-1,onClick:()=>i(o=>Math.min(te-1,o+1)),children:"Siguiente"})]}),t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Precio"}),e.jsxs("p",{className:"muted",children:["Actual: ",et]}),e.jsxs("p",{className:"muted",children:["Estado: ",t.active?"Activo":"Inactivo"]}),e.jsxs("form",{className:"form-inline",onSubmit:st,children:[e.jsx("input",{className:"input",type:"number",step:"0.01",min:"0",placeholder:"Nuevo precio",value:m.price,onChange:o=>u(C=>({...C,price:Number(o.target.value)}))}),e.jsx("button",{className:"btn",type:"submit",disabled:J.isPending,children:J.isPending?"Guardando...":"Actualizar"})]}),J.isError&&e.jsx("p",{className:"error",children:J.error?.message}),e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Precio"}),e.jsx("th",{children:"Desde"})]})}),e.jsx("tbody",{children:($e.data?.content??[]).map(o=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono",children:`$${o.price.toFixed(2)}`}),e.jsx("td",{className:"mono small",children:new Date(o.validFrom).toLocaleString()})]},o.id))})]})})]}),e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Inventario"}),e.jsxs("p",{className:"muted",children:["Stock total:"," ",M.isLoading?"Cargando...":M.data?M.data.total:"Sin datos"]}),e.jsxs("p",{className:"muted",children:["Stock crítico configurado: ",tt]}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>Pe(),children:"Definir stock crítico"}),M.isError&&e.jsx("p",{className:"error",children:M.error?.message??"No se pudo obtener el stock"}),M.isLoading&&e.jsx("p",{className:"muted",children:"Cargando lotes..."}),M.data&&M.data.lots.length>0&&e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Lote"}),e.jsx("th",{children:"Batch"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Costo Unit."}),e.jsx("th",{children:"Ubicación"}),e.jsx("th",{children:"Mfg."}),e.jsx("th",{children:"Vence"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:M.data.lots.map(o=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:o.lotId.substring(0,8)}),e.jsx("td",{className:"mono small",children:o.batchName||"—"}),e.jsx("td",{className:"mono",children:o.quantity}),e.jsx("td",{className:"mono small",children:o.costUnit?`$${o.costUnit.toLocaleString()}`:"—"}),e.jsx("td",{children:o.locationCode?e.jsx("span",{title:o.locationName||"",children:o.locationCode}):"—"}),e.jsx("td",{className:"mono small",children:o.mfgDate?new Date(o.mfgDate).toLocaleDateString():"—"}),e.jsx("td",{className:"mono small",children:o.expDate?new Date(o.expDate).toLocaleDateString():"—"}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn small ghost",onClick:()=>t&&Q({product:t,lot:o}),disabled:o.quantity<=0,children:"Transferir"})})]},o.lotId))})]})}),M.data&&M.data.lots.length===0&&!M.isLoading&&e.jsx("p",{className:"muted small",children:"No hay lotes registrados para este producto."})]})]})]}),e.jsx(Ft,{open:j,product:b,onClose:Ve,onSaved:We}),e.jsx(It,{open:N,product:f,onClose:ze}),e.jsx(Lt,{open:p,product:y,pendingValue:y?F[y.id]:void 0,error:y?I[y.id]:void 0,submitting:K,onClose:_e,onSubmit:Ge}),e.jsx(Dt,{open:Te,product:Re,imageUrl:Oe,onClose:Xe}),e.jsx(qt,{open:!!B,lot:B?.lot??null,productName:B?.product.name??"",onClose:()=>Q(null),onTransferred:()=>{B?.product.id&&D.invalidateQueries({queryKey:["product",B.product.id,"stock"]}),D.invalidateQueries({queryKey:["inventoryMovements"],exact:!1})}})]})}function Ot(s){if(ce.isAxiosError(s)){const a=s.response?.data;if(typeof a=="string"&&a.trim().length>0)return{message:a};if(a&&typeof a=="object"){const i=a.errors??{};let r;const d=i.criticalStock;return Array.isArray(d)&&d.length>0?r=d[0]:typeof d=="string"&&d.trim().length>0&&(r=d),{message:[a.detail,a.message,a.error,a.title].find(n=>typeof n=="string"&&n.trim().length>0)?.trim()??s.response?.statusText??"No se pudo guardar",fieldMessage:r}}const h=s.response?.statusText;if(h)return{message:h}}return s instanceof Error&&s.message?{message:s.message}:{message:"No se pudo guardar"}}function Bt(){const{session:s}=xt(),[a,h]=x.useState(null),[i,r]=x.useState(!1),[d,t]=x.useState(null),[n,m]=x.useState({code:"",name:"",description:"",type:"WAREHOUSE",parentLocationId:void 0}),u=re(),j=P({queryKey:["locations"],queryFn:()=>qe()}),c=P({queryKey:["parent-locations",s?.companyId],queryFn:()=>bt(s?.companyId??""),enabled:!!s?.companyId}),b=P({queryKey:["location-stock-summary"],queryFn:pt}),l=O({mutationFn:v=>ht(v),onSuccess:()=>{u.invalidateQueries({queryKey:["locations"]}),u.invalidateQueries({queryKey:["location-stock-summary"]}),r(!1),w()}}),N=O({mutationFn:v=>gt(v),onSuccess:()=>{u.invalidateQueries({queryKey:["locations"]}),u.invalidateQueries({queryKey:["location-stock-summary"]}),h(null)}}),w=()=>{m({code:"",name:"",description:"",type:"WAREHOUSE",parentLocationId:void 0}),t(null)},f=v=>{v?(t(v),m({code:v.code,name:v.name,description:v.description,type:v.type,parentLocationId:v.parentLocationId})):w(),r(!0)},k=v=>{if(v.preventDefault(),!n.code||!n.name){alert("Código y nombre son requeridos");return}l.mutate(n)},p=()=>{a&&window.confirm(`¿Eliminar ubicación ${a.name}?`)&&N.mutate(a.id)},S=j.data??[],y=b.data??[],g=S.reduce((v,I)=>(v[I.type]||(v[I.type]=[]),v[I.type].push(I),v),{}),F=a?y.find(v=>v.locationId===a.id):null;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Ubicaciones"}),e.jsx("p",{className:"muted small",children:"Gestiona las ubicaciones físicas del inventario"})]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn primary",type:"button",onClick:()=>f(),children:"+ Nueva Ubicación"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>u.invalidateQueries({queryKey:["locations"]}),disabled:j.isFetching,children:j.isFetching?"Cargando...":"Refrescar"})]}),j.isLoading&&e.jsx("p",{children:"Cargando ubicaciones..."}),j.isError&&e.jsx("p",{className:"error",children:j.error.message}),!j.isLoading&&!j.isError&&e.jsx(e.Fragment,{children:e.jsxs("div",{className:"locations-grid",children:[e.jsx("div",{className:"locations-list",children:Object.entries(g).map(([v,I])=>e.jsxs("div",{className:"location-type-section",children:[e.jsx("h3",{className:"location-type-title",children:v}),e.jsx("div",{className:"location-items",children:I.map(A=>{const L=y.find(Q=>Q.locationId===A.id)?.products.length??0,B=a?.id===A.id;return e.jsxs("div",{className:`location-item${B?" selected":""}`,onClick:()=>h(A),children:[e.jsxs("div",{className:"location-item-header",children:[e.jsx("span",{className:"location-code mono",children:A.code}),L>0&&e.jsxs("span",{className:"location-badge",children:[L," productos"]})]}),e.jsx("div",{className:"location-name",children:A.name}),A.description&&e.jsx("div",{className:"location-description muted small",children:A.description})]},A.id)})})]},v))}),e.jsx("div",{className:"location-details",children:a?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Detalles de Ubicación"}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Código:"}),e.jsx("span",{className:"mono",children:a.code})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Nombre:"}),e.jsx("span",{children:a.name})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Tipo:"}),e.jsx("span",{children:a.type})]}),a.description&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Descripción:"}),e.jsx("span",{children:a.description})]}),e.jsxs("div",{className:"inline-actions",style:{marginTop:"1rem"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>f(a),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:p,disabled:N.isPending,children:N.isPending?"Eliminando...":"Eliminar"})]})]}),e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Productos en esta Ubicación"}),b.isLoading&&e.jsx("p",{className:"muted",children:"Cargando stock..."}),F&&F.products.length>0?e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Lotes"})]})}),e.jsx("tbody",{children:F.products.map(v=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:v.productSku}),e.jsx("td",{children:v.productName}),e.jsx("td",{className:"mono",children:v.totalQuantity.toFixed(2)}),e.jsx("td",{className:"mono",children:v.lotCount})]},v.productId))})]})}):e.jsx("p",{className:"muted small",children:"No hay productos en esta ubicación"})]})]}):e.jsx("div",{className:"empty-state",children:e.jsx("p",{className:"muted",children:"Selecciona una ubicación para ver detalles"})})})]})}),i&&e.jsx("div",{className:"modal-overlay",onClick:()=>r(!1),children:e.jsxs("div",{className:"modal",onClick:v=>v.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:d?"Editar Ubicación":"Nueva Ubicación"}),e.jsx("button",{className:"btn-close",onClick:()=>r(!1),children:"×"})]}),e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Código *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:n.code,onChange:v=>m({...n,code:v.target.value}),placeholder:"Ej: ALM-01"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:n.name,onChange:v=>m({...n,name:v.target.value}),placeholder:"Ej: Almacén Principal"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Tipo"}),e.jsxs("select",{className:"input",value:n.type,onChange:v=>m({...n,type:v.target.value}),children:[e.jsx("option",{value:"WAREHOUSE",children:"WAREHOUSE"}),e.jsx("option",{value:"SHELF",children:"SHELF"}),e.jsx("option",{value:"BIN",children:"BIN"})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Ubicación Padre (opcional)"}),e.jsxs("select",{className:"input",value:n.parentLocationId??"",onChange:v=>m({...n,parentLocationId:v.target.value||void 0}),children:[e.jsx("option",{value:"",children:"-- Sin ubicación padre --"}),c.data&&c.data.length>0&&e.jsx("optgroup",{label:"Ubicaciones Padre de la Empresa",children:c.data.map(v=>e.jsxs("option",{value:v.id,children:[v.code," - ",v.name]},v.id))}),S.length>0&&e.jsx("optgroup",{label:"Otras Ubicaciones",children:S.map(v=>e.jsxs("option",{value:v.id,children:[v.code," - ",v.name," (",v.type,")"]},v.id))})]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Descripción (opcional)"}),e.jsx("textarea",{className:"input",rows:3,value:n.description??"",onChange:v=>m({...n,description:v.target.value}),placeholder:"Descripción de la ubicación"})]}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>r(!1),disabled:l.isPending,children:"Cancelar"}),e.jsx("button",{className:"btn primary",type:"submit",disabled:l.isPending,children:l.isPending?"Guardando...":d?"Actualizar":"Crear"})]}),l.isError&&e.jsx("p",{className:"error",children:l.error?.message??"Error al guardar"})]})]})})]})}function Ut(){const[s,a]=x.useState(null),[h,i]=x.useState(!1),[r,d]=x.useState(null),[t,n]=x.useState("active"),[m,u]=x.useState({code:"",name:"",description:"",active:!0}),j=re(),c=P({queryKey:["services",{status:t}],queryFn:()=>t==="all"?Ae():Ae(t==="active")}),b=O({mutationFn:g=>jt(g),onSuccess:g=>{j.invalidateQueries({queryKey:["services"]}),i(!1),a(g),w()}}),l=O({mutationFn:({id:g,payload:F})=>Nt(g,F),onSuccess:()=>{j.invalidateQueries({queryKey:["services"]}),i(!1),w()}}),N=O({mutationFn:g=>vt(g),onSuccess:()=>{j.invalidateQueries({queryKey:["services"]}),a(null)}}),w=()=>{u({code:"",name:"",description:"",active:!0}),d(null)},f=g=>{g?(d(g),u({code:g.code,name:g.name,description:g.description,active:g.active})):w(),i(!0)},k=g=>{if(g.preventDefault(),!m.code||!m.name){alert("Código y nombre son requeridos");return}r?l.mutate({id:r.id,payload:m}):b.mutate(m)},p=()=>{s&&window.confirm(`¿Eliminar servicio ${s.name}?`)&&N.mutate(s.id)},S=c.data??[],y=g=>g?new Date(g).toLocaleDateString("es-CL",{year:"numeric",month:"short",day:"numeric"}):"Nunca";return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{children:[e.jsx("h2",{children:"Servicios"}),e.jsx("p",{className:"muted small",children:"Gestiona servicios que no requieren inventario"})]})}),e.jsxs("div",{className:"inline-actions",children:[e.jsxs("select",{className:"input",value:t,onChange:g=>n(g.target.value),children:[e.jsx("option",{value:"active",children:"Activos"}),e.jsx("option",{value:"inactive",children:"Inactivos"}),e.jsx("option",{value:"all",children:"Todos"})]}),e.jsx("button",{className:"btn primary",type:"button",onClick:()=>f(),children:"+ Nuevo Servicio"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>j.invalidateQueries({queryKey:["services"]}),disabled:c.isFetching,children:c.isFetching?"Cargando...":"Refrescar"})]}),c.isLoading&&e.jsx("p",{children:"Cargando servicios..."}),c.isError&&e.jsx("p",{className:"error",children:c.error.message}),!c.isLoading&&!c.isError&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Última Compra"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:S.map(g=>{const F=s?.id===g.id;return e.jsxs("tr",{className:F?"selected":"",onClick:()=>a(g),children:[e.jsx("td",{className:"mono",children:g.code}),e.jsx("td",{children:g.name}),e.jsx("td",{className:"mono small",children:y(g.lastPurchaseDate)}),e.jsx("td",{children:e.jsx("span",{className:`badge ${g.active?"badge-success":"badge-muted"}`,children:g.active?"Activo":"Inactivo"})}),e.jsx("td",{children:e.jsx("button",{className:"btn ghost small",type:"button",onClick:v=>{v.stopPropagation(),f(g)},children:"Editar"})})]},g.id)})})]})}),S.length===0&&e.jsx("div",{className:"empty-state",children:e.jsx("p",{className:"muted",children:"No hay servicios registrados"})}),s&&e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Detalles del Servicio"}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Código:"}),e.jsx("span",{className:"mono",children:s.code})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Nombre:"}),e.jsx("span",{children:s.name})]}),s.description&&e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Descripción:"}),e.jsx("span",{children:s.description})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Última compra:"}),e.jsx("span",{children:y(s.lastPurchaseDate)})]}),e.jsxs("div",{className:"detail-row",children:[e.jsx("span",{className:"muted",children:"Estado:"}),e.jsx("span",{children:s.active?"Activo":"Inactivo"})]}),e.jsxs("div",{className:"inline-actions",style:{marginTop:"1rem"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>f(s),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:p,disabled:N.isPending,children:N.isPending?"Eliminando...":"Eliminar"})]})]})]}),h&&e.jsx("div",{className:"modal-overlay",onClick:()=>i(!1),children:e.jsxs("div",{className:"modal",onClick:g=>g.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h2",{children:r?"Editar Servicio":"Nuevo Servicio"}),e.jsx("button",{className:"btn-close",onClick:()=>i(!1),children:"×"})]}),e.jsxs("form",{onSubmit:k,children:[e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Código *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:m.code,onChange:g=>u({...m,code:g.target.value}),placeholder:"Ej: SRV-001"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Nombre *"}),e.jsx("input",{className:"input",type:"text",required:!0,value:m.name,onChange:g=>u({...m,name:g.target.value}),placeholder:"Ej: Consultoría de TI"})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Descripción (opcional)"}),e.jsx("textarea",{className:"input",rows:3,value:m.description??"",onChange:g=>u({...m,description:g.target.value}),placeholder:"Descripción del servicio"})]}),e.jsx("div",{className:"form-group",children:e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:m.active??!0,onChange:g=>u({...m,active:g.target.checked})}),"Activo"]})}),e.jsxs("div",{className:"modal-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>i(!1),disabled:b.isPending||l.isPending,children:"Cancelar"}),e.jsx("button",{className:"btn primary",type:"submit",disabled:b.isPending||l.isPending,children:b.isPending||l.isPending?"Guardando...":r?"Actualizar":"Crear"})]}),(b.isError||l.isError)&&e.jsx("p",{className:"error",children:(b.error||l.error)?.message??"Error al guardar"})]})]})})]})}const oe={productId:"",direction:"increase",quantity:"0",unitCost:"0",reason:"",expDate:""};function $t({open:s,onClose:a,onApplied:h}){const[i,r]=x.useState(oe);x.useEffect(()=>{s||r(oe)},[s]);const d=P({queryKey:["products",{dialog:"inventory-adjustment"}],queryFn:()=>Y({size:200,status:"all"}),enabled:s}),t=x.useMemo(()=>d.data?.content??[],[d.data]),n=O({mutationFn:()=>{if(!i.productId)throw new Error("Selecciona un producto");const u=Number(i.quantity);if(!Number.isFinite(u)||u<=0)throw new Error("La cantidad debe ser mayor a cero");const j=i.direction,c=Number(i.unitCost||0);if(j==="increase"&&(Number.isNaN(c)||c<0))throw new Error("El costo unitario debe ser positivo");const b={productId:i.productId,quantity:u,direction:j,reason:i.reason.trim()||"Ajuste manual",unitCost:j==="increase"?c:void 0,expDate:i.expDate||void 0};return ft(b)},onSuccess:()=>{h?.(),r(oe),a()}}),m=u=>{u.preventDefault(),!n.isPending&&n.mutate()};return e.jsx(X,{open:s,title:"Ajuste de stock",onClose:()=>{n.isPending||a()},children:e.jsxs("form",{className:"form-grid",onSubmit:m,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Producto *"}),e.jsxs("select",{className:"input",value:i.productId,onChange:u=>r(j=>({...j,productId:u.target.value})),disabled:n.isPending,required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un producto"}),t.map(u=>e.jsx("option",{value:u.id,children:u.name},u.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Tipo de ajuste"}),e.jsxs("select",{className:"input",value:i.direction,onChange:u=>r(j=>({...j,direction:u.target.value})),disabled:n.isPending,children:[e.jsx("option",{value:"increase",children:"Incremento"}),e.jsx("option",{value:"decrease",children:"Disminucion"})]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Cantidad *"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:i.quantity,onChange:u=>r(j=>({...j,quantity:u.target.value})),disabled:n.isPending,required:!0})]}),i.direction==="increase"&&e.jsxs("label",{children:[e.jsx("span",{children:"Costo unitario"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:i.unitCost,onChange:u=>r(j=>({...j,unitCost:u.target.value})),disabled:n.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de vencimiento"}),e.jsx("input",{className:"input",type:"date",value:i.expDate,onChange:u=>r(j=>({...j,expDate:u.target.value})),disabled:n.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Motivo"}),e.jsx("textarea",{className:"input",rows:3,value:i.reason,onChange:u=>r(j=>({...j,reason:u.target.value})),placeholder:"Regularizacion, inventario, merma, etc.",disabled:n.isPending})]}),n.isError&&e.jsx("p",{className:"error",children:n.error?.message??"No se pudo registrar el ajuste"}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:n.isPending,children:n.isPending?"Guardando...":"Registrar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:a,disabled:n.isPending,children:"Cancelar"})]})]})})}async function Qt(s){const a=new URLSearchParams;s.productId&&a.append("productId",s.productId),s.type&&a.append("type",s.type),s.from&&a.append("from",s.from),s.to&&a.append("to",s.to),a.append("page",String(s.page??0)),a.append("size",String(s.size));const h=await fetch(`/api/v1/inventory/movements?${a}`);if(!h.ok)throw new Error("Error al cargar movimientos");return h.json()}const Ie=[{value:"",label:"Todos los tipos"},{value:"MANUAL_IN",label:"Entrada manual"},{value:"MANUAL_OUT",label:"Salida manual"},{value:"SALE_OUT",label:"Venta"},{value:"SALE_CANCEL",label:"Cancelación venta"},{value:"PURCHASE_IN",label:"Compra"}];function Kt(){const[s,a]=x.useState(0),[h,i]=x.useState(""),[r,d]=x.useState(""),[t,n]=x.useState(""),m=P({queryKey:["inventory-movements",s,h,r,t],queryFn:()=>Qt({type:h||void 0,from:r?new Date(r).toISOString():void 0,to:t?new Date(t+"T23:59:59").toISOString():void 0,page:s,size:20})}),u=c=>Ie.find(b=>b.value===c)?.label??c,j=c=>{switch(c){case"MANUAL_IN":case"PURCHASE_IN":return"status active";case"MANUAL_OUT":case"SALE_OUT":return"status cancelled";case"SALE_CANCEL":return"status warning";default:return"status"}};return e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Historial de Movimientos (Auditoría)"}),e.jsx("p",{className:"muted",style:{marginBottom:"1rem"},children:"Registro completo de todos los movimientos de inventario con trazabilidad"}),e.jsxs("div",{className:"filter-bar",style:{marginBottom:"1rem"},children:[e.jsx("select",{className:"input",value:h,onChange:c=>{i(c.target.value),a(0)},children:Ie.map(c=>e.jsx("option",{value:c.value,children:c.label},c.value))}),e.jsx("input",{type:"date",className:"input",value:r,onChange:c=>{d(c.target.value),a(0)},placeholder:"Desde"}),e.jsx("input",{type:"date",className:"input",value:t,onChange:c=>{n(c.target.value),a(0)},placeholder:"Hasta"}),(h||r||t)&&e.jsx("button",{className:"btn ghost",onClick:()=>{i(""),d(""),n(""),a(0)},children:"Limpiar filtros"})]}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Stock Anterior"}),e.jsx("th",{children:"Stock Nuevo"}),e.jsx("th",{children:"Usuario"}),e.jsx("th",{children:"IP"}),e.jsx("th",{children:"Nota"})]})}),e.jsxs("tbody",{children:[m.isLoading&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"muted",children:"Cargando movimientos..."})}),m.isError&&e.jsx("tr",{children:e.jsxs("td",{colSpan:9,className:"error",children:["Error: ",m.error.message]})}),!m.isLoading&&!m.isError&&m.data?.content.map(c=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:new Date(c.createdAt).toLocaleString("es-CL")}),e.jsx("td",{children:e.jsx("span",{className:j(c.type),children:u(c.type)})}),e.jsx("td",{children:c.productName}),e.jsxs("td",{className:"mono",children:[c.type.includes("OUT")?"-":"+",Number(c.qty).toFixed(2)]}),e.jsx("td",{className:"mono",children:c.previousQty!=null?Number(c.previousQty).toFixed(2):"-"}),e.jsx("td",{className:"mono",children:c.newQty!=null?Number(c.newQty).toFixed(2):"-"}),e.jsx("td",{className:"small",children:c.createdBy??"Sistema"}),e.jsx("td",{className:"mono small",children:c.userIp??"-"}),e.jsx("td",{className:"small",children:c.note??"-"})]},c.id)),!m.isLoading&&!m.isError&&m.data?.content.length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:9,className:"muted",children:"No hay movimientos"})})]})]})}),m.data&&m.data.totalPages>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:s===0,onClick:()=>a(c=>Math.max(0,c-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Página ",s+1," de ",m.data.totalPages]}),e.jsx("button",{className:"btn",disabled:s+1>=m.data.totalPages,onClick:()=>a(c=>c+1),children:"Siguiente"})]}),m.data&&e.jsx("div",{style:{marginTop:"1rem",padding:"0.75rem",background:"#f5f5f5",borderRadius:"4px"},children:e.jsxs("p",{className:"muted small",children:[e.jsx("strong",{children:"Total de registros:"})," ",m.data.totalElements," movimientos"]})})]})}function Vt(){x.useMemo(()=>xe(),[]);const s=P({queryKey:["products-rotation"],queryFn:()=>Y({size:200,status:"all"})}),a=s.data?.content??[],h=x.useMemo(()=>{const i=a.map(l=>{const N=Number(l.stock??0),f=Number(l.currentPrice??0)*.7,k=N*f,p=Math.random()*20;return{id:l.id,name:l.name??"Sin nombre",stock:N,value:k,rotation:p,category:l.category??"General"}}),r=i.reduce((l,N)=>l+N.value,0),d=[...i].sort((l,N)=>N.value-l.value);let t=0;const n=d.map(l=>{t+=l.value;const N=r>0?t/r*100:0;return{...l,class:N<=80?"A":N<=95?"B":"C"}}),m=n.filter(l=>l.class==="A"),u=n.filter(l=>l.class==="B"),j=n.filter(l=>l.class==="C"),c=[...i].sort((l,N)=>N.rotation-l.rotation).slice(0,5),b=[...i].sort((l,N)=>l.rotation-N.rotation).slice(0,5);return{classA:m,classB:u,classC:j,topMovers:c,slowMovers:b,totalValue:r}},[a]);return s.isLoading?e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100 mb-4",children:"Análisis de Rotación"}),e.jsx("div",{className:"animate-pulse bg-neutral-800 rounded-lg h-80"})]}):e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100 mb-4",children:"Análisis de Rotación (ABC)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-green-950 border border-green-800 rounded-lg p-4",children:[e.jsx("h4",{className:"text-green-400 font-medium mb-2",children:"📊 Clase A (80%)"}),e.jsx("p",{className:"text-green-100 text-2xl font-bold",children:h.classA.length}),e.jsx("p",{className:"text-green-300 text-sm",children:"Productos críticos"})]}),e.jsxs("div",{className:"bg-yellow-950 border border-yellow-800 rounded-lg p-4",children:[e.jsx("h4",{className:"text-yellow-400 font-medium mb-2",children:"📈 Clase B (15%)"}),e.jsx("p",{className:"text-yellow-100 text-2xl font-bold",children:h.classB.length}),e.jsx("p",{className:"text-yellow-300 text-sm",children:"Productos importantes"})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("h4",{className:"text-neutral-300 font-medium mb-2",children:"📉 Clase C (5%)"}),e.jsx("p",{className:"text-neutral-100 text-2xl font-bold",children:h.classC.length}),e.jsx("p",{className:"text-neutral-400 text-sm",children:"Baja prioridad"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-neutral-300 font-medium mb-3",children:"🔥 Top Movers"}),e.jsx("div",{className:"space-y-2",children:h.topMovers.map((i,r)=>e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("span",{className:"text-neutral-100 font-medium",children:[r===0?"🥇":r===1?"🥈":r===2?"🥉":`${r+1}.`," ",i.name]}),e.jsxs("span",{className:"text-green-400 font-semibold",children:[i.rotation.toFixed(1)," u/mes"]})]})},i.id))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-neutral-300 font-medium mb-3",children:"🐌 Slow Movers"}),e.jsx("div",{className:"space-y-2",children:h.slowMovers.map(i=>e.jsx("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-neutral-100 font-medium",children:i.name}),e.jsxs("span",{className:"text-red-400 font-semibold",children:[i.rotation.toFixed(1)," u/mes"]})]})},i.id))})]})]}),e.jsxs("div",{className:"mt-4 bg-blue-950 border border-blue-800 rounded-lg p-3 text-blue-400 text-sm",children:["💡 ",e.jsx("strong",{children:"Insight:"})," Clasificación ABC ayuda a priorizar gestión de inventario según valor"]})]})}function zt(){const s=x.useMemo(()=>xe(),[]),a=n=>s.format(n??0),h=P({queryKey:["inventory-summary"],queryFn:de}),i=h.data,r=Number(i?.totalValue??0),d=x.useMemo(()=>[{month:"Hace 3m",value:r*.75},{month:"Hace 2m",value:r*.85},{month:"Hace 1m",value:r*.92},{month:"Actual",value:r}],[r]),t=Math.max(...d.map(n=>n.value));return h.isLoading?e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100 mb-4",children:"Evolución de Valorización"}),e.jsx("div",{className:"animate-pulse bg-neutral-800 rounded-lg h-64"})]}):e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-neutral-100",children:"Evolución de Valorización"}),e.jsxs("span",{className:"px-3 py-1 bg-blue-950 text-blue-400 border border-blue-800 rounded-full text-sm",children:["📈 Tendencia: +",((r/(r*.75)-1)*100).toFixed(1),"%"]})]}),e.jsx("div",{className:"space-y-4 mb-6",children:d.map((n,m)=>{const u=t>0?n.value/t*100:0,j=m===d.length-1;return e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("span",{className:"text-neutral-300 text-sm",children:n.month}),e.jsx("span",{className:"text-neutral-100 font-semibold",children:a(n.value)})]}),e.jsx("div",{className:"w-full bg-neutral-800 rounded-full h-3 overflow-hidden",children:e.jsx("div",{className:`h-full ${j?"bg-gradient-to-r from-blue-600 to-blue-400":"bg-neutral-600"} transition-all`,style:{width:`${u}%`}})})]},n.month)})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-neutral-400 text-sm",children:"Valor Total"}),e.jsx("p",{className:"text-neutral-100 text-xl font-bold",children:a(r)})]}),e.jsxs("div",{className:"bg-neutral-800 border border-neutral-700 rounded-lg p-3",children:[e.jsx("p",{className:"text-neutral-400 text-sm",children:"Productos"}),e.jsx("p",{className:"text-neutral-100 text-xl font-bold",children:i?.activeProducts??0})]})]})]})}function _t(){const s=P({queryKey:["products-replenishment"],queryFn:()=>Y({size:100,status:"all"})}),a=s.data?.content??[],h=x.useMemo(()=>a.map(i=>{const r=Number(i.stock??0),d=Math.random()*5+1,t=7,n=d*3,m=d*t+n,u=d*30,j=r<m,c=d>0?r/d:999,b=Math.max(0,u-r);return{id:i.id,name:i.name??"Sin nombre",stock:r,reorderPoint:m,daysOfCoverage:c,suggestedOrder:b,needsReplenishment:j,urgency:c<7?"critical":c<14?"high":"normal"}}).filter(i=>i.needsReplenishment).sort((i,r)=>i.daysOfCoverage-r.daysOfCoverage).slice(0,8),[a]);return s.isLoading?e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100 mb-4",children:"Panel de Reabastecimiento"}),e.jsx("div",{className:"animate-pulse bg-neutral-800 rounded-lg h-80"})]}):e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-neutral-100",children:"Panel de Reabastecimiento"}),e.jsxs("span",{className:"px-3 py-1 bg-orange-950 text-orange-400 border border-orange-800 rounded-full text-sm",children:[h.length," productos requieren pedido"]})]}),h.length===0?e.jsx("div",{className:"bg-green-950 border border-green-800 rounded-lg p-4 text-center",children:e.jsx("p",{className:"text-green-400",children:"✅ Todos los productos tienen stock suficiente"})}):e.jsx("div",{className:"space-y-3",children:h.map(i=>{const r={critical:{bg:"bg-red-950",border:"border-red-800",text:"text-red-400",icon:"🔴"},high:{bg:"bg-yellow-950",border:"border-yellow-800",text:"text-yellow-400",icon:"⚠️"},normal:{bg:"bg-blue-950",border:"border-blue-800",text:"text-blue-400",icon:"ℹ️"}}[i.urgency]||{bg:"bg-neutral-950",border:"border-neutral-800",text:"text-neutral-400",icon:"ℹ️"};return e.jsxs("div",{className:`${r.bg} border ${r.border} rounded-lg p-4`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-lg",children:r.icon}),e.jsx("h4",{className:"text-neutral-100 font-medium",children:i.name})]}),e.jsxs("p",{className:"text-neutral-400 text-sm",children:["Stock actual:"," ",e.jsxs("strong",{className:r.text,children:[i.stock," unidades"]})]}),e.jsxs("p",{className:"text-neutral-400 text-sm",children:["Cobertura: ",e.jsxs("strong",{children:[i.daysOfCoverage.toFixed(0)," días"]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-neutral-400 text-xs mb-1",children:"Cantidad sugerida"}),e.jsx("p",{className:`${r.text} text-2xl font-bold`,children:Math.ceil(i.suggestedOrder)})]})]}),e.jsx("button",{className:`w-full mt-2 px-4 py-2 ${r.bg} ${r.text} border ${r.border} rounded-lg hover:bg-opacity-80 transition`,children:"Generar Orden de Compra"})]},i.id)})}),e.jsxs("div",{className:"mt-4 bg-blue-950 border border-blue-800 rounded-lg p-3 text-blue-400 text-sm",children:["💡 ",e.jsx("strong",{children:"Sugerencia:"})," Punto de reorden calculado según consumo + plazo de entrega + stock de seguridad"]})]})}function Gt(){const s=x.useMemo(()=>xe(),[]),a=m=>s.format(m??0),h=P({queryKey:["inventory-summary"],queryFn:de}),i=P({queryKey:["products-efficiency"],queryFn:()=>Y({size:200,status:"all"})}),r=h.data,d=i.data?.content??[],t=Number(r?.totalValue??0),n=x.useMemo(()=>{const m=d.length,c=d.reduce((y,g)=>y+Number(g.stock??0),0)/15,b=d.filter(y=>Number(y.stock??0)===0).length,l=m>0?b/m*100:0,N=12,w=150,f=(w-N)/w*100,S=t*.05/12;return{daysOfCoverage:c,stockOutRate:l,inventoryAccuracy:f,monthlyStorageCost:S,outOfStock:b,totalProducts:m}},[d,t]);return h.isLoading||i.isLoading?e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100 mb-4",children:"Métricas de Eficiencia"}),e.jsx("div",{className:"animate-pulse bg-neutral-800 rounded-lg h-64"})]}):e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5",children:[e.jsx("h3",{className:"text-neutral-100 mb-4",children:"Métricas de Eficiencia"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"bg-blue-950 border border-blue-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-blue-400 font-medium",children:"📅 Días de Cobertura"}),e.jsx("span",{className:"text-blue-300 text-2xl font-bold",children:n.daysOfCoverage.toFixed(0)})]}),e.jsx("p",{className:"text-blue-300 text-sm",children:"Stock actual / Consumo diario promedio"}),e.jsx("div",{className:"mt-2 w-full bg-blue-900 rounded-full h-2",children:e.jsx("div",{className:"bg-blue-500 h-full rounded-full transition-all",style:{width:`${Math.min(n.daysOfCoverage/60*100,100)}%`}})})]}),e.jsxs("div",{className:"bg-red-950 border border-red-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-red-400 font-medium",children:"📉 Tasa de Quiebre"}),e.jsxs("span",{className:"text-red-300 text-2xl font-bold",children:[n.stockOutRate.toFixed(1),"%"]})]}),e.jsxs("p",{className:"text-red-300 text-sm",children:[n.outOfStock," de ",n.totalProducts," productos sin stock"]}),e.jsx("div",{className:"mt-2 w-full bg-red-900 rounded-full h-2",children:e.jsx("div",{className:"bg-red-500 h-full rounded-full transition-all",style:{width:`${n.stockOutRate}%`}})})]}),e.jsxs("div",{className:"bg-green-950 border border-green-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-green-400 font-medium",children:"✅ Precisión Inventario"}),e.jsxs("span",{className:"text-green-300 text-2xl font-bold",children:[n.inventoryAccuracy.toFixed(1),"%"]})]}),e.jsx("p",{className:"text-green-300 text-sm",children:"Basado en movimientos vs ajustes"}),e.jsx("div",{className:"mt-2 w-full bg-green-900 rounded-full h-2",children:e.jsx("div",{className:"bg-green-500 h-full rounded-full transition-all",style:{width:`${n.inventoryAccuracy}%`}})})]}),e.jsxs("div",{className:"bg-purple-950 border border-purple-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h4",{className:"text-purple-400 font-medium",children:"💰 Costo Almacenamiento"}),e.jsx("span",{className:"text-purple-300 text-2xl font-bold",children:a(n.monthlyStorageCost)})]}),e.jsx("p",{className:"text-purple-300 text-sm",children:"Estimado mensual (~5% anual del valor)"})]})]}),e.jsxs("div",{className:"mt-4 bg-neutral-800 border border-neutral-700 rounded-lg p-4",children:[e.jsx("h4",{className:"text-neutral-100 font-medium mb-2",children:"Recomendaciones"}),e.jsxs("ul",{className:"space-y-1 text-neutral-300 text-sm",children:[n.stockOutRate>10&&e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-red-400",children:"⚠️"}),e.jsx("span",{children:"Tasa de quiebre alta. Revisar puntos de reorden."})]}),n.daysOfCoverage>90&&e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-yellow-400",children:"⚠️"}),e.jsx("span",{children:"Sobrestock detectado. Evaluar reducción de inventario."})]}),n.inventoryAccuracy<95&&e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-orange-400",children:"⚠️"}),e.jsx("span",{children:"Baja precisión. Realizar conteo cíclico."})]}),n.stockOutRate<=5&&n.inventoryAccuracy>=95&&e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-green-400",children:"✅"}),e.jsx("span",{children:"Inventario en niveles óptimos. ¡Buen trabajo!"})]})]})]})]})}function Ht(){const{data:s,isLoading:a,error:h}=P({queryKey:["inventoryKPIs"],queryFn:yt,refetchInterval:6e4});if(a)return e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:Array.from({length:6}).map((t,n)=>e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-4 bg-neutral-800 rounded w-2/3 mb-3"}),e.jsx("div",{className:"h-8 bg-neutral-800 rounded w-1/2 mb-2"}),e.jsx("div",{className:"h-3 bg-neutral-800 rounded w-3/4"})]},n))});if(h)return e.jsx("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-6 text-center",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar KPIs de inventario"})});const i=t=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0}).format(t),r=t=>new Intl.NumberFormat("es-CL").format(t),d=[{title:"Cobertura de Stock",value:s?.stockCoverageDays!==null&&s?.stockCoverageDays!==void 0?`${s.stockCoverageDays.toFixed(1)} días`:"N/A",subtitle:"Duración estimada del inventario",color:"text-blue-400",bgColor:"bg-blue-900/20",borderColor:"border-blue-800"},{title:"Ratio de Rotación",value:s?.turnoverRatio?s.turnoverRatio.toFixed(2):"0.00",subtitle:"Veces por año (anualizado)",color:"text-green-400",bgColor:"bg-green-900/20",borderColor:"border-green-800"},{title:"Stock Muerto",value:i(s?.deadStockValue||0),subtitle:`${s?.deadStockCount||0} productos sin movimiento >90 días`,color:"text-orange-400",bgColor:"bg-orange-900/20",borderColor:"border-orange-800"},{title:"Tiempo de Reposición",value:`${s?.averageLeadTimeDays||0} días`,subtitle:"Tiempo promedio de lead time",color:"text-purple-400",bgColor:"bg-purple-900/20",borderColor:"border-purple-800"},{title:"Stock Crítico",value:r(s?.criticalStockProducts||0),subtitle:"Productos bajo umbral",color:"text-red-400",bgColor:"bg-red-900/20",borderColor:"border-red-800"},{title:"Sobrestock",value:i(s?.overstockValue||0),subtitle:`${s?.overstockCount||0} productos excedidos`,color:"text-yellow-400",bgColor:"bg-yellow-900/20",borderColor:"border-yellow-800"}];return e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4",children:d.map((t,n)=>e.jsxs("div",{className:`${t.bgColor} border ${t.borderColor} rounded-lg p-6 transition-all hover:scale-[1.02]`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsx("h3",{className:"text-sm font-medium text-neutral-400",children:t.title}),e.jsx("div",{className:`w-10 h-10 rounded-lg ${t.bgColor} border ${t.borderColor} flex items-center justify-center`,children:e.jsx("span",{className:`text-xl ${t.color}`,children:"●"})})]}),e.jsx("div",{className:`text-2xl font-bold ${t.color} mb-1`,children:t.value}),e.jsx("p",{className:"text-xs text-neutral-500",children:t.subtitle})]},n))})}function Wt(){const{data:s,isLoading:a,error:h}=P({queryKey:["stockMovementStats"],queryFn:Ct,refetchInterval:6e4});if(a)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-neutral-800 rounded w-1/3 mb-6"}),e.jsx("div",{className:"h-64 bg-neutral-800 rounded"})]});if(h)return e.jsx("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-6 text-center",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar estadísticas de movimiento"})});const i=t=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0}).format(t),r=t=>new Intl.NumberFormat("es-CL").format(t),d=[{name:"Entradas",valor:s?.totalInflows||0,transacciones:s?.inflowTransactions||0},{name:"Salidas",valor:s?.totalOutflows||0,transacciones:s?.outflowTransactions||0}];return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-100 mb-2",children:"Resumen de Movimientos (últimos 30 días)"}),e.jsx("p",{className:"text-sm text-neutral-400",children:"Análisis de entradas y salidas de inventario"})]}),e.jsx("div",{className:"mb-8",children:e.jsx(he,{width:"100%",height:300,children:e.jsxs(ge,{data:d,margin:{top:20,right:30,left:20,bottom:5},children:[e.jsx(be,{strokeDasharray:"3 3",stroke:"#404040"}),e.jsx(pe,{dataKey:"name",stroke:"#a3a3a3"}),e.jsx(je,{stroke:"#a3a3a3",tickFormatter:t=>i(t)}),e.jsx(Ne,{contentStyle:{backgroundColor:"#262626",border:"1px solid #404040",borderRadius:"8px"},labelStyle:{color:"#f5f5f5"},formatter:t=>i(t)}),e.jsx(ve,{}),e.jsx(ae,{dataKey:"valor",fill:"#3b82f6",name:"Valor Total",radius:[8,8,0,0]})]})})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-green-900/20 border border-green-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-neutral-400 mb-1",children:"Total Entradas"}),e.jsx("div",{className:"text-2xl font-bold text-green-400",children:i(s?.totalInflows||0)}),e.jsxs("div",{className:"text-xs text-neutral-500 mt-1",children:[s?.inflowTransactions||0," transacciones"]})]}),e.jsxs("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-neutral-400 mb-1",children:"Total Salidas"}),e.jsx("div",{className:"text-2xl font-bold text-red-400",children:i(s?.totalOutflows||0)}),e.jsxs("div",{className:"text-xs text-neutral-500 mt-1",children:[s?.outflowTransactions||0," transacciones"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-neutral-300 mb-3",children:"Top 5 Entradas"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"border-b border-neutral-800",children:e.jsxs("tr",{className:"text-left text-neutral-400",children:[e.jsx("th",{className:"pb-2 font-medium",children:"Producto"}),e.jsx("th",{className:"pb-2 font-medium text-right",children:"Cantidad"}),e.jsx("th",{className:"pb-2 font-medium text-right",children:"Valor"})]})}),e.jsx("tbody",{children:s?.topInflowProducts&&s.topInflowProducts.length>0?s.topInflowProducts.map((t,n)=>e.jsxs("tr",{className:"border-b border-neutral-800/50",children:[e.jsx("td",{className:"py-2 text-neutral-300",children:t.productName}),e.jsx("td",{className:"py-2 text-right text-neutral-400",children:r(t.quantity)}),e.jsx("td",{className:"py-2 text-right text-green-400",children:i(t.value)})]},n)):e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-4 text-center text-neutral-500",children:"Sin movimientos de entrada"})})})]})})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold text-neutral-300 mb-3",children:"Top 5 Salidas"}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"border-b border-neutral-800",children:e.jsxs("tr",{className:"text-left text-neutral-400",children:[e.jsx("th",{className:"pb-2 font-medium",children:"Producto"}),e.jsx("th",{className:"pb-2 font-medium text-right",children:"Cantidad"}),e.jsx("th",{className:"pb-2 font-medium text-right",children:"Valor"})]})}),e.jsx("tbody",{children:s?.topOutflowProducts&&s.topOutflowProducts.length>0?s.topOutflowProducts.map((t,n)=>e.jsxs("tr",{className:"border-b border-neutral-800/50",children:[e.jsx("td",{className:"py-2 text-neutral-300",children:t.productName}),e.jsx("td",{className:"py-2 text-right text-neutral-400",children:r(t.quantity)}),e.jsx("td",{className:"py-2 text-right text-red-400",children:i(t.value)})]},n)):e.jsx("tr",{children:e.jsx("td",{colSpan:3,className:"py-4 text-center text-neutral-500",children:"Sin movimientos de salida"})})})]})})]})]})]})}function Yt(){const{data:s,isLoading:a,error:h}=P({queryKey:["abcAnalysis"],queryFn:()=>ue(),refetchInterval:3e5});if(a)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-neutral-800 rounded w-1/3 mb-6"}),e.jsx("div",{className:"h-80 bg-neutral-800 rounded"})]});if(h)return e.jsx("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-6 text-center",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar análisis ABC"})});if(!s||s.length===0)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 text-center",children:[e.jsx("p",{className:"text-neutral-400",children:"No hay datos suficientes para análisis ABC"}),e.jsx("p",{className:"text-xs text-neutral-500 mt-2",children:"El análisis requiere productos con inventario valorizado"})]});const i=l=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0,maximumFractionDigits:0}).format(l),r=s.filter(l=>l.classification==="A"),d=s.filter(l=>l.classification==="B"),t=s.filter(l=>l.classification==="C"),n=r.reduce((l,N)=>l+N.totalValue,0),m=d.reduce((l,N)=>l+N.totalValue,0),u=t.reduce((l,N)=>l+N.totalValue,0),j=n+m+u,c=[{name:"Clase A",productos:r.length,valor:n,porcentaje:(n/j*100).toFixed(1)},{name:"Clase B",productos:d.length,valor:m,porcentaje:(m/j*100).toFixed(1)},{name:"Clase C",productos:t.length,valor:u,porcentaje:(u/j*100).toFixed(1)}],b={A:"#22c55e",B:"#eab308",C:"#f97316"};return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"text-xl font-semibold text-neutral-100 mb-2",children:"Análisis ABC de Inventario"}),e.jsx("p",{className:"text-sm text-neutral-400",children:"Clasificación por valor de inventario (Principio de Pareto 80-15-5)"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-green-900/20 border border-green-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-neutral-300",children:"Clase A"}),e.jsxs("span",{className:"px-2 py-1 bg-green-900/40 border border-green-800 rounded text-xs font-semibold text-green-400",children:[r.length," productos"]})]}),e.jsx("div",{className:"text-2xl font-bold text-green-400 mb-1",children:i(n)}),e.jsxs("div",{className:"text-xs text-neutral-400",children:[(n/j*100).toFixed(1),"% del valor total"]}),e.jsx("div",{className:"text-xs text-neutral-500 mt-2",children:"Alta rotación - Control diario"})]}),e.jsxs("div",{className:"bg-yellow-900/20 border border-yellow-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-neutral-300",children:"Clase B"}),e.jsxs("span",{className:"px-2 py-1 bg-yellow-900/40 border border-yellow-800 rounded text-xs font-semibold text-yellow-400",children:[d.length," productos"]})]}),e.jsx("div",{className:"text-2xl font-bold text-yellow-400 mb-1",children:i(m)}),e.jsxs("div",{className:"text-xs text-neutral-400",children:[(m/j*100).toFixed(1),"% del valor total"]}),e.jsx("div",{className:"text-xs text-neutral-500 mt-2",children:"Rotación media - Control semanal"})]}),e.jsxs("div",{className:"bg-orange-900/20 border border-orange-800 rounded-lg p-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-neutral-300",children:"Clase C"}),e.jsxs("span",{className:"px-2 py-1 bg-orange-900/40 border border-orange-800 rounded text-xs font-semibold text-orange-400",children:[t.length," productos"]})]}),e.jsx("div",{className:"text-2xl font-bold text-orange-400 mb-1",children:i(u)}),e.jsxs("div",{className:"text-xs text-neutral-400",children:[(u/j*100).toFixed(1),"% del valor total"]}),e.jsx("div",{className:"text-xs text-neutral-500 mt-2",children:"Baja rotación - Control mensual"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-sm font-semibold text-neutral-300 mb-3",children:"Distribución de Valor por Clasificación"}),e.jsx(he,{width:"100%",height:300,children:e.jsxs(ge,{data:c,margin:{top:20,right:30,left:20,bottom:5},children:[e.jsx(be,{strokeDasharray:"3 3",stroke:"#404040"}),e.jsx(pe,{dataKey:"name",stroke:"#a3a3a3"}),e.jsx(je,{stroke:"#a3a3a3",tickFormatter:l=>i(l)}),e.jsx(Ne,{contentStyle:{backgroundColor:"#262626",border:"1px solid #404040",borderRadius:"8px"},labelStyle:{color:"#f5f5f5"},formatter:l=>i(l)}),e.jsx(ve,{}),e.jsx(ae,{dataKey:"valor",name:"Valor Total",radius:[8,8,0,0],children:c.map((l,N)=>e.jsx(Me,{fill:N===0?b.A:N===1?b.B:b.C},`cell-${N}`))})]})})]}),e.jsx("div",{className:"bg-neutral-800/50 border border-neutral-700 rounded-lg p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-center",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Total Productos"}),e.jsx("div",{className:"text-lg font-semibold text-neutral-100",children:s.length})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Valor Total Inventario"}),e.jsx("div",{className:"text-lg font-semibold text-neutral-100",children:i(j)})]}),e.jsxs("div",{children:[e.jsx("div",{className:"text-xs text-neutral-400 mb-1",children:"Concentración Clase A"}),e.jsxs("div",{className:"text-lg font-semibold text-green-400",children:[(r.length/s.length*100).toFixed(1),"% productos"]})]})]})})]})}function Xt(){const[s,a]=x.useState("all"),[h,i]=x.useState(""),[r,d]=x.useState(1),t=10,{data:n,isLoading:m,error:u}=P({queryKey:["abcAnalysis"],queryFn:()=>ue(),refetchInterval:3e5});if(m)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-neutral-800 rounded w-1/3 mb-4"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:5}).map((p,S)=>e.jsx("div",{className:"h-12 bg-neutral-800 rounded"},S))})]});if(u||!n)return e.jsx("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-6 text-center",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar productos"})});const j=p=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0,maximumFractionDigits:0}).format(p),c=p=>p?new Date(p).toLocaleDateString("es-CL"):"N/A",b=n.filter(p=>{const S=s==="all"||p.classification===s,y=p.productName.toLowerCase().includes(h.toLowerCase())||p.category.toLowerCase().includes(h.toLowerCase());return S&&y}),l=Math.ceil(b.length/t),N=(r-1)*t,w=N+t,f=b.slice(N,w),k=p=>{switch(p){case"A":return"bg-green-900/40 border-green-800 text-green-400";case"B":return"bg-yellow-900/40 border-yellow-800 text-yellow-400";case"C":return"bg-orange-900/40 border-orange-800 text-orange-400";default:return"bg-neutral-800 border-neutral-700 text-neutral-400"}};return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:[e.jsxs("div",{className:"mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-100 mb-4",children:"Productos por Clasificación ABC"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3 mb-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx("input",{type:"text",placeholder:"Buscar producto o categoría...",value:h,onChange:p=>{i(p.target.value),d(1)},className:"w-full px-3 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-100 placeholder-neutral-500 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"})}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("button",{onClick:()=>{a("all"),d(1)},className:`px-3 py-2 rounded-lg text-xs font-medium border transition-colors ${s==="all"?"bg-blue-900/40 border-blue-800 text-blue-400":"bg-neutral-800 border-neutral-700 text-neutral-400 hover:bg-neutral-700"}`,children:["Todos (",n.length,")"]}),e.jsx("button",{onClick:()=>{a("A"),d(1)},className:`px-3 py-2 rounded-lg text-xs font-medium border transition-colors ${s==="A"?"bg-green-900/40 border-green-800 text-green-400":"bg-neutral-800 border-neutral-700 text-neutral-400 hover:bg-neutral-700"}`,children:"Clase A"}),e.jsx("button",{onClick:()=>{a("B"),d(1)},className:`px-3 py-2 rounded-lg text-xs font-medium border transition-colors ${s==="B"?"bg-yellow-900/40 border-yellow-800 text-yellow-400":"bg-neutral-800 border-neutral-700 text-neutral-400 hover:bg-neutral-700"}`,children:"Clase B"}),e.jsx("button",{onClick:()=>{a("C"),d(1)},className:`px-3 py-2 rounded-lg text-xs font-medium border transition-colors ${s==="C"?"bg-orange-900/40 border-orange-800 text-orange-400":"bg-neutral-800 border-neutral-700 text-neutral-400 hover:bg-neutral-700"}`,children:"Clase C"})]})]})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{className:"border-b border-neutral-800",children:e.jsxs("tr",{className:"text-left text-neutral-400",children:[e.jsx("th",{className:"pb-3 font-medium",children:"Clase"}),e.jsx("th",{className:"pb-3 font-medium",children:"Producto"}),e.jsx("th",{className:"pb-3 font-medium",children:"Categoría"}),e.jsx("th",{className:"pb-3 font-medium text-right",children:"Valor Total"}),e.jsx("th",{className:"pb-3 font-medium text-right",children:"% del Total"}),e.jsx("th",{className:"pb-3 font-medium text-right",children:"Cantidad"}),e.jsx("th",{className:"pb-3 font-medium text-right",children:"Frecuencia"}),e.jsx("th",{className:"pb-3 font-medium text-right",children:"Última Mov."})]})}),e.jsx("tbody",{children:f.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:8,className:"py-8 text-center text-neutral-500",children:"No se encontraron productos"})}):f.map(p=>e.jsxs("tr",{className:"border-b border-neutral-800/50 hover:bg-neutral-800/30",children:[e.jsx("td",{className:"py-3",children:e.jsx("span",{className:`inline-flex px-2.5 py-1 rounded-md text-xs font-semibold border ${k(p.classification)}`,children:p.classification})}),e.jsx("td",{className:"py-3 text-neutral-100 font-medium",children:p.productName}),e.jsx("td",{className:"py-3 text-neutral-400",children:p.category}),e.jsx("td",{className:"py-3 text-right text-neutral-100 font-medium",children:j(p.totalValue)}),e.jsxs("td",{className:"py-3 text-right text-neutral-400",children:[p.percentageOfTotalValue.toFixed(2),"%"]}),e.jsx("td",{className:"py-3 text-right text-neutral-400",children:p.totalQuantity.toLocaleString("es-CL")}),e.jsx("td",{className:"py-3 text-right text-neutral-400",children:p.salesFrequency}),e.jsx("td",{className:"py-3 text-right text-neutral-400 text-xs",children:c(p.lastMovementDate)})]},p.productId))})]})}),l>1&&e.jsxs("div",{className:"mt-4 flex items-center justify-between",children:[e.jsxs("div",{className:"text-xs text-neutral-500",children:["Mostrando ",N+1,"-",Math.min(w,b.length)," de"," ",b.length," productos"]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>d(p=>Math.max(1,p-1)),disabled:r===1,className:"px-3 py-1 bg-neutral-800 border border-neutral-700 rounded text-xs text-neutral-400 hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Anterior"}),e.jsxs("span",{className:"px-3 py-1 text-xs text-neutral-400",children:["Página ",r," de ",l]}),e.jsx("button",{onClick:()=>d(p=>Math.min(l,p+1)),disabled:r===l,className:"px-3 py-1 bg-neutral-800 border border-neutral-700 rounded text-xs text-neutral-400 hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Siguiente"})]})]})]})}function Zt(){const{data:s,isLoading:a}=P({queryKey:["abcAnalysis"],queryFn:()=>ue(),refetchInterval:3e5});if(a)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-6 bg-neutral-800 rounded w-2/3 mb-4"}),e.jsx("div",{className:"space-y-3",children:Array.from({length:3}).map((t,n)=>e.jsx("div",{className:"h-24 bg-neutral-800 rounded"},n))})]});const h=s?.filter(t=>t.classification==="A")||[],i=s?.filter(t=>t.classification==="B")||[],r=s?.filter(t=>t.classification==="C")||[],d=[{classification:"A",title:"Productos Clase A - Alta Prioridad",color:"green",bgColor:"bg-green-900/20",borderColor:"border-green-800",textColor:"text-green-400",count:h.length,strategies:[{icon:"📊",title:"Monitoreo Continuo",description:"Control diario de niveles de inventario y rotación"},{icon:"🎯",title:"Stock Óptimo",description:"Mantener niveles óptimos para evitar quiebres"},{icon:"🔄",title:"Reposición Frecuente",description:"Revisión y pedidos cada 1-3 días según demanda"},{icon:"📈",title:"Previsión Exacta",description:"Usar modelos de forecasting para proyectar demanda"}]},{classification:"B",title:"Productos Clase B - Prioridad Media",color:"yellow",bgColor:"bg-yellow-900/20",borderColor:"border-yellow-800",textColor:"text-yellow-400",count:i.length,strategies:[{icon:"📅",title:"Control Semanal",description:"Revisión de inventario cada 5-7 días"},{icon:"⚖️",title:"Stock Balanceado",description:"Mantener inventario moderado sin excesos"},{icon:"🔔",title:"Alertas Automáticas",description:"Configurar notificaciones de stock bajo"},{icon:"📊",title:"Análisis Trimestral",description:"Evaluar tendencias y ajustar políticas"}]},{classification:"C",title:"Productos Clase C - Baja Prioridad",color:"orange",bgColor:"bg-orange-900/20",borderColor:"border-orange-800",textColor:"text-orange-400",count:r.length,strategies:[{icon:"📆",title:"Revisión Mensual",description:"Control básico mensual o bimestral"},{icon:"📉",title:"Minimizar Inventario",description:"Reducir stock al mínimo necesario"},{icon:"🔍",title:"Evaluar Descontinuación",description:"Considerar eliminar productos de baja rotación"},{icon:"💡",title:"Pedidos por Demanda",description:"Comprar solo cuando hay orden confirmada"}]}];return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h3",{className:"text-lg font-semibold text-neutral-100 mb-2",children:"Estrategias de Gestión por Clasificación"}),e.jsx("p",{className:"text-xs text-neutral-400",children:"Recomendaciones operativas basadas en el análisis ABC"})]}),e.jsx("div",{className:"space-y-4",children:d.map(t=>e.jsxs("div",{className:`${t.bgColor} border ${t.borderColor} rounded-lg p-4`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:`text-sm font-semibold ${t.textColor}`,children:t.title}),e.jsxs("span",{className:`px-2 py-1 rounded text-xs font-semibold ${t.bgColor} border ${t.borderColor} ${t.textColor}`,children:[t.count," productos"]})]}),e.jsx("div",{className:"space-y-2",children:t.strategies.map((n,m)=>e.jsxs("div",{className:"flex items-start gap-3 bg-neutral-900/50 rounded-lg p-3",children:[e.jsx("div",{className:"text-xl flex-shrink-0",children:n.icon}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"text-xs font-medium text-neutral-200 mb-1",children:n.title}),e.jsx("div",{className:"text-xs text-neutral-400",children:n.description})]})]},m))})]},t.classification))}),e.jsx("div",{className:"mt-6 bg-blue-900/20 border border-blue-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"text-2xl",children:"💡"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-400 mb-2",children:"Mejores Prácticas"}),e.jsxs("ul",{className:"text-xs text-neutral-300 space-y-1",children:[e.jsx("li",{children:"• Concentrar esfuerzos en productos Clase A (80% del valor)"}),e.jsx("li",{children:"• Automatizar controles para productos Clase B"}),e.jsx("li",{children:"• Simplificar gestión de productos Clase C"}),e.jsx("li",{children:"• Revisar clasificación ABC cada 3-6 meses"}),e.jsx("li",{children:"• Ajustar estrategias según estacionalidad"})]})]})]})})]})}function Jt(){const{data:s,isLoading:a,error:h}=P({queryKey:["forecastAnalysis"],queryFn:()=>me(),refetchInterval:3e5});if(a)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-8 bg-neutral-800 rounded w-1/3 mb-4"}),e.jsx("div",{className:"h-64 bg-neutral-800 rounded"})]});if(h)return e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:e.jsxs("p",{className:"text-red-400",children:["Error al cargar pronósticos: ",String(h)]})});if(!s||s.length===0)return e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:e.jsx("p",{className:"text-neutral-400",children:"No hay datos suficientes para generar pronósticos"})});const i=s.length,r=s.filter(l=>l.stockStatus==="understocked").length,d=s.filter(l=>l.stockStatus==="overstocked").length,t=s.filter(l=>l.stockStatus==="optimal").length,n=s.reduce((l,N)=>l+N.predictedDemand,0),m=s.reduce((l,N)=>l+N.currentStock,0),u=s.reduce((l,N)=>l+N.recommendedOrderQty,0),j=s.reduce((l,N)=>l+N.confidence,0)/i,c=s.slice(0,10).map(l=>({name:l.productName.length>20?l.productName.substring(0,20)+"...":l.productName,demandaPredicha:l.predictedDemand,stockActual:l.currentStock,status:l.stockStatus})),b=l=>{switch(l){case"understocked":return"#ef4444";case"overstocked":return"#f97316";case"optimal":return"#22c55e";default:return"#6b7280"}};return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 space-y-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-white",children:"📈 Pronóstico de Demanda (Próximos 30 días)"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[e.jsxs("div",{className:"bg-neutral-800/50 border border-neutral-700 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Productos Analizados"}),e.jsx("div",{className:"text-2xl font-bold text-white mt-1",children:i})]}),e.jsxs("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-red-400",children:"Stock Bajo"}),e.jsx("div",{className:"text-2xl font-bold text-red-400 mt-1",children:r}),e.jsx("div",{className:"text-xs text-red-500 mt-1",children:"Requieren reposición"})]}),e.jsxs("div",{className:"bg-green-900/20 border border-green-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-green-400",children:"Stock Óptimo"}),e.jsx("div",{className:"text-2xl font-bold text-green-400 mt-1",children:t}),e.jsx("div",{className:"text-xs text-green-500 mt-1",children:"Niveles adecuados"})]}),e.jsxs("div",{className:"bg-orange-900/20 border border-orange-800 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-orange-400",children:"Sobre-stock"}),e.jsx("div",{className:"text-2xl font-bold text-orange-400 mt-1",children:d}),e.jsx("div",{className:"text-xs text-orange-500 mt-1",children:"Exceso de inventario"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"bg-neutral-800/50 border border-neutral-700 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Demanda Predicha Total"}),e.jsxs("div",{className:"text-xl font-bold text-white mt-1",children:[n.toFixed(0)," unidades"]})]}),e.jsxs("div",{className:"bg-neutral-800/50 border border-neutral-700 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Stock Actual Total"}),e.jsxs("div",{className:"text-xl font-bold text-white mt-1",children:[m.toFixed(0)," unidades"]})]}),e.jsxs("div",{className:"bg-neutral-800/50 border border-neutral-700 rounded-lg p-4",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Orden Recomendada Total"}),e.jsxs("div",{className:"text-xl font-bold text-blue-400 mt-1",children:[u.toFixed(0)," unidades"]})]})]}),e.jsxs("div",{className:"bg-neutral-800/30 rounded-lg p-4",children:[e.jsx("h4",{className:"text-lg font-semibold text-white mb-4",children:"Top 10 Productos: Demanda Predicha vs Stock Actual"}),e.jsx(he,{width:"100%",height:400,children:e.jsxs(ge,{data:c,margin:{top:20,right:30,left:20,bottom:60},children:[e.jsx(be,{strokeDasharray:"3 3",stroke:"#404040"}),e.jsx(pe,{dataKey:"name",angle:-45,textAnchor:"end",height:100,stroke:"#a3a3a3",style:{fontSize:"12px"}}),e.jsx(je,{stroke:"#a3a3a3"}),e.jsx(Ne,{contentStyle:{backgroundColor:"#262626",border:"1px solid #404040",borderRadius:"8px"},labelStyle:{color:"#fff"}}),e.jsx(ve,{wrapperStyle:{paddingTop:"20px"},iconType:"circle"}),e.jsx(ae,{dataKey:"demandaPredicha",name:"Demanda Predicha",fill:"#3b82f6"}),e.jsx(ae,{dataKey:"stockActual",name:"Stock Actual",children:c.map((l,N)=>e.jsx(Me,{fill:b(l.status)},`cell-${N}`))})]})})]}),e.jsx("div",{className:"bg-blue-900/20 border border-blue-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("div",{className:"text-sm text-blue-400",children:"Confianza Promedio del Modelo"}),e.jsx("div",{className:"text-xs text-neutral-400 mt-1",children:"Basado en historial de 90 días"})]}),e.jsxs("div",{className:"text-3xl font-bold text-blue-400",children:[j.toFixed(0),"%"]})]})})]})}function es(){const[s,a]=x.useState("all"),[h,i]=x.useState("all"),[r,d]=x.useState(""),[t,n]=x.useState(1),m=10,{data:u,isLoading:j,error:c}=P({queryKey:["forecastAnalysis"],queryFn:()=>me(),refetchInterval:300*1e3});if(j)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-8 bg-neutral-800 rounded w-1/3 mb-4"}),e.jsx("div",{className:"h-96 bg-neutral-800 rounded"})]});if(c)return e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:e.jsx("p",{className:"text-red-400",children:"Error al cargar pronósticos"})});if(!u||u.length===0)return e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:e.jsx("p",{className:"text-neutral-400",children:"No hay pronósticos disponibles"})});const b=u.filter(p=>{const S=s==="all"||p.stockStatus===s,y=h==="all"||p.trend===h,g=p.productName.toLowerCase().includes(r.toLowerCase())||p.category.toLowerCase().includes(r.toLowerCase());return S&&y&&g}),l=Math.ceil(b.length/m),N=(t-1)*m,w=b.slice(N,N+m),f=p=>{switch(p){case"understocked":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-red-900/40 border border-red-800 text-red-400",children:"Stock Bajo"});case"overstocked":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-orange-900/40 border border-orange-800 text-orange-400",children:"Sobre-stock"});case"optimal":return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-green-900/40 border border-green-800 text-green-400",children:"Óptimo"});default:return e.jsx("span",{className:"px-2 py-1 text-xs font-semibold rounded-full bg-neutral-800 border border-neutral-700 text-neutral-400",children:p})}},k=p=>{switch(p){case"increasing":return e.jsx("span",{className:"text-green-400",children:"↗️ Creciente"});case"decreasing":return e.jsx("span",{className:"text-red-400",children:"↘️ Decreciente"});case"stable":return e.jsx("span",{className:"text-blue-400",children:"→ Estable"});default:return e.jsx("span",{className:"text-neutral-400",children:p})}};return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 space-y-4",children:[e.jsx("h3",{className:"text-xl font-semibold text-white",children:"🎯 Tabla de Pronósticos"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>a("all"),className:`px-3 py-1.5 text-sm rounded-lg border transition ${s==="all"?"bg-blue-600 border-blue-500 text-white":"bg-neutral-800 border-neutral-700 text-neutral-300 hover:bg-neutral-700"}`,children:"Todos"}),e.jsx("button",{onClick:()=>a("understocked"),className:`px-3 py-1.5 text-sm rounded-lg border transition ${s==="understocked"?"bg-red-600 border-red-500 text-white":"bg-neutral-800 border-neutral-700 text-neutral-300 hover:bg-neutral-700"}`,children:"Stock Bajo"}),e.jsx("button",{onClick:()=>a("optimal"),className:`px-3 py-1.5 text-sm rounded-lg border transition ${s==="optimal"?"bg-green-600 border-green-500 text-white":"bg-neutral-800 border-neutral-700 text-neutral-300 hover:bg-neutral-700"}`,children:"Óptimo"}),e.jsx("button",{onClick:()=>a("overstocked"),className:`px-3 py-1.5 text-sm rounded-lg border transition ${s==="overstocked"?"bg-orange-600 border-orange-500 text-white":"bg-neutral-800 border-neutral-700 text-neutral-300 hover:bg-neutral-700"}`,children:"Sobre-stock"})]}),e.jsx("input",{type:"text",placeholder:"Buscar producto o categoría...",value:r,onChange:p=>{d(p.target.value),n(1)},className:"flex-1 px-4 py-2 bg-neutral-800 border border-neutral-700 rounded-lg text-white placeholder-neutral-500 focus:outline-none focus:border-blue-500"})]}),e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b border-neutral-800",children:[e.jsx("th",{className:"text-left p-3 text-sm font-semibold text-neutral-400",children:"Estado"}),e.jsx("th",{className:"text-left p-3 text-sm font-semibold text-neutral-400",children:"Producto"}),e.jsx("th",{className:"text-left p-3 text-sm font-semibold text-neutral-400",children:"Categoría"}),e.jsx("th",{className:"text-right p-3 text-sm font-semibold text-neutral-400",children:"Stock Actual"}),e.jsx("th",{className:"text-right p-3 text-sm font-semibold text-neutral-400",children:"Demanda (30d)"}),e.jsx("th",{className:"text-right p-3 text-sm font-semibold text-neutral-400",children:"Días Stock"}),e.jsx("th",{className:"text-center p-3 text-sm font-semibold text-neutral-400",children:"Tendencia"}),e.jsx("th",{className:"text-right p-3 text-sm font-semibold text-neutral-400",children:"Orden Recomendada"}),e.jsx("th",{className:"text-right p-3 text-sm font-semibold text-neutral-400",children:"Confianza"})]})}),e.jsx("tbody",{children:w.map((p,S)=>e.jsxs("tr",{className:"border-b border-neutral-800 hover:bg-neutral-800/30 transition",children:[e.jsx("td",{className:"p-3",children:f(p.stockStatus)}),e.jsx("td",{className:"p-3 text-white font-medium",children:p.productName}),e.jsx("td",{className:"p-3 text-neutral-300",children:p.category}),e.jsx("td",{className:"p-3 text-right text-white",children:p.currentStock.toFixed(0)}),e.jsx("td",{className:"p-3 text-right text-blue-400 font-semibold",children:p.predictedDemand.toFixed(0)}),e.jsx("td",{className:"p-3 text-right",children:e.jsxs("span",{className:p.daysOfStock<15?"text-red-400 font-semibold":p.daysOfStock>60?"text-orange-400":"text-green-400",children:[p.daysOfStock," días"]})}),e.jsx("td",{className:"p-3 text-center text-sm",children:k(p.trend)}),e.jsx("td",{className:"p-3 text-right",children:p.recommendedOrderQty>0?e.jsx("span",{className:"text-yellow-400 font-semibold",children:p.recommendedOrderQty.toFixed(0)}):e.jsx("span",{className:"text-neutral-500",children:"-"})}),e.jsxs("td",{className:"p-3 text-right text-neutral-400",children:[p.confidence.toFixed(0),"%"]})]},S))})]})}),l>1&&e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs("div",{className:"text-sm text-neutral-400",children:["Mostrando ",N+1,"-",Math.min(N+m,b.length)," de"," ",b.length]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("button",{onClick:()=>n(p=>Math.max(1,p-1)),disabled:t===1,className:"px-3 py-1.5 text-sm bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Anterior"}),e.jsxs("span",{className:"px-3 py-1.5 text-sm text-neutral-300",children:["Página ",t," de ",l]}),e.jsx("button",{onClick:()=>n(p=>Math.min(l,p+1)),disabled:t===l,className:"px-3 py-1.5 text-sm bg-neutral-800 border border-neutral-700 rounded-lg text-neutral-300 hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed",children:"Siguiente"})]})]}),b.length===0&&e.jsx("div",{className:"text-center py-8 text-neutral-400",children:"No se encontraron pronósticos con los filtros aplicados"})]})}function ts(){const{data:s,isLoading:a}=P({queryKey:["forecastAnalysis"],queryFn:()=>me(),refetchInterval:3e5});if(a)return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 animate-pulse",children:[e.jsx("div",{className:"h-8 bg-neutral-800 rounded w-1/3 mb-4"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"h-20 bg-neutral-800 rounded"}),e.jsx("div",{className:"h-20 bg-neutral-800 rounded"}),e.jsx("div",{className:"h-20 bg-neutral-800 rounded"})]})]});if(!s||s.length===0)return e.jsx("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6",children:e.jsx("p",{className:"text-neutral-400",children:"No hay recomendaciones disponibles"})});const h=s.filter(t=>t.stockStatus==="understocked").sort((t,n)=>t.daysOfStock-n.daysOfStock).slice(0,5),i=s.filter(t=>t.trend==="increasing").sort((t,n)=>n.predictedDemand-t.predictedDemand).slice(0,3),r=s.filter(t=>t.stockStatus==="overstocked").sort((t,n)=>n.daysOfStock-t.daysOfStock).slice(0,3),d=s.filter(t=>t.recommendedOrderQty>0).reduce((t,n)=>t+n.recommendedOrderQty,0);return e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-lg p-6 space-y-6",children:[e.jsx("h3",{className:"text-xl font-semibold text-white",children:"💡 Recomendaciones Estratégicas"}),h.length>0&&e.jsxs("div",{className:"bg-red-900/20 border border-red-800 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"🚨"}),e.jsx("h4",{className:"text-lg font-semibold text-red-400",children:"Acción Urgente Requerida"})]}),e.jsx("div",{className:"space-y-2",children:h.map((t,n)=>e.jsx("div",{className:"bg-neutral-900/50 rounded-lg p-3 border border-red-800/30",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:t.productName}),e.jsxs("div",{className:"text-sm text-red-400 mt-1",children:["Stock actual: ",t.currentStock.toFixed(0)," unidades (",t.daysOfStock," días)"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Ordenar"}),e.jsxs("div",{className:"text-lg font-bold text-yellow-400",children:[t.recommendedOrderQty.toFixed(0)," unidades"]})]})]})},n))}),e.jsx("div",{className:"pt-2 border-t border-red-800/30",children:e.jsx("div",{className:"text-sm text-red-300",children:"⚠️ Estos productos necesitan reposición inmediata para evitar quiebres de stock"})})]}),i.length>0&&e.jsxs("div",{className:"bg-green-900/20 border border-green-800 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"📈"}),e.jsx("h4",{className:"text-lg font-semibold text-green-400",children:"Productos con Demanda Creciente"})]}),e.jsx("div",{className:"space-y-2",children:i.map((t,n)=>e.jsxs("div",{className:"flex justify-between items-center bg-neutral-900/50 rounded-lg p-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:t.productName}),e.jsxs("div",{className:"text-sm text-green-400 mt-1",children:["Demanda predicha: ",t.predictedDemand.toFixed(0)," unidades (↗️ Aumentando)"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Promedio diario"}),e.jsx("div",{className:"text-white font-semibold",children:t.historicalAverage.toFixed(1)})]})]},n))}),e.jsx("div",{className:"pt-2 border-t border-green-800/30",children:e.jsx("div",{className:"text-sm text-green-300",children:"💡 Considere aumentar niveles de stock de seguridad para estos productos"})})]}),r.length>0&&e.jsxs("div",{className:"bg-orange-900/20 border border-orange-800 rounded-lg p-4 space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"⚠️"}),e.jsx("h4",{className:"text-lg font-semibold text-orange-400",children:"Optimización de Inventario"})]}),e.jsx("div",{className:"space-y-2",children:r.map((t,n)=>e.jsxs("div",{className:"flex justify-between items-center bg-neutral-900/50 rounded-lg p-3",children:[e.jsxs("div",{children:[e.jsx("div",{className:"font-medium text-white",children:t.productName}),e.jsxs("div",{className:"text-sm text-orange-400 mt-1",children:["Stock excesivo: ",t.daysOfStock," días de inventario"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-sm text-neutral-400",children:"Stock actual"}),e.jsx("div",{className:"text-white font-semibold",children:t.currentStock.toFixed(0)})]})]},n))}),e.jsx("div",{className:"pt-2 border-t border-orange-800/30",children:e.jsx("div",{className:"text-sm text-orange-300",children:"💡 Evalúe promociones o redistribución para optimizar capital de trabajo"})})]}),d>0&&e.jsx("div",{className:"bg-blue-900/20 border border-blue-800 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-2xl",children:"🛒"}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-semibold text-blue-400",children:"Orden de Compra Sugerida"}),e.jsx("div",{className:"text-sm text-neutral-400 mt-1",children:"Total de unidades a ordenar"})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("div",{className:"text-3xl font-bold text-blue-400",children:d.toFixed(0)}),e.jsx("div",{className:"text-sm text-neutral-400",children:"unidades"})]})]})}),e.jsxs("div",{className:"bg-neutral-800/50 border border-neutral-700 rounded-lg p-4 space-y-2",children:[e.jsxs("h4",{className:"font-semibold text-white flex items-center gap-2",children:[e.jsx("span",{children:"📋"}),"Mejores Prácticas de Gestión Predictiva"]}),e.jsxs("ul",{className:"space-y-2 text-sm text-neutral-300",children:[e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-400 mt-0.5",children:"✓"}),e.jsx("span",{children:"Revisar pronósticos semanalmente para ajustar niveles de stock"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-400 mt-0.5",children:"✓"}),e.jsx("span",{children:"Priorizar reposición de productos con menos de 15 días de inventario"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-400 mt-0.5",children:"✓"}),e.jsx("span",{children:"Considerar estacionalidad y eventos especiales en planificación"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-400 mt-0.5",children:"✓"}),e.jsx("span",{children:"Validar precisión del modelo comparando pronósticos con demanda real"})]}),e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-blue-400 mt-0.5",children:"✓"}),e.jsx("span",{children:"Optimizar frecuencia de pedidos para productos de alta rotación"})]})]})]})]})}const De=10;function ss(s){const a=Number(s);return Number.isFinite(a)?`$${a.toLocaleString("es-CL",{maximumFractionDigits:0})}`:"$0"}function ds(){const s=re(),a=Pt(),[h,i]=x.useState(!1),[r,d]=x.useState(null),[t,n]=x.useState(""),m=P({queryKey:["products",{view:"inventory"}],queryFn:()=>Y({size:200,status:"all"})}),u=P({queryKey:["inventory","settings"],queryFn:wt});x.useEffect(()=>{if(u.data){const S=Number(u.data.lowStockThreshold??0);if(Number.isFinite(S)&&S>0){r===null&&d(S),n(y=>y||String(S));return}}!u.isLoading&&r===null&&(d(De),n(String(De)))},[u.data,u.isLoading,r]);const j=P({queryKey:["inventory","summary"],queryFn:de}),c=P({queryKey:["inventory","alerts",r],enabled:r!==null,queryFn:()=>kt(r??void 0)}),b=O({mutationFn:S=>St({lowStockThreshold:S}),onSuccess:S=>{const y=Number(S.lowStockThreshold??0);Number.isFinite(y)&&y>0&&(d(y),n(String(y))),s.invalidateQueries({queryKey:["inventory","summary"]}),s.invalidateQueries({queryKey:["inventory","alerts"]}),s.setQueryData(["inventory","settings"],S)}}),l=()=>{const S=Number(t);if(!Number.isFinite(S)||S<=0){window.alert("Ingresa un umbral mayor a cero");return}b.mutate(S)},N=()=>{s.invalidateQueries({queryKey:["inventory","summary"]}),s.invalidateQueries({queryKey:["inventory","alerts"]}),s.invalidateQueries({queryKey:["products"],exact:!1}),i(!1)},w=x.useMemo(()=>new Map((m.data?.content??[]).map(S=>[S.id,S])),[m.data]),f=j.data;ss(f?.totalValue??0);const k=f?.activeProducts??0,p=f?.lowStockAlerts??c.data?.length??0;return f?.lowStockThreshold??r??Number(t||0),e.jsxs("div",{className:"page-section",children:[e.jsx(Et,{title:"Inventario",description:"Visibiliza catalogo, lotes y alertas de stock para garantizar disponibilidad.",actions:e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn ghost",onClick:()=>a("/app/inventory/movements"),children:"📋 Ver movimientos"}),e.jsx("button",{className:"btn",onClick:()=>i(!0),children:"+ Ajuste de stock"})]})}),!j.isLoading&&e.jsxs("div",{style:{marginBottom:"1.5rem",display:"flex",flexDirection:"column",gap:"0.5rem"},children:[p>5&&e.jsxs("div",{className:"bg-red-950 border border-red-800 rounded-lg p-3 text-red-400 text-sm",children:["🔴 ",e.jsx("strong",{children:"Crítico:"})," ",p," productos con stock bajo - requiere atención inmediata"]}),k===0&&e.jsxs("div",{className:"bg-yellow-950 border border-yellow-800 rounded-lg p-3 text-yellow-400 text-sm",children:["⚠️ ",e.jsx("strong",{children:"Advertencia:"})," No hay productos activos en el inventario"]})]}),e.jsxs("div",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{className:"text-neutral-100",style:{fontSize:"1.25rem",fontWeight:"600",marginBottom:"1rem"},children:"📊 KPIs de Inventario"}),e.jsx(Ht,{})]}),e.jsx("div",{style:{marginBottom:"2rem"},children:e.jsx(Wt,{})}),e.jsxs("div",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{className:"text-neutral-100",style:{fontSize:"1.25rem",fontWeight:"600",marginBottom:"1rem"},children:"🎯 Análisis ABC de Inventario"}),e.jsx("div",{style:{marginBottom:"1.5rem"},children:e.jsx(Yt,{})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-5",children:[e.jsx(Xt,{}),e.jsx(Zt,{})]})]}),e.jsxs("div",{style:{marginBottom:"2rem",marginTop:"2rem"},children:[e.jsx("h2",{className:"text-neutral-100",style:{fontSize:"1.5rem",fontWeight:"600",marginBottom:"1rem"},children:"📈 Pronóstico de Demanda e Inteligencia Predictiva"}),e.jsx("div",{style:{marginBottom:"1.25rem"},children:e.jsx(Jt,{})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-5",children:[e.jsx(es,{}),e.jsx(ts,{})]})]}),e.jsxs("section",{className:"responsive-grid",children:[e.jsx("div",{className:"card",children:e.jsx(Rt,{})}),e.jsx("div",{className:"card",children:e.jsx(Bt,{})}),e.jsx("div",{className:"card",children:e.jsx(Ut,{})})]}),e.jsxs("div",{style:{marginBottom:"2rem",marginTop:"2rem"},children:[e.jsx("h2",{className:"text-neutral-100",style:{fontSize:"1.25rem",fontWeight:"600",marginBottom:"1rem"},children:"📊 Análisis de Inventario"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-5",children:[e.jsx(Vt,{}),e.jsx(zt,{})]})]}),e.jsxs("div",{style:{marginBottom:"2rem"},children:[e.jsx("h2",{className:"text-neutral-100",style:{fontSize:"1.25rem",fontWeight:"600",marginBottom:"1rem"},children:"⚙️ Gestión Operativa"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-5",children:[e.jsx(_t,{}),e.jsx(Gt,{})]})]}),e.jsx("section",{className:"responsive-grid",children:e.jsxs("div",{className:"bg-neutral-900 border border-neutral-800 rounded-2xl shadow-lg p-5 table-card",children:[e.jsx("h3",{className:"text-neutral-100",children:"Lotes con stock crítico"}),e.jsxs("div",{className:"inline-actions",style:{marginBottom:"0.75rem"},children:[e.jsx("label",{className:"muted small text-neutral-400",htmlFor:"low-stock-threshold",children:"Umbral"}),e.jsx("input",{id:"low-stock-threshold",className:"input bg-neutral-800 border-neutral-700 text-neutral-100",type:"number",step:"0.1",min:"0.1",value:t,onChange:S=>n(S.target.value),disabled:b.isPending}),e.jsx("button",{className:"btn",type:"button",onClick:l,disabled:b.isPending,children:b.isPending?"Guardando...":"Guardar"})]}),b.isError&&e.jsx("p",{className:"error",children:b.error?.message??"No se pudo actualizar el umbral"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Lote"}),e.jsx("th",{children:"Disponible"}),e.jsx("th",{children:"Expira"}),e.jsx("th",{children:"Creado"}),e.jsx("th",{children:"Acción"})]})}),e.jsxs("tbody",{children:[c.isLoading&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"muted text-neutral-400",children:"Cargando alertas..."})}),c.isError&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"error text-red-400",children:c.error?.message??"No se pudieron obtener alertas"})}),!c.isLoading&&!c.isError&&(c.data??[]).map(S=>{const y=w.get(S.productId),g=Number(S.qtyAvailable),F=r??10,v=g<5||g<F*.1,I=g>=5&&g<=F,A=S.expDate?new Date(S.expDate):null,K=new Date,L=A?Math.floor((A.getTime()-K.getTime())/(1e3*60*60*24)):null,B=L!==null&&L<=30&&L>=0,Q=L!==null&&L<0,V=v?{icon:"🔴",label:"Crítico",className:"bg-red-950 text-red-400 border-red-800"}:I?{icon:"🟡",label:"Bajo",className:"bg-yellow-950 text-yellow-400 border-yellow-800"}:{icon:"🟢",label:"Normal",className:"bg-green-950 text-green-400 border-green-800"};return e.jsxs("tr",{className:Q?"bg-red-950/20":B?"bg-yellow-950/20":"",children:[e.jsx("td",{children:e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md text-xs font-medium border ${V.className}`,children:[e.jsx("span",{children:V.icon}),e.jsx("span",{children:V.label})]})}),e.jsx("td",{className:"text-neutral-100",children:y?.name??S.productId}),e.jsx("td",{className:"mono text-neutral-300",children:S.lotId}),e.jsx("td",{className:`mono font-semibold ${v?"text-red-400":I?"text-yellow-400":"text-neutral-100"}`,children:g.toFixed(2)}),e.jsxs("td",{className:`mono ${Q?"text-red-400 font-semibold":B?"text-yellow-400 font-semibold":"text-neutral-300"}`,children:[A?A.toLocaleDateString():"-",Q&&e.jsx("span",{className:"ml-2",children:"❌ Vencido"}),B&&!Q&&e.jsxs("span",{className:"ml-2",children:["⚠️ ",L,"d"]})]}),e.jsx("td",{className:"mono small text-neutral-400",children:new Date(S.createdAt).toLocaleDateString()}),e.jsx("td",{children:e.jsx("button",{className:"btn ghost text-xs",type:"button",onClick:()=>{i(!0)},title:"Reabastecimiento rápido",children:"+ Stock"})})]},S.lotId)}),!c.isLoading&&!c.isError&&(c.data??[]).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:7,className:"muted text-neutral-400 text-center py-8",children:"✅ Sin alertas de stock crítico"})})]})]})})]})}),e.jsx(Kt,{}),e.jsx($t,{open:h,onClose:()=>i(!1),onApplied:N})]})}export{ds as default};
