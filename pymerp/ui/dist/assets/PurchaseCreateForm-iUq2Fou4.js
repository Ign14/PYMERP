import{c as ge,j as e,T as Ae,U as we,k as ke,O as ze,K as Ee,m as qe}from"./index-C0DCX_lx.js";import{r as s}from"./react-DFcFNn96.js";import{u as F}from"./useQuery-ClGZjTlq.js";const Me=["Factura","Boleta","CotizaciÃ³n","Orden de Compra","GuÃ­a de Despacho"],Q=()=>new Date().toISOString().slice(0,16);function Oe({initialSupplierId:K,initialProductId:U,initialLocationId:G,initialQty:_,onSubmitted:je,className:ve}){const x=s.useMemo(()=>K??"",[K]),u=s.useMemo(()=>U??"",[U]),p=s.useMemo(()=>G??"",[G]),m=s.useMemo(()=>Math.max(Math.round(_??1),1),[_]),[T,g]=s.useState(x),[ye,j]=s.useState(!1),[P,v]=s.useState(""),[A,y]=s.useState(""),[X,Y]=s.useState("Factura"),[H,J]=s.useState(""),[Z,ee]=s.useState(null),[te,se]=s.useState(Q),[w,ne]=s.useState(Q),[r,k]=s.useState([]),[a,z]=s.useState("product"),[E,f]=s.useState(u),[o,q]=s.useState(""),[M,b]=s.useState(m),[$,C]=s.useState(0),[fe,ae]=s.useState(19),[le,R]=s.useState(""),[ie,W]=s.useState(""),[be,O]=s.useState(""),[re,S]=s.useState(p),[N,oe]=s.useState(!0),[d,de]=s.useState("amount"),[I,ce]=s.useState(0),[V,B]=s.useState(null);s.useEffect(()=>{g(x)},[x]),s.useEffect(()=>{f(u)},[u]),s.useEffect(()=>{S(p)},[p]),s.useEffect(()=>{b(m)},[m]);const Ce=F({queryKey:["products",{dialog:"purchases"}],queryFn:()=>ke({size:200})}),D=F({queryKey:["services",{dialog:"purchases"}],queryFn:()=>ze({status:"ACTIVE"})}),ue=F({queryKey:["suppliers",{dialog:"purchases"}],queryFn:()=>Ee()}),pe=F({queryKey:["locations",{dialog:"purchases"}],queryFn:()=>qe()}),L=ge({mutationFn:t=>Ae(t),onSuccess:t=>{g(t.id),j(!1),v(""),y(""),ue.refetch()}});s.useEffect(()=>{if(a==="service"&&o){const t=D.data?.find(n=>n.id===o);t?.unitPrice&&C(t.unitPrice)}},[a,o,D.data]);const me=()=>{g(x),j(!1),v(""),y(""),Y("Factura"),J(""),ee(null);const t=Q();se(t),ne(t),k([]),z("product"),f(u),q(""),b(m),C(0),R(""),W(""),O(""),S(p),oe(!0),de("amount"),ce(0),B(null),ae(19)},h=ge({mutationFn:t=>we(t.payload,t.file),onSuccess:t=>{me(),je?.(t.id)}}),he=Ce.data?.content??[],Se=ue.data??[],i=s.useMemo(()=>{const t=r.reduce((Pe,xe)=>Pe+xe.qty*xe.unitCost,0);let n=0;d==="percentage"?n=t*(I/100):n=I;const c=t-n,l=N?c*.19:0,Te=c+l;return{subtotal:t,discountAmount:n,net:c,vat:l,total:Te}},[r,N,d,I]),Ne=()=>{!P.trim()||!A.trim()||L.mutate({name:P,rut:A})},Ie=()=>{if(a==="product"&&!E||a==="service"&&!o||M<=0||$<=0)return;const t={qty:M,unitCost:$,vatRate:fe};a==="product"?(t.productId=E,t.mfgDate=ie||void 0,t.expDate=le||void 0,t.locationId=re||void 0):t.serviceId=o,k(n=>[...n,t]),f(u),q(""),b(m),C(0),R(""),W(""),O(""),S(p),ae(19)},De=t=>{k(n=>n.filter((c,l)=>l!==t))},Fe=t=>{if(t.preventDefault(),!T||r.length===0)return;const n={supplierId:T,docType:X,docNumber:H,issuedAt:new Date(te).toISOString(),receivedAt:w?new Date(w).toISOString():void 0,paymentTermDays:Z??void 0,net:Number(i.net.toFixed(2)),vat:Number(i.vat.toFixed(2)),total:Number(i.total.toFixed(2)),items:r};h.mutate({payload:n,file:V||void 0})};return e.jsxs("form",{className:ve??"form-grid",onSubmit:Fe,children:[e.jsx("div",{style:{gridColumn:"1 / -1"},children:e.jsx("h3",{style:{marginBottom:"0.5rem",fontSize:"0.9rem",fontWeight:"600"},children:"InformaciÃ³n del Proveedor"})}),ye?e.jsxs(e.Fragment,{children:[e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"Nombre Proveedor *"}),e.jsx("input",{className:"input",value:P,onChange:t=>v(t.target.value),placeholder:"Nombre del proveedor"})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"RUT *"}),e.jsx("input",{className:"input",value:A,onChange:t=>y(t.target.value),placeholder:"12.345.678-9"})]}),e.jsxs("div",{style:{gridColumn:"1 / -1",display:"flex",gap:"0.5rem"},children:[e.jsx("button",{type:"button",className:"btn",onClick:Ne,disabled:L.isPending,children:L.isPending?"Creando...":"Crear Proveedor"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>{j(!1),v(""),y("")},children:"Cancelar"})]})]}):e.jsx(e.Fragment,{children:e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"Proveedor *"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsxs("select",{className:"input",value:T,onChange:t=>g(t.target.value),required:!0,style:{flex:1},children:[e.jsx("option",{value:"",children:"Selecciona proveedor"}),Se.map(t=>e.jsxs("option",{value:t.id,children:[t.name," ",t.rut?`(${t.rut})`:""]},t.id))]}),e.jsx("button",{type:"button",className:"btn",onClick:()=>j(!0),style:{whiteSpace:"nowrap"},children:"+ Nuevo"})]})]})}),e.jsx("div",{className:"line",style:{gridColumn:"1 / -1"}}),e.jsx("div",{style:{gridColumn:"1 / -1"},children:e.jsx("h3",{style:{marginBottom:"0.5rem",fontSize:"0.9rem",fontWeight:"600"},children:"InformaciÃ³n del Documento"})}),e.jsxs("label",{children:[e.jsx("span",{children:"Tipo de Documento *"}),e.jsx("select",{className:"input",value:X,onChange:t=>Y(t.target.value),required:!0,children:Me.map(t=>e.jsx("option",{value:t,children:t},t))})]}),e.jsxs("label",{children:[e.jsx("span",{children:"NÃºmero de Documento"}),e.jsx("input",{className:"input",value:H,onChange:t=>J(t.target.value.slice(0,35)),maxLength:35,placeholder:"Ej: OC-2025-001 o 12345"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de EmisiÃ³n *"}),e.jsx("input",{className:"input",type:"datetime-local",value:te,onChange:t=>se(t.target.value),required:!0})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de RecepciÃ³n"}),e.jsx("input",{className:"input",type:"datetime-local",value:w,onChange:t=>ne(t.target.value)})]}),e.jsxs("label",{children:[e.jsx("span",{children:"TÃ©rminos de pago (opcional)"}),e.jsxs("select",{className:"input",value:Z??"",onChange:t=>ee(t.target.value?Number(t.target.value):null),children:[e.jsx("option",{value:"",children:"Sin tÃ©rminos de pago"}),e.jsx("option",{value:"7",children:"7 dÃ­as"}),e.jsx("option",{value:"15",children:"15 dÃ­as"}),e.jsx("option",{value:"30",children:"30 dÃ­as"}),e.jsx("option",{value:"60",children:"60 dÃ­as"})]})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"ðŸ“Ž Adjuntar Documento PDF (opcional)"}),e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginTop:"0.25rem"},children:[e.jsx("input",{type:"file",accept:".pdf,application/pdf",onChange:t=>{const n=t.target.files?.[0];if(n){if(n.size>10*1024*1024){alert("El archivo es demasiado grande. MÃ¡ximo 10MB."),t.target.value="";return}B(n)}},style:{flex:1}}),V&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",padding:"0.5rem",backgroundColor:"#e3f2fd",borderRadius:"4px",fontSize:"0.85rem"},children:[e.jsxs("span",{children:["ðŸ“„ ",V.name]}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>B(null),style:{padding:"0.25rem 0.5rem",fontSize:"0.75rem"},children:"âœ•"})]})]}),e.jsx("small",{className:"muted",style:{display:"block",marginTop:"0.25rem"},children:"Formatos aceptados: PDF. TamaÃ±o mÃ¡ximo: 10MB"})]}),e.jsx("div",{className:"line",style:{gridColumn:"1 / -1"}}),e.jsx("div",{style:{gridColumn:"1 / -1"},children:e.jsx("h3",{style:{marginBottom:"0.5rem",fontSize:"0.9rem",fontWeight:"600"},children:"Items de Compra"})}),e.jsxs("div",{className:"item-builder",style:{gridColumn:"1 / -1",display:"grid",gridTemplateColumns:"repeat(2, 1fr)",gap:"0.75rem"},children:[e.jsxs("div",{style:{gridColumn:"1 / -1",display:"flex",gap:"1rem",marginBottom:"0.5rem"},children:[e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"radio",name:"itemType",value:"product",checked:a==="product",onChange:t=>z(t.target.value)}),e.jsx("span",{children:"Producto"})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"radio",name:"itemType",value:"service",checked:a==="service",onChange:t=>z(t.target.value)}),e.jsx("span",{children:"Servicio"})]})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:a==="product"?"Producto *":"Servicio *"}),a==="product"?e.jsxs("select",{className:"input",value:E,onChange:t=>f(t.target.value),children:[e.jsx("option",{value:"",children:"Seleccionar producto"}),he.map(t=>e.jsxs("option",{value:t.id,children:[t.name," ",t.sku?`(${t.sku})`:""]},t.id))]}):e.jsxs("select",{className:"input",value:o,onChange:t=>q(t.target.value),children:[e.jsx("option",{value:"",children:"Seleccionar servicio"}),D.data?.map(t=>e.jsxs("option",{value:t.id,children:[t.code," - ",t.name]},t.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Cantidad *"}),e.jsx("input",{className:"input",type:"number",min:1,value:M,onChange:t=>b(Number(t.target.value)),placeholder:"Cantidad"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Costo unitario *"}),e.jsx("input",{className:"input",type:"number",step:"0.01",min:0,value:$,onChange:t=>C(Number(t.target.value)),placeholder:"Costo unitario"})]}),a==="product"&&e.jsxs(e.Fragment,{children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre del lote (opcional)"}),e.jsx("input",{className:"input",type:"text",value:be,onChange:t=>O(t.target.value),placeholder:"Ej: LOTE-2025-001"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"UbicaciÃ³n de destino"}),e.jsxs("select",{className:"input",value:re,onChange:t=>S(t.target.value),children:[e.jsx("option",{value:"",children:"Sin ubicaciÃ³n"}),pe.data?.map(t=>e.jsxs("option",{value:t.id,children:[t.code," - ",t.name," (",t.type,")"]},t.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de fabricaciÃ³n"}),e.jsx("input",{className:"input",type:"date",value:ie,onChange:t=>W(t.target.value)})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de vencimiento"}),e.jsx("input",{className:"input",type:"date",value:le,onChange:t=>R(t.target.value)})]})]}),e.jsxs("button",{type:"button",className:"btn",onClick:Ie,style:{gridColumn:"1 / -1"},children:["+ Agregar ",a==="product"?"Producto":"Servicio"]})]}),r.length>0&&e.jsx("div",{style:{gridColumn:"1 / -1",overflowX:"auto"},children:e.jsxs("table",{className:"table",style:{minWidth:"600px"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Tipo"}),e.jsx("th",{children:"Item"}),e.jsx("th",{style:{textAlign:"right"},children:"Cantidad"}),e.jsx("th",{style:{textAlign:"right"},children:"Costo Unit."}),e.jsx("th",{style:{textAlign:"right"},children:"Subtotal"}),e.jsx("th",{children:"Info"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:r.map((t,n)=>{const c=t.productId?"Producto":"Servicio";return e.jsxs("tr",{children:[e.jsx("td",{children:c}),e.jsxs("td",{children:[t.productId&&he.find(l=>l.id===t.productId)?.name,t.serviceId&&D.data?.find(l=>l.id===t.serviceId)?.name]}),e.jsx("td",{style:{textAlign:"right"},children:t.qty}),e.jsxs("td",{style:{textAlign:"right"},children:["$",t.unitCost.toFixed(2)]}),e.jsxs("td",{style:{textAlign:"right"},children:["$",(t.qty*t.unitCost).toFixed(2)]}),e.jsxs("td",{children:[t.productId&&e.jsxs("div",{children:[t.locationId&&e.jsxs("span",{children:["ðŸ“ ",pe.data?.find(l=>l.id===t.locationId)?.name]}),t.mfgDate&&e.jsxs("span",{children:["ðŸ·ï¸ MFG: ",new Date(t.mfgDate).toLocaleDateString("es-CL")]}),t.expDate&&e.jsxs("span",{children:["â° Venc: ",new Date(t.expDate).toLocaleDateString("es-CL")]}),!t.locationId&&!t.mfgDate&&!t.expDate&&"-"]}),t.serviceId&&"-"]}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>De(n),style:{padding:"0.25rem 0.5rem"},children:"Quitar"})})]},`${t.productId??t.serviceId}-${n}`)})})]})}),e.jsx("div",{className:"line",style:{gridColumn:"1 / -1"}}),e.jsx("div",{style:{gridColumn:"1 / -1"},children:e.jsx("h3",{style:{marginBottom:"0.5rem",fontSize:"0.9rem",fontWeight:"600"},children:"Descuentos e Impuestos"})}),e.jsxs("label",{style:{gridColumn:"span 1"},children:[e.jsx("span",{children:"Tipo de Descuento"}),e.jsxs("select",{className:"input",value:d,onChange:t=>de(t.target.value),children:[e.jsx("option",{value:"amount",children:"Monto Fijo ($)"}),e.jsx("option",{value:"percentage",children:"Porcentaje (%)"})]})]}),e.jsxs("label",{style:{gridColumn:"span 1"},children:[e.jsxs("span",{children:["Descuento ",d==="percentage"?"(%)":"($)"]}),e.jsx("input",{className:"input",type:"number",step:"0.01",min:0,max:d==="percentage"?100:void 0,value:I,onChange:t=>ce(Number(t.target.value)),placeholder:d==="percentage"?"0-100":"0.00"})]}),e.jsxs("label",{style:{gridColumn:"1 / -1",display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:N,onChange:t=>oe(t.target.checked),style:{width:"auto"}}),e.jsx("span",{style:{fontWeight:"600"},children:"Aplicar IVA 19%"})]}),e.jsx("div",{style:{gridColumn:"1 / -1",backgroundColor:"#f8f9fa",padding:"1rem",borderRadius:"8px",marginTop:"0.5rem"},children:e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:"1rem"},children:[e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"Subtotal"}),e.jsxs("div",{style:{fontSize:"1.1rem",fontWeight:"600"},children:["$",i.subtotal.toFixed(2)]})]}),i.discountAmount>0&&e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"Descuento"}),e.jsxs("div",{style:{fontSize:"1.1rem",fontWeight:"600",color:"#dc3545"},children:["-$",i.discountAmount.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"Neto"}),e.jsxs("div",{style:{fontSize:"1.1rem",fontWeight:"600"},children:["$",i.net.toFixed(2)]})]}),N&&e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"IVA (19%)"}),e.jsxs("div",{style:{fontSize:"1.1rem",fontWeight:"600"},children:["$",i.vat.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"Total"}),e.jsxs("div",{style:{fontSize:"1.3rem",fontWeight:"700",color:"#0066cc"},children:["$",i.total.toFixed(2)]})]})]})}),h.isError&&e.jsx("p",{className:"error",style:{gridColumn:"1 / -1"},children:h.error.message}),e.jsxs("div",{className:"buttons",style:{gridColumn:"1 / -1"},children:[e.jsx("button",{className:"btn",type:"submit",disabled:h.isPending||r.length===0,children:h.isPending?"Guardando...":"Registrar Compra"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:me,children:"Limpiar Formulario"})]})]})}export{Oe as P};
