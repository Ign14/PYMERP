import{c as k,aa as F,z as D,j as e,u as w,ab as q,C as M}from"./index-OfXnknKF.js";import{r as c}from"./react-DFcFNn96.js";import{P as O}from"./PageHeader-DR0dkBli.js";import{u as $}from"./useQuery-7A7SEbdC.js";import{p as G}from"./problemDetail-B33ux2x6.js";import{M as T}from"./Modal-BCEKQ7aJ.js";const P={name:"",rut:"",address:"",commune:"",businessActivity:"",phone:"",email:""},Q=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function I({open:g,supplier:t,onClose:N,onSaved:i}){const[n,u]=c.useState(P),[s,v]=c.useState({}),[y,o]=c.useState(null),x=k({mutationFn:a=>t?F(t.id,a):D(a),onSuccess:a=>{v({}),o(null),i?.(a),N()},onError:a=>{const l=G(a),m={};for(const[j,p]of Object.entries(l.fieldErrors))j in P&&typeof p=="string"&&p.trim().length>0&&(m[j]=p);v(m),o(l.message??"No se pudo guardar el proveedor")}});c.useEffect(()=>{if(!g){u(P),v({}),o(null),x.reset();return}u(t?{name:t.name??"",rut:t.rut??"",address:t.address??"",commune:t.commune??"",businessActivity:t.businessActivity??"",phone:t.phone??"",email:t.email??""}:P),v({}),o(null),x.reset()},[g,t,x]);const h=a=>{v(l=>{if(!l[a])return l;const m={...l};return delete m[a],m})},b=a=>{a.preventDefault(),o(null);const l=n.name.trim(),m=n.rut.trim(),j=n.email.trim(),p={};if(l||(p.name="El nombre es obligatorio"),m||(p.rut="El RUT es obligatorio"),j&&!Q.test(j)&&(p.email="Ingresa un email válido"),Object.keys(p).length>0){v(p);return}v({});const f=A=>{const S=A.trim();return S.length>0?S:null},E={name:l,rut:m,address:f(n.address),commune:f(n.commune),businessActivity:f(n.businessActivity),phone:f(n.phone),email:f(n.email)};x.mutate(E)},R=t?"Editar proveedor":"Nuevo proveedor",d=x.isPending;return e.jsx(T,{open:g,title:R,onClose:()=>!d&&N(),children:e.jsxs("form",{className:"form-grid",onSubmit:b,noValidate:!0,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:`input${s.name?" input-error":""}`,value:n.name,onChange:a=>{u(l=>({...l,name:a.target.value})),h("name"),o(null)},placeholder:"Proveedor demo",disabled:d,maxLength:100,required:!0,"data-autofocus":!0,"aria-invalid":s.name?"true":void 0,"aria-describedby":s.name?"supplier-form-name-error":void 0}),s.name?e.jsx("p",{id:"supplier-form-name-error",className:"error","aria-live":"polite",children:s.name}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"RUT *"}),e.jsx("input",{className:`input${s.rut?" input-error":""}`,value:n.rut,onChange:a=>{u(l=>({...l,rut:a.target.value})),h("rut"),o(null)},placeholder:"76.123.456-k",disabled:d,maxLength:20,required:!0,"aria-invalid":s.rut?"true":void 0,"aria-describedby":s.rut?"supplier-form-rut-error":void 0}),s.rut?e.jsx("p",{id:"supplier-form-rut-error",className:"error","aria-live":"polite",children:s.rut}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Dirección"}),e.jsx("input",{className:"input",value:n.address,onChange:a=>{u(l=>({...l,address:a.target.value})),h("address"),o(null)},placeholder:"Av. Principal 1234",disabled:d,maxLength:200}),s.address?e.jsx("p",{className:"error","aria-live":"polite",children:s.address}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Comuna"}),e.jsx("input",{className:"input",value:n.commune,onChange:a=>{u(l=>({...l,commune:a.target.value})),h("commune"),o(null)},placeholder:"Providencia",disabled:d,maxLength:120}),s.commune?e.jsx("p",{className:"error","aria-live":"polite",children:s.commune}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Giro / actividad"}),e.jsx("input",{className:"input",value:n.businessActivity,onChange:a=>{u(l=>({...l,businessActivity:a.target.value})),h("businessActivity"),o(null)},placeholder:"Distribución",disabled:d,maxLength:120}),s.businessActivity?e.jsx("p",{className:"error","aria-live":"polite",children:s.businessActivity}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Teléfono"}),e.jsx("input",{className:"input",value:n.phone,onChange:a=>{u(l=>({...l,phone:a.target.value})),h("phone"),o(null)},placeholder:"+56 9 1234 5678",disabled:d,maxLength:30}),s.phone?e.jsx("p",{className:"error","aria-live":"polite",children:s.phone}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Email"}),e.jsx("input",{className:`input${s.email?" input-error":""}`,value:n.email,onChange:a=>{u(l=>({...l,email:a.target.value})),h("email"),o(null)},placeholder:"contacto@empresa.cl",type:"email",disabled:d,maxLength:120,"aria-invalid":s.email?"true":void 0,"aria-describedby":s.email?"supplier-form-email-error":void 0}),s.email?e.jsx("p",{id:"supplier-form-email-error",className:"error","aria-live":"polite",children:s.email}):null]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:d,children:d?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:N,disabled:d,children:"Cancelar"})]}),y?e.jsx("p",{className:"error","aria-live":"polite",children:y}):null]})})}const L=c.forwardRef((g,t)=>{const N=w(),[i,n]=c.useState(null),[u,s]=c.useState(!1),[v,y]=c.useState(null),o=$({queryKey:["suppliers"],queryFn:M,refetchOnWindowFocus:!1}),x=c.useCallback(()=>{y(null),s(!0)},[]),h=c.useCallback(()=>{s(!1),y(null)},[]);c.useImperativeHandle(t,()=>({openCreate:x}),[x]),c.useEffect(()=>{if(!i)return;const r=o.data?.find(C=>C.id===i.id);r?r!==i&&n(r):n(null)},[o.data,i]);const b=k({mutationFn:r=>q(r),onSuccess:(r,C)=>{N.invalidateQueries({queryKey:["suppliers"]}),i?.id===C&&n(null)}}),R=r=>{N.invalidateQueries({queryKey:["suppliers"]}),n(r),h()},d=()=>{i&&(y(i),s(!0))},a=()=>{!i||b.isPending||window.confirm(`Eliminar proveedor ${i.name}?`)&&b.mutate(i.id)},{data:l,isLoading:m,isError:j,error:p,refetch:f,isFetching:E}=o,A=r=>{if(!r)return"Sin información";const C=r.trim();return C.length>0?C:"Sin información"},S=i?[{label:"Nombre",value:i.name},{label:"RUT",value:i.rut??null},{label:"Dirección",value:i.address??null},{label:"Comuna",value:i.commune??null},{label:"Giro / actividad",value:i.businessActivity??null},{label:"Teléfono",value:i.phone??null},{label:"Email",value:i.email??null,type:"email"}]:[];return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Proveedores"}),e.jsx("button",{className:"btn",onClick:()=>f(),disabled:E,children:E?"Cargando":"Refrescar"})]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn",type:"button",onClick:x,children:"+ Proveedor"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:d,disabled:!i,children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:a,disabled:!i||b.isPending,children:b.isPending?"Eliminando...":"Eliminar"})]}),b.isError&&e.jsx("p",{className:"error",children:b.error?.message??"No se pudo eliminar el proveedor"}),m&&e.jsx("p",{children:"Loading..."}),j&&e.jsx("p",{className:"error",children:p?.message??"No se pudieron cargar los proveedores"}),!m&&!j&&e.jsxs(e.Fragment,{children:[e.jsxs("ul",{className:"list",children:[(l??[]).map(r=>e.jsxs("li",{className:i?.id===r.id?"selected":void 0,onClick:()=>n(r),children:[e.jsx("strong",{children:r.name}),r.rut?e.jsxs("span",{className:"mono small",children:[" rut ",r.rut]}):null]},r.id)),(l??[]).length===0&&e.jsx("li",{className:"muted",children:"Sin proveedores"})]}),i?e.jsx("div",{className:"supplier-details","aria-live":"polite",children:S.map(r=>e.jsxs("div",{className:"supplier-detail-item",children:[e.jsx("span",{className:"supplier-detail-label",children:r.label}),e.jsx("span",{className:"supplier-detail-value",children:r.type==="email"&&r.value&&r.value.trim().length>0?e.jsx("a",{href:`mailto:${r.value.trim()}`,children:r.value.trim()}):A(r.value)})]},r.label))}):e.jsx("p",{className:"muted",children:"Selecciona un proveedor para ver sus datos."})]}),e.jsx(I,{open:u,supplier:v,onClose:h,onSaved:R})]})});L.displayName="SuppliersCard";const _=[{supplier:"Distribuidora Norte",nextReview:"2025-10-15",status:"Activo"},{supplier:"Log�stica Express",nextReview:"2025-11-01",status:"Renegociar"}];function X(){const g=c.useRef(null);return e.jsxs("div",{className:"page-section",children:[e.jsx(O,{title:"Proveedores",description:"Consolida contratos, contactos y desempe�o de abastecimiento.",actions:e.jsx("button",{className:"btn",onClick:()=>g.current?.openCreate(),children:"+ Registrar proveedor"})}),e.jsxs("section",{className:"responsive-grid",children:[e.jsx("div",{className:"card",children:e.jsx(L,{ref:g})}),e.jsxs("div",{className:"card table-card",children:[e.jsx("h3",{children:"Contratos prioritarios"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Proveedor"}),e.jsx("th",{children:"Revisi�n"}),e.jsx("th",{children:"Estado"})]})}),e.jsx("tbody",{children:_.map(t=>e.jsxs("tr",{children:[e.jsx("td",{children:t.supplier}),e.jsx("td",{className:"mono small",children:t.nextReview}),e.jsx("td",{children:e.jsx("span",{className:`status ${t.status.toLowerCase()}`,children:t.status})})]},t.supplier))})]})})]})]})]})}export{X as default};
