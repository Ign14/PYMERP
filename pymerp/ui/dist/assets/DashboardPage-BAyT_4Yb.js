import{j as e,g as S,a as D,l as w}from"./index-BtVHljoa.js";import{i as M,r as p}from"./react-D8kvZI4c.js";import{u as f}from"./useQuery-Dnian6zg.js";import{P as E}from"./PageHeader-BlxDVWRK.js";import{R as L,L as R,C as K,X as $,Y as q,T as A,a as T,b as P}from"./charts-BH7DIlZU.js";const y=/^\d{4}-\d{2}-\d{2}$/;function z(s,n){const d=new Date(s);return d.setDate(d.getDate()+n),d}function C(s){const n=s.getFullYear(),d=`${s.getMonth()+1}`.padStart(2,"0"),t=`${s.getDate()}`.padStart(2,"0");return`${n}-${d}-${t}`}function I(){const s=new Date,n=z(s,-13);return{from:C(n),to:C(s)}}function Q(s,n,d){const t=y.test(s??"")?s:d.from,l=y.test(n??"")?n:d.to;return t>l?{from:t,to:t}:{from:t,to:l}}function U(){const[s,n]=M(),d=p.useMemo(I,[]),t=p.useMemo(()=>({from:s.get("from"),to:s.get("to")}),[s]),l=p.useMemo(()=>Q(t.from,t.to,d),[t.from,t.to,d]);p.useEffect(()=>{(t.from!==l.from||t.to!==l.to)&&n({from:l.from,to:l.to},{replace:!0})},[t.from,t.to,l.from,l.to,n]);const N=a=>r=>{const o=r.target.value;if(!y.test(o))return;let j=a==="from"?o:l.from,g=a==="to"?o:l.to;j>g&&(a==="from"?g=o:j=o),n({from:j,to:g})},{from:m,to:i}=l,c=f({queryKey:["salesMetrics",m,i],queryFn:()=>S({from:m,to:i}),enabled:!!(m&&i)}),h=f({queryKey:["trend",m,i,"purchase-sale"],queryFn:()=>D({from:m,to:i,series:"purchase,sale"}),enabled:!!(m&&i)}),u=f({queryKey:["lowStockProducts"],queryFn:()=>w()}),F=p.useMemo(()=>new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",maximumFractionDigits:0}),[]),x=a=>F.format(a??0),v=p.useMemo(()=>{if(!h.data)return[];const a=new Map;return h.data.purchase.forEach(r=>{const o=a.get(r.date)??{date:r.date,purchase:0,sale:0};o.purchase=r.value??0,a.set(r.date,o)}),h.data.sale.forEach(r=>{const o=a.get(r.date)??{date:r.date,purchase:0,sale:0};o.sale=r.value??0,a.set(r.date,o)}),Array.from(a.values()).sort((r,o)=>r.date.localeCompare(o.date))},[h.data]),k=(c.data?.topPaymentMethods??[]).slice(0,4),b=c.isFetching||h.isFetching;return e.jsxs("div",{className:"dashboard-panel",children:[e.jsx(E,{title:"Panel de control",description:"Visualiza tus KPIs diarios y compara la tendencia de compras versus ventas."}),e.jsxs("section",{className:"card panel-filter","aria-labelledby":"panel-filter-title",children:[e.jsxs("div",{className:"panel-filter-header",children:[e.jsx("h3",{id:"panel-filter-title",children:"Filtro por fechas"}),e.jsx("span",{className:`panel-filter-status ${b?"busy":""}`,role:"status",children:b?"Actualizando datos...":"Datos al día"})]}),e.jsxs("div",{className:"date-filter",role:"group","aria-label":"Rango de fechas",children:[e.jsxs("label",{children:[e.jsx("span",{children:"Desde"}),e.jsx("input",{type:"date",value:m,max:i,onChange:N("from")})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Hasta"}),e.jsx("input",{type:"date",value:i,min:m,onChange:N("to")})]})]}),e.jsxs("p",{className:"muted small",children:["Período seleccionado: ",m," a ",i]})]}),e.jsxs("section",{className:"panel-kpis","aria-label":"Indicadores clave",children:[e.jsxs("article",{className:"card kpi-card",children:[e.jsx("h3",{children:"Ventas del día"}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando..."}):c.isError?e.jsx("p",{className:"panel-error",children:"No se pudieron cargar los indicadores."}):e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"kpi-value",children:x(c.data?.totalDay??0)}),e.jsxs("p",{className:"kpi-meta",children:["Total emitido el ",i]})]})]}),e.jsxs("article",{className:"card kpi-card",children:[e.jsx("h3",{children:"Producto más vendido"}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando..."}):c.isError?e.jsx("p",{className:"panel-error",children:"No se pudieron cargar los indicadores."}):c.data?.topProduct?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"kpi-value",children:c.data.topProduct.name}),e.jsxs("p",{className:"kpi-meta",children:[c.data.topProduct.qty," unidades"]})]}):e.jsx("p",{className:"muted",children:"Sin datos para el período seleccionado."})]}),e.jsxs("article",{className:"card kpi-card",children:[e.jsx("h3",{children:"Formas de pago más utilizadas"}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando..."}):c.isError?e.jsx("p",{className:"panel-error",children:"No se pudieron cargar los indicadores."}):k.length>0?e.jsx("ul",{className:"kpi-list",children:k.map(a=>e.jsxs("li",{children:[e.jsx("span",{className:"kpi-list-label",children:a.method}),e.jsxs("span",{className:"kpi-list-value",children:[a.count," usos"]})]},a.method))}):e.jsx("p",{className:"muted",children:"No hay ventas registradas en este rango."})]})]}),u.data&&u.data.length>0&&e.jsxs("section",{className:"card",style:{marginTop:"1.5rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"1rem"},children:[e.jsx("h3",{style:{margin:0},children:"⚠️ Productos bajo stock crítico"}),e.jsx("span",{className:"badge",style:{backgroundColor:"#dc2626",color:"white",padding:"0.25rem 0.5rem",borderRadius:"0.25rem",fontSize:"0.75rem"},children:u.data.length})]}),e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Categoría"}),e.jsx("th",{children:"Stock Actual"}),e.jsx("th",{children:"Stock Mínimo"}),e.jsx("th",{children:"Faltante"})]})}),e.jsx("tbody",{children:u.data.map(a=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:a.sku}),e.jsx("td",{children:a.name}),e.jsx("td",{children:a.category||"—"}),e.jsx("td",{className:"mono",style:{color:"#dc2626",fontWeight:"bold"},children:a.currentStock}),e.jsx("td",{className:"mono",children:a.criticalStock}),e.jsx("td",{className:"mono",style:{color:"#dc2626"},children:a.deficit})]},a.productId))})]})})]}),e.jsxs("section",{className:"card panel-chart","aria-labelledby":"overview-title",children:[e.jsx("div",{className:"panel-chart-header",children:e.jsxs("div",{children:[e.jsx("h3",{id:"overview-title",children:"Vista general"}),e.jsx("p",{className:"muted small",children:"Comparativo de compras vs. ventas"})]})}),h.isLoading?e.jsx("p",{className:"muted",children:"Cargando tendencia..."}):h.isError?e.jsx("p",{className:"panel-error",children:"No se pudo cargar la tendencia."}):v.length===0?e.jsx("p",{className:"muted",children:"Sin datos para el rango seleccionado."}):e.jsx("div",{className:"chart-wrapper",children:e.jsx(L,{width:"100%",height:"100%",children:e.jsxs(R,{data:v,margin:{top:20,right:24,bottom:8,left:0},children:[e.jsx(K,{strokeDasharray:"3 3",stroke:"#1f2937"}),e.jsx($,{dataKey:"date",stroke:"#9aa0a6",tick:{fontSize:12}}),e.jsx(q,{stroke:"#9aa0a6",tickFormatter:a=>x(Number(a)),width:96}),e.jsx(A,{formatter:a=>x(a),labelFormatter:a=>`Fecha: ${a}`}),e.jsx(T,{}),e.jsx(P,{type:"monotone",dataKey:"sale",name:"Ventas",stroke:"#60a5fa",strokeWidth:2,dot:!1}),e.jsx(P,{type:"monotone",dataKey:"purchase",name:"Compras",stroke:"#f97316",strokeWidth:2,dot:!1})]})})})]})]})}export{U as default};
