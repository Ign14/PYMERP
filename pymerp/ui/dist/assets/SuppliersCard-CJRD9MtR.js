import{L as F,M,j as e,u as w,N as q,p as D}from"./index-BpLAP759.js";import{r as l}from"./react-BYfE7jJl.js";import{a as S,u as Q}from"./useMutation-CPedeap3.js";import{M as R}from"./Modal-Bq1-hS2x.js";const v={name:"",rut:""};function O({open:p,supplier:o,onClose:d,onSaved:s}){const[a,u]=l.useState(v);l.useEffect(()=>{p&&u(o?{name:o.name??"",rut:o.rut??""}:v)},[p,o]);const t=S({mutationFn:r=>o?F(o.id,r):M(r),onSuccess:r=>{s?.(r),d()}}),h=r=>{r.preventDefault();const i=a.name.trim();if(!i){window.alert("El nombre es obligatorio");return}t.mutate({name:i,rut:a.rut?.trim()||void 0})},m=o?"Editar proveedor":"Nuevo proveedor";return e.jsx(R,{open:p,title:m,onClose:()=>!t.isPending&&d(),children:e.jsxs("form",{className:"form-grid",onSubmit:h,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",value:a.name,onChange:r=>u(i=>({...i,name:r.target.value})),placeholder:"Proveedor demo",disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"RUT"}),e.jsx("input",{className:"input",value:a.rut??"",onChange:r=>u(i=>({...i,rut:r.target.value})),placeholder:"76.123.456-k",disabled:t.isPending})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:t.isPending,children:t.isPending?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:d,disabled:t.isPending,children:"Cancelar"})]}),t.isError&&e.jsx("p",{className:"error",children:t.error?.message??"No se pudo guardar"})]})})}const K=l.forwardRef((p,o)=>{const d=w(),[s,a]=l.useState(null),[u,t]=l.useState(!1),[h,m]=l.useState(null),r=Q({queryKey:["suppliers"],queryFn:D,refetchOnWindowFocus:!1}),i=l.useCallback(()=>{m(null),t(!0)},[]),f=l.useCallback(()=>{t(!1),m(null)},[]);l.useImperativeHandle(o,()=>({openCreate:i}),[i]),l.useEffect(()=>{if(!s)return;const n=r.data?.find(g=>g.id===s.id);n?n!==s&&a(n):a(null)},[r.data,s]);const c=S({mutationFn:n=>q(n),onSuccess:(n,g)=>{d.invalidateQueries({queryKey:["suppliers"]}),s?.id===g&&a(null)}}),C=n=>{d.invalidateQueries({queryKey:["suppliers"]}),a(n),f()},y=()=>{s&&(m(s),t(!0))},E=()=>{!s||c.isPending||window.confirm(`Eliminar proveedor ${s.name}?`)&&c.mutate(s.id)},{data:b,isLoading:x,isError:j,error:P,refetch:k,isFetching:N}=r;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Proveedores"}),e.jsx("button",{className:"btn",onClick:()=>k(),disabled:N,children:N?"Cargando":"Refrescar"})]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn",type:"button",onClick:i,children:"+ Proveedor"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:y,disabled:!s,children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:E,disabled:!s||c.isPending,children:c.isPending?"Eliminando...":"Eliminar"})]}),c.isError&&e.jsx("p",{className:"error",children:c.error?.message??"No se pudo eliminar el proveedor"}),x&&e.jsx("p",{children:"Loading..."}),j&&e.jsx("p",{className:"error",children:P?.message??"No se pudieron cargar los proveedores"}),!x&&!j&&e.jsxs("ul",{className:"list",children:[(b??[]).map(n=>e.jsxs("li",{className:s?.id===n.id?"selected":void 0,onClick:()=>a(n),children:[e.jsx("strong",{children:n.name}),n.rut?e.jsxs("span",{className:"mono small",children:[" rut ",n.rut]}):null]},n.id)),(b??[]).length===0&&e.jsx("li",{className:"muted",children:"Sin proveedores"})]}),e.jsx(O,{open:u,supplier:h,onClose:f,onSaved:C})]})});K.displayName="SuppliersCard";export{K as S};
