import{i as W,n as V,u as R,c as L,j as e,aE as $,aF as B,S as K,aG as H,aH as X,aI as Y,aJ as J,aK as Z,aL as ee,aM as se,aN as ae}from"./index-CaCRVxfF.js";import{P as T}from"./PageHeader-t0ceLskt.js";import{r as v,d as te}from"./react-D8kvZI4c.js";import{u as D}from"./useQuery-CEK1m8YW.js";import{p as P}from"./problemDetail-CXg4dB0F.js";import{M as O}from"./Modal-C-I2iRqA.js";const ne=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;function q(){return{businessName:"",rut:"",businessActivity:"",address:"",commune:"",phone:"",email:"",receiptFooterMessage:""}}function k(l){return{businessName:l.businessName??"",rut:l.rut??"",businessActivity:l.businessActivity??"",address:l.address??"",commune:l.commune??"",phone:l.phone??"",email:l.email??"",receiptFooterMessage:l.receiptFooterMessage??""}}function le(l){const d={},r=l.businessName.trim();r||(d.businessName="La razón social es obligatoria");const m=l.rut.trim();let a;m?W(m)?a=V(m):d.rut="Ingresa un RUT válido":d.rut="El RUT es obligatorio";const n=l.email.trim();if(n&&!ne.test(n)&&(d.email="Ingresa un email válido"),Object.keys(d).length>0)return{errors:d};const c=N=>{const h=N.trim();return h.length>0?h:void 0};return{payload:{businessName:r,rut:a??l.rut,businessActivity:c(l.businessActivity),address:c(l.address),commune:c(l.commune),phone:c(l.phone),email:n?n.toLowerCase():void 0,receiptFooterMessage:c(l.receiptFooterMessage)},errors:d}}function re({companyId:l}){const d=R(),[r,m]=v.useState(!1),[a,n]=v.useState(q()),[c,b]=v.useState({}),[N,h]=v.useState(null),[w,i]=v.useState(null),g=D({queryKey:["company",l],queryFn:()=>B(l),enabled:!!l,refetchOnWindowFocus:!1});v.useEffect(()=>{g.data&&r&&n(k(g.data))},[g.data,r]);const t=L({mutationFn:s=>$(l,s),onSuccess:s=>{d.invalidateQueries({queryKey:["company",l],exact:!0}),d.invalidateQueries({queryKey:["companies"],exact:!1}),i("Datos guardados correctamente"),h(null),b({}),m(!1),n(k(s))},onError:s=>{const o=P(s);b(E=>({...E,...o.fieldErrors})),h(o.message??"No se pudieron guardar los cambios"),i(null)}}),j=g.isLoading,f=g.isError?g.error:null,u=g.data;v.useEffect(()=>{u&&!r&&n(k(u))},[u,r]);const y=v.useMemo(()=>{if(!u)return null;const s=[u.address,u.commune].filter(Boolean).join(", ");return{businessName:u.businessName??"",rut:u.rut??"",activity:u.businessActivity??"",location:s,phone:u.phone??"",email:u.email??"",receiptFooterMessage:u.receiptFooterMessage??"",updatedAt:u.updatedAt}},[u]),S=s=>{b(o=>{if(!o[s])return o;const E={...o};return delete E[s],E})},F=s=>{s.preventDefault(),h(null),i(null);const{payload:o,errors:E}=le(a);if(!o||Object.keys(E).length>0){b(E);return}t.mutate(o)};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Cuenta de la empresa"}),e.jsxs("div",{className:"card-actions",children:[e.jsx("button",{className:"btn-link",onClick:()=>g.refetch(),disabled:g.isFetching,children:g.isFetching?"Actualizando...":"Actualizar"}),e.jsx("button",{className:"btn-link",onClick:()=>{u&&!r&&n(k(u)),b({}),h(null),i(null),m(s=>!s)},disabled:j||t.isPending,children:r?"Cancelar":"Editar"})]})]}),e.jsxs("div",{className:"card-body",children:[j&&e.jsx("p",{children:"Cargando configuracion de la empresa..."}),f&&e.jsx("p",{className:"error","aria-live":"assertive",children:f.message??"No se pudo cargar la informacion de la empresa"}),!j&&!f&&y&&!r&&e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"12px"},children:[e.jsxs("dl",{style:{display:"grid",gap:"12px",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))"},children:[e.jsxs("div",{children:[e.jsx("dt",{children:"Razon social"}),e.jsx("dd",{children:y.businessName||"Sin registrar"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"RUT"}),e.jsx("dd",{children:y.rut||"Sin registrar"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Giro"}),e.jsx("dd",{children:y.activity||"Sin registrar"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Ubicacion"}),e.jsx("dd",{children:y.location||"Sin registrar"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Telefono"}),e.jsx("dd",{children:y.phone||"Sin registrar"})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Correo"}),e.jsx("dd",{children:y.email||"Sin registrar"})]})]}),y.receiptFooterMessage?e.jsxs("p",{className:"muted small",children:["Mensaje en boletas: ",y.receiptFooterMessage]}):null,y.updatedAt?e.jsxs("p",{className:"muted small",children:["Ultima actualizacion: ",new Date(y.updatedAt).toLocaleString()]}):null,w?e.jsx("p",{className:"success","aria-live":"polite",children:w}):null]}),!j&&!f&&u&&r&&e.jsxs("form",{className:"form-grid",onSubmit:F,noValidate:!0,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Razon social *"}),e.jsx("input",{className:"input",value:a.businessName,onChange:s=>{n(o=>({...o,businessName:s.target.value})),S("businessName"),i(null)},disabled:t.isPending,"aria-invalid":c.businessName?"true":void 0,"aria-describedby":c.businessName?"account-businessName-error":void 0}),c.businessName?e.jsx("p",{id:"account-businessName-error",className:"error","aria-live":"polite",children:c.businessName}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"RUT *"}),e.jsx("input",{className:"input",value:a.rut,onChange:s=>{n(o=>({...o,rut:s.target.value})),S("rut"),i(null)},disabled:t.isPending,"aria-invalid":c.rut?"true":void 0,"aria-describedby":c.rut?"account-rut-error":void 0}),c.rut?e.jsx("p",{id:"account-rut-error",className:"error","aria-live":"polite",children:c.rut}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Giro"}),e.jsx("input",{className:"input",value:a.businessActivity,onChange:s=>{n(o=>({...o,businessActivity:s.target.value})),S("businessActivity"),i(null)},disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Direccion"}),e.jsx("input",{className:"input",value:a.address,onChange:s=>{n(o=>({...o,address:s.target.value})),S("address"),i(null)},disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Comuna"}),e.jsx("input",{className:"input",value:a.commune,onChange:s=>{n(o=>({...o,commune:s.target.value})),S("commune"),i(null)},disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Telefono"}),e.jsx("input",{className:"input",value:a.phone,onChange:s=>{n(o=>({...o,phone:s.target.value})),S("phone"),i(null)},disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Correo de contacto"}),e.jsx("input",{className:"input",value:a.email,onChange:s=>{n(o=>({...o,email:s.target.value})),S("email"),i(null)},disabled:t.isPending,"aria-invalid":c.email?"true":void 0,"aria-describedby":c.email?"account-email-error":void 0}),c.email?e.jsx("p",{id:"account-email-error",className:"error","aria-live":"polite",children:c.email}):null]}),e.jsxs("label",{className:"full",children:[e.jsx("span",{children:"Mensaje en comprobantes"}),e.jsx("textarea",{className:"input",rows:3,value:a.receiptFooterMessage,onChange:s=>{n(o=>({...o,receiptFooterMessage:s.target.value})),S("receiptFooterMessage"),i(null)},disabled:t.isPending})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:t.isPending,children:t.isPending?"Guardando...":"Guardar cambios"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{n(u?k(u):q()),b({}),h(null),i(null),m(!1)},disabled:t.isPending,children:"Cancelar"})]}),N?e.jsx("p",{className:"error","aria-live":"assertive",children:N}):null,w?e.jsx("p",{className:"success","aria-live":"polite",children:w}):null]})]})]})}const I="http://localhost:5173/login";function ie(){const l=te(),{session:d,logout:r}=K(),[m,a]=v.useState(null),n=d?.modules??[],c=async()=>{try{await navigator.clipboard.writeText(I),a("Enlace copiado al portapapeles.")}catch{a("No se pudo copiar el enlace. Copialo manualmente.")}},b=()=>{r(),l("/login")},N=()=>{l("/login")};return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsx("h2",{children:"Acceso a la cuenta"})}),e.jsxs("div",{className:"card-body",style:{display:"flex",flexDirection:"column",gap:"16px"},children:[d?e.jsxs(e.Fragment,{children:[e.jsxs("p",{children:["Sesion iniciada como ",e.jsx("strong",{children:d.email}),d.name?` (${d.name})`:"","."]}),e.jsxs("p",{className:"muted small",children:["Compania activa: ",d.companyId]}),n.length>0?e.jsxs("div",{children:[e.jsx("h3",{className:"small",children:"Modulos habilitados"}),e.jsx("p",{className:"muted small",children:n.join(", ")})]}):null]}):e.jsx("p",{children:"No hay una sesion activa en este momento."}),e.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:[e.jsx("h3",{children:"Enlace para nuevos usuarios"}),e.jsxs("p",{className:"muted small",children:["Comparte este enlace con los usuarios que crees desde esta pagina para que inicien sesion con la contrasena entregada: ",e.jsx("span",{className:"mono",children:I})]}),e.jsxs("div",{style:{display:"flex",gap:"12px",flexWrap:"wrap"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:c,children:"Copiar enlace de acceso"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:N,children:"Abrir pantalla de login"})]}),m?e.jsx("p",{className:"muted small","aria-live":"polite",children:m}):null]}),e.jsxs("section",{style:{display:"flex",flexDirection:"column",gap:"8px"},children:[e.jsx("h3",{children:"Sesion actual"}),e.jsx("p",{className:"muted small",children:"Cierra la sesion para probar nuevas credenciales o cambia de usuario sin abandonar la seccion de configuracion."}),e.jsx("button",{className:"btn danger",type:"button",onClick:b,children:"Cerrar sesion"})]})]})]})}const Q=[{value:"ROLE_ADMIN",label:"Administrador"},{value:"ROLE_SALES",label:"Ventas"},{value:"ROLE_PURCHASES",label:"Compras"},{value:"ROLE_INVENTORY",label:"Inventario"},{value:"ROLE_FINANCE",label:"Finanzas"},{value:"ROLE_REPORTS",label:"Reportes"},{value:"ROLE_SETTINGS",label:"Configuracion"}],oe=[{value:"active",label:"Activo"},{value:"disabled",label:"Suspendido"}];function A(){const l="ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789";let d="";for(let r=0;r<10;r+=1)d+=l[Math.floor(Math.random()*l.length)];return d}function ce(){const l=R(),[d,r]=v.useState(!1),[m,a]=v.useState(null),[n,c]=v.useState(null),[b,N]=v.useState(null),h=D({queryKey:["users"],queryFn:J,refetchOnWindowFocus:!1}),w=L({mutationFn:s=>H(s),onSuccess:s=>{l.invalidateQueries({queryKey:["users"],exact:!1}),N(`Usuario ${s.email} creado. Comparte el enlace de acceso con la nueva clave.`)}}),i=L({mutationFn:({id:s,payload:o})=>X(s,o),onSuccess:s=>{l.invalidateQueries({queryKey:["users"],exact:!1}),N(`Usuario ${s.email} actualizado.`)}}),g=L({mutationFn:({id:s,payload:o})=>Y(s,o),onSuccess:()=>{l.invalidateQueries({queryKey:["users"],exact:!1})}}),t=h.data??[],j=h.isLoading,f=h.isError?h.error:null,u=async s=>{const o={email:s.email.trim(),name:s.name.trim(),roles:s.roles,status:s.status,password:s.password??"",role:s.roles[0]??void 0};try{await w.mutateAsync(o),r(!1)}catch(E){const p=P(E);throw new Error(p.message??"No se pudo crear el usuario")}},y=async(s,o)=>{const E={email:s.email.trim(),name:s.name.trim(),roles:s.roles,status:s.status,role:s.roles[0]??void 0};try{await i.mutateAsync({id:o,payload:E}),a(null)}catch(p){const x=P(p);throw new Error(x.message??"No se pudo actualizar el usuario")}},S=async(s,o)=>{const E={password:s};try{const p=n?.email??"";await g.mutateAsync({id:o,payload:E}),N(p?`Contrasena actualizada para ${p}.`:"Contrasena actualizada."),c(null)}catch(p){const x=P(p);throw new Error(x.message??"No se pudo actualizar la contrasena")}},F=v.useMemo(()=>{const s=new Map;for(const o of Q)s.set(o.value,o.label);return s},[]);return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Usuarios y accesos"}),e.jsxs("div",{className:"card-actions",children:[e.jsx("button",{className:"btn-link",onClick:()=>h.refetch(),disabled:h.isFetching,children:h.isFetching?"Actualizando...":"Actualizar"}),e.jsx("button",{className:"btn-link",onClick:()=>r(!0),disabled:w.isPending,children:"Nuevo usuario"})]})]}),e.jsxs("div",{className:"card-body",children:[j&&e.jsx("p",{children:"Cargando usuarios..."}),f&&e.jsx("p",{className:"error","aria-live":"assertive",children:f.message??"No se pudieron cargar los usuarios"}),!j&&!f&&t.length===0&&e.jsx("p",{className:"muted",children:"Aun no se registran usuarios para esta cuenta."}),!j&&!f&&t.length>0&&e.jsx("div",{style:{overflowX:"auto"},children:e.jsxs("table",{style:{width:"100%",borderCollapse:"collapse"},children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{style:{textAlign:"left",padding:"8px"},children:"Nombre"}),e.jsx("th",{style:{textAlign:"left",padding:"8px"},children:"Correo"}),e.jsx("th",{style:{textAlign:"left",padding:"8px"},children:"Roles"}),e.jsx("th",{style:{textAlign:"left",padding:"8px"},children:"Estado"}),e.jsx("th",{style:{textAlign:"left",padding:"8px"},children:"Creado"}),e.jsx("th",{style:{textAlign:"left",padding:"8px"},"aria-label":"Acciones"})]})}),e.jsx("tbody",{children:t.map(s=>{const o=s.roles.length>0?s.roles.map(E=>F.get(E)??E).join(", "):"-";return e.jsxs("tr",{style:{borderTop:"1px solid rgba(255,255,255,0.1)"},children:[e.jsx("td",{style:{padding:"8px"},children:s.name||"Sin nombre"}),e.jsx("td",{style:{padding:"8px",fontFamily:"monospace",fontSize:"0.9rem"},children:s.email}),e.jsx("td",{style:{padding:"8px"},children:o}),e.jsx("td",{style:{padding:"8px"},children:s.status==="active"?"Activo":"Suspendido"}),e.jsx("td",{style:{padding:"8px",fontSize:"0.9rem"},children:s.createdAt?new Date(s.createdAt).toLocaleDateString():"N/D"}),e.jsx("td",{style:{padding:"8px"},children:e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("button",{className:"btn-link",onClick:()=>a(s),children:"Editar"}),e.jsx("button",{className:"btn-link",onClick:()=>c(s),children:"Reset clave"})]})})]},s.id)})})]})}),b?e.jsx("p",{className:"success","aria-live":"polite",children:b}):null]}),e.jsx(G,{mode:"create",open:d,onClose:()=>r(!1),onSubmit:u,isSubmitting:w.isPending}),e.jsx(G,{mode:"edit",open:!!m,onClose:()=>a(null),onSubmit:s=>m?y(s,m.id):Promise.resolve(),initialUser:m??void 0,isSubmitting:i.isPending}),e.jsx(de,{open:!!n,onClose:()=>c(null),user:n??void 0,onSubmit:async s=>{n&&await S(s,n.id)},isSubmitting:g.isPending})]})}function G({mode:l,open:d,onClose:r,initialUser:m,onSubmit:a,isSubmitting:n}){const[c,b]=v.useState(""),[N,h]=v.useState(""),[w,i]=v.useState("active"),[g,t]=v.useState(new Set(["ROLE_ADMIN"])),[j,f]=v.useState(l==="create"?A():""),[u,y]=v.useState({}),[S,F]=v.useState(null),s=()=>{l==="create"?(b(""),h(""),i("active"),t(new Set(["ROLE_ADMIN"])),f(A())):m&&(b(m.email??""),h(m.name??""),i(m.status??"active"),t(new Set(m.roles??[])),f("")),y({}),F(null)};if(v.useEffect(()=>{d&&(l==="create"?(b(""),h(""),i("active"),t(new Set(["ROLE_ADMIN"])),f(A())):m&&(b(m.email??""),h(m.name??""),i(m.status??"active"),t(new Set(m.roles??[])),f("")),y({}),F(null))},[d,l,m]),!d)return null;const o=p=>{t(x=>{const C=new Set(x);return C.has(p)?C.delete(p):C.add(p),C})},E=async p=>{p.preventDefault();const x={},C=c.trim(),U=N.trim();C?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(C)||(x.email="El formato del correo no es valido"):x.email="El correo es obligatorio",U||(x.name="El nombre es obligatorio");const z=Array.from(g);if(z.length===0&&(x.roles="Selecciona al menos un rol"),l==="create"){const M=j.trim();M?M.length<8&&(x.password="La contrasena debe tener al menos 8 caracteres"):x.password="La contrasena es obligatoria"}if(y(x),F(null),!(Object.keys(x).length>0))try{await a({email:C,name:U,status:w,roles:z,password:l==="create"?j.trim():void 0}),s()}catch(M){F(M instanceof Error?M.message:"No se pudo guardar el usuario")}};return e.jsx(O,{open:d,onClose:()=>{s(),r()},title:l==="create"?"Crear usuario":"Editar usuario",children:e.jsxs("form",{className:"form-grid",onSubmit:E,noValidate:!0,children:[e.jsxs("label",{className:"full",children:[e.jsx("span",{children:"Correo *"}),e.jsx("input",{className:"input",value:c,onChange:p=>{b(p.target.value),y(x=>{if(!x.email)return x;const C={...x};return delete C.email,C})},disabled:n,autoComplete:"email"}),u.email?e.jsx("p",{className:"error","aria-live":"polite",children:u.email}):null]}),e.jsxs("label",{className:"full",children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",value:N,onChange:p=>{h(p.target.value),y(x=>{if(!x.name)return x;const C={...x};return delete C.name,C})},disabled:n,autoComplete:"name"}),u.name?e.jsx("p",{className:"error","aria-live":"polite",children:u.name}):null]}),e.jsxs("fieldset",{className:"full",children:[e.jsx("legend",{children:"Roles *"}),e.jsx("div",{style:{display:"grid",gap:"8px",gridTemplateColumns:"repeat(auto-fit, minmax(160px, 1fr))"},children:Q.map(p=>e.jsxs("label",{className:"checkbox",children:[e.jsx("input",{type:"checkbox",checked:g.has(p.value),onChange:()=>{o(p.value),y(x=>{if(!x.roles)return x;const C={...x};return delete C.roles,C})},disabled:n&&!g.has(p.value)}),e.jsx("span",{children:p.label})]},p.value))}),u.roles?e.jsx("p",{className:"error","aria-live":"polite",children:u.roles}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Estado"}),e.jsx("select",{className:"input",value:w,onChange:p=>i(p.target.value),disabled:n,children:oe.map(p=>e.jsx("option",{value:p.value,children:p.label},p.value))})]}),l==="create"&&e.jsxs("label",{className:"full",children:[e.jsx("span",{children:"Contrasena inicial *"}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("input",{className:"input",value:j,onChange:p=>{f(p.target.value),y(x=>{if(!x.password)return x;const C={...x};return delete C.password,C})},disabled:n,autoComplete:"new-password"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>f(A()),disabled:n,children:"Generar"})]}),u.password?e.jsx("p",{className:"error","aria-live":"polite",children:u.password}):null,e.jsx("p",{className:"muted small",children:"Entrega este valor junto con el enlace de acceso: http://localhost:5173/login"})]}),S?e.jsx("p",{className:"error","aria-live":"assertive",children:S}):null,e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:n,children:n?"Guardando...":l==="create"?"Crear usuario":"Guardar cambios"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{s(),r()},disabled:n,children:"Cancelar"})]})]})})}function de({open:l,onClose:d,user:r,onSubmit:m,isSubmitting:a}){const[n,c]=v.useState(A()),[b,N]=v.useState(null);if(!l||!r)return null;const h=async w=>{w.preventDefault();const i=n.trim();if(i.length<8){N("La contrasena debe tener al menos 8 caracteres");return}try{await m(i),N(null),c(A())}catch(g){N(g instanceof Error?g.message:"No se pudo actualizar la contrasena")}};return e.jsx(O,{open:l,onClose:()=>{c(A()),N(null),d()},title:"Restablecer contrasena",children:e.jsxs("form",{className:"stack gap-sm",onSubmit:h,noValidate:!0,children:[e.jsxs("p",{children:["Se generara una nueva contrasena para ",e.jsx("strong",{children:r.email}),". Comparte este valor y pide que la cambien al ingresar."]}),e.jsxs("div",{style:{display:"flex",gap:"8px",flexWrap:"wrap"},children:[e.jsx("input",{className:"input",value:n,onChange:w=>c(w.target.value),disabled:a,autoComplete:"new-password"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>c(A()),disabled:a,children:"Generar"})]}),b?e.jsx("p",{className:"error","aria-live":"assertive",children:b}):null,e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:a,children:a?"Guardando...":"Guardar nueva contrasena"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{c(A()),N(null),d()},disabled:a,children:"Cancelar"})]})]})})}const _=()=>({businessName:"",fantasyName:"",rut:"",logoUrl:"",businessActivity:"",address:"",commune:"",phone:"",email:"",receiptFooterMessage:"",slogan:"",parentLocations:[]});function ue({open:l,onClose:d,editingCompany:r}){const m=R(),[a,n]=v.useState(()=>r?{businessName:r.businessName,fantasyName:r.fantasyName||"",rut:r.rut,logoUrl:r.logoUrl||"",businessActivity:r.businessActivity||"",address:r.address||"",commune:r.commune||"",phone:r.phone||"",email:r.email||"",receiptFooterMessage:r.receiptFooterMessage||"",slogan:r.slogan||"",parentLocations:r.parentLocations||[]}:_()),c=L({mutationFn:t=>Z(t),onSuccess:()=>{m.invalidateQueries({queryKey:["companies"],exact:!1}),N()}}),b=L({mutationFn:({id:t,payload:j})=>ee(t,j),onSuccess:()=>{m.invalidateQueries({queryKey:["companies"],exact:!1}),N()}}),N=()=>{n(_()),d()},h=t=>{if(t.preventDefault(),!a.businessName.trim()){alert("La razón social es obligatoria");return}if(!a.rut.trim()){alert("El RUT es obligatorio");return}const j={businessName:a.businessName.trim(),fantasyName:a.fantasyName.trim()||void 0,rut:a.rut.trim(),logoUrl:a.logoUrl.trim()||void 0,businessActivity:a.businessActivity.trim()||void 0,address:a.address.trim()||void 0,commune:a.commune.trim()||void 0,phone:a.phone.trim()||void 0,email:a.email.trim()||void 0,receiptFooterMessage:a.receiptFooterMessage.trim()||void 0,slogan:a.slogan.trim()||void 0,parentLocations:a.parentLocations.filter(f=>f.name.trim()&&f.code.trim())};r?b.mutate({id:r.id,payload:j}):c.mutate(j)},w=()=>{n(t=>({...t,parentLocations:[...t.parentLocations,{name:"",code:""}]}))},i=t=>{n(j=>({...j,parentLocations:j.parentLocations.filter((f,u)=>u!==t)}))},g=(t,j,f)=>{n(u=>{const y=[...u.parentLocations];return y[t]={...y[t],[j]:f},{...u,parentLocations:y}})};return e.jsx(O,{open:l,onClose:N,title:r?"Editar Empresa":"Nueva Empresa",children:e.jsxs("form",{onSubmit:h,children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["Razón Social ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:a.businessName,onChange:t=>n({...a,businessName:t.target.value}),className:"w-full px-3 py-2 border rounded",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Nombre de Fantasía"}),e.jsx("input",{type:"text",value:a.fantasyName,onChange:t=>n({...a,fantasyName:t.target.value}),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium mb-1",children:["RUT ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{type:"text",value:a.rut,onChange:t=>n({...a,rut:t.target.value}),className:"w-full px-3 py-2 border rounded",placeholder:"12345678-9",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"URL del Logo"}),e.jsx("input",{type:"text",value:a.logoUrl,onChange:t=>n({...a,logoUrl:t.target.value}),className:"w-full px-3 py-2 border rounded",placeholder:"https://ejemplo.com/logo.png"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Giro Comercial"}),e.jsx("input",{type:"text",value:a.businessActivity,onChange:t=>n({...a,businessActivity:t.target.value}),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Dirección"}),e.jsx("input",{type:"text",value:a.address,onChange:t=>n({...a,address:t.target.value}),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Comuna"}),e.jsx("input",{type:"text",value:a.commune,onChange:t=>n({...a,commune:t.target.value}),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Teléfono"}),e.jsx("input",{type:"text",value:a.phone,onChange:t=>n({...a,phone:t.target.value}),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Email"}),e.jsx("input",{type:"email",value:a.email,onChange:t=>n({...a,email:t.target.value}),className:"w-full px-3 py-2 border rounded"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Slogan"}),e.jsx("input",{type:"text",value:a.slogan,onChange:t=>n({...a,slogan:t.target.value}),className:"w-full px-3 py-2 border rounded"})]})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{className:"block text-sm font-medium mb-1",children:"Mensaje para recibos"}),e.jsx("textarea",{value:a.receiptFooterMessage,onChange:t=>n({...a,receiptFooterMessage:t.target.value}),className:"w-full px-3 py-2 border rounded",rows:3})]}),e.jsxs("div",{className:"mb-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("label",{className:"block text-sm font-medium",children:"Ubicaciones Padre"}),e.jsx("button",{type:"button",onClick:w,className:"px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm",children:"+ Agregar"})]}),a.parentLocations.length===0?e.jsx("p",{className:"text-sm text-gray-500",children:"No hay ubicaciones padre. Agrégalas para organizar el inventario."}):e.jsx("div",{className:"space-y-2",children:a.parentLocations.map((t,j)=>e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx("input",{type:"text",value:t.name,onChange:f=>g(j,"name",f.target.value),placeholder:"Nombre (ej: Bodega Principal)",className:"flex-1 px-3 py-2 border rounded"}),e.jsx("input",{type:"text",value:t.code,onChange:f=>g(j,"code",f.target.value),placeholder:"Código (ej: BP)",className:"w-32 px-3 py-2 border rounded"}),e.jsx("button",{type:"button",onClick:()=>i(j),className:"px-3 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"✕"})]},j))})]}),e.jsxs("div",{className:"flex justify-end gap-2 pt-4 border-t",children:[e.jsx("button",{type:"button",onClick:N,className:"px-4 py-2 border rounded hover:bg-gray-100",children:"Cancelar"}),e.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",disabled:c.isPending||b.isPending,children:r?"Actualizar":"Crear"})]})]})})}function me(){const l=R(),[d,r]=v.useState(!1),[m,a]=v.useState(null),{data:n=[],isLoading:c}=D({queryKey:["companies"],queryFn:ae}),b=L({mutationFn:i=>se(i),onSuccess:()=>{l.invalidateQueries({queryKey:["companies"],exact:!1})}}),N=()=>{a(null),r(!0)},h=i=>{a(i),r(!0)},w=i=>{confirm(`¿Estás seguro de eliminar la empresa "${i.fantasyName||i.businessName}"?

Esto también eliminará todas sus ubicaciones padre.`)&&b.mutate(i.id)};return e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Gestión de Empresas"}),e.jsx("button",{onClick:N,className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"+ Nueva Empresa"})]}),c?e.jsx("p",{className:"text-gray-500",children:"Cargando empresas..."}):n.length===0?e.jsx("p",{className:"text-gray-500",children:"No hay empresas registradas."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"w-full text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"border-b",children:[e.jsx("th",{className:"text-left p-2",children:"Nombre/Razón Social"}),e.jsx("th",{className:"text-left p-2",children:"RUT"}),e.jsx("th",{className:"text-left p-2",children:"Ubicaciones Padre"}),e.jsx("th",{className:"text-right p-2",children:"Acciones"})]})}),e.jsx("tbody",{children:n.map(i=>e.jsxs("tr",{className:"border-b hover:bg-gray-50",children:[e.jsx("td",{className:"p-2",children:e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:i.fantasyName||i.businessName}),i.fantasyName&&e.jsx("div",{className:"text-xs text-gray-500",children:i.businessName})]})}),e.jsx("td",{className:"p-2",children:i.rut}),e.jsx("td",{className:"p-2",children:i.parentLocations&&i.parentLocations.length>0?e.jsx("div",{className:"flex flex-wrap gap-1",children:i.parentLocations.map(g=>e.jsxs("span",{className:"px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs",children:[g.code," - ",g.name]},g.id))}):e.jsx("span",{className:"text-gray-400",children:"Sin ubicaciones"})}),e.jsxs("td",{className:"p-2 text-right",children:[e.jsx("button",{onClick:()=>h(i),className:"px-3 py-1 text-blue-600 hover:bg-blue-50 rounded mr-2",children:"Editar"}),e.jsx("button",{onClick:()=>w(i),className:"px-3 py-1 text-red-600 hover:bg-red-50 rounded",disabled:b.isPending,children:"Eliminar"})]})]},i.id))})]})})]}),e.jsx(ue,{open:d,onClose:()=>r(!1),editingCompany:m})]})}function ve(){const{session:l}=K();if(!l)return e.jsxs("div",{className:"page-section",children:[e.jsx(T,{title:"Configuracion",description:"Inicia sesion para administrar la cuenta."}),e.jsx("p",{children:"No hay una sesion activa actualmente."})]});const d={display:"grid",gap:"24px",gridTemplateColumns:"repeat(auto-fit, minmax(320px, 1fr))",alignItems:"stretch"};return e.jsxs("div",{className:"page-section",children:[e.jsx(T,{title:"Configuracion",description:"Administra los datos de la empresa, los usuarios y el acceso a PYMERP."}),e.jsxs("div",{style:d,children:[e.jsx(re,{companyId:l.companyId}),e.jsx(ie,{}),e.jsx(ce,{})]}),e.jsx("div",{className:"mt-6",children:e.jsx(me,{})})]})}export{ve as default};
