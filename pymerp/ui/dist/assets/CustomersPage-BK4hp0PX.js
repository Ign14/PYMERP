import{u as A,l as _,c as $,a1 as J,j as e,a2 as Z,a3 as X,d as Y,a4 as ee,a5 as U,a6 as se}from"./index-OfXnknKF.js";import{r as i}from"./react-DFcFNn96.js";import{u as O}from"./useQuery-7A7SEbdC.js";import{P as ae}from"./PageHeader-DR0dkBli.js";import{u as te,m as ne,c as le}from"./customersUtils-Co8rj5Pn.js";import{M as re}from"./Modal-BCEKQ7aJ.js";const ie=20,oe="createdAt,desc",B=i.forwardRef((P,h)=>{const{segmentFilter:r,segmentLabel:x,onClearSegment:n,onOpenCreateDialog:o,onOpenEditDialog:g}=P,b=A(),[c,j]=i.useState(""),[a,l]=i.useState(null),[m,N]=i.useState(null),[f,S]=i.useState(!1),d=i.useRef(null),p=i.useRef(0);i.useImperativeHandle(h,()=>({focusCreate:()=>{o?.()},clearForm:()=>{},getFilters:()=>({query:c,segment:r??null,active:a})}),[o,c,r,a]),i.useEffect(()=>{p.current=0},[c,r,a]);const T=i.useCallback(async s=>{const D=c.trim(),C=performance.now(),M=await _({q:D.length?D:void 0,segment:r??void 0,page:s,size:ie,sort:oe}),H=Math.round(performance.now()-C),W=M.content?.length??0;return console.info(`[Customers] page ${s} fetched (${W} items) in ${H}ms`),M},[c,r,a]),t=te({queryKey:["customers",c,r??null,a??null],queryFn:({pageParam:s=0})=>T(s),getNextPageParam:s=>le(s),initialPageParam:0}),{fetchNextPage:v,isFetchingNextPage:E,refetch:F}=t,y=i.useMemo(()=>ne(t.data?.pages??[]),[t.data]);i.useEffect(()=>{if(y.length===0){N(null);return}N(s=>s&&y.some(D=>D.id===s)?s:y[0]?.id??null)},[y]);const u=i.useMemo(()=>m?y.find(s=>s.id===m)??null:null,[y,m]),w=i.useMemo(()=>u?u.lat!==void 0&&u.lat!==null&&`${u.lat}`.trim()!==""&&u.lng!==void 0&&u.lng!==null&&`${u.lng}`.trim()!==""?`${u.lat},${u.lng}`:u.address&&u.address.trim()?u.address.trim():null:null,[u]),z=i.useMemo(()=>w?`https://www.google.com/maps?q=${encodeURIComponent(w)}&output=embed`:null,[w]),Q=i.useMemo(()=>w?`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(w)}`:null,[w]),q=t.hasNextPage??!1,R=t.isLoading&&!E;i.useEffect(()=>{const s=t.data?.pages.length??0;s>p.current&&(p.current=s,console.info(`[Customers] pages fetched so far: ${s}`))},[t.data]),i.useEffect(()=>{const s=d.current;if(!s)return;const D=new IntersectionObserver(C=>{C[0].isIntersecting&&q&&!E&&v()});return D.observe(s),()=>D.disconnect()},[q,E,v]);const I=$({mutationFn:s=>J(s),onSuccess:()=>{b.invalidateQueries({queryKey:["customers"],exact:!1})}}),k=O({queryKey:["customers",m,"stats"],queryFn:()=>Z(m),enabled:!!m&&f,staleTime:3e4}),L=O({queryKey:["customers",m,"sales"],queryFn:()=>X(m,0,5),enabled:!!m&&f,staleTime:3e4}),K=t.isError?t.error?.message??"No se pudieron cargar los clientes":void 0,G=!R&&!t.isError&&y.length===0;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Clientes"}),e.jsx("input",{className:"input",placeholder:"Buscar por nombre, email, telÃ©fono o RUT",value:c,onChange:s=>j(s.target.value)})]}),x&&e.jsxs("div",{className:"active-filter",children:[e.jsxs("span",{children:["Filtrado por segmento: ",x]}),n&&e.jsx("button",{className:"btn ghost",type:"button",onClick:n,children:"Limpiar"})]}),R&&e.jsx("p",{children:"Loading..."}),!R&&t.isError&&y.length===0&&e.jsxs("div",{className:"error",children:[e.jsx("p",{children:K}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>F(),children:"Reintentar"})]}),!t.isError&&y.length>0&&e.jsx("ul",{className:"list","aria-live":"polite",children:y.map(s=>{const D=m===s.id;return e.jsxs("li",{className:`list-row${D?" selected":""}`,onClick:()=>N(s.id),role:"button",tabIndex:0,onKeyDown:C=>{(C.key==="Enter"||C.key===" ")&&(C.preventDefault(),N(s.id))},children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.name}),s.rut?e.jsxs("div",{className:"mono small",children:["RUT: ",s.rut]}):null,s.segment?e.jsx("div",{className:"mono small",children:s.segment}):null,s.email?e.jsx("div",{className:"mono small",children:s.email}):null,s.phone?e.jsx("div",{className:"mono small",children:s.phone}):null,s.address?e.jsx("div",{className:"mono small",children:s.address}):null,s.active===!1?e.jsx("div",{className:"badge",style:{backgroundColor:"#f5f5f5",color:"#666"},children:"Inactivo"}):null]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:"btn ghost",onClick:C=>{C.stopPropagation(),g?.(s)},children:"Editar"}),e.jsx("button",{className:"btn ghost",onClick:C=>{C.stopPropagation(),I.mutate(s.id)},disabled:I.isPending,children:s.active!==!1?"Desactivar":"Activar"})]})]},s.id)})}),G&&e.jsxs("div",{className:"muted",children:[e.jsx("p",{children:"Sin clientes"}),e.jsx("p",{className:"small",children:"Crea tu primer cliente usando el formulario debajo."})]}),t.isError&&y.length>0&&e.jsxs("div",{className:"error inline",children:[e.jsx("span",{children:K}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>F(),children:"Reintentar"})]}),e.jsx("div",{ref:d,"aria-hidden":"true"}),E&&e.jsx("p",{className:"muted",children:"Cargando mas..."}),!q&&y.length>0&&e.jsx("p",{className:"muted",children:"No hay mas resultados"}),u&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"map-panel",children:[e.jsxs("div",{className:"map-header",children:[e.jsxs("div",{children:[e.jsx("strong",{children:u.name}),u.address?e.jsx("p",{className:"muted small",children:u.address}):e.jsx("p",{className:"muted small",children:"Sin direcciÃ³n registrada"})]}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>S(!f),children:f?"Ocultar detalles":"Ver detalles"}),Q&&e.jsx("a",{className:"btn ghost",href:Q,target:"_blank",rel:"noreferrer",children:"Ver en Google Maps"})]})]}),z?e.jsx("div",{className:"map-preview",children:e.jsx("iframe",{title:`UbicaciÃ³n de ${u.name}`,src:z,loading:"lazy",allowFullScreen:!0})}):e.jsx("p",{className:"muted small",children:"Registra una direcciÃ³n o coordenadas para visualizar el mapa."})]}),f&&e.jsxs("div",{className:"card",style:{marginTop:"1rem",padding:"1rem"},children:[e.jsx("h3",{style:{marginBottom:"1rem",fontSize:"0.95rem"},children:"Historial y EstadÃ­sticas"}),k.isLoading&&e.jsx("p",{className:"muted",children:"Cargando estadÃ­sticas..."}),k.isError&&e.jsx("p",{className:"error",children:"Error al cargar estadÃ­sticas"}),k.data&&e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(150px, 1fr))",gap:"1rem",marginBottom:"1.5rem"},children:[e.jsxs("div",{children:[e.jsx("p",{className:"muted small",children:"Total Ventas"}),e.jsx("p",{style:{fontSize:"1.5rem",fontWeight:"600",margin:"0.25rem 0"},children:k.data.totalSales||0})]}),e.jsxs("div",{children:[e.jsx("p",{className:"muted small",children:"Ingresos Totales"}),e.jsxs("p",{style:{fontSize:"1.5rem",fontWeight:"600",margin:"0.25rem 0"},children:["$",(k.data.totalRevenue||0).toLocaleString("es-CL")]})]}),e.jsxs("div",{children:[e.jsx("p",{className:"muted small",children:"Ãšltima Venta"}),e.jsx("p",{style:{fontSize:"1.5rem",fontWeight:"600",margin:"0.25rem 0"},children:k.data.lastSaleDate?new Date(k.data.lastSaleDate).toLocaleDateString("es-CL"):"-"})]})]}),e.jsx("h4",{style:{marginBottom:"0.5rem",fontSize:"0.9rem"},children:"Ãšltimas Ventas"}),L.isLoading&&e.jsx("p",{className:"muted",children:"Cargando historial..."}),L.isError&&e.jsx("p",{className:"error",children:"Error al cargar historial"}),L.data&&L.data.content.length>0?e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Fecha"}),e.jsx("th",{children:"Tipo"}),e.jsx("th",{style:{textAlign:"right"},children:"Total"})]})}),e.jsx("tbody",{children:L.data.content.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono small",children:new Date(s.saleDate).toLocaleDateString("es-CL")}),e.jsx("td",{children:s.docType||"-"}),e.jsxs("td",{className:"mono",style:{textAlign:"right",fontWeight:"600"},children:["$",s.total.toLocaleString("es-CL")]})]},s.saleId))})]}):L.data&&e.jsx("p",{className:"muted small",children:"No hay ventas registradas"})]})]}),e.jsxs("div",{className:"active-filter",style:{display:"flex",gap:"1rem",alignItems:"center",marginTop:"1rem"},children:[e.jsx("span",{className:"muted small",children:"Mostrar:"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem"},children:[e.jsx("button",{className:`btn ghost ${a===null?"selected":""}`,type:"button",onClick:()=>l(null),children:"Todos"}),e.jsx("button",{className:`btn ghost ${a===!0?"selected":""}`,type:"button",onClick:()=>l(!0),children:"Activos"}),e.jsx("button",{className:`btn ghost ${a===!1?"selected":""}`,type:"button",onClick:()=>l(!1),children:"Inactivos"})]})]}),I.isError&&e.jsx("p",{className:"error",children:I.error?.message})]})});B.displayName="CustomersCard";const V=()=>({name:"",rut:"",phone:"",email:"",address:"",segment:"",contactPerson:"",notes:"",active:!0,latText:"",lngText:""});function ce({open:P,onClose:h,editingCustomer:r}){const x=A(),[n,o]=i.useState(()=>r?{name:r.name,rut:r.rut||"",phone:r.phone||"",email:r.email||"",address:r.address||"",segment:r.segment||"",contactPerson:r.contactPerson||"",notes:r.notes||"",active:r.active!==!1,latText:r.lat?.toString()||"",lngText:r.lng?.toString()||""}:V()),g=$({mutationFn:a=>Y(a),onSuccess:()=>{x.invalidateQueries({queryKey:["customers"],exact:!1}),c()}}),b=$({mutationFn:({id:a,payload:l})=>ee(a,l),onSuccess:()=>{x.invalidateQueries({queryKey:["customers"],exact:!1}),c()}}),c=()=>{o(V()),h()},j=a=>{if(a.preventDefault(),!n.name||!n.name.trim()){alert("El nombre es obligatorio");return}const l=N=>{if(!N||!N.trim())return null;const f=Number(N.trim());return Number.isFinite(f)?f:null},m={name:n.name.trim(),rut:n.rut?.trim()||void 0,phone:n.phone?.trim()||void 0,email:n.email?.trim()||void 0,address:n.address?.trim()||void 0,segment:n.segment?.trim()||void 0,contactPerson:n.contactPerson?.trim()||void 0,notes:n.notes?.trim()||void 0,active:n.active,lat:l(n.latText),lng:l(n.lngText)};r?b.mutate({id:r.id,payload:m}):g.mutate(m)};return e.jsx(re,{open:P,onClose:c,title:r?"Editar Cliente":"Nuevo Cliente",children:e.jsxs("form",{className:"form-grid",onSubmit:j,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",autoFocus:!0,value:n.name,onChange:a=>o(l=>({...l,name:a.target.value})),placeholder:"Cliente demo"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"RUT"}),e.jsx("input",{className:"input",value:n.rut??"",onChange:a=>o(l=>({...l,rut:a.target.value})),placeholder:"12.345.678-9"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Email"}),e.jsx("input",{className:"input",type:"email",value:n.email??"",onChange:a=>o(l=>({...l,email:a.target.value})),placeholder:"cliente@correo.com"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"TelÃ©fono"}),e.jsx("input",{className:"input",value:n.phone??"",onChange:a=>o(l=>({...l,phone:a.target.value})),placeholder:"+56 9 0000 0000"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Persona de Contacto"}),e.jsx("input",{className:"input",value:n.contactPerson??"",onChange:a=>o(l=>({...l,contactPerson:a.target.value})),placeholder:"Juan PÃ©rez"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Segmento"}),e.jsx("input",{className:"input",value:n.segment??"",onChange:a=>o(l=>({...l,segment:a.target.value})),placeholder:"Retail"})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"DirecciÃ³n"}),e.jsx("input",{className:"input",value:n.address??"",onChange:a=>o(l=>({...l,address:a.target.value})),placeholder:"Av. Demo 123"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Latitud"}),e.jsx("input",{className:"input",type:"number",step:"any",value:n.latText,onChange:a=>o(l=>({...l,latText:a.target.value})),placeholder:"-33.4489"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Longitud"}),e.jsx("input",{className:"input",type:"number",step:"any",value:n.lngText,onChange:a=>o(l=>({...l,lngText:a.target.value})),placeholder:"-70.6693"})]}),e.jsxs("label",{style:{gridColumn:"1 / -1"},children:[e.jsx("span",{children:"Notas"}),e.jsx("textarea",{className:"input",rows:3,value:n.notes??"",onChange:a=>o(l=>({...l,notes:a.target.value})),placeholder:"Observaciones adicionales..."})]}),e.jsxs("label",{className:"checkbox-label",style:{gridColumn:"1 / -1"},children:[e.jsx("input",{type:"checkbox",checked:n.active!==!1,onChange:a=>o(l=>({...l,active:a.target.checked}))}),e.jsx("span",{children:"Cliente activo"})]}),e.jsxs("div",{className:"buttons",style:{gridColumn:"1 / -1"},children:[e.jsx("button",{className:"btn",type:"submit",disabled:g.isPending||b.isPending,children:r?b.isPending?"Actualizando...":"Actualizar":g.isPending?"Guardando...":"Crear"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:c,children:"Cancelar"})]}),g.isError&&e.jsx("p",{className:"error",style:{gridColumn:"1 / -1"},children:g.error?.message}),b.isError&&e.jsx("p",{className:"error",style:{gridColumn:"1 / -1"},children:b.error?.message})]})})}function de({open:P,onClose:h}){const r=A(),[x,n]=i.useState(null),[o,g]=i.useState(null),[b,c]=i.useState(!1),j=$({mutationFn:async d=>{const p=new FormData;p.append("file",d);const T=await fetch("/api/v1/customers/import",{method:"POST",body:p});if(!T.ok)throw new Error("Error importando archivo");return T.json()},onSuccess:d=>{g(d),r.invalidateQueries({queryKey:["customers"]}),r.invalidateQueries({queryKey:["customers","segments"]})}}),a=d=>{d.preventDefault(),c(!1);const p=d.dataTransfer.files[0];p&&p.name.endsWith(".csv")&&(n(p),g(null))},l=d=>{d.preventDefault(),c(!0)},m=()=>{c(!1)},N=d=>{const p=d.target.files?.[0];p&&(n(p),g(null))},f=()=>{x&&j.mutate(x)},S=()=>{n(null),g(null),h()};return P?e.jsx("div",{className:"dialog-overlay",onClick:S,children:e.jsxs("div",{className:"dialog",onClick:d=>d.stopPropagation(),children:[e.jsxs("div",{className:"dialog-header",children:[e.jsx("h2",{children:"Importar Clientes desde CSV"}),e.jsx("button",{className:"close-button",onClick:S,children:"âœ•"})]}),e.jsx("div",{className:"dialog-body",children:o?e.jsxs("div",{className:"import-result",children:[e.jsxs("div",{className:`result-summary ${o.totalErrors>0?"warning":"success"}`,children:[e.jsx("h3",{children:"ImportaciÃ³n completada"}),e.jsxs("div",{className:"result-stats",children:[e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"Creados:"}),e.jsx("span",{className:"stat-value text-success",children:o.created})]}),e.jsxs("div",{className:"stat",children:[e.jsx("span",{className:"stat-label",children:"Errores:"}),e.jsx("span",{className:"stat-value text-critical",children:o.totalErrors})]})]})]}),o.errors.length>0&&e.jsxs("div",{className:"error-list",children:[e.jsx("h4",{children:"Errores detectados:"}),e.jsxs("div",{className:"errors-container",children:[o.errors.slice(0,10).map((d,p)=>e.jsxs("div",{className:"error-item",children:[e.jsxs("span",{className:"error-line",children:["LÃ­nea ",d.line,":"]}),e.jsx("span",{className:"error-message",children:d.error})]},p)),o.errors.length>10&&e.jsxs("p",{className:"text-muted",children:["... y ",o.errors.length-10," errores mÃ¡s"]})]})]})]}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`file-drop-zone ${b?"dragging":""}`,onDrop:a,onDragOver:l,onDragLeave:m,children:x?e.jsxs("div",{className:"file-selected",children:[e.jsx("div",{className:"file-icon",children:"ðŸ“„"}),e.jsx("div",{className:"file-name",children:x.name}),e.jsxs("div",{className:"file-size",children:[(x.size/1024).toFixed(1)," KB"]})]}):e.jsxs("div",{className:"file-drop-message",children:[e.jsx("div",{className:"upload-icon",children:"ðŸ“¥"}),e.jsx("p",{children:"Arrastra un archivo CSV aquÃ­"}),e.jsx("p",{className:"text-muted",children:"o"}),e.jsxs("label",{className:"btn btn-secondary",children:["Seleccionar archivo",e.jsx("input",{type:"file",accept:".csv",onChange:N,style:{display:"none"}})]})]})}),e.jsxs("div",{className:"import-instructions",children:[e.jsx("h4",{children:"Formato esperado del CSV:"}),e.jsx("p",{children:"El archivo debe tener las siguientes columnas en orden:"}),e.jsxs("ol",{children:[e.jsx("li",{children:"Nombre (requerido)"}),e.jsx("li",{children:"RUT"}),e.jsx("li",{children:"Email"}),e.jsx("li",{children:"TelÃ©fono"}),e.jsx("li",{children:"DirecciÃ³n"}),e.jsx("li",{children:"Segmento (cÃ³digo)"}),e.jsx("li",{children:"Persona de Contacto"}),e.jsx("li",{children:"Notas"}),e.jsx("li",{children:"Activo (SÃ­/No)"})]})]})]})}),e.jsx("div",{className:"dialog-footer",children:o?e.jsx("button",{className:"btn",onClick:S,children:"Cerrar"}):e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:S,children:"Cancelar"}),e.jsx("button",{className:"btn",onClick:f,disabled:!x||j.isPending,children:j.isPending?"Importando...":"Importar"})]})})]})}):null}function je(){const P=i.useRef(null),[h,r]=i.useState(null),[x,n]=i.useState(!1),[o,g]=i.useState(!1),[b,c]=i.useState(null),j=O({queryKey:["customers","segments"],queryFn:se,staleTime:6e4}),a=j.data??[],l=a.reduce((t,v)=>t+v.total,0),m=i.useMemo(()=>h?a.find(t=>t.code===h)??{name:h===U?"Sin segmentar":h,segment:h===U?"Sin segmentar":h,code:h,total:0,color:null}:null,[h,a]),N=t=>{r(v=>v===t.code?null:t.code)},f=()=>r(null),S=()=>{c(null),n(!0)},d=t=>{c(t),n(!0)},p=()=>{n(!1),c(null)},T=()=>{const t=P.current?.getFilters(),v=new URLSearchParams;t?.query&&v.append("query",t.query),t?.segment&&v.append("segment",t.segment),t?.active!==void 0&&t.active!==null&&v.append("active",String(t.active));const E=`/api/v1/customers/export${v.toString()?`?${v.toString()}`:""}`,F=document.createElement("a");F.href=E,F.download="customers.csv",document.body.appendChild(F),F.click(),document.body.removeChild(F)};return e.jsxs("div",{className:"page-section",children:[e.jsx(ae,{title:"Clientes",description:"Administra fichas, contactos y geolocalizaciÃ³n de clientes.",actions:e.jsxs(e.Fragment,{children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>g(!0),children:"ðŸ“¤ Importar CSV"}),e.jsx("button",{className:"btn btn-secondary",onClick:T,children:"ðŸ“¥ Exportar CSV"}),e.jsx("button",{className:"btn",onClick:S,children:"+ Nuevo cliente"})]})}),e.jsx(ce,{open:x,onClose:p,editingCustomer:b}),e.jsx(de,{open:o,onClose:()=>g(!1)}),e.jsxs("section",{className:"responsive-grid",children:[e.jsx("div",{className:"card",children:e.jsx(B,{ref:P,segmentFilter:h,segmentLabel:m?.name||m?.segment,onClearSegment:h?f:void 0,onOpenCreateDialog:S,onOpenEditDialog:d})}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"SegmentaciÃ³n"}),j.isLoading&&e.jsx("p",{children:"Loading..."}),j.isError&&e.jsx("p",{className:"error",children:j.error?.message??"No se pudieron cargar los segmentos"}),!j.isLoading&&!j.isError&&e.jsxs(e.Fragment,{children:[e.jsxs("ul",{className:"segment-list",children:[a.map(t=>{const v=t.code===h,E=t.name||t.segment;return e.jsx("li",{children:e.jsxs("button",{type:"button",className:`segment-chip${v?" active":""}`,onClick:()=>N(t),style:{borderLeft:t.color?`4px solid ${t.color}`:void 0},children:[e.jsxs("div",{children:[e.jsx("strong",{children:E}),e.jsxs("p",{className:"muted small",children:[t.total," clientes"]})]}),e.jsx("span",{className:"stat-trend",children:l?`${Math.round(t.total/l*100)}%`:"-"})]})},`${t.code}-${E}`)}),a.length===0&&e.jsx("li",{className:"muted",children:"Sin segmentos registrados"})]}),m&&e.jsx("button",{className:"btn ghost",type:"button",onClick:f,children:"Limpiar filtro"})]})]})]})]})}export{je as default};
