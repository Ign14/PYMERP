import{c as q,j as e,u as w}from"./index-C0DCX_lx.js";import{r as d}from"./react-DFcFNn96.js";import{u as M}from"./useQuery-ClGZjTlq.js";import{M as O}from"./Modal-BfA53Mfc.js";import{u as T,e as B,t as Z,d as _}from"./inventory-DjR51aUj.js";const Q=/^[A-Z0-9-_]{2,32}$/,L={code:"",name:"",description:"",enabled:!0};function U({open:b,location:a,onClose:u,onSaved:x,existingCodes:j=[],existingNames:N=[]}){const[r,p]=d.useState(L),[c,h]=d.useState({});d.useEffect(()=>{if(!b){p(L),h({});return}p(a?{code:a.code??"",name:a.name??"",description:a.description??"",enabled:a.enabled}:L),h({})},[b,a]);const m=d.useMemo(()=>j.map(n=>n.trim().toUpperCase()).filter(Boolean),[j]),C=d.useMemo(()=>N.map(n=>n.trim().toLowerCase()).filter(Boolean),[N]),v=q({mutationFn:n=>a?T(a.id,n):B(n),onSuccess:n=>{x?.(n),u()},onError:n=>{h(i=>({...i,form:n instanceof Error?n.message:"No se pudo guardar la ubicación"}))}}),g=(n,i)=>{p(l=>({...l,[n]:i})),h(l=>{if(!l[n])return l;const o={...l};return delete o[n],o})},f=n=>{n.preventDefault();const i={},l=r.code.trim().toUpperCase(),o=r.name.trim();if(o?o.length<2||o.length>80?i.name="El nombre debe tener entre 2 y 80 caracteres":C.includes(o.toLowerCase())&&(!a||a.name.toLowerCase()!==o.toLowerCase())&&(i.name="Ya existe una ubicación con ese nombre"):i.name="El nombre es obligatorio",l&&(Q.test(l)?m.includes(l)&&(!a||(a.code??"").toUpperCase()!==l)&&(i.code="Ya existe una ubicación con ese código"):i.code="Código inválido (solo A-Z, 0-9, -, _ ; 2-32 caracteres)"),Object.keys(i).length>0){h(i);return}const E={code:l||void 0,name:o,description:r.description.trim()||void 0,enabled:r.enabled};v.mutate(E)},y=a?"Editar ubicación":"Nueva ubicación",t=v.isPending;return e.jsx(O,{open:b,onClose:()=>!t&&u(),title:y,children:e.jsxs("form",{className:"form-grid",onSubmit:f,noValidate:!0,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:`input${c.name?" input-error":""}`,value:r.name,onChange:n=>g("name",n.target.value),placeholder:"Bodega principal",disabled:t,required:!0,"data-autofocus":!0}),c.name?e.jsx("p",{className:"error",children:c.name}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Código"}),e.jsx("input",{className:`input${c.code?" input-error":""}`,value:r.code,onChange:n=>g("code",n.target.value.toUpperCase()),placeholder:"BOD-001",disabled:t,maxLength:32}),c.code?e.jsx("p",{className:"error",children:c.code}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Descripción"}),e.jsx("textarea",{className:"input",rows:3,value:r.description,onChange:n=>g("description",n.target.value),placeholder:"Detalles de la ubicación",disabled:t})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Estado"}),e.jsx("div",{className:"inline-actions",children:e.jsxs("label",{className:"inline-flex",children:[e.jsx("input",{type:"checkbox",checked:r.enabled,onChange:n=>g("enabled",n.target.checked),disabled:t}),e.jsx("span",{className:"muted small",style:{marginLeft:"0.5rem"},children:"Activa"})]})})]}),c.form?e.jsx("p",{className:"error",style:{gridColumn:"1 / -1"},children:c.form}):null,e.jsxs("div",{className:"modal-actions",style:{gridColumn:"1 / -1"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:u,disabled:t,children:"Cancelar"}),e.jsx("button",{className:"btn",type:"submit",disabled:t,children:t?"Guardando…":a?"Guardar":"Crear"})]})]})})}const k=[{value:"name,asc",label:"Nombre (A → Z)"},{value:"name,desc",label:"Nombre (Z → A)"},{value:"code,asc",label:"Código (A → Z)"},{value:"createdAt,desc",label:"Fecha (recientes)"}],A=8;function I(){const b=w(),[a,u]=d.useState({q:"",page:0,sort:k[0].value,statusFilter:"enabled"}),[x,j]=d.useState(""),[N,r]=d.useState(!1),[p,c]=d.useState(null),h=a.statusFilter==="enabled"?!0:a.statusFilter==="disabled"?!1:void 0,m=M({queryKey:["inventory-locations",a.q,h,a.sort,a.page,A],queryFn:()=>_({q:a.q||void 0,enabled:h,sort:a.sort,page:a.page,size:A}),keepPreviousData:!0}),C=()=>{u(s=>({...s,q:x.trim(),page:0}))},v=s=>{u(S=>({...S,sort:s,page:0}))},g=s=>{u(S=>({...S,statusFilter:s,page:0}))},f=()=>{u(s=>({...s,page:Math.max(0,s.page-1)}))},y=()=>{m.data&&u(s=>({...s,page:s.page+1<(m.data?.totalPages??1)?s.page+1:s.page}))},t=m.data?.content??[],n=m.data?.totalPages??0,i=d.useMemo(()=>t.map(s=>s.code??""),[t]),l=d.useMemo(()=>t.map(s=>s.name??""),[t]),o=()=>{c(null),r(!0)},E=s=>{c(s),r(!0)},F=()=>{r(!1),c(null)},P=()=>{b.invalidateQueries({queryKey:["inventory-locations"]}),F()},D=async s=>{await Z(s.id,!s.enabled),b.invalidateQueries({queryKey:["inventory-locations"]})};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsxs("div",{children:[e.jsx("h2",{children:"Ubicaciones"}),e.jsx("p",{className:"muted small",children:"Gestiona centros logísticos y controla su estado en tiempo real."})]}),e.jsx("div",{className:"inline-actions",children:e.jsx("button",{className:"btn",onClick:o,children:"+ Nueva ubicación"})})]}),e.jsxs("div",{className:"inline-actions",style:{flexWrap:"wrap",gap:"0.5rem"},children:[e.jsx("input",{className:"input",placeholder:"Buscar por nombre o código",value:x,onChange:s=>j(s.target.value),onKeyDown:s=>{s.key==="Enter"&&C()}}),e.jsx("button",{className:"btn ghost",type:"button",onClick:C,children:"Buscar"}),e.jsx("select",{className:"input",value:a.sort,onChange:s=>v(s.target.value),children:k.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("div",{className:"inline-actions",children:["enabled","disabled","all"].map(s=>e.jsx("button",{className:`btn ghost${a.statusFilter===s?" active":""}`,type:"button",onClick:()=>g(s),children:s==="enabled"?"Activas":s==="disabled"?"Deshabilitadas":"Todas"},s))})]}),m.isLoading?e.jsx("p",{className:"muted",children:"Cargando ubicaciones…"}):m.isError?e.jsx("p",{className:"error",children:m.error?.message??"No se pudieron cargar las ubicaciones"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Código"}),e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Creada"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:t.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:6,className:"muted",children:"No hay ubicaciones que coincidan con los filtros"})}):t.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono",children:s.code||"—"}),e.jsx("td",{children:s.name}),e.jsx("td",{children:s.description||"—"}),e.jsx("td",{children:e.jsx("span",{className:`badge ${s.enabled?"badge-success":"badge-warning"}`,children:s.enabled?"Activa":"Deshabilitada"})}),e.jsx("td",{children:new Date(s.createdAt).toLocaleDateString("es-CL")}),e.jsx("td",{children:e.jsxs("div",{className:"table-actions",children:[e.jsx("button",{className:"btn ghost small",type:"button",onClick:()=>E(s),children:"Editar"}),e.jsx("button",{className:"btn ghost small",type:"button",onClick:()=>D(s),children:s.enabled?"Deshabilitar":"Habilitar"})]})})]},s.id))})]})}),e.jsxs("div",{className:"inline-actions",style:{justifyContent:"space-between",marginTop:"0.75rem"},children:[e.jsxs("div",{className:"muted small",children:["Página ",a.page+1," de ",n||1]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn ghost small",onClick:f,disabled:a.page===0,children:"Anterior"}),e.jsx("button",{className:"btn ghost small",onClick:y,disabled:a.page+1>=n,children:"Siguiente"})]})]})]}),e.jsx(U,{open:N,location:p,onClose:F,onSaved:P,existingCodes:i,existingNames:l})]})}export{I as default};
