import{j as e,z as I,A as $,u as G,B as R,C as _,D as B,k as O,d as T,E as Y}from"./index-BpLAP759.js";import{r as o}from"./react-BYfE7jJl.js";import{a as y,u as C}from"./useMutation-CPedeap3.js";import{M as Z}from"./Modal-Bq1-hS2x.js";const F={sku:"",name:"",description:"",category:"",barcode:"",imageUrl:""};function H({open:h,product:n,onClose:u,onSaved:g}){const[i,d]=o.useState(F);o.useEffect(()=>{h&&d(n?{sku:n.sku??"",name:n.name??"",description:n.description??"",category:n.category??"",barcode:n.barcode??"",imageUrl:n.imageUrl??""}:F)},[h,n]);const t=y({mutationFn:r=>n?I(n.id,r):$(r),onSuccess:r=>{g?.(r),u()}}),m=r=>{r.preventDefault();const a=i.sku.trim(),b=i.name.trim();if(!a){window.alert("El SKU es obligatorio");return}if(!b){window.alert("El nombre es obligatorio");return}t.mutate({sku:a,name:b,description:i.description?.trim()||void 0,category:i.category?.trim()||void 0,barcode:i.barcode?.trim()||void 0,imageUrl:i.imageUrl?.trim()||void 0})},x=n?"Editar producto":"Nuevo producto";return e.jsx(Z,{open:h,title:x,onClose:()=>!t.isPending&&u(),children:e.jsxs("form",{className:"form-grid",onSubmit:m,children:[e.jsxs("label",{children:[e.jsx("span",{children:"SKU *"}),e.jsx("input",{className:"input",value:i.sku,onChange:r=>d(a=>({...a,sku:r.target.value})),placeholder:"SKU-001",disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",value:i.name,onChange:r=>d(a=>({...a,name:r.target.value})),placeholder:"Producto demo",disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Categoria"}),e.jsx("input",{className:"input",value:i.category??"",onChange:r=>d(a=>({...a,category:r.target.value})),placeholder:"Bebidas",disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Codigo de barras"}),e.jsx("input",{className:"input",value:i.barcode??"",onChange:r=>d(a=>({...a,barcode:r.target.value})),placeholder:"7890000000",disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Descripcion"}),e.jsx("textarea",{className:"input",value:i.description??"",onChange:r=>d(a=>({...a,description:r.target.value})),placeholder:"Notas internas",rows:3,disabled:t.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Imagen (URL)"}),e.jsx("input",{className:"input",value:i.imageUrl??"",onChange:r=>d(a=>({...a,imageUrl:r.target.value})),placeholder:"https://...",disabled:t.isPending})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:t.isPending,children:t.isPending?"Guardando...":"Guardar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:u,disabled:t.isPending,children:"Cancelar"})]}),t.isError&&e.jsx("p",{className:"error",children:t.error?.message??"No se pudo guardar"})]})})}const J=10;function se(){const[h,n]=o.useState(""),[u,g]=o.useState(0),[i,d]=o.useState("active"),[t,m]=o.useState(null),[x,r]=o.useState({price:0}),[a,b]=o.useState(!1),[k,S]=o.useState(null),p=G(),P=s=>{if(typeof s=="number")return Number.isFinite(s)?s:null;if(typeof s=="string"&&s.trim().length>0){const c=Number(s);return Number.isFinite(c)?c:null}return null},E=s=>{const c=P(s);return c===null||c<=0?"Sin precio":`$${c.toFixed(2)}`};o.useEffect(()=>{g(0)},[i]);const l=C({queryKey:["products",{q:h,page:u,status:i}],queryFn:()=>T({q:h||void 0,page:u,size:J,status:i}),placeholderData:O}),D=C({queryKey:["product-prices",t?.id],queryFn:()=>{if(!t)throw new Error("Producto no seleccionado");return Y(t.id,{size:5})},enabled:!!t}),N=y({mutationFn:async()=>{if(!t)throw new Error("Select a product first");return R(t.id,x)},onSuccess:()=>{p.invalidateQueries({queryKey:["products"],exact:!1}),p.invalidateQueries({queryKey:["product-prices",t?.id]}),r({price:0})}}),j=y({mutationFn:s=>_(s),onSuccess:(s,c)=>{p.invalidateQueries({queryKey:["products"],exact:!1}),p.removeQueries({queryKey:["product-prices",c],exact:!0}),t?.id===c&&(m(null),r({price:0}))}}),v=y({mutationFn:s=>{if(!t)throw new Error("Producto no seleccionado");return B(t.id,s)},onSuccess:s=>{p.invalidateQueries({queryKey:["products"],exact:!1}),m(s),r({price:P(s.currentPrice)??0})}}),w=()=>{S(null),b(!0)},q=()=>{t&&(S(t),b(!0))},K=()=>{b(!1),S(null)},U=s=>{p.invalidateQueries({queryKey:["products"],exact:!1}),m(s),r({price:P(s.currentPrice)??0})},A=()=>{!t||j.isPending||window.confirm(`Eliminar producto ${t.name}?`)&&j.mutate(t.id)},M=()=>{!t||v.isPending||v.mutate(!t.active)},Q=l.data?.content??[],f=l.data?.totalPages??1;o.useEffect(()=>{if(!t)return;const s=l.data?.content?.find(c=>c.id===t.id);if(!s){m(null),r({price:0});return}s!==t&&(m(s),r({price:P(s.currentPrice)??0}))},[l.data,t]);const L=o.useMemo(()=>t?E(t.currentPrice):"",[t]),z=s=>{if(s.preventDefault(),!!t){if(!x.price||x.price<=0){alert("Ingresa un precio valido");return}N.mutate()}};return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Productos"}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("input",{className:"input",placeholder:"Buscar por nombre, SKU o codigo",value:h,onChange:s=>{n(s.target.value),g(0)}}),e.jsxs("select",{className:"input",value:i,onChange:s=>d(s.target.value),children:[e.jsx("option",{value:"active",children:"Activos"}),e.jsx("option",{value:"inactive",children:"Inactivos"}),e.jsx("option",{value:"all",children:"Todos"})]}),e.jsx("button",{className:"btn",onClick:()=>p.invalidateQueries({queryKey:["products"]}),disabled:l.isFetching,children:l.isFetching?"Cargando":"Refrescar"})]})]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn",type:"button",onClick:w,children:"+ Producto"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:q,disabled:!t,children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:M,disabled:!t||v.isPending,children:v.isPending?"Actualizando...":t?.active?"Desactivar":"Activar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:A,disabled:!t||j.isPending,children:j.isPending?"Eliminando...":"Eliminar"})]}),j.isError&&e.jsx("p",{className:"error",children:j.error?.message??"No se pudo eliminar el producto"}),v.isError&&e.jsx("p",{className:"error",children:v.error?.message??"No se pudo actualizar el estado"}),l.isLoading&&e.jsx("p",{children:"Loading..."}),l.isError&&e.jsx("p",{className:"error",children:l.error.message}),!l.isLoading&&!l.isError&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Nombre"}),e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Precio actual"}),e.jsx("th",{children:"Estado"})]})}),e.jsx("tbody",{children:Q.map(s=>e.jsxs("tr",{className:t?.id===s.id?"selected":void 0,onClick:()=>{m(s),r({price:P(s.currentPrice)??0})},children:[e.jsx("td",{children:s.name}),e.jsx("td",{className:"mono",children:s.sku}),e.jsx("td",{className:"mono",children:E(s.currentPrice)}),e.jsx("td",{children:s.active?"Activo":"Inactivo"})]},s.id))})]})}),f>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:u===0,onClick:()=>g(s=>Math.max(0,s-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Pagina ",u+1," de ",f]}),e.jsx("button",{className:"btn",disabled:u>=f-1,onClick:()=>g(s=>Math.min(f-1,s+1)),children:"Siguiente"})]}),t&&e.jsxs("div",{className:"panel",children:[e.jsx("h3",{className:"panel-title",children:"Precio"}),e.jsxs("p",{className:"muted",children:["Actual: ",L]}),e.jsxs("p",{className:"muted",children:["Estado: ",t.active?"Activo":"Inactivo"]}),e.jsxs("form",{className:"form-inline",onSubmit:z,children:[e.jsx("input",{className:"input",type:"number",step:"0.01",min:"0",placeholder:"Nuevo precio",value:x.price,onChange:s=>r(c=>({...c,price:Number(s.target.value)}))}),e.jsx("button",{className:"btn",type:"submit",disabled:N.isPending,children:N.isPending?"Guardando...":"Actualizar"})]}),N.isError&&e.jsx("p",{className:"error",children:N.error?.message}),e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Precio"}),e.jsx("th",{children:"Desde"})]})}),e.jsx("tbody",{children:(D.data?.content??[]).map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono",children:`$${s.price.toFixed(2)}`}),e.jsx("td",{className:"mono small",children:new Date(s.validFrom).toLocaleString()})]},s.id))})]})})]})]}),e.jsx(H,{open:a,product:k,onClose:K,onSaved:U})]})}export{se as P};
