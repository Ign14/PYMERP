import{j as e,o as B,d as G,p as U,u as _,q as H,r as X,k as Y,s as Z,t as J}from"./index-BpLAP759.js";import{r as n}from"./react-BYfE7jJl.js";import{u as $,a as K}from"./useMutation-CPedeap3.js";import{P as W}from"./PageHeader-ECmiVUlh.js";import{M as ee}from"./Modal-Bq1-hS2x.js";import{u as te,f as A,g as se}from"./table-Bis8ST_Y.js";import{u as ae}from"./useDebouncedValue-e1gzF8eY.js";import{R as ne,B as re,C as le,X as ce,Y as oe,T as ie,b as de}from"./charts-CrTcgEid.js";function ue({open:c,onClose:r,onCreated:h}){const[N,v]=n.useState(""),[d,q]=n.useState("Factura"),[p,y]=n.useState(""),[x,i]=n.useState(()=>new Date().toISOString().slice(0,16)),[l,C]=n.useState([]),[S,f]=n.useState(""),[P,D]=n.useState(1),[j,u]=n.useState(0),[t,a]=n.useState(19),[I,F]=n.useState(""),E=$({queryKey:["products",{dialog:"purchases"}],queryFn:()=>G({size:200}),enabled:c}),L=$({queryKey:["suppliers",{dialog:"purchases"}],queryFn:()=>U(),enabled:c});n.useEffect(()=>{c&&i(new Date().toISOString().slice(0,16))},[c]);const k=K({mutationFn:s=>B(s),onSuccess:()=>{h(),V(),r()}}),R=E.data?.content??[],M=L.data??[],g=n.useMemo(()=>{const s=l.reduce((m,b)=>m+b.qty*b.unitCost,0),o=l.reduce((m,b)=>m+b.qty*b.unitCost*((b.vatRate??t)/100),0),w=s+o;return{net:s,vat:o,total:w}},[l,t]),O=()=>{!S||P<=0||j<=0||(C(s=>[...s,{productId:S,qty:P,unitCost:j,vatRate:t,expDate:I||void 0}]),f(""),D(1),u(0),F(""))},Q=s=>{C(o=>o.filter((w,m)=>m!==s))},V=()=>{v(""),q("Factura"),y(""),C([]),f(""),D(1),u(0),F("")},z=s=>{if(s.preventDefault(),!N||l.length===0)return;const o={supplierId:N,docType:d,docNumber:p,issuedAt:new Date(x).toISOString(),net:Number(g.net.toFixed(2)),vat:Number(g.vat.toFixed(2)),total:Number(g.total.toFixed(2)),items:l};k.mutate(o)};return e.jsx(ee,{open:c,onClose:r,title:"Registrar compra",children:e.jsxs("form",{className:"form-grid",onSubmit:z,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Proveedor *"}),e.jsxs("select",{className:"input",value:N,onChange:s=>v(s.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecciona proveedor"}),M.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Documento"}),e.jsx("input",{className:"input",value:d,onChange:s=>q(s.target.value)})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Nï¿½mero"}),e.jsx("input",{className:"input",value:p,onChange:s=>y(s.target.value)})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Emitida"}),e.jsx("input",{className:"input",type:"datetime-local",value:x,onChange:s=>i(s.target.value)})]}),e.jsx("div",{className:"line"}),e.jsxs("div",{className:"item-builder",children:[e.jsxs("select",{className:"input",value:S,onChange:s=>f(s.target.value),children:[e.jsx("option",{value:"",children:"Producto"}),R.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("input",{className:"input",type:"number",min:1,value:P,onChange:s=>D(Number(s.target.value))}),e.jsx("input",{className:"input",type:"number",step:"0.01",min:0,value:j,onChange:s=>u(Number(s.target.value))}),e.jsx("input",{className:"input",type:"date",value:I,onChange:s=>F(s.target.value)}),e.jsx("input",{className:"input",type:"number",step:"0.1",min:0,value:t,onChange:s=>a(Number(s.target.value))}),e.jsx("button",{type:"button",className:"btn",onClick:O,children:"Agregar"})]}),l.length>0&&e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Costo"}),e.jsx("th",{children:"Vence"}),e.jsx("th",{children:"IVA %"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:l.map((s,o)=>{const w=R.find(m=>m.id===s.productId);return e.jsxs("tr",{children:[e.jsx("td",{children:w?.name??s.productId}),e.jsx("td",{className:"mono",children:s.qty}),e.jsxs("td",{className:"mono",children:["$",s.unitCost.toFixed(2)]}),e.jsx("td",{className:"mono",children:s.expDate?new Date(s.expDate).toLocaleDateString():"-"}),e.jsx("td",{className:"mono",children:(s.vatRate??t).toFixed(1)}),e.jsx("td",{children:e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>Q(o),children:"Quitar"})})]},`${s.productId}-${o}`)})})]})}),e.jsxs("div",{className:"totals-grid",children:[e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"Neto"}),e.jsxs("strong",{children:["$",g.net.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"IVA"}),e.jsxs("strong",{children:["$",g.vat.toFixed(2)]})]}),e.jsxs("div",{children:[e.jsx("span",{className:"muted small",children:"Total"}),e.jsxs("strong",{children:["$",g.total.toFixed(2)]})]})]}),k.isError&&e.jsx("p",{className:"error",children:k.error.message}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:k.isPending,children:k.isPending?"Guardando...":"Registrar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:V,children:"Limpiar"})]})]})})}const T=10,me=[{value:"",label:"Todos"},{value:"received",label:"Recibida"},{value:"cancelled",label:"Cancelada"}];function ye(){const c=_(),[r,h]=n.useState(0),[N,v]=n.useState(!1),[d,q]=n.useState("received"),[p,y]=n.useState(""),x=ae(p,300);n.useEffect(()=>{h(0)},[d,x]);const i=$({queryKey:["purchases",r,d,x],queryFn:()=>Z({page:r,size:T,status:d||void 0,search:x||void 0}),placeholderData:Y}),l=$({queryKey:["purchases","metrics",14],queryFn:()=>J(14)}),C=K({mutationFn:t=>H(t),onSuccess:()=>c.invalidateQueries({queryKey:["purchases"]})}),S=K({mutationFn:({id:t,payload:a})=>X(t,a),onSuccess:()=>c.invalidateQueries({queryKey:["purchases"]})}),f=t=>{if(t.status?.toLowerCase()==="cancelled"){window.alert("La compra ya fue cancelada.");return}window.confirm(`Cancelar compra ${t.docNumber??t.id}?`)&&C.mutate(t.id)},P=t=>{const a=window.prompt("Documento",t.docType??"");if(a===null)return;const I=window.prompt("Numero",t.docNumber??"");if(I===null)return;const F={docType:a.trim()||t.docType,docNumber:I.trim()||t.docNumber};S.mutate({id:t.id,payload:F})},D=n.useMemo(()=>[{header:"Documento",accessorKey:"docType",cell:t=>t.getValue()??"Factura"},{header:"Numero",accessorKey:"docNumber",cell:t=>t.getValue()??"-"},{header:"Proveedor",accessorFn:t=>t.supplierName??t.supplierId??"-",cell:t=>t.getValue()??"-"},{header:"Estado",accessorKey:"status",cell:t=>{const a=t.getValue()??"";return e.jsx("span",{className:`status ${a.toLowerCase()}`,children:a})}},{header:"Neto",accessorKey:"net",cell:t=>`$${Number(t.getValue()).toLocaleString()}`},{header:"IVA",accessorKey:"vat",cell:t=>`$${Number(t.getValue()).toLocaleString()}`},{header:"Total",accessorKey:"total",cell:t=>`$${Number(t.getValue()).toLocaleString()}`},{header:"Emitida",accessorKey:"issuedAt",cell:t=>new Date(t.getValue()).toLocaleString()},{id:"actions",header:"Acciones",cell:({row:t})=>e.jsxs("div",{className:"table-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>P(t.original),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>f(t.original),children:"Cancelar"})]})}],[]),j=te({data:i.data?.content??[],columns:D,getCoreRowModel:se(),manualPagination:!0,pageCount:i.data?.totalPages??-1,state:{pagination:{pageIndex:r,pageSize:T}},onPaginationChange:t=>{const a=typeof t=="function"?t({pageIndex:r,pageSize:T}).pageIndex:t.pageIndex;h(a)}}),u=n.useMemo(()=>(l.data??[]).map(t=>({date:t.date,total:Number(t.total??0),count:t.count})),[l.data]);return e.jsxs("div",{className:"page-section",children:[e.jsx(W,{title:"Compras y abastecimiento",description:"Controla ordenes, recepciones y presupuestos para evitar quiebres.",actions:e.jsx("button",{className:"btn",onClick:()=>v(!0),children:"+ Nueva orden"})}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"filter-bar",children:[e.jsx("input",{className:"input",placeholder:"Buscar (doc, numero, proveedor)",value:p,onChange:t=>y(t.target.value)}),p&&e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>y(""),children:"Limpiar"}),e.jsx("select",{className:"input",value:d,onChange:t=>q(t.target.value),children:me.map(t=>e.jsx("option",{value:t.value,children:t.label},t.value))})]})}),e.jsxs("section",{className:"kpi-grid",children:[e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ordenes en curso"}),e.jsx("p",{className:"stat-value",children:i.data?.totalElements??0}),e.jsx("span",{className:"stat-trend",children:"Total registros listados"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Gasto 14 dias"}),e.jsxs("p",{className:"stat-value",children:["$",u.reduce((t,a)=>t+a.total,0).toLocaleString()]}),e.jsx("span",{className:"stat-trend",children:"Incluye impuestos"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ordenes diarias"}),e.jsx("p",{className:"stat-value",children:u.reduce((t,a)=>t+a.count,0)}),e.jsx("span",{className:"stat-trend",children:"Ultimas 2 semanas"})]})]}),e.jsxs("div",{className:"card",children:[e.jsx("h3",{children:"Tendencia de compras"}),e.jsx("div",{style:{height:260},children:e.jsx(ne,{width:"100%",height:"100%",children:e.jsxs(re,{data:u,children:[e.jsx(le,{strokeDasharray:"3 3",stroke:"#1f2937"}),e.jsx(ce,{dataKey:"date",stroke:"#9aa0a6",tick:{fontSize:12}}),e.jsx(oe,{stroke:"#9aa0a6",tickFormatter:t=>`$${(t/1e3).toFixed(0)}k`}),e.jsx(ie,{formatter:t=>`$${t.toLocaleString()}`}),e.jsx(de,{dataKey:"total",fill:"#a855f7",radius:[6,6,0,0]})]})})})]}),e.jsxs("div",{className:"card table-card",children:[e.jsx("h3",{children:"Ordenes recientes"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:j.getHeaderGroups().map(t=>e.jsx("tr",{children:t.headers.map(a=>e.jsx("th",{children:A(a.column.columnDef.header,a.getContext())},a.id))},t.id))}),e.jsx("tbody",{children:j.getRowModel().rows.map(t=>e.jsx("tr",{children:t.getVisibleCells().map(a=>e.jsx("td",{children:A(a.column.columnDef.cell,a.getContext())},a.id))},t.id))})]})}),e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:r===0,onClick:()=>h(t=>Math.max(0,t-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Pagina ",r+1," de ",i.data?.totalPages??1]}),e.jsx("button",{className:"btn",disabled:r+1>=(i.data?.totalPages??1),onClick:()=>h(t=>t+1),children:"Siguiente"})]})]}),e.jsx(ue,{open:N,onClose:()=>v(!1),onCreated:()=>c.invalidateQueries({queryKey:["purchases"]})})]})}export{ye as default};
