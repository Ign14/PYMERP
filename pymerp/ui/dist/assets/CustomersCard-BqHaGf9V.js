import{G as w,H as O,I as q,u as D,g as L,J as K,K as $,j as e}from"./index-BpLAP759.js";import{r as l}from"./react-BYfE7jJl.js";import{Q as A,b as B,a as M}from"./useMutation-CPedeap3.js";var G=class extends A{constructor(t,i){super(t,i)}bindMethods(){super.bindMethods(),this.fetchNextPage=this.fetchNextPage.bind(this),this.fetchPreviousPage=this.fetchPreviousPage.bind(this)}setOptions(t){super.setOptions({...t,behavior:w()})}getOptimisticResult(t){return t.behavior=w(),super.getOptimisticResult(t)}fetchNextPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"forward"}}})}fetchPreviousPage(t){return this.fetch({...t,meta:{fetchMore:{direction:"backward"}}})}createResult(t,i){const{state:c}=t,o=super.createResult(t,i),{isFetching:d,isRefetching:r,isError:u,isRefetchError:h}=o,m=c.fetchMeta?.fetchMore?.direction,g=u&&m==="forward",b=d&&m==="forward",a=u&&m==="backward",p=d&&m==="backward";return{...o,fetchNextPage:this.fetchNextPage,fetchPreviousPage:this.fetchPreviousPage,hasNextPage:q(i,c.data),hasPreviousPage:O(i,c.data),isFetchNextPageError:g,isFetchingNextPage:b,isFetchPreviousPageError:a,isFetchingPreviousPage:p,isRefetchError:h&&!g&&!a,isRefetching:r&&!b&&!p}}};function _(t,i){return B(t,G)}function H(t){const i=new Set,c=[];for(const o of t){const d=o.content??[];for(const r of d)i.has(r.id)||(i.add(r.id),c.push(r))}return c}function T(t){const i=t.page,c=typeof t.number=="number"?t.number:typeof i=="number"?i:0,o=typeof t.totalPages=="number"?t.totalPages:0;return(typeof t.hasNext=="boolean"?t.hasNext:o>0?c+1<o:!1)?c+1:void 0}const z=20,J="createdAt,desc",j=()=>({name:"",phone:"",email:"",address:"",segment:""}),Z=l.forwardRef((t,i)=>{const c=D(),[o,d]=l.useState(""),[r,u]=l.useState(()=>j()),h=l.useRef(null),m=l.useRef(null),g=l.useRef(0);l.useImperativeHandle(i,()=>({focusCreate:()=>{h.current?.focus()},clearForm:()=>{u(j()),h.current?.focus()}}),[]),l.useEffect(()=>{g.current=0},[o]);const b=l.useCallback(async s=>{const n=o.trim(),y=performance.now(),E=await L({q:n.length?n:void 0,page:s,size:z,sort:J}),k=Math.round(performance.now()-y),I=E.content?.length??0;return console.info(`[Customers] page ${s} fetched (${I} items) in ${k}ms`),E},[o]),a=_({queryKey:["customers",o],queryFn:({pageParam:s=0})=>b(s),getNextPageParam:s=>T(s),initialPageParam:0}),{fetchNextPage:p,isFetchingNextPage:x,refetch:R}=a,f=l.useMemo(()=>H(a.data?.pages??[]),[a.data]),P=a.hasNextPage??!1,C=a.isLoading&&!x;l.useEffect(()=>{const s=a.data?.pages.length??0;s>g.current&&(g.current=s,console.info(`[Customers] pages fetched so far: ${s}`))},[a.data]),l.useEffect(()=>{const s=m.current;if(!s)return;const n=new IntersectionObserver(y=>{y[0].isIntersecting&&P&&!x&&p()});return n.observe(s),()=>n.disconnect()},[P,x,p]);const v=M({mutationFn:s=>K(s),onSuccess:()=>{c.invalidateQueries({queryKey:["customers"],exact:!1}),u(j()),h.current?.focus()}}),N=M({mutationFn:s=>$(s),onSuccess:()=>{c.invalidateQueries({queryKey:["customers"],exact:!1})}}),Q=s=>{if(s.preventDefault(),!r.name||!r.name.trim()){alert("El nombre es obligatorio");return}v.mutate({name:r.name.trim(),phone:r.phone?.trim()||void 0,email:r.email?.trim()||void 0,address:r.address?.trim()||void 0,segment:r.segment?.trim()||void 0})},F=a.isError?a.error?.message??"No se pudieron cargar los clientes":void 0,S=!C&&!a.isError&&f.length===0;return e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"card-header",children:[e.jsx("h2",{children:"Clientes"}),e.jsx("input",{className:"input",placeholder:"Buscar por nombre",value:o,onChange:s=>d(s.target.value)})]}),C&&e.jsx("p",{children:"Loading..."}),!C&&a.isError&&f.length===0&&e.jsxs("div",{className:"error",children:[e.jsx("p",{children:F}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>R(),children:"Reintentar"})]}),!a.isError&&f.length>0&&e.jsx("ul",{className:"list","aria-live":"polite",children:f.map(s=>e.jsxs("li",{className:"list-row",children:[e.jsxs("div",{children:[e.jsx("strong",{children:s.name}),s.segment?e.jsx("div",{className:"mono small",children:s.segment}):null,s.email?e.jsx("div",{className:"mono small",children:s.email}):null,s.phone?e.jsx("div",{className:"mono small",children:s.phone}):null]}),e.jsx("button",{className:"btn ghost",onClick:()=>N.mutate(s.id),disabled:N.isPending,children:"Eliminar"})]},s.id))}),S&&e.jsxs("div",{className:"muted",children:[e.jsx("p",{children:"Sin clientes"}),e.jsx("p",{className:"small",children:"Crea tu primer cliente usando el formulario debajo."})]}),a.isError&&f.length>0&&e.jsxs("div",{className:"error inline",children:[e.jsx("span",{children:F}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>R(),children:"Reintentar"})]}),e.jsx("div",{ref:m,"aria-hidden":"true"}),x&&e.jsx("p",{className:"muted",children:"Cargando mas..."}),!P&&f.length>0&&e.jsx("p",{className:"muted",children:"No hay mas resultados"}),e.jsxs("form",{className:"form-grid",onSubmit:Q,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{className:"input",ref:h,value:r.name,onChange:s=>u(n=>({...n,name:s.target.value})),placeholder:"Cliente demo"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Email"}),e.jsx("input",{className:"input",value:r.email??"",onChange:s=>u(n=>({...n,email:s.target.value})),placeholder:"cliente@correo.com"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Telefono"}),e.jsx("input",{className:"input",value:r.phone??"",onChange:s=>u(n=>({...n,phone:s.target.value})),placeholder:"+56 9 0000 0000"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Direccion"}),e.jsx("input",{className:"input",value:r.address??"",onChange:s=>u(n=>({...n,address:s.target.value})),placeholder:"Av. Demo 123"})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Segmento"}),e.jsx("input",{className:"input",value:r.segment??"",onChange:s=>u(n=>({...n,segment:s.target.value})),placeholder:"Retail"})]}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:v.isPending,children:v.isPending?"Guardando...":"Crear"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>{u(j()),h.current?.focus()},children:"Limpiar"})]}),v.isError&&e.jsx("p",{className:"error",children:v.error?.message}),N.isError&&e.jsx("p",{className:"error",children:N.error?.message})]})]})});Z.displayName="CustomersCard";export{Z as C};
