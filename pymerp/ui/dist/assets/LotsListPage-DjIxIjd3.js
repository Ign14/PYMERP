import{j as e,u as K,c as k,k as w,K as Q}from"./index-C0DCX_lx.js";import{d as _,r as h}from"./react-DFcFNn96.js";import{u as g}from"./useQuery-ClGZjTlq.js";import{M as R}from"./Modal-BfA53Mfc.js";import{b as B,c as U,d as V}from"./inventory-DjR51aUj.js";const M={OK:{label:"OK",className:"bg-green-950 text-green-400 border-green-800"},BAJO_STOCK:{label:"Bajo stock",className:"bg-yellow-950 text-yellow-400 border-yellow-800"},POR_VENCER:{label:"Por vencer",className:"bg-orange-950 text-orange-400 border-orange-800"},VENCIDO:{label:"Vencido",className:"bg-red-950 text-red-400 border-red-800"}};function z({status:m}){const l=m?.trim().toUpperCase()??"",a=M[l]??{label:m||"Desconocido",className:"bg-neutral-950 text-neutral-300 border-neutral-800"};return e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-semibold border ${a.className}`,children:a.label})}const f=10,G=[{value:"",label:"Todos los estados"},{value:"OK",label:"OK"},{value:"BAJO_STOCK",label:"Bajo stock"},{value:"POR_VENCER",label:"Por vencer"},{value:"VENCIDO",label:"Vencido"}],S=[{value:"expDate,asc",label:"Expiración ↑"},{value:"expDate,desc",label:"Expiración ↓"},{value:"qtyAvailable,desc",label:"Cantidad disponible ↓"},{value:"qtyAvailable,asc",label:"Cantidad disponible ↑"},{value:"fechaIngreso,desc",label:"Ingreso reciente"}];function X(){const m=_(),l=K(),[a,x]=h.useState({q:"",status:"",productId:"",supplierId:"",locationId:"",dateFrom:"",dateTo:"",sort:S[0].value,page:0}),[d,N]=h.useState({open:!1,lot:null}),[p,j]=h.useState(null),r=h.useMemo(()=>["inventory-lots",a.q,a.status,a.productId,a.supplierId,a.locationId,a.dateFrom,a.dateTo,a.sort,a.page,f],[a]),c=g({queryKey:r,queryFn:()=>U({q:a.q||void 0,status:a.status||void 0,productId:a.productId||void 0,supplierId:a.supplierId||void 0,locationId:a.locationId||void 0,dateFrom:a.dateFrom?new Date(a.dateFrom).toISOString():void 0,dateTo:a.dateTo?new Date(a.dateTo).toISOString():void 0,sort:a.sort,page:a.page,size:f}),keepPreviousData:!0}),T=g({queryKey:["inventory-products"],queryFn:()=>w({size:200,status:"all"}),staleTime:6e4}),O=g({queryKey:["inventory-suppliers"],queryFn:()=>Q(void 0,!0),staleTime:6e4}),y=g({queryKey:["assignable-locations"],queryFn:()=>V({enabled:!0,page:0,size:200,sort:"name,asc"}),staleTime:6e4}),o=k({mutationFn:s=>B(s.lotId,s.locationId),onMutate:async s=>{await l.cancelQueries({queryKey:r});const i=l.getQueryData(r);if(i){const t=y.data?.content.find(u=>u.id===s.locationId),A={...i,content:i.content.map(u=>u.lotId===s.lotId?{...u,location:t?{id:t.id,name:t.name}:{id:s.locationId,name:"Ubicación seleccionada"}}:u)};l.setQueryData(r,A)}return{previous:i}},onError:(s,i,t)=>{t?.previous&&l.setQueryData(r,t.previous)},onSettled:()=>{l.invalidateQueries({queryKey:r})}}),I=c.data?.content??[],v=c.data?.totalPages??1,L=s=>{N({open:!0,lot:s}),j(s.location?.id??null)},b=()=>{N({open:!1,lot:null}),j(null)},q=()=>{!d.lot||!p||(o.mutate({lotId:d.lot.lotId,locationId:p}),b())},n=(s,i)=>{x(t=>({...t,[s]:i,page:s==="page"?t.page:0}))},D=()=>{x(s=>({...s,page:Math.max(0,s.page-1)}))},E=()=>{x(s=>({...s,page:s.page+1<v?s.page+1:s.page}))},F=T.data?.content??[],P=O.data??[],C=y.data?.content??[];return e.jsxs("div",{className:"card",children:[e.jsx("div",{className:"card-header",children:e.jsxs("div",{children:[e.jsx("h2",{children:"Lista de lotes"}),e.jsx("p",{className:"muted small",children:"Controla los lotes activos y responde rápidamente a alertas de stock o vencimientos."})]})}),e.jsxs("div",{className:"card-body",style:{display:"flex",flexDirection:"column",gap:"1rem"},children:[e.jsxs("div",{className:"inline-actions",style:{flexWrap:"wrap",gap:"0.75rem"},children:[e.jsx("input",{className:"input",placeholder:"Buscar productos, proveedores o lotes...",value:a.q,onChange:s=>n("q",s.target.value)}),e.jsxs("select",{className:"input",value:a.productId,onChange:s=>n("productId",s.target.value),children:[e.jsx("option",{value:"",children:"Todos los productos"}),F.map(s=>e.jsxs("option",{value:s.id,children:[s.sku," · ",s.name]},s.id))]}),e.jsxs("select",{className:"input",value:a.supplierId,onChange:s=>n("supplierId",s.target.value),children:[e.jsx("option",{value:"",children:"Todos los proveedores"}),P.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsxs("select",{className:"input",value:a.locationId,onChange:s=>n("locationId",s.target.value),children:[e.jsx("option",{value:"",children:"Todas las ubicaciones"}),C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]}),e.jsx("select",{className:"input",value:a.status,onChange:s=>n("status",s.target.value),children:G.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"inline-actions",style:{flexWrap:"wrap",gap:"0.75rem"},children:[e.jsxs("label",{className:"small",htmlFor:"lot-date-from",children:["Desde",e.jsx("input",{id:"lot-date-from",type:"date",className:"input",value:a.dateFrom,onChange:s=>n("dateFrom",s.target.value)})]}),e.jsxs("label",{className:"small",htmlFor:"lot-date-to",children:["Hasta",e.jsx("input",{id:"lot-date-to",type:"date",className:"input",value:a.dateTo,onChange:s=>n("dateTo",s.target.value)})]}),e.jsx("select",{className:"input",value:a.sort,onChange:s=>n("sort",s.target.value),children:S.map(s=>e.jsxs("option",{value:s.value,children:["Ordenar por ",s.label]},s.value))})]})]}),c.isLoading?e.jsx("p",{className:"muted",children:"Cargando lotes…"}):c.isError?e.jsx("p",{className:"error",children:c.error?.message??"No se pudieron cargar lotes"}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Lote"}),e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Proveedor"}),e.jsx("th",{children:"Ubicación"}),e.jsx("th",{children:"Cant. disp."}),e.jsx("th",{children:"Cant. reserv."}),e.jsx("th",{children:"Estado"}),e.jsx("th",{children:"Fecha ingreso"}),e.jsx("th",{children:"Fecha expiración"}),e.jsx("th",{children:"Acciones"})]})}),e.jsx("tbody",{children:I.length===0?e.jsx("tr",{children:e.jsx("td",{colSpan:10,className:"muted",children:"No hay lotes registrados para los filtros actuales."})}):I.map(s=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono",children:s.lotId}),e.jsxs("td",{children:[s.product.name,e.jsx("div",{className:"muted small",children:s.product.sku})]}),e.jsx("td",{children:s.supplier?.name??"—"}),e.jsx("td",{children:s.location?.name??"Sin asignar"}),e.jsx("td",{className:"mono font-semibold",children:s.qtyAvailable.toLocaleString("es-CL")}),e.jsx("td",{className:"mono",children:s.qtyReserved.toLocaleString("es-CL")}),e.jsx("td",{children:e.jsx(z,{status:s.status})}),e.jsx("td",{className:"mono",children:new Date(s.fechaIngreso).toLocaleDateString("es-CL")}),e.jsx("td",{className:"mono",children:s.fechaExpiracion?new Date(s.fechaExpiracion).toLocaleDateString("es-CL"):"—"}),e.jsx("td",{children:e.jsxs("div",{className:"inline-actions",style:{flexDirection:"column",gap:"0.25rem"},children:[e.jsx("button",{className:"btn ghost small",type:"button",onClick:()=>L(s),children:"Asignar ubicación"}),e.jsx("button",{className:"btn ghost small",type:"button",onClick:()=>m(`/app/inventory/movements?lotId=${encodeURIComponent(s.lotId)}`),children:"Ver movimientos"})]})})]},s.lotId))})]})}),e.jsxs("div",{className:"inline-actions",style:{justifyContent:"space-between",marginTop:"0.75rem"},children:[e.jsxs("div",{className:"muted",children:["Página ",a.page+1," de ",v]}),e.jsxs("div",{className:"inline-actions",children:[e.jsx("button",{className:"btn ghost small",onClick:D,disabled:a.page===0,children:"Anterior"}),e.jsx("button",{className:"btn ghost small",onClick:E,disabled:a.page+1>=v,children:"Siguiente"})]})]})]}),e.jsx(R,{open:d.open,onClose:b,title:"Asignar ubicación",children:d.lot?e.jsxs("div",{className:"form-grid",children:[e.jsxs("label",{children:[e.jsx("span",{children:"Lote"}),e.jsx("input",{className:"input",value:d.lot.lotId,disabled:!0})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Ubicación"}),e.jsxs("select",{className:"input",value:p??"",onChange:s=>j(s.target.value),disabled:o.isPending,children:[e.jsx("option",{value:"",children:"Selecciona una ubicación"}),C.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))]})]}),o.isError?e.jsx("p",{className:"error",children:o.error?.message??"No se pudo asignar"}):null,e.jsxs("div",{className:"modal-actions",style:{gridColumn:"1 / -1"},children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:b,disabled:o.isPending,children:"Cancelar"}),e.jsx("button",{className:"btn",type:"button",onClick:q,disabled:o.isPending||!p,children:o.isPending?"Guardando…":"Asignar"})]})]}):e.jsx("p",{className:"muted",children:"Selecciona un lote primero."})})]})}export{X as default};
