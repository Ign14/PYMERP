import{j as e,v as F,d as N,u as L,w as k,x as A,y as E,b as Q}from"./index-BpLAP759.js";import{r as u}from"./react-BYfE7jJl.js";import{u as j,a as f}from"./useMutation-CPedeap3.js";import{P as K}from"./PageHeader-ECmiVUlh.js";import{P as T}from"./ProductsCard-CySb5dUk.js";import{M}from"./Modal-Bq1-hS2x.js";const v={productId:"",direction:"increase",quantity:"0",unitCost:"0",reason:"",expDate:""};function z({open:i,onClose:c,onApplied:x}){const[a,o]=u.useState(v);u.useEffect(()=>{i||o(v)},[i]);const h=j({queryKey:["products",{dialog:"inventory-adjustment"}],queryFn:()=>N({size:200,status:"all"}),enabled:i}),p=u.useMemo(()=>h.data?.content??[],[h.data]),r=f({mutationFn:()=>{if(!a.productId)throw new Error("Selecciona un producto");const n=Number(a.quantity);if(!Number.isFinite(n)||n<=0)throw new Error("La cantidad debe ser mayor a cero");const s=a.direction,l=Number(a.unitCost||0);if(s==="increase"&&(Number.isNaN(l)||l<0))throw new Error("El costo unitario debe ser positivo");const g={productId:a.productId,quantity:n,direction:s,reason:a.reason.trim()||"Ajuste manual",unitCost:s==="increase"?l:void 0,expDate:a.expDate||void 0};return F(g)},onSuccess:()=>{x?.(),o(v),c()}}),m=n=>{n.preventDefault(),!r.isPending&&r.mutate()};return e.jsx(M,{open:i,title:"Ajuste de stock",onClose:()=>{r.isPending||c()},children:e.jsxs("form",{className:"form-grid",onSubmit:m,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Producto *"}),e.jsxs("select",{className:"input",value:a.productId,onChange:n=>o(s=>({...s,productId:n.target.value})),disabled:r.isPending,required:!0,children:[e.jsx("option",{value:"",children:"Selecciona un producto"}),p.map(n=>e.jsx("option",{value:n.id,children:n.name},n.id))]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Tipo de ajuste"}),e.jsxs("select",{className:"input",value:a.direction,onChange:n=>o(s=>({...s,direction:n.target.value})),disabled:r.isPending,children:[e.jsx("option",{value:"increase",children:"Incremento"}),e.jsx("option",{value:"decrease",children:"Disminucion"})]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Cantidad *"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:a.quantity,onChange:n=>o(s=>({...s,quantity:n.target.value})),disabled:r.isPending,required:!0})]}),a.direction==="increase"&&e.jsxs("label",{children:[e.jsx("span",{children:"Costo unitario"}),e.jsx("input",{className:"input",type:"number",min:"0",step:"0.01",value:a.unitCost,onChange:n=>o(s=>({...s,unitCost:n.target.value})),disabled:r.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Fecha de vencimiento"}),e.jsx("input",{className:"input",type:"date",value:a.expDate,onChange:n=>o(s=>({...s,expDate:n.target.value})),disabled:r.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Motivo"}),e.jsx("textarea",{className:"input",rows:3,value:a.reason,onChange:n=>o(s=>({...s,reason:n.target.value})),placeholder:"Regularizacion, inventario, merma, etc.",disabled:r.isPending})]}),r.isError&&e.jsx("p",{className:"error",children:r.error?.message??"No se pudo registrar el ajuste"}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:r.isPending,children:r.isPending?"Guardando...":"Registrar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:c,disabled:r.isPending,children:"Cancelar"})]})]})})}const b=10;function V(i){const c=Number(i);return Number.isFinite(c)?`$${c.toLocaleString("es-CL",{maximumFractionDigits:0})}`:"$0"}function U(){const i=L(),[c,x]=u.useState(!1),[a,o]=u.useState(null),[h,p]=u.useState(""),r=j({queryKey:["products",{view:"inventory"}],queryFn:()=>N({size:200,status:"all"})}),m=j({queryKey:["inventory","settings"],queryFn:A});u.useEffect(()=>{if(m.data){const t=Number(m.data.lowStockThreshold??0);if(Number.isFinite(t)&&t>0){a===null&&o(t),p(d=>d||String(t));return}}!m.isLoading&&a===null&&(o(b),p(String(b)))},[m.data,m.isLoading,a]);const n=j({queryKey:["inventory","summary"],queryFn:E}),s=j({queryKey:["inventory","alerts",a],enabled:a!==null,queryFn:()=>Q(a??void 0)}),l=f({mutationFn:t=>k({lowStockThreshold:t}),onSuccess:t=>{const d=Number(t.lowStockThreshold??0);Number.isFinite(d)&&d>0&&(o(d),p(String(d))),i.invalidateQueries({queryKey:["inventory","summary"]}),i.invalidateQueries({queryKey:["inventory","alerts"]}),i.setQueryData(["inventory","settings"],t)}}),g=()=>{const t=Number(h);if(!Number.isFinite(t)||t<=0){window.alert("Ingresa un umbral mayor a cero");return}l.mutate(t)},S=()=>{i.invalidateQueries({queryKey:["inventory","summary"]}),i.invalidateQueries({queryKey:["inventory","alerts"]}),i.invalidateQueries({queryKey:["products"],exact:!1}),x(!1)},C=u.useMemo(()=>new Map((r.data?.content??[]).map(t=>[t.id,t])),[r.data]),y=n.data,P=V(y?.totalValue??0),q=y?.activeProducts??0,I=y?.lowStockAlerts??s.data?.length??0,w=y?.lowStockThreshold??a??Number(h||0);return e.jsxs("div",{className:"page-section",children:[e.jsx(K,{title:"Inventario",description:"Visibiliza catalogo, lotes y alertas de stock para garantizar disponibilidad.",actions:e.jsx("button",{className:"btn",onClick:()=>x(!0),children:"+ Ajuste de stock"})}),e.jsxs("section",{className:"kpi-grid",children:[e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Valor inventario"}),e.jsx("p",{className:"stat-value",children:n.isLoading?"-":P}),e.jsx("span",{className:"stat-trend",children:"Costo total disponible"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Productos activos"}),e.jsx("p",{className:"stat-value",children:n.isLoading?"-":q}),e.jsx("span",{className:"stat-trend",children:"Inventario sincronizado"})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Alertas stock"}),e.jsx("p",{className:"stat-value",children:s.isLoading?"-":I}),e.jsxs("span",{className:"stat-trend",children:["Umbral ",w??"-"]})]})]}),e.jsxs("section",{className:"responsive-grid",children:[e.jsx("div",{className:"card",children:e.jsx(T,{})}),e.jsxs("div",{className:"card table-card",children:[e.jsx("h3",{children:"Lotes con stock critico"}),e.jsxs("div",{className:"inline-actions",style:{marginBottom:"0.75rem"},children:[e.jsx("label",{className:"muted small",htmlFor:"low-stock-threshold",children:"Umbral"}),e.jsx("input",{id:"low-stock-threshold",className:"input",type:"number",step:"0.1",min:"0.1",value:h,onChange:t=>p(t.target.value),disabled:l.isPending}),e.jsx("button",{className:"btn",type:"button",onClick:g,disabled:l.isPending,children:l.isPending?"Guardando...":"Guardar"})]}),l.isError&&e.jsx("p",{className:"error",children:l.error?.message??"No se pudo actualizar el umbral"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Lote"}),e.jsx("th",{children:"Disponible"}),e.jsx("th",{children:"Expira"}),e.jsx("th",{children:"Creado"})]})}),e.jsxs("tbody",{children:[s.isLoading&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"muted",children:"Cargando alertas..."})}),s.isError&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"error",children:s.error?.message??"No se pudieron obtener alertas"})}),!s.isLoading&&!s.isError&&(s.data??[]).map(t=>{const d=C.get(t.productId),D=t.expDate?new Date(t.expDate).toLocaleDateString():"-";return e.jsxs("tr",{children:[e.jsx("td",{children:d?.name??t.productId}),e.jsx("td",{className:"mono",children:t.lotId}),e.jsx("td",{className:"mono",children:Number(t.qtyAvailable).toFixed(2)}),e.jsx("td",{className:"mono",children:D}),e.jsx("td",{className:"mono small",children:new Date(t.createdAt).toLocaleDateString()})]},t.lotId)}),!s.isLoading&&!s.isError&&(s.data??[]).length===0&&e.jsx("tr",{children:e.jsx("td",{colSpan:5,className:"muted",children:"Sin alertas"})})]})]})})]})]}),e.jsx(z,{open:c,onClose:()=>x(!1),onApplied:S})]})}export{U as default};
