import{b as Be,j as e,u as qe,c as xe,d as ze,i as Ge,n as Ye,l as We,e as He,f as Ze,h as Xe,k as Je,m as et,o as tt,p as $e,q as st,r as at,s as nt,t as rt,v as lt,w as ot,x as ve,y as ct}from"./index-OfXnknKF.js";import{r as n}from"./react-DFcFNn96.js";import{u as ae}from"./useQuery-7A7SEbdC.js";import{P as it}from"./PageHeader-DR0dkBli.js";import{M as _e}from"./Modal-BCEKQ7aJ.js";import{u as dt,m as ut,c as mt}from"./customersUtils-Co8rj5Pn.js";import{u as Ae}from"./useDebouncedValue-DwVyRO6o.js";import{p as ht}from"./problemDetail-B33ux2x6.js";import{u as pt,f as Ee,g as xt}from"./table-BQREnrjO.js";import{R as gt,A as ft,C as jt,X as bt,Y as yt,T as Nt,c as vt,d as Ct}from"./charts-BeDQCoM6.js";function _t(t){return ae({queryKey:["frequent-products",t],queryFn:()=>{if(!t)throw new Error("customerId is required");return Be(t)},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3})}const St=new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",minimumFractionDigits:0,maximumFractionDigits:0});function wt(t){try{return new Date(t).toLocaleDateString()}catch{return t}}function Pt({customerId:t,visible:r,onPick:d}){const[l,f]=n.useState(""),{data:c,isLoading:p,isFetching:y,isError:E,refetch:v}=_t(t);n.useEffect(()=>{f("")},[t]);const C=n.useMemo(()=>{if(!c)return[];const i=l.trim().toLowerCase();return i?c.filter(u=>{const S=u.name?.toLowerCase()??"",w=u.sku?.toLowerCase()??"";return S.includes(i)||w.includes(i)}):c},[c,l]);if(!r||!t)return null;const j=(c?.length??0)>0,_=p||y&&!(c&&c.length);return e.jsxs("section",{className:"card frequent-products-panel","aria-label":"Productos frecuentes del cliente","aria-live":"polite",children:[e.jsxs("header",{className:"card-header frequent-products-header",children:[e.jsxs("div",{className:"frequent-products-heading",children:[e.jsx("h2",{className:"card-title",children:"Productos frecuentes"}),e.jsx("p",{className:"muted",children:"Basado en compras anteriores del cliente."})]}),j?e.jsxs("div",{className:"frequent-products-search",children:[e.jsx("label",{className:"sr-only",htmlFor:"frequent-products-search",children:"Buscar producto frecuente"}),e.jsx("input",{id:"frequent-products-search",type:"search",className:"input",placeholder:"Buscar por nombre o SKU",value:l,onChange:i=>f(i.target.value),autoComplete:"off"})]}):null]}),e.jsxs("div",{className:"frequent-products-content","aria-busy":_,children:[_?e.jsxs("div",{className:"frequent-products-loading",role:"status","aria-live":"polite",children:[e.jsx("div",{className:"skeleton skeleton-text","aria-hidden":"true"}),e.jsx("div",{className:"skeleton skeleton-text","aria-hidden":"true"}),e.jsx("div",{className:"skeleton skeleton-text","aria-hidden":"true"})]}):null,!_&&E?e.jsxs("div",{className:"frequent-products-error",role:"alert",children:[e.jsx("p",{children:"No pudimos cargar los productos frecuentes."}),e.jsx("button",{type:"button",className:"btn",onClick:()=>v(),children:"Reintentar"})]}):null,!_&&!E&&(c?.length??0)===0?e.jsx("p",{className:"muted",role:"status",children:"Este cliente no tiene compras previas."}):null,!_&&!E&&C.length>0?e.jsx("ul",{className:"frequent-products-list",children:C.map(i=>{const u=wt(i.lastPurchasedAt),S=i.avgQty!==void 0&&i.avgQty!==null?Number(i.avgQty).toFixed(1):null,w=i.lastUnitPrice!==void 0&&i.lastUnitPrice!==null?St.format(i.lastUnitPrice):null,G=()=>d(i,{lastQty:i.lastQty});return e.jsx("li",{children:e.jsxs("div",{role:"button",tabIndex:0,className:"frequent-product-row",onClick:G,onKeyDown:$=>{($.key==="Enter"||$.key===" ")&&($.preventDefault(),G())},"aria-label":`Agregar ${i.name}`,children:[e.jsxs("div",{className:"frequent-product-main",children:[e.jsx("span",{className:"frequent-product-name",children:i.name}),e.jsxs("span",{className:"frequent-product-sku",children:["SKU: ",i.sku||"—"]})]}),e.jsxs("dl",{className:"frequent-product-meta",children:[e.jsxs("div",{children:[e.jsx("dt",{children:"Última compra"}),e.jsx("dd",{children:u})]}),e.jsxs("div",{children:[e.jsx("dt",{children:"Veces compradas"}),e.jsx("dd",{children:i.totalPurchases})]}),i.lastQty!==void 0?e.jsxs("div",{children:[e.jsx("dt",{children:"Última cantidad"}),e.jsx("dd",{children:i.lastQty})]}):null,S?e.jsxs("div",{children:[e.jsx("dt",{children:"Cantidad promedio"}),e.jsx("dd",{children:S})]}):null,w?e.jsxs("div",{children:[e.jsx("dt",{children:"Último precio"}),e.jsx("dd",{children:w})]}):null]})]})},i.productId)})}):null,!_&&!E&&C.length===0&&(c?.length??0)>0?e.jsxs("p",{className:"muted",role:"status",children:['No encontramos coincidencias para "',l,'".']}):null]})]})}const Se=[{value:"Factura",label:"Factura"},{value:"Boleta",label:"Boleta"},{value:"Cotización",label:"Cotización"},{value:"Comprobante",label:"Comprobante"}],we=[{value:"Efectivo",label:"Efectivo"},{value:"Tarjetas",label:"Tarjetas"},{value:"Transferencia",label:"Transferencia"},{value:"Otros",label:"Otros"}],Et=20,Dt="name,asc",kt=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,ge={name:"",document:"",email:"",phone:"",address:"",commune:""};function Ce(t){const r=t.trim();return r.length>0?r:void 0}function Tt(t){const r={},d=t.name.trim();d.length<3?r.name="El nombre debe tener al menos 3 caracteres":d.length>120&&(r.name="El nombre no puede superar 120 caracteres");const l=t.document.trim();let f;l.length>0&&(Ge(l)?f=Ye(l):r.document="Ingresa un RUT válido");const c=t.email.trim();c&&!kt.test(c)&&(r.email="Ingresa un email válido");const p=t.phone.trim();return Object.keys(r).length>0?{errors:r}:{payload:{name:d,document:f??Ce(t.document),email:c?c.toLowerCase():void 0,phone:p?p.replace(/\s+/g," ").trim():void 0,address:Ce(t.address),commune:Ce(t.commune)},errors:r}}function Ft(t,r,d){const l=n.useRef(t.length);n.useEffect(()=>{if(!r){l.current=t.length;return}if(t.length===0){d(-1),l.current=0;return}t.length!==l.current&&(d(0),l.current=t.length)},[t,r,d])}function Rt({value:t,onSelect:r,onClear:d,disabled:l,label:f="Cliente",required:c=!1,error:p=null,onErrorDismiss:y,debounceMs:E=400}){const[v,C]=n.useState(""),[j,_]=n.useState(!1),[i,u]=n.useState(-1),[S,w]=n.useState({tone:null,message:null}),[G,$]=n.useState(!1),[R,K]=n.useState({...ge}),[k,Q]=n.useState({}),[M,J]=n.useState(null),ne=n.useRef(null),V=n.useRef(null),Y=n.useRef(null),g=n.useRef(null),A=Ae(v,E),W=qe(),N=n.useId(),re=n.useId(),B=n.useRef(null),he=n.useRef(null);n.useEffect(()=>{const o=t?.id??null;o!==g.current&&(g.current=o,C(t?t.name??"":""))},[t]);const O=dt({queryKey:["customers","picker",A],queryFn:async({pageParam:o=0})=>{const m=A.trim();return await We({page:o,size:Et,sort:Dt,q:m.length>0?m:void 0})},getNextPageParam:o=>mt(o),initialPageParam:0}),U=n.useMemo(()=>ut(O.data?.pages??[]),[O.data]);Ft(U,j,u);const le=O.hasNextPage??!1,oe=O.isFetchingNextPage,ue=O.isPending&&U.length===0,se=n.useCallback(o=>{typeof window<"u"&&typeof window.requestAnimationFrame=="function"?window.requestAnimationFrame(o):setTimeout(o,0)},[]);n.useEffect(()=>{if(!j||typeof window>"u"||typeof window.IntersectionObserver>"u")return;const o=B.current;if(!o)return;const m=new IntersectionObserver(Z=>{const[de]=Z;de?.isIntersecting&&le&&!oe&&O.fetchNextPage()});return m.observe(o),he.current=m,()=>m.disconnect()},[j,le,oe,O]);const T=()=>{Y.current&&(window.clearTimeout(Y.current),Y.current=null)},ce=n.useCallback(()=>{_(!1),u(-1)},[]),H=n.useCallback(o=>{r(o),ce(),w({tone:null,message:null}),y?.(),se(()=>V.current?.blur())},[ce,r,y,se]),z=()=>{l||(T(),_(!0))},me=()=>{T(),Y.current=window.setTimeout(()=>{ce()},120)},s=o=>{const{value:m}=o.currentTarget;C(m),w({tone:null,message:null}),j||_(!0)},h=o=>{if(!j&&(o.key==="ArrowDown"||o.key==="ArrowUp"||o.key==="Enter")&&_(!0),o.key==="ArrowDown"){if(o.preventDefault(),U.length===0)return;u(m=>m+1>=U.length?m:m+1);return}if(o.key==="ArrowUp"){if(o.preventDefault(),U.length===0)return;u(m=>m<=0?0:m-1);return}if(o.key==="Enter"){j&&i>=0&&U[i]&&(o.preventDefault(),H(U[i]));return}if(o.key==="Escape"){if(o.preventDefault(),j){ce();return}v.length>0&&(C(""),d?.())}},I=o=>{o.preventDefault(),T()},ee=()=>{$(!0),K({...ge,name:v.trim()}),Q({}),J(null),ce(),se(()=>{V.current?.blur()})},ie=()=>{L.isPending||($(!1),K({...ge}),Q({}),J(null),V.current?.focus())},L=xe({mutationFn:o=>ze(o),onSuccess:o=>{W.invalidateQueries({queryKey:["customers"],exact:!1}),w({tone:"success",message:"Cliente creado"}),$(!1),K({...ge}),Q({}),J(null),H(o),se(()=>V.current?.focus())},onError:o=>{const m=ht(o),Z={};for(const[de,je]of Object.entries(m.fieldErrors))je&&de in ge&&(Z[de]=je);Q(Z),J(m.message??"No se pudo crear el cliente")}}),te=o=>{o.preventDefault(),J(null);const{payload:m,errors:Z}=Tt(R);if(!m||Object.keys(Z).length>0){Q(Z);return}L.mutate(m)},pe=o=>{const m=[];return o.document&&m.push(o.document),o.email&&m.push(o.email),!o.email&&o.phone&&m.push(o.phone),m.join(" • ")};return e.jsxs("div",{className:"customer-select",ref:ne,children:[e.jsxs("label",{className:"customer-select__label",htmlFor:`${N}-input`,children:[f,c?e.jsx("span",{className:"customer-select__required","aria-hidden":"true",children:"*"}):null]}),e.jsxs("div",{className:"customer-select__field",children:[e.jsxs("div",{className:`customer-select__combobox${j?" is-open":""}${l?" is-disabled":""}${p?" has-error":""}`,children:[e.jsx("input",{id:`${N}-input`,ref:V,type:"text",className:"customer-select__input",role:"combobox","aria-autocomplete":"list","aria-expanded":j,"aria-controls":N,"aria-activedescendant":i>=0&&U[i]?`${N}-option-${i}`:void 0,"aria-describedby":p?`${N}-error`:void 0,placeholder:"Buscar por nombre, RUT o email…",value:v,onFocus:z,onBlur:me,onInput:s,onKeyDown:h,disabled:l,autoComplete:"off","aria-required":c?"true":void 0}),t?e.jsx("button",{type:"button",className:"customer-select__clear",onClick:()=>{d?.(),C(""),w({tone:null,message:null}),V.current?.focus()},"aria-label":"Limpiar cliente seleccionado",disabled:l,children:"×"}):null,e.jsx("button",{type:"button",className:"customer-select__create-btn",onClick:ee,disabled:l,children:"+ Nuevo cliente"})]}),j?e.jsxs("div",{className:"customer-select__dropdown",role:"listbox",id:N,children:[ue?e.jsx("div",{className:"customer-select__empty",children:"Buscando clientes…"}):U.length===0?e.jsxs("div",{className:"customer-select__empty",role:"status","aria-live":"polite",children:[e.jsx("p",{children:"Sin resultados. ¿Crear cliente?"}),e.jsx("button",{type:"button",className:"btn ghost",onClick:ee,children:"Crear cliente"})]}):e.jsx("ul",{className:"customer-select__options",children:U.map((o,m)=>{const Z=pe(o),de=m===i;return e.jsx("li",{children:e.jsxs("button",{type:"button",role:"option",id:`${N}-option-${m}`,className:`customer-select__option${de?" is-active":""}`,"aria-selected":de,onMouseDown:I,onClick:()=>H(o),children:[e.jsx("span",{className:"customer-select__option-name",children:o.name}),Z?e.jsx("span",{className:"customer-select__option-meta",children:Z}):null]})},o.id)})}),O.isError?e.jsx("div",{className:"customer-select__empty customer-select__empty--error",role:"alert",children:O.error.message||"No se pudieron cargar los clientes"}):null,le?e.jsx("div",{className:"customer-select__load-more",ref:B,children:e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>void O.fetchNextPage(),disabled:oe,children:oe?"Cargando más…":"Cargar más"})}):null]}):null,p?e.jsx("p",{id:`${N}-error`,className:"customer-select__feedback customer-select__feedback--error",role:"alert",children:p}):null,S.tone&&S.message?e.jsx("p",{className:`customer-select__feedback customer-select__feedback--${S.tone}`,role:"status","aria-live":"polite",children:S.message}):null]}),G?e.jsxs("div",{className:"customer-create-overlay",role:"dialog","aria-modal":"true","aria-labelledby":re,children:[e.jsx("div",{className:"customer-create-overlay__backdrop",onClick:ie,role:"presentation"}),e.jsxs("section",{className:"customer-create-sheet",children:[e.jsxs("header",{className:"customer-create-sheet__header",children:[e.jsx("h3",{id:re,children:"Nuevo cliente"}),e.jsx("button",{type:"button",className:"icon-btn",onClick:ie,"aria-label":"Cerrar",disabled:L.isPending,children:"×"})]}),e.jsxs("form",{className:"customer-create-sheet__form",onSubmit:te,noValidate:!0,children:[e.jsxs("label",{children:[e.jsx("span",{children:"Nombre *"}),e.jsx("input",{type:"text",className:`input${k.name?" input-error":""}`,value:R.name,onChange:o=>{K(m=>({...m,name:o.target.value})),Q(m=>({...m,name:void 0}))},required:!0,minLength:3,maxLength:120,autoFocus:!0,disabled:L.isPending}),k.name?e.jsx("span",{className:"error",role:"alert",children:k.name}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"RUT"}),e.jsx("input",{type:"text",className:`input${k.document?" input-error":""}`,value:R.document,onChange:o=>{K(m=>({...m,document:o.target.value})),Q(m=>({...m,document:void 0}))},placeholder:"76.123.456-0",disabled:L.isPending}),k.document?e.jsx("span",{className:"error",role:"alert",children:k.document}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Email"}),e.jsx("input",{type:"email",className:`input${k.email?" input-error":""}`,value:R.email,onChange:o=>{K(m=>({...m,email:o.target.value})),Q(m=>({...m,email:void 0}))},placeholder:"contacto@cliente.cl",disabled:L.isPending}),k.email?e.jsx("span",{className:"error",role:"alert",children:k.email}):null]}),e.jsxs("label",{children:[e.jsx("span",{children:"Teléfono"}),e.jsx("input",{type:"tel",className:"input",value:R.phone,onChange:o=>{K(m=>({...m,phone:o.target.value}))},placeholder:"+56 9 1234 5678",disabled:L.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Dirección"}),e.jsx("input",{type:"text",className:"input",value:R.address,onChange:o=>{K(m=>({...m,address:o.target.value}))},placeholder:"Av. Principal 1234",disabled:L.isPending})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Comuna"}),e.jsx("input",{type:"text",className:"input",value:R.commune,onChange:o=>{K(m=>({...m,commune:o.target.value}))},placeholder:"Providencia",disabled:L.isPending})]}),M?e.jsx("div",{className:"customer-create-sheet__alert",role:"alert",children:M}):null,e.jsxs("div",{className:"customer-create-sheet__actions",children:[e.jsx("button",{type:"button",className:"btn ghost",onClick:ie,disabled:L.isPending,children:"Cancelar"}),e.jsx("button",{className:"btn",type:"submit",disabled:L.isPending,children:L.isPending?"Guardando…":"Guardar"})]})]})]})]}):null]})}const De=Se[0].value,ke=we[2].value,Te=["barcode","sku","qr"],Lt=100,Mt=[{value:"auto",label:"Detección automática"},{value:"barcode",label:"Código de barras"},{value:"sku",label:"SKU"},{value:"qr",label:"QR"}];function It({open:t,onClose:r,onCreated:d}){const[l,f]=n.useState(null),[c,p]=n.useState(null),[y,E]=n.useState(De),[v,C]=n.useState(ke),[j,_]=n.useState([]),[i,u]=n.useState(""),[S,w]=n.useState(1),[G,$]=n.useState(0),[R,K]=n.useState("amount"),[k,Q]=n.useState(0),[M,J]=n.useState(!0),[ne,V]=n.useState({}),[Y,g]=n.useState(!1),A=n.useRef(null),W=n.useRef(""),N=n.useRef(null),[re,B]=n.useState(""),[he,O]=n.useState(""),[U,le]=n.useState("auto"),[oe,ue]=n.useState(!1),[se,T]=n.useState({status:"idle"}),ce=ae({queryKey:["products",{dialog:"sales"}],queryFn:()=>Xe({size:200}),enabled:t,staleTime:3e4});ae({queryKey:["locations",{dialog:"sales"}],queryFn:()=>Je(),enabled:t});const H=xe({mutationFn:a=>Ze(a),onSuccess:a=>{d(a),de(),r()}}),z=ce.data?.content??[],me=l?.id??"";n.useEffect(()=>{z.length&&V(a=>{let x=!1;const b={...a};for(const P of z)b[P.id]||(b[P.id]=P,x=!0);return x?b:a})},[z]),n.useEffect(()=>{l?.id||g(!1)},[l]);const s=n.useCallback(a=>{f(a),p(null)},[]),h=n.useCallback(()=>{f(null),p(null),g(!1)},[]),I=n.useCallback((a,x=1,b)=>{if(!a||x<=0||Number.isNaN(x))return;const P=b!==void 0&&!Number.isNaN(b)?b:Number(a.currentPrice??0)||0;V(q=>q[a.id]?q:{...q,[a.id]:a}),_(q=>{const F=q.findIndex(D=>D.productId===a.id);if(F!==-1){const D=q[F],be=[...q];return be[F]={...D,qty:D.qty+x,unitPrice:b!==void 0?b:D.unitPrice||P},be}return[...q,{productId:a.id,qty:x,unitPrice:P}]})},[]),ee=n.useCallback(async(a,x={})=>{const b=a.trim();if(!b)return x.showEmptyError&&T({status:"error",message:"Ingresa un código válido."}),null;ue(!0),T({status:"loading",message:"Buscando producto..."});const P=x.hint?[x.hint,...Te.filter(F=>F!==x.hint)]:Te,q=new Set;try{for(const F of P){if(q.has(F))continue;q.add(F);const D=await He({query:b,type:F});if(D)return I(D,1),T({status:"success",message:`Producto "${D.name}" agregado a la venta.`}),D}return T({status:"error",message:"Producto no encontrado para el código ingresado."}),null}catch(F){const D=F instanceof Error?F.message:"No se pudo buscar el producto.";return T({status:"error",message:D}),null}finally{ue(!1)}},[I]),ie=n.useCallback(()=>{N.current&&(window.clearTimeout(N.current),N.current=null);const a=W.current.trim();if(!a){B(""),W.current="";return}let x=a;B(""),W.current="",ee(x,{showEmptyError:!1})},[ee]),L=a=>{const x=a.target.value;B(x),W.current=x,N.current&&window.clearTimeout(N.current),x&&(N.current=window.setTimeout(ie,Lt))},te=a=>{a.key==="Enter"&&(a.preventDefault(),ie())},pe=async()=>{if(oe)return;await ee(he,{hint:U==="auto"?void 0:U,showEmptyError:!0})&&(O(""),le("auto"))},o=n.useMemo(()=>{const a=j.reduce((F,D)=>F+D.qty*D.unitPrice-(D.discount??0),0);let x=0;R==="percentage"?x=a*(k/100):x=k;const b=a-x,P=M?b*.19:0,q=b+P;return{subtotal:a,discountAmount:x,net:b,vat:P,total:q}},[j,M,R,k]),m=()=>{if(!i){T({status:"error",message:"Selecciona un producto para agregarlo."});return}const a=z.find(x=>x.id===i);if(!a){T({status:"error",message:"Producto seleccionado no disponible."});return}if(S<=0||Number.isNaN(S)){T({status:"error",message:"La cantidad debe ser mayor a cero."});return}if(G<=0||Number.isNaN(G)){T({status:"error",message:"El precio unitario debe ser mayor a cero."});return}I(a,S,G),T({status:"success",message:`Se agregó ${S}× "${a.name}" al carrito.`}),u(""),w(1),$(0)},Z=a=>{_(x=>x.filter((b,P)=>P!==a))},de=()=>{f(null),p(null),E(De),C(ke),_([]),u(""),w(1),$(0),O(""),le("auto"),T({status:"idle"}),ue(!1),B(""),W.current="",N.current&&(window.clearTimeout(N.current),N.current=null),g(!1)},je=a=>{if(a.preventDefault(),!l?.id){p("Selecciona un cliente");return}if(j.length===0)return;const x={customerId:l.id,docType:y,paymentMethod:v,discount:k>0?R==="percentage"?o.discountAmount:k:void 0,vatRate:M?19:void 0,items:j};H.mutate(x)};n.useEffect(()=>{if(!t){T({status:"idle"}),ue(!1),B(""),W.current="",N.current&&(window.clearTimeout(N.current),N.current=null),g(!1);return}requestAnimationFrame(()=>{A.current&&(A.current.focus(),A.current.select())})},[t]),n.useEffect(()=>()=>{N.current&&(window.clearTimeout(N.current),N.current=null)},[]);const Qe=n.useCallback((a,x)=>{const b=ne[a.productId]??z.find(Ve=>Ve.id===a.productId);if(!b){T({status:"error",message:"El producto ya no está disponible en el catálogo."});return}const P=x?.lastQty,q=a.avgQty?Math.round(a.avgQty):1,F=P!==void 0&&P>0?P:q,D=F>0?F:1,be=b.currentPrice!==void 0&&b.currentPrice!==null?void 0:a.lastUnitPrice;I(b,D,be),T({status:"success",message:`Se agregó ${D}× "${b.name}" desde frecuentes.`})},[I,ne,z]);return e.jsx(_e,{open:t,onClose:r,title:"Registrar venta",initialFocusRef:A,className:"modal--wide sales-create-modal",children:e.jsxs("form",{className:"form-grid",onSubmit:je,children:[e.jsx(Rt,{value:l,onSelect:s,onClear:h,label:"Cliente",required:!0,error:c,onErrorDismiss:()=>p(null),disabled:H.isPending}),e.jsxs("label",{children:[e.jsx("span",{children:"Documento"}),e.jsx("select",{className:"input",value:y,onChange:a=>E(a.target.value),children:Se.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Método de pago"}),e.jsx("select",{className:"input",value:v,onChange:a=>C(a.target.value),children:we.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))})]}),e.jsx("div",{className:"line"}),e.jsx("div",{className:"section-title",children:"Descuentos e Impuestos"}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"1rem"},children:[e.jsxs("label",{children:[e.jsx("span",{children:"Tipo de descuento"}),e.jsxs("select",{className:"input",value:R,onChange:a=>K(a.target.value),children:[e.jsx("option",{value:"amount",children:"Monto fijo ($)"}),e.jsx("option",{value:"percentage",children:"Porcentaje (%)"})]})]}),e.jsxs("label",{children:[e.jsx("span",{children:"Valor descuento"}),e.jsx("input",{className:"input",type:"number",min:0,step:R==="percentage"?1:.01,value:k,onChange:a=>Q(Number(a.target.value)),placeholder:R==="percentage"?"0-100":"0.00"})]}),e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[e.jsx("input",{type:"checkbox",checked:M,onChange:a=>J(a.target.checked)}),e.jsx("span",{children:"Aplicar IVA 19%"})]})]}),e.jsx("div",{className:"line"}),e.jsxs("div",{className:"lookup-section",children:[e.jsxs("div",{className:"scan-input-wrapper",children:[e.jsxs("label",{children:[e.jsx("span",{children:"Escáner USB"}),e.jsx("input",{ref:A,className:"input scan-input",type:"text",inputMode:"text",autoComplete:"off",value:re,onChange:L,onKeyDown:te,placeholder:"Enfoca y escanea el código","aria-describedby":"scan-hint"})]}),e.jsx("p",{id:"scan-hint",className:"scan-hint",children:"Mantén el foco en este campo y escanea código de barras, SKU o QR. El producto se agrega automáticamente cuando se detecta la lectura."})]}),e.jsx("div",{className:"manual-entry",children:e.jsxs("label",{children:[e.jsx("span",{children:"Agregar por código"}),e.jsxs("div",{className:"manual-entry__inputs",children:[e.jsx("input",{className:"input",type:"text",value:he,onChange:a=>O(a.target.value),onKeyDown:a=>{a.key==="Enter"&&(a.preventDefault(),pe())},placeholder:"Ingresa código, SKU o QR"}),e.jsx("select",{className:"input manual-entry__type",value:U,onChange:a=>le(a.target.value),"aria-label":"Tipo de código",children:Mt.map(a=>e.jsx("option",{value:a.value,children:a.label},a.value))}),e.jsx("button",{type:"button",className:"btn",onClick:()=>void pe(),disabled:oe||he.trim()==="",children:oe?"Buscando...":"Agregar"})]})]})})]}),se.status!=="idle"&&e.jsx("div",{className:`status-message lookup-feedback ${se.status==="success"?"success":se.status==="error"?"error":"loading"}`,role:"status","aria-live":"polite",children:se.message??""}),e.jsxs("section",{className:"frequent-products-wrapper",children:[e.jsxs("label",{className:"frequent-products-toggle",children:[e.jsx("input",{type:"checkbox",checked:Y,onChange:a=>g(a.target.checked),disabled:!me}),e.jsx("span",{children:"Productos frecuentes del cliente"})]}),e.jsx(Pt,{customerId:me||void 0,visible:Y&&!!me,onPick:Qe})]}),e.jsx("div",{className:"line"}),e.jsxs("div",{className:"item-builder",children:[e.jsxs("select",{className:"input",value:i,onChange:a=>{const x=a.target.value;u(x);const b=z.find(P=>P.id===x);b?.currentPrice!==void 0&&b.currentPrice!==null?$(Number(b.currentPrice)):$(0)},children:[e.jsx("option",{value:"",children:"Selecciona producto"}),z.map(a=>e.jsx("option",{value:a.id,children:a.name},a.id))]}),e.jsx("input",{className:"input",type:"number",min:1,value:S,onChange:a=>w(Number(a.target.value))}),e.jsx("input",{className:"input",type:"number",step:"0.01",min:0,value:G,onChange:a=>$(Number(a.target.value))}),e.jsx("button",{type:"button",className:"btn",onClick:m,children:"Agregar"})]}),j.length>0&&e.jsx("div",{className:"table-wrapper compact",children:e.jsxs("table",{className:"table nowrap",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Producto"}),e.jsx("th",{children:"Cantidad"}),e.jsx("th",{children:"Precio"}),e.jsx("th",{})]})}),e.jsx("tbody",{children:j.map((a,x)=>{const P=(ne[a.productId]??z.find(D=>D.id===a.productId))?.name??a.productId,q=`${a.qty}`,F=`$${a.unitPrice.toFixed(2)}`;return e.jsxs("tr",{children:[e.jsx("td",{title:P,children:e.jsx("span",{className:"cell-text",children:P})}),e.jsx("td",{className:"mono",title:q,children:e.jsx("span",{className:"cell-text",children:a.qty})}),e.jsx("td",{className:"mono",title:F,children:e.jsx("span",{className:"cell-text",children:F})}),e.jsx("td",{className:"actions-cell",children:e.jsx("button",{type:"button",className:"btn ghost",onClick:()=>Z(x),children:"Quitar"})})]},`${a.productId}-${x}`)})})]})}),e.jsxs("div",{className:"total-section",style:{display:"grid",gridTemplateColumns:"1fr auto",gap:"0.5rem",padding:"1rem",background:"#f9f9f9",borderRadius:"4px"},children:[e.jsx("span",{className:"muted",children:"Subtotal:"}),e.jsxs("strong",{children:["$",o.subtotal.toFixed(2)]}),k>0&&e.jsxs(e.Fragment,{children:[e.jsxs("span",{className:"muted",children:["Descuento (",R==="percentage"?`${k}%`:"$","):"]}),e.jsxs("strong",{children:["-$",o.discountAmount.toFixed(2)]})]}),e.jsx("span",{className:"muted",children:"Neto:"}),e.jsxs("strong",{children:["$",o.net.toFixed(2)]}),M&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"muted",children:"IVA (19%):"}),e.jsxs("strong",{children:["$",o.vat.toFixed(2)]})]}),e.jsx("span",{style:{fontSize:"1.1rem",fontWeight:"bold"},children:"Total:"}),e.jsxs("strong",{style:{fontSize:"1.1rem"},children:["$",o.total.toFixed(2)]})]}),H.isError&&e.jsx("p",{className:"error",children:H.error.message}),e.jsxs("div",{className:"buttons",children:[e.jsx("button",{className:"btn",type:"submit",disabled:H.isPending,children:H.isPending?"Guardando...":"Registrar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:de,children:"Limpiar"})]})]})})}const Oe="es-CL",Ue="CLP",Fe=new Intl.NumberFormat(Oe,{style:"currency",currency:Ue,minimumFractionDigits:0,maximumFractionDigits:0});function Ke(t){const r=Ue;return new Intl.NumberFormat(Oe,{style:"currency",currency:r,minimumFractionDigits:0,maximumFractionDigits:0})}function Pe(t){return t==null||Number.isNaN(t)?Fe.format(0):Fe.format(t)}function qt({value:t,rangeLabel:r,formatter:d=Pe}){return e.jsxs("article",{className:"card stat","aria-label":`Promedio diario de ventas para ${r}`,children:[e.jsx("h3",{children:"Promedio diario"}),e.jsx("p",{className:"stat-value","data-testid":"sales-daily-average",children:d(t)}),e.jsxs("span",{className:"stat-trend",children:["Rango seleccionado: ",r]})]})}function $t({value:t,rangeLabel:r,formatter:d=Pe}){return e.jsxs("article",{className:"card stat","aria-label":`Ventas acumuladas para ${r}`,children:[e.jsx("h3",{children:"Ventas acumuladas"}),e.jsx("p",{className:"stat-value","data-testid":"sales-total-14d",children:d(t)}),e.jsxs("span",{className:"stat-trend",children:["Rango seleccionado: ",r]}),e.jsx("span",{className:"stat-trend",children:"Montos brutos del periodo"}),e.jsx("span",{className:"muted small",children:"Incluye solo Boleta y Factura"})]})}function At({days:t=14}){const r=n.useMemo(()=>Ke(),[]),d=v=>r.format(v??0),{data:l,isLoading:f,error:c}=ae({queryKey:["sales-window-metrics",t],queryFn:()=>et(`${t}d`)}),p=n.useMemo(()=>l?.dailyAverage??0,[l]),y=n.useMemo(()=>l?.totalWithTax??0,[l]);n.useMemo(()=>l?.documentCount??0,[l]);const E=`Últimos ${t} días`;return f?e.jsx("section",{"aria-labelledby":"sales-dashboard-overview-heading",className:"dashboard-overview",children:e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("header",{className:"card-header",children:e.jsx("div",{children:e.jsx("h2",{id:"sales-dashboard-overview-heading",children:"Resumen de ventas"})})}),e.jsxs("div",{className:"kpi-grid",style:{marginBottom:"1.5rem"},children:[e.jsx("div",{className:"animate-pulse bg-gray-200 rounded-lg h-32"}),e.jsx("div",{className:"animate-pulse bg-gray-200 rounded-lg h-32"})]})]})}):c?e.jsx("section",{"aria-labelledby":"sales-dashboard-overview-heading",className:"dashboard-overview",children:e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("header",{className:"card-header",children:e.jsx("div",{children:e.jsx("h2",{id:"sales-dashboard-overview-heading",children:"Resumen de ventas"})})}),e.jsxs("div",{className:"kpi-grid",style:{marginBottom:"1.5rem"},children:[e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-600",children:"Error al cargar métricas de ventas"})}),e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-red-600",children:"Error al cargar métricas de ventas"})})]})]})}):e.jsx("section",{"aria-labelledby":"sales-dashboard-overview-heading",className:"dashboard-overview",children:e.jsxs("div",{className:"card",style:{marginBottom:"1.5rem"},children:[e.jsx("header",{className:"card-header",children:e.jsx("div",{children:e.jsx("h2",{id:"sales-dashboard-overview-heading",children:"Resumen de ventas"})})}),e.jsxs("div",{className:"kpi-grid",style:{marginBottom:"1.5rem"},children:[e.jsx(qt,{value:p,rangeLabel:E,formatter:d}),e.jsx($t,{value:y,rangeLabel:E,formatter:d})]})]})})}const Ot={position:"absolute",width:1,height:1,padding:0,margin:-1,overflow:"hidden",clip:"rect(0, 0, 0, 0)",whiteSpace:"nowrap",border:0};function Ut({points:t,formatter:r=Pe,averageLine:d}){const l=t.map(c=>({date:c.date,total:c.total??0})),f=l.some(c=>c.total>0);return e.jsxs("div",{className:"chart-container","data-testid":"sales-trend-chart","data-point-count":l.length,children:[e.jsx("div",{style:{height:260},role:"img","aria-label":"Tendencia de ventas diarias",children:e.jsx(gt,{width:"100%",height:"100%",children:e.jsxs(ft,{data:l,margin:{top:10,right:24,left:0,bottom:0},children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"salesTrendGradient",x1:"0",y1:"0",x2:"0",y2:"1",children:[e.jsx("stop",{offset:"5%",stopColor:"#60a5fa",stopOpacity:.85}),e.jsx("stop",{offset:"95%",stopColor:"#60a5fa",stopOpacity:0})]})}),e.jsx(jt,{strokeDasharray:"3 3",stroke:"#1f2937"}),e.jsx(bt,{dataKey:"date",stroke:"#9aa0a6",tick:{fontSize:12}}),e.jsx(yt,{stroke:"#9aa0a6",tickFormatter:c=>r(Number(c)),width:96}),e.jsx(Nt,{formatter:(c,p)=>{const y=p==="total"?"Venta del día":"Promedio período";return[r(c),y]},labelFormatter:c=>`Fecha: ${c}`}),e.jsx(vt,{type:"monotone",dataKey:"total",stroke:"#60a5fa",fill:"url(#salesTrendGradient)",dot:{r:4,strokeWidth:2,fill:"#3b82f6"},activeDot:{r:6,stroke:"#3b82f6",strokeWidth:2}}),d!==void 0&&d>0&&e.jsx(Ct,{y:d,stroke:"#f97316",strokeWidth:2,strokeDasharray:"5 5",label:{value:`Promedio: ${r(d)}`,position:"right",style:{fill:"#f97316",fontSize:12}}})]})})}),!f&&e.jsx("p",{className:"muted",role:"status",children:"Sin ventas registradas en el período seleccionado."}),e.jsx("ul",{style:Ot,"data-testid":"sales-trend-points",children:l.map(c=>e.jsx("li",{"data-testid":"sales-trend-point",children:`${c.date}: ${c.total}`},c.date))})]})}function Kt({days:t=14}){const r=new Date().toISOString().split("T")[0],d=new Date(Date.now()-(t-1)*24*60*60*1e3).toISOString().split("T")[0],[l,f]=n.useState(d),[c,p]=n.useState(r),y=n.useMemo(()=>Ke(),[]),E=u=>y.format(u??0),v=ae({queryKey:["sales","daily-range",l,c],queryFn:()=>tt(l,c),enabled:!!l&&!!c&&l<=c}),C=v.data??[],j=n.useMemo(()=>C.length===0?0:C.reduce((S,w)=>S+w.total,0)/C.length,[C]),_=u=>{u&&(f(u),u>c&&p(u))},i=u=>{u&&(p(u),u<l&&f(u))};return e.jsxs("div",{className:"card",children:[e.jsxs("header",{className:"card-header",style:{gap:"1rem",flexWrap:"wrap"},children:[e.jsxs("div",{style:{display:"flex",flexDirection:"column",gap:"0.25rem"},children:[e.jsx("h2",{children:"Tendencia de ventas"}),e.jsxs("p",{className:"muted small",children:["Promedio diario: ",E(j)," | Total período: ",E(C.reduce((u,S)=>u+S.total,0))]})]}),e.jsxs("div",{className:"field-group",style:{display:"flex",gap:"0.75rem",alignItems:"center"},children:[e.jsxs("label",{className:"field",style:{display:"flex",flexDirection:"column",gap:"0.25rem"},children:[e.jsx("span",{className:"muted small",children:"Desde"}),e.jsx("input",{className:"input",type:"date",value:l,max:c,onChange:u=>_(u.target.value)})]}),e.jsxs("label",{className:"field",style:{display:"flex",flexDirection:"column",gap:"0.25rem"},children:[e.jsx("span",{className:"muted small",children:"Hasta"}),e.jsx("input",{className:"input",type:"date",value:c,min:l,max:r,onChange:u=>i(u.target.value)})]})]})]}),e.jsx("div",{className:"chart-card",children:v.isLoading?e.jsx("p",{className:"muted",role:"status",children:"Cargando datos de ventas..."}):v.isError?e.jsxs("p",{className:"panel-error",role:"status",children:["Error al cargar los datos de ventas. ",v.error?.message]}):C.length>0?e.jsx(Ut,{points:C,formatter:E,averageLine:j}):e.jsxs("p",{className:"muted",role:"status",children:["No hay ventas registradas en el rango seleccionado (",l," - ",c,")."]})})]})}function Qt({page:t=0,size:r=10,sort:d="date,DESC",enabled:l=!0}={}){return ae({queryKey:["sale-documents",t,r,d],queryFn:()=>st({page:t,size:r,sort:d}),enabled:l,placeholderData:$e})}const Vt=new Intl.DateTimeFormat("es-CL",{dateStyle:"medium"}),Bt=new Intl.NumberFormat("es-CL",{style:"currency",currency:"CLP",maximumFractionDigits:0});function zt(t){if(!t)return"—";const r=Date.parse(t);return Number.isNaN(r)?t:Vt.format(new Date(r))}function Gt(t){return t==null||Number.isNaN(t)?"—":Bt.format(t)}function Re(t){const r=[t.documentNumber];return(!r[0]||!r[0]?.trim())&&(r[0]=t.docNumber),(!r[0]||!r[0]?.trim())&&t.series&&t.folio!==void 0&&t.folio!==null&&(r[0]=`${t.series}-${t.folio}`),r[0]?.trim()||t.id}const Yt=10;function Wt({isOpen:t,onClose:r,pageSize:d=Yt}){const[l,f]=n.useState(0),c=n.useRef(null);n.useEffect(()=>{t&&f(0)},[t]);const p=Qt({page:l,size:d,enabled:t}),y=p.data?.content??[],E=p.data?.totalPages??1,v=!p.isLoading&&!p.isError&&y.length===0,C=n.useMemo(()=>p.isFetching&&!p.isLoading?"Actualizando documentos...":null,[p.isFetching,p.isLoading]),j=()=>{p.refetch()},_=()=>{f(u=>Math.max(0,u-1))},i=()=>{f(u=>u+1)};return e.jsxs(_e,{open:t,onClose:r,title:"Documentos de venta",initialFocusRef:c,className:"modal--wide",children:[e.jsxs("div",{className:"sale-documents-modal","aria-live":"polite",children:[p.isLoading&&e.jsx("p",{role:"status",children:"Cargando documentos..."}),p.isError&&e.jsxs("div",{className:"sale-documents-modal__error",role:"alert",children:[e.jsx("p",{children:p.error?.message??"No se pudieron obtener los documentos de venta."}),e.jsx("button",{className:"btn",type:"button",onClick:j,children:"Reintentar"})]}),C&&e.jsx("p",{className:"muted",role:"status",children:C}),v&&e.jsx("p",{className:"muted",children:"No hay documentos de ventas registrados."}),!p.isLoading&&!p.isError&&y.length>0&&e.jsx("div",{className:"sale-documents-modal__table",children:e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table sale-documents-modal__grid",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{scope:"col",children:"Fecha"}),e.jsx("th",{scope:"col",children:"Número de documento"}),e.jsx("th",{scope:"col",children:"Cliente"}),e.jsx("th",{scope:"col",children:"Total"}),e.jsx("th",{scope:"col",className:"sale-documents-modal__status-column",children:"Estado"})]})}),e.jsx("tbody",{children:y.map(u=>e.jsxs("tr",{children:[e.jsx("td",{children:zt(u.date)}),e.jsx("td",{children:e.jsx("span",{className:"sale-documents-modal__cell",title:Re(u),children:Re(u)})}),e.jsx("td",{children:e.jsx("span",{className:"sale-documents-modal__cell",title:u.customerName,children:u.customerName||"—"})}),e.jsx("td",{className:"mono",children:Gt(u.total)}),e.jsx("td",{className:"sale-documents-modal__status-column",children:u.status?e.jsx("span",{className:`status ${u.status.toLowerCase()}`,"aria-label":u.status,children:u.status}):"—"})]},u.id))})]})})}),!p.isError&&y.length>0&&e.jsxs("div",{className:"sale-documents-modal__pagination",children:[e.jsx("button",{className:"btn",type:"button",onClick:_,disabled:l===0||p.isFetching,children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Página ",l+1," de ",E]}),e.jsx("button",{className:"btn",type:"button",onClick:i,disabled:l+1>=E||p.isFetching,children:"Siguiente"})]})]}),e.jsx("footer",{className:"sale-documents-modal__footer",children:e.jsx("button",{ref:c,className:"btn ghost",type:"button",onClick:r,children:"Cerrar"})})]})}const ye=10,Le=14,Ht=[{value:"",label:"Todos"},{value:"emitida",label:"Emitida"},{value:"cancelled",label:"Cancelada"}],Zt=[{value:"",label:"Todos los documentos"},...Se.map(t=>({value:t.value,label:t.label}))],Xt=[{value:"",label:"Todos los pagos"},...we.map(t=>({value:t.value,label:t.label}))];function fe(t,r){return t?t.toLowerCase().includes(r):!1}function X(t){return t==null||Number.isNaN(t)?"-":`$${Math.round(t).toLocaleString("es-CL")}`}function Ne(t){return t==null||Number.isNaN(t)?"-":t.toLocaleString("es-CL")}function Jt(t,r){const d=[];return t&&t>0&&d.push(`- ${X(t)}`),r&&r>0&&d.push(`+ ${X(r)}`),d.length>0?d.join(" / "):"—"}function Me(t){return t.documentNumber&&t.documentNumber.trim()?t.documentNumber.trim():t.docNumber&&t.docNumber.trim()?t.docNumber.trim():t.series&&(t.folio??"")!==""?`${t.series}-${t.folio}`:t.id}function Ie(t){return t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-zA-Z0-9._-]+/g,"_").replace(/^_+|_+$/g,"")}function es(t){if(!t)return".pdf";const r=t.toLowerCase();return r.includes("pdf")?".pdf":r.includes("html")?".html":r.includes("json")?".json":r.includes("xml")?".xml":".bin"}function ts(t,r){if(r?.filename)return r.filename;const d=Ie(t.type||"documento"),l=Ie(t.number??t.id),f=es(r?.mimeType);return`${d||"documento"}-${l||t.id}${f}`}function ss(t){return`${t.type} ${t.number??t.id}`}function as(t,r){const d=URL.createObjectURL(t.blob),l=document.createElement("a");l.href=d,l.download=r,l.rel="noopener",document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(d)}async function ns(t,r){const d=URL.createObjectURL(t.blob),l=window.open("","_blank","noopener,noreferrer");if(!l)throw URL.revokeObjectURL(d),new Error("No se pudo abrir la ventana de impresión. Revisa el bloqueador de ventanas emergentes.");const f=()=>{URL.revokeObjectURL(d)};if(l.addEventListener("beforeunload",f,{once:!0}),t.mimeType.toLowerCase().includes("pdf")){l.document.body.style.margin="0",l.document.body.style.height="100vh";const c=l.document.createElement("iframe");c.src=d,c.title=r,c.style.border="0",c.style.width="100%",c.style.height="100%",l.document.body.appendChild(c),c.onload=()=>{l.document.title=r,l.focus(),l.print()}}else{const c=await t.blob.text();l.document.open(),l.document.write(c),l.document.title=r,l.document.close(),l.focus(),l.print()}setTimeout(f,6e4)}function xs(){const t=qe(),[r,d]=n.useState(0),[l,f]=n.useState(!1),[c,p]=n.useState("emitida"),[y,E]=n.useState(""),[v,C]=n.useState(""),[j,_]=n.useState(""),[i,u]=n.useState(null),[S,w]=n.useState(null),[G,$]=n.useState(!1),R=n.useRef(null),K=n.useRef(null),k=n.useRef(null),Q=Ae(j,300);n.useEffect(()=>{d(0)},[c,y,v,Q]),n.useEffect(()=>{G||requestAnimationFrame(()=>{R.current?.focus()})},[G]);const M=ae({queryKey:["sales",r,c,y,v,Q],queryFn:()=>ot({page:r,size:ye,status:c||void 0,docType:y||void 0,paymentMethod:v||void 0,search:Q||void 0}),placeholderData:$e}),J=ae({queryKey:["sales","metrics","summary","today"],queryFn:()=>ve("today")}),ne=ae({queryKey:["sales","metrics","summary","week"],queryFn:()=>ve("week")}),V=ae({queryKey:["sales","metrics","summary","month"],queryFn:()=>ve("month")}),Y=ae({queryKey:["sale-detail",i?.id],queryFn:()=>{if(!i)throw new Error("Documento no seleccionado");return ct(i.id)},enabled:!!i}),g=Y.data??null,A=n.useMemo(()=>{if(!g)return{subtotal:0,discount:0,tax:0,total:0};const s=g.items.reduce((ie,L)=>ie+(L.discount??0),0),h=g.net,I=g.vat??0,ee=g.total??h+I;return{subtotal:h,discount:s,tax:I,total:ee}},[g]);n.useEffect(()=>{if(!i||!g)return;const s=K.current;s&&requestAnimationFrame(()=>s.focus())},[i,g]);const W=xe({mutationFn:s=>at(s),onSuccess:()=>t.invalidateQueries({queryKey:["sales"]})}),N=xe({mutationFn:({id:s,payload:h})=>lt(s,h),onSuccess:()=>t.invalidateQueries({queryKey:["sales"]})}),re=xe({mutationFn:async s=>{const h=await nt(s.id);await ns(h,ss(s))},onMutate:()=>{w(null)},onError:s=>{w(s instanceof Error?s.message:"No se pudo preparar la impresión. Intenta nuevamente.")}}),B=xe({mutationFn:async s=>{const h=await rt(s.id),I=ts(s,h);as(h,I)},onMutate:()=>{w(null)},onError:s=>{w(s instanceof Error?s.message:"No se pudo descargar el documento. Intenta nuevamente.")}}),he=s=>{if(s.status?.toLowerCase()==="cancelled"){window.alert("La venta ya fue cancelada.");return}window.confirm(`Cancelar venta ${s.docType??"Factura"}?`)&&W.mutate(s.id)},O=s=>{const h=window.prompt("Documento",s.docType??"");if(h===null)return;const I=window.prompt("Metodo de pago",s.paymentMethod??"");if(I===null)return;const ee={docType:h.trim()||s.docType,paymentMethod:I.trim()||s.paymentMethod};N.mutate({id:s.id,payload:ee})},U=s=>{const h={id:s.id,direction:"sales",type:s.docType??"Documento",number:Me(s),issuedAt:s.issuedAt,total:s.total,status:s.status};u(h),w(null)},le=()=>{u(null),w(null),re.reset(),B.reset()},oe=()=>{$(!0)},ue=()=>{$(!1)},se=s=>{d(0);const h=j.trim().toLowerCase(),I=!c||s.status.toLowerCase()===c.toLowerCase(),ee=!y||s.docType===y,ie=!v||s.paymentMethod===v,L=!h||fe(s.docType,h)||fe(s.paymentMethod,h)||fe(s.customerName,h)||fe(s.customerId,h)||fe(s.id,h);I&&ee&&ie&&L&&t.setQueriesData({queryKey:["sales"]},te=>{if(!te||te.number!==0)return te;const pe={id:s.id,customerId:s.customerId??void 0,customerName:s.customerName??void 0,docType:s.docType,docNumber:s.docNumber??s.documentNumber??s.id,paymentMethod:s.paymentMethod,status:s.status,net:s.net,vat:s.vat,total:s.total,issuedAt:s.issuedAt},o=te.content??[],m=[pe,...o].slice(0,te.size??ye);return{...te,content:m,totalElements:(te.totalElements??0)+1}}),t.invalidateQueries({queryKey:["sales"]})},T=n.useMemo(()=>[{header:"Documento",accessorKey:"docType",cell:s=>s.getValue()??"Factura"},{header:"Número de documento",accessorFn:s=>Me(s),cell:s=>{const h=s.getValue()??"-";return e.jsx("span",{className:"mono",children:h})}},{header:"Cliente",accessorFn:s=>s.customerName??s.customerId??"-",cell:s=>s.getValue()??"-"},{header:"Pago",accessorKey:"paymentMethod",cell:s=>s.getValue()??"-"},{header:"Estado",accessorKey:"status",cell:s=>{const h=s.getValue()??"";return e.jsx("span",{className:`status ${h.toLowerCase()}`,children:h})}},{header:"Neto",accessorKey:"net",cell:s=>`$${(s.getValue()??0).toLocaleString()}`},{header:"IVA",accessorKey:"vat",cell:s=>`$${(s.getValue()??0).toLocaleString()}`},{header:"Total",accessorKey:"total",cell:s=>`$${(s.getValue()??0).toLocaleString()}`},{header:"Emitida",accessorKey:"issuedAt",cell:s=>new Date(s.getValue()).toLocaleString()},{id:"actions",header:"Acciones",cell:({row:s})=>e.jsxs("div",{className:"table-actions",children:[e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>U(s.original),children:"Comprobante"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>O(s.original),children:"Editar"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>he(s.original),disabled:W.isPending,children:W.isPending?"Cancelando...":"Cancelar"})]})}],[W.isPending]),ce=pt({data:M.data?.content??[],columns:T,getCoreRowModel:xt(),manualPagination:!0,pageCount:M.data?.totalPages??-1,state:{pagination:{pageIndex:r,pageSize:ye}},onPaginationChange:s=>{const h=typeof s=="function"?s({pageIndex:r,pageSize:ye}).pageIndex:s.pageIndex;d(h)}}),H=J.data,z=ne.data,me=V.data;return e.jsxs("div",{className:"page-section",children:[e.jsx(it,{title:"Ventas",description:"Gestiona documentos, monitorea cobranzas y analiza el desempeno.",actions:e.jsx("button",{className:"btn",onClick:()=>f(!0),children:"+ Registrar venta"})}),e.jsx(At,{days:Le}),e.jsxs("section",{className:"kpi-grid",children:[e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ventas del día"}),e.jsx("p",{className:"stat-value",children:J.isLoading?"Cargando...":J.isError?"—":X(H?.total)}),e.jsx("span",{className:"stat-trend",children:J.isError?"Sin datos disponibles.":`${Ne(H?.count)} documentos`})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ventas de la semana"}),e.jsx("p",{className:"stat-value",children:ne.isLoading?"Cargando...":ne.isError?"—":X(z?.total)}),e.jsx("span",{className:"stat-trend",children:ne.isError?"Sin datos disponibles.":`${Ne(z?.count)} documentos`})]}),e.jsxs("div",{className:"card stat",children:[e.jsx("h3",{children:"Ventas del mes"}),e.jsx("p",{className:"stat-value",children:V.isLoading?"Cargando...":V.isError?"—":X(me?.total)}),e.jsx("span",{className:"stat-trend",children:V.isError?"Sin datos disponibles.":`${Ne(me?.count)} documentos`})]}),e.jsxs("button",{type:"button",className:"card documents-card documents-card--action",onClick:oe,ref:R,"aria-describedby":"sales-documents-card-description",children:[e.jsx("header",{className:"documents-card__header",children:e.jsxs("div",{children:[e.jsx("h3",{children:"Número de documentos"}),e.jsx("p",{className:"documents-card__total",children:M.isLoading?"Cargando...":M.isError?"—":(M.data?.totalElements??0).toLocaleString("es-CL")}),e.jsx("span",{className:"muted small",children:M.isError?"No se pudo obtener el total actual.":"Total documentos"})]})}),e.jsx("span",{className:"documents-card__action-hint",children:"Ver documentos"}),e.jsx("span",{id:"sales-documents-card-description",className:"muted small",children:"Abre la lista completa en una ventana emergente."})]})]}),e.jsx(Kt,{days:Le}),e.jsx("div",{className:"card",children:e.jsxs("div",{className:"filter-bar",children:[e.jsx("input",{className:"input",placeholder:"Buscar (cliente, doc, pago)",value:j,onChange:s=>_(s.target.value)}),j&&e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>_(""),children:"Limpiar"}),e.jsx("select",{className:"input",value:c,onChange:s=>p(s.target.value),children:Ht.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("select",{className:"input",value:y,onChange:s=>E(s.target.value),children:Zt.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))}),e.jsx("select",{className:"input",value:v,onChange:s=>C(s.target.value),children:Xt.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]})}),e.jsxs("div",{className:"card table-card",children:[e.jsx("h3",{children:"Documentos recientes"}),e.jsx("div",{className:"table-wrapper",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:ce.getHeaderGroups().map(s=>e.jsx("tr",{children:s.headers.map(h=>e.jsx("th",{children:h.isPlaceholder?null:Ee(h.column.columnDef.header,h.getContext())},h.id))},s.id))}),e.jsx("tbody",{children:ce.getRowModel().rows.map(s=>e.jsx("tr",{children:s.getVisibleCells().map(h=>e.jsx("td",{children:Ee(h.column.columnDef.cell,h.getContext())},h.id))},s.id))})]})}),e.jsxs("div",{className:"pagination",children:[e.jsx("button",{className:"btn",disabled:r===0,onClick:()=>d(s=>Math.max(0,s-1)),children:"Anterior"}),e.jsxs("span",{className:"muted",children:["Pagina ",r+1," de ",M.data?.totalPages??1]}),e.jsx("button",{className:"btn",disabled:r+1>=(M.data?.totalPages??1),onClick:()=>d(s=>s+1),children:"Siguiente"})]})]}),e.jsx(Wt,{isOpen:G,onClose:ue}),e.jsx(It,{open:l,onClose:()=>f(!1),onCreated:se}),e.jsxs(_e,{open:!!i,onClose:le,title:"Detalle del comprobante",initialFocusRef:K,className:"modal--wide",children:[Y.isLoading&&e.jsx("p",{children:"Cargando comprobante..."}),Y.isError&&e.jsx("p",{className:"error",children:Y.error?.message??"No se pudo cargar el comprobante."}),S&&!Y.isLoading&&e.jsx("p",{className:"error",children:S}),g&&e.jsxs("div",{className:"document-detail","aria-live":"polite",children:[e.jsxs("section",{className:"document-detail__header",children:[e.jsxs("div",{className:"document-detail__headline",children:[e.jsx("p",{className:"document-detail__type",children:g.docType??i?.type??"Documento"}),e.jsxs("p",{className:"document-detail__number",children:["#",i?.number??g.id]})]}),e.jsxs("div",{className:"document-detail__meta-grid",children:[e.jsxs("div",{className:"document-detail__meta-item",children:[e.jsx("span",{className:"document-detail__meta-label",children:"Fecha"}),e.jsx("span",{className:"document-detail__meta-value",children:i?.issuedAt?new Date(i.issuedAt).toLocaleString():"—"})]}),e.jsxs("div",{className:"document-detail__meta-item",children:[e.jsx("span",{className:"document-detail__meta-label",children:g.customer?"Cliente":g.supplier?"Proveedor":"Contraparte"}),e.jsx("span",{className:"document-detail__meta-value",children:g.customer?.name??g.supplier?.name??"—"})]}),e.jsxs("div",{className:"document-detail__meta-item",children:[e.jsx("span",{className:"document-detail__meta-label",children:"Pago"}),e.jsx("span",{className:"document-detail__meta-value",children:g.paymentMethod??"—"})]}),e.jsxs("div",{className:"document-detail__meta-item",children:[e.jsx("span",{className:"document-detail__meta-label",children:"Estado"}),e.jsx("span",{className:"document-detail__meta-value",children:g.status})]}),e.jsxs("div",{className:"document-detail__meta-item document-detail__meta-item--highlight",children:[e.jsx("span",{className:"document-detail__meta-label",children:"Total"}),e.jsx("span",{className:"document-detail__meta-value document-detail__meta-value--highlight",children:X(A.total)})]})]})]}),e.jsx("div",{className:"document-detail__items table-wrapper compact",children:e.jsxs("table",{className:"table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"SKU"}),e.jsx("th",{children:"Descripción"}),e.jsx("th",{className:"mono",children:"Cantidad"}),e.jsx("th",{className:"mono",children:"Precio unitario"}),e.jsx("th",{className:"mono",children:"Descuentos/Impuestos"}),e.jsx("th",{className:"mono",children:"Total ítem"})]})}),e.jsx("tbody",{children:g.items.map((s,h)=>e.jsxs("tr",{children:[e.jsx("td",{className:"mono",children:s.productId??"—"}),e.jsx("td",{children:e.jsx("span",{className:"document-detail__description",title:s.productName,children:s.productName})}),e.jsx("td",{className:"mono",children:Ne(s.qty)}),e.jsx("td",{className:"mono",children:X(s.unitPrice)}),e.jsx("td",{className:"mono",children:Jt(s.discount,s.tax)}),e.jsx("td",{className:"mono",children:X(s.lineTotal)})]},`${s.productId??"item"}-${h}`))})]})}),e.jsxs("div",{className:"document-detail__totals",children:[e.jsxs("div",{className:"document-detail__totals-item",children:[e.jsx("span",{children:"Subtotal"}),e.jsx("strong",{children:X(A.subtotal)})]}),e.jsxs("div",{className:"document-detail__totals-item",children:[e.jsx("span",{children:"Descuentos"}),e.jsx("strong",{children:A.discount>0?`- ${X(A.discount)}`:X(A.discount)})]}),e.jsxs("div",{className:"document-detail__totals-item",children:[e.jsx("span",{children:"Impuestos"}),e.jsx("strong",{children:X(A.tax)})]}),e.jsxs("div",{className:"document-detail__totals-item document-detail__totals-item--accent",children:[e.jsx("span",{children:"Total"}),e.jsx("strong",{children:X(A.total)})]})]}),e.jsxs("div",{className:"document-detail__actions",children:[e.jsx("button",{ref:K,className:"btn",type:"button",onClick:()=>i&&g&&re.mutate(i),disabled:!i||!g||re.isPending||B.isPending,children:re.isPending?"Preparando...":"Imprimir"}),e.jsx("button",{className:"btn ghost",type:"button",onClick:()=>i&&g&&B.mutate(i),disabled:!i||!g||B.isPending||re.isPending,children:B.isPending?"Descargando...":"Descargar"}),e.jsx("button",{ref:k,className:"btn ghost",type:"button",onClick:le,children:"Cerrar"})]})]})]})]})}export{xs as default};
