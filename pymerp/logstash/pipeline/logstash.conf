input {
  # TCP input para logs en tiempo real (desde aplicación)
  tcp {
    port => 5000
    codec => json_lines
  }
  
  # File input para logs desde archivos (producción)
  file {
    path => "/var/log/pymerp/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
  }
}

filter {
  # Parsear timestamp ISO8601
  date {
    match => ["@timestamp", "ISO8601"]
    target => "@timestamp"
  }

  # Añadir tag para errores
  if [level] == "ERROR" {
    mutate {
      add_tag => ["error"]
    }
  }

  # Extraer duración de performance (si existe en el mensaje)
  if [message] =~ /duration/ {
    grok {
      match => { "message" => "duration=(?<duration_ms>\d+)ms" }
    }
    mutate {
      convert => { "duration_ms" => "integer" }
    }
  }

  # Enriquecer con información de tenant (companyId)
  if [companyId] {
    mutate {
      add_field => { "tenant" => "%{companyId}" }
    }
  }

  # Extraer información de exception si existe
  if [stack_trace] {
    mutate {
      add_tag => ["has_exception"]
    }
  }
}

output {
  # Enviar a Elasticsearch con índice diario
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "logs-pymerp-%{+YYYY.MM.dd}"
  }
  
  # Output a consola para debugging (comentar en producción)
  stdout {
    codec => rubydebug
  }
}
